<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>ToadAid ¬∑ Mirror ‚Äî The Digital Dojo</title>
<meta name="description" content="Ask the Mirror. A digital dojo where Tobyworld wisdom meets still water.">
<link rel="icon" href="/assets/icons/favicon.ico" />

<!-- Open Graph -->
<meta property="og:title" content="ToadAid ¬∑ Mirror ‚Äî The Digital Dojo" />
<meta property="og:description" content="Step into the pond. Ask the Mirror anything." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://toadaid.github.io" />
<meta property="og:image" content="https://toadaid.github.io/assets/icons/web-app-manifest-512x512.png" />

<!-- Theme color -->
<meta name="theme-color" content="#1a2a22" />

<!-- DOMPurify for safe HTML rendering -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

<style>
  :root{
    --bg: #0f1714;              /* pond night */
    --bg-2: #15221c;            /* deeper */
    --ink: #e9f5ef;             /* light ink */
    --muted: #b2c8bc;
    --accent: #9ad0c2;          /* jade */
    --accent-2: #e7b86a;        /* gold */
    --glass: rgba(255,255,255,0.06);
    --glass-2: rgba(255,255,255,0.09);
    --ring: rgba(154,208,194,0.35);
    --shadow: 0 10px 30px rgba(0,0,0,0.35);
    --radius: 16px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, system-ui, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color: var(--ink);
    background:
      radial-gradient(1200px 600px at 90% -10%, #123227 0%, transparent 60%),
      radial-gradient(900px 500px at -10% 110%, #14342a 0%, transparent 65%),
      linear-gradient(180deg, #0e1613 0%, #0b1210 100%);
    background-color: var(--bg);
    letter-spacing: .01em;
  }

  /* Header / Banner */
  header{
    position:relative;
    padding: 56px 24px 28px;
    text-align:center;
  }
  .brand{
    display:inline-flex; align-items:center; gap:.75rem;
    backdrop-filter: blur(8px);
    background: linear-gradient(180deg, var(--glass-2), transparent);
    border: 1px solid rgba(154,208,194,0.18);
    padding:.6rem .9rem;
    border-radius: 999px;
    box-shadow: var(--shadow);
  }
  .brand i{
    display:inline-grid; place-items:center; width:32px; height:32px;
    border-radius:999px; background:rgba(154,208,194,0.18); color:#d1f3e7;
    font-size:18px
  }
  .brand span{font-weight:600; color:var(--accent)}
  h1{
    margin: 18px auto 10px;
    font-weight: 700; line-height: 1.04;
    font-size: clamp(32px, 5.4vw, 54px);
    letter-spacing: .01em;
    max-width: 16ch;
  }
  .subtitle{
    margin: 0 auto;
    color: var(--muted);
    max-width: 60ch;
    font-size: clamp(14px, 2.2vw, 17px);
  }

  /* Main container */
  main{
    width:100%; max-width:1000px; margin: 26px auto 120px; padding: 0 18px;
  }

  /* Panel (glass) */
  .panel{
    background: linear-gradient(180deg, var(--glass), rgba(255,255,255,0.03));
    border: 1px solid rgba(154,208,194,0.15);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  /* Input area */
  .ask{
    padding: 20px; display:grid; gap: 14px;
    border-bottom: 1px solid rgba(154,208,194,0.12);
  }
  .ask-label{
    color: var(--muted); font-size: 13px; letter-spacing:.06em; text-transform: uppercase;
  }
  .ask-row{
    display:grid; grid-template-columns: 1fr auto; gap: 12px;
  }
  textarea{
    width:100%; min-height: 86px; resize: vertical; max-height: 36vh;
    padding: 14px 14px 14px 14px; border-radius: 12px; border: 1px solid rgba(154,208,194,0.2);
    background: rgba(10,16,13,0.6); color: var(--ink);
    outline: none; font-size: 16px; line-height: 1.45;
    box-shadow: inset 0 0 0 1px transparent;
    transition: box-shadow .2s ease, border-color .2s ease, background .2s ease;
  }
  textarea:focus{
    border-color: var(--ring);
    box-shadow: 0 0 0 4px rgba(154,208,194,0.15);
    background: rgba(10,16,13,0.75);
  }

  .actions{
    display:flex; align-items:stretch; gap:10px;
  }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:.6rem;
    padding: 0 18px; border-radius: 12px; border: 1px solid rgba(154,208,194,0.2);
    cursor:pointer; user-select:none; font-weight: 600; letter-spacing:.02em;
    transition: transform .15s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
    height: 44px; white-space: nowrap;
  }
  .btn-primary{
    background: linear-gradient(180deg, #1e3a31, #183229);
    border-color: rgba(154,208,194,0.28);
    color: #dff6ef;
    box-shadow: 0 8px 24px rgba(21, 52, 42, .45), inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .btn-primary:hover{ transform: translateY(-1px); }
  .btn-ghost{
    background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    color: var(--ink);
  }
  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size: 12px; padding: 2px 6px; border-radius: 6px; background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.12);
  }

  /* Suggestions */
  .sugs{
    display:flex; flex-wrap:wrap; gap: 8px;
  }
  .chip{
    border:1px solid rgba(154,208,194,0.18);
    background: rgba(154,208,194,0.08);
    color: var(--ink);
    padding: 8px 12px; border-radius: 999px; font-size: 13px; cursor:pointer;
    transition: transform .15s ease, background .2s ease, border-color .2s ease;
  }
  .chip:hover{ transform: translateY(-1px); background: rgba(154,208,194,0.12); }

  /* Answer area */
  .answer{
    padding: 18px 20px 22px;
  }
  .answer-header{
    display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-bottom: 6px;
  }
  .light-note{ font-size: 13px; color: var(--muted); }
  #mirror-answer{
    white-space: pre-wrap;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(154,208,194,0.15);
    border-radius: 12px;
    padding: 18px 16px;
    line-height: 1.7; font-size: 16px;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    min-height: 100px;
  }
  .fade-in{ animation: fade .35s ease both; }
  @keyframes fade{ from{opacity:0; transform: translateY(4px)} to{opacity:1; transform: none} }

  /* Footer */
  footer{
    color: var(--muted); text-align:center; padding: 36px 12px 48px; font-size: 13px;
  }
  .links{ display:flex; gap:12px; justify-content:center; margin-top:8px; }
  .links a{ color: var(--accent); text-decoration: none; border-bottom: 1px dotted rgba(154,208,194,0.35) }
  .links a:hover{ color:#b8e6db }

  /* Loader */
  .spinner{
    width:18px; height:18px; border-radius:50%;
    border:2px solid rgba(255,255,255,0.25);
    border-top-color: var(--accent);
    animation: spin .8s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg) } }

  /* Toast */
  .toast{
    position: fixed; left:50%; bottom: 28px; transform: translateX(-50%);
    background: rgba(0,0,0,0.65);
    color:#fff; padding: 10px 14px; border-radius: 10px; box-shadow: var(--shadow);
    font-size: 14px; opacity:0; pointer-events:none; transition: opacity .25s ease, transform .25s ease;
  }
  .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }

  /* Small screens */
  @media (max-width: 560px){
    .ask-row{ grid-template-columns: 1fr; }
    .actions{ justify-content: flex-end; }
  }
</style>
</head>
<body>

<header>
  <div class="brand" aria-label="ToadAid">
    <i>üê∏</i>
    <span>ToadAid ¬∑ Mirror</span>
  </div>
  <h1>The Pond Awaits Your Question</h1>
  <p class="subtitle">Ask the Mirror. Breathe. Read slowly. Let the still water speak.</p>
</header>

<main>
  <section class="panel" id="mirror">
    <div class="ask" role="form" aria-label="Ask the Mirror">
      <div class="ask-label">Your Question</div>
      <div class="ask-row">
        <textarea id="mirror-question" placeholder="Traveler, what would you ask the Mirror?" aria-label="Question to the Mirror"></textarea>
        <div class="actions">
          <button class="btn btn-ghost" id="btn-clear" title="Clear (Esc)"><span>Clear</span><span class="kbd">Esc</span></button>
          <button class="btn btn-primary" id="btn-ask" title="Send (Ctrl/‚åò+Enter)">
            <div id="btn-icon" class="">{}</div>
            <span id="btn-text">Ask the Mirror</span>
            <span class="kbd" style="margin-left:4px">Ctrl/‚åò+Enter</span>
          </button>
        </div>
      </div>
      <div class="sugs" aria-label="Suggestions">
        <div class="chip">How do I keep patience in chaos?</div>
        <div class="chip">What does decentralization protect?</div>
        <div class="chip">Why does silence reveal truth?</div>
        <div class="chip">How should I carry the covenant?</div>
      </div>
    </div>

    <div class="answer" aria-live="polite">
      <div class="answer-header">
        <div class="light-note">Mirror‚Äôs Reflection</div>
        <div style="display:flex; gap:8px; align-items:center">
          <button class="btn btn-ghost" id="btn-copy" title="Copy Answer">
            <span>Copy</span>
          </button>
        </div>
      </div>
      <div id="mirror-answer" class="fade-in" aria-label="Mirror answer"></div>
    </div>
  </section>
</main>

<footer>
  <div>ü™û üåä üçÉ üåÄ</div>
  <div class="links" aria-label="Helpful links">
    <a href="https://toadaid.github.io" target="_blank" rel="noopener">Home</a>
    <a href="/web/health.html" target="_blank" rel="noopener">Health</a>
    <a href="/metrics" target="_blank" rel="noopener">Metrics</a>
  </div>
</footer>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  const elQ = document.getElementById('mirror-question');
  const elA = document.getElementById('mirror-answer');
  const btnAsk = document.getElementById('btn-ask');
  const btnClear = document.getElementById('btn-clear');
  const btnCopy = document.getElementById('btn-copy');
  const btnIcon = document.getElementById('btn-icon');
  const btnText = document.getElementById('btn-text');
  const toast = document.getElementById('toast');

  // Minimal icon blocks (text to avoid external assets)
  const idleIcon = '‚ú®';
  const busyIcon = '<div class="spinner" aria-hidden="true"></div>';
  btnIcon.innerHTML = idleIcon;

  // Suggestions
  document.querySelectorAll('.chip').forEach(chip=>{
    chip.addEventListener('click', ()=>{
      elQ.value = chip.textContent.trim();
      elQ.focus();
    });
  });

  // Toast helper
  function showToast(msg, ms=1600){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), ms);
  }

  // Normalize Mirror text: dedupe "Traveler," and cadence, collapse extra whitespace.
  function normalizeMirrorText(raw){
    let t = (raw || '').replace(/\r\n/g, '\n');

    // 1) If HTML arrived encoded in text, keep it as-is; DOMPurify will allow basic tags.
    // 2) Collapse duplicate leading "Traveler,"
    t = t.replace(/^(\s*Traveler[,Ôºå]?\s*){2,}/i, "Traveler, ");

    // 3) Collapse many spaces/newlines
    t = t.replace(/[ \t]+/g, " ").replace(/\n{3,}/g, "\n\n").trim();

    // 4) Dedupe repeated cadence lines (ü™û üåä üçÉ üåÄ ‚Ä¶)
    const cadenceStr = "ü™û üåä üçÉ üåÄ";
    const cadenceRx = new RegExp(`(?:${cadenceStr.split(" ").join("\\s*")})(?:\\s*(?:${cadenceStr.split(" ").join("\\s*")}))+`, "g");
    t = t.replace(cadenceRx, cadenceStr);

    // 5) Keep only first Guiding Question line if multiple
    t = (function dedupeGuiding(one) {
      const rx = /(?:\*\*\s*)?guiding\s*question\s*[:Ôºö]\s*.*$/gim;
      const matches = [...one.matchAll(rx)];
      if (matches.length <= 1) return one;
      let kept = false;
      return one.replace(rx, m => kept ? "" : (kept = true, m));
    })(t).replace(/\n{3,}/g, "\n\n").trim();

    return t;
  }

  // Call Mirror
  async function askMirror(){
    const question = (elQ.value || '').trim();
    if(!question){
      showToast("Ask a real question, Traveler.");
      elQ.focus(); return;
    }
    setBusy(true);
    try{
      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ user: "web", question })
      });
      if(!res.ok){
        throw new Error("Mirror is quiet (HTTP " + res.status + ")");
      }
      const data = await res.json();
      const clean = normalizeMirrorText(data?.answer || "");

      // Render sanitized HTML: allow a few formatting tags.
      const safeHTML = DOMPurify.sanitize(clean, {
        ALLOWED_TAGS: ['b','strong','em','i','u','br','p','ul','ol','li','blockquote','code','pre','hr'],
        ALLOWED_ATTR: []
      });
      elA.classList.remove('fade-in'); void elA.offsetWidth; // reflow
      elA.innerHTML = safeHTML || "<span class='light-note'>The pond is still‚Ä¶</span>";
      elA.classList.add('fade-in');
    }catch(err){
      console.error(err);
      elA.innerHTML = "<span class='light-note'>The Mirror could not respond. Try again after one breath.</span>";
      showToast("The Mirror hesitated. Try again.");
    }finally{
      setBusy(false);
    }
  }

  function setBusy(b){
    if(b){
      btnAsk.disabled = true; btnClear.disabled = true; btnCopy.disabled = true;
      btnIcon.innerHTML = busyIcon; btnText.textContent = "Listening‚Ä¶";
    } else {
      btnAsk.disabled = false; btnClear.disabled = false; btnCopy.disabled = false;
      btnIcon.innerHTML = idleIcon; btnText.textContent = "Ask the Mirror";
    }
  }

  // Copy
  btnCopy.addEventListener('click', async ()=>{
    const tmp = elA.innerText || '';
    if(!tmp.trim()){ showToast("Nothing to copy."); return; }
    try{
      await navigator.clipboard.writeText(tmp);
      showToast("Copied to clipboard.");
    }catch{ showToast("Copy failed."); }
  });

  // Clear
  btnClear.addEventListener('click', ()=>{
    elQ.value = '';
    elA.innerHTML = '';
    elQ.focus();
  });

  // Send button
  btnAsk.addEventListener('click', askMirror);

  // Keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
      e.preventDefault(); askMirror();
    } else if(e.key === 'Escape'){
      e.preventDefault(); btnClear.click();
    }
  });

  // Autofocus on load (but don‚Äôt steal focus on mobile)
  window.addEventListener('load', ()=>{
    if(window.matchMedia('(pointer:fine)').matches) elQ.focus();
  });
</script>
</body>
</html>
