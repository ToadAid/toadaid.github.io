<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="format-detection" content="telephone=no" />
<style>html{-webkit-text-size-adjust:100%}</style>

<title>ToadAid â€” Guarding the Lore</title>
<meta name="description" content="ToadAid â€” Guarding the Lore. Ask the Mirror for guidance and explore the scrolls of Tobyworld.">

<!-- OG -->
<meta property="og:title" content="ToadAid â€” Guarding the Lore" />
<meta property="og:description" content="Ask the Mirror for guidance. Explore the scrolls of Tobyworld." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://toadaid.github.io" />
<meta property="og:image" content="https://toadaid.github.io/assets/icons/web-app-manifest-512x512.png" />
<link rel="canonical" href="https://toadaid.github.io" />

<!-- Icons -->
<link rel="icon" type="image/x-icon" href="/assets/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
<link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
<link rel="manifest" href="/assets/icons/site.webmanifest">
<meta name="theme-color" content="#355e3b" />

<style>
/* styles unchanged from your original */
... (keep all your CSS here exactly as in index.html) ...
</style>
</head>
<body>

<!-- Banner -->
<div class="banner">
  <h1>ğŸ¯ ToadAid â€” Guarding the Lore</h1>
  <p>One scroll, one light. One leaf, one vow.</p>
</div>

<div class="translate-bar">
  ğŸŒ Want to read in your language? In Chrome: Menu (â‹®) â†’ Translate â†’ Select your language.
</div>

<section style="text-align:center">
  <!-- buttons unchanged -->
</section>

<!-- Mirror -->
<section id="mirror">
  <h2>ğŸ”® Ask the Mirror</h2>
  <div class="mirror-wrap">
    <input id="mirror-question" type="text" placeholder="What wisdom do you seek today, traveler?" autocomplete="off">
    <div class="sugs">
      <!-- chips unchanged -->
    </div>

    <button id="mirror-ask-btn" class="btn cta" onclick="askMirror()">
      <span class="loading-ripple" id="ask-spinner"><div></div><div></div></span>
      <span id="ask-label">Seek Wisdom</span>
    </button>

    <div id="mirror-answer"></div>
  </div>
</section>

<!-- Lore + Children + Footer unchanged -->

<script>
/* Books */
function openBook(bookFile){ ... } // unchanged

/* ----------------- Mirror logic ----------------- */
const MIRROR_API = "https://toadaid.duckdns.org/ask";
const askBtn = document.getElementById('mirror-ask-btn');
const askSpin = document.getElementById('ask-spinner');
const askLabel = document.getElementById('ask-label');
const qInput = document.getElementById('mirror-question');
const ansDiv = document.getElementById('mirror-answer');

// NEW: off-ramp detection
const BOW_RX = /Traveler,\s*the reflection rests\.[\s\S]*?(?:ğŸªğŸŒŠğŸƒğŸŒ€)?/i;

function cleanMirrorResponse(reply){ ... } // unchanged

function parseMirrorResponse(reply){
  const bow = reply.match(BOW_RX);
  if (bow) {
    return {
      offRamp: true,
      greeting: bow[0].trim(),
      points: [],
      guidingQuestion: "",
      symbols: "",
      paragraphs: []
    };
  }
  // normal parse
  const lines = reply.split('\n').filter(Boolean);
  const s = { greeting:'', points:[], guidingQuestion:'', symbols:'', paragraphs:[], offRamp:false };
  let inGreeting=true;
  for(const raw of lines){
    const line = raw.trim();
    if(/^traveler[,ï¼Œ]?/i.test(line)){ s.greeting=line; inGreeting=false; continue; }
    if(/guiding\s*question/i.test(line)){ s.guidingQuestion=line; continue; }
    if(/[ğŸªğŸŒŠğŸƒğŸŒ€]/.test(line) && line.length<=16){ s.symbols=line; continue; }
    if(/\*\*(.*?)\*\*/.test(line)){ s.points.push(line); continue; }
    if(!inGreeting) s.paragraphs.push(line);
  }
  return s;
}

function formatMirrorResponse(question, s){
  let html = `
    <div class="mirror-dialogue">
      <div class="user-question"><strong>You asked:</strong> "${question}"</div>
      <div class="mirror-response">
  `;
  if(s.greeting) html += `<div class="mirror-greeting">${s.greeting}</div>`;

  if (s.offRamp) { // show only bow
    html += `</div></div>`;
    return html;
  }

  // normal flow
  s.paragraphs.forEach(p=>{ if(!/\*\*(.*?)\*\*/.test(p)) html += `<div class="wisdom-paragraph">${p}</div>`; });
  s.points.forEach(point=>{
    const m = point.match(/\*\*(.*?)\*\*/);
    if(m){
      const title = m[1];
      const content = point.replace(/\*\*(.*?)\*\*/,'').trim();
      html += `<div class="wisdom-point"><strong>${title}</strong>${content}</div>`;
    }else{
      html += `<div class="wisdom-paragraph">${point}</div>`;
    }
  });
  if(s.guidingQuestion) html += `<div class="guiding-question">${s.guidingQuestion.replace(/guiding\s*question\s*[:ï¼š]/i,'<strong>Guiding Question:</strong>')}</div>`;
  if(s.symbols) html += `<div class="symbols-line">${s.symbols}</div>`;
  html += `<div class="mirror-signature">ğŸª The Mirror has spoken</div></div></div>`;
  return html;
}

function showError(message){ ... } // unchanged
function showCommunityInvitation(){ ... } // unchanged
function setBusy(b){ ... } // unchanged
async function typewriterEffect(htmlContent){ ... } // unchanged
function pickSpeed(el){ ... } // unchanged
function typewriteSection(container, html, text, speed){ ... } // unchanged

/* Ask */
async function askMirror(){
  const question = qInput.value.trim();
  if(!question){ showError("The Mirror awaits your question, traveler..."); return; }
  if(!navigator.onLine){ showError("ğŸ“¶ Youâ€™re offline â€” the pond is resting. Iâ€™ll be here when you return."); return; }

  setBusy(true);
  ansDiv.innerHTML = '<div style="text-align:center;padding:1.1rem">ğŸŒŠ The pond grows still, awaiting reflection...</div>';

  try{
    const res = await fetch(MIRROR_API, {
      method:'POST',
      headers:{ "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify({ question, user: "web_visitor_" + Date.now() })
    });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    let reply = data.answer || data.reply || "The Mirror is silent, but the pond remembers your question.";
    reply = cleanMirrorResponse(reply);

    const s = parseMirrorResponse(reply);
    const html = formatMirrorResponse(question, s);

    ansDiv.innerHTML = '';
    await typewriterEffect(html);

    if (!s.offRamp) {
      setTimeout(showCommunityInvitation, 600);
    } else {
      // optional: disable input on off-ramp
      // qInput.disabled = true; askBtn.disabled = true;
    }
  }catch(err){
    console.error('Mirror error:', err);
    showError("ğŸŒ€ The waters are unsettled today. The Mirror suggests you try again when the pond grows still.");
  }finally{
    setBusy(false);
    qInput.value=''; if(window.matchMedia('(pointer:fine)').matches) qInput.focus();
  }
}

/* Enter to send */
qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); askMirror(); }});
window.addEventListener('load', ()=>{ if(window.matchMedia('(pointer:fine)').matches) qInput.focus(); });
</script>

</body>
</html>
