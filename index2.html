<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="format-detection" content="telephone=no" />
<style>html{-webkit-text-size-adjust:100%}</style>

<title>ToadAid — Guarding the Lore</title>
<meta name="description" content="ToadAid — Guarding the Lore. Ask the Mirror for guidance and explore the scrolls of Tobyworld.">

<!-- Open Graph -->
<meta property="og:title" content="ToadAid — Guarding the Lore" />
<meta property="og:description" content="Ask the Mirror for guidance. Explore the scrolls of Tobyworld." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://toadaid.github.io" />
<meta property="og:image" content="https://toadaid.github.io/assets/icons/web-app-manifest-512x512.png" />

<!-- Canonical -->
<link rel="canonical" href="https://toadaid.github.io" />

<!-- Favicons -->
<link rel="icon" type="image/x-icon" href="/assets/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
<link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
<link rel="manifest" href="/assets/icons/site.webmanifest">
<meta name="theme-color" content="#355e3b" />

<style>
  :root{
    --bg:#f5f1e6;
    --ink:#2f2f2f;
    --green:#355e3b;
    --gold:#ffd23f;        /* brighter like screenshot translate bar/buttons */
    --gold-ink:#1a1a1a;
    --card:#ffffff;
    --chip:#214834;
    --chip-ink:#eaf3ee;
    --shadow-s:rgba(0,0,0,.08);
    --shadow-m:rgba(0,0,0,.2);
    --accent-veil:rgba(53,94,59,.08);
  }

  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
  body{font-family:'Segoe UI',system-ui,-apple-system,Roboto,Ubuntu,sans-serif;background:var(--bg);color:var(--ink);line-height:1.6;overflow-x:hidden}

  /* ---------- Banner (bright image with subtle shade) ---------- */
  .banner{
    position:relative;width:100%;min-height:260px;
    background:
      linear-gradient(rgba(0,0,0,.12), rgba(0,0,0,.22)),
      url('banner.jpg') center/cover no-repeat;
    display:flex;flex-direction:column;justify-content:center;align-items:center;
    text-align:center;color:#fff;padding:1.2rem 1rem;box-shadow:0 2px 10px var(--shadow-m);
  }
  @media (min-width:768px){ .banner{min-height:360px} }
  .banner h1{font-size:clamp(1.9rem,4.6vw,2.8rem);text-shadow:0 2px 8px rgba(0,0,0,.55);font-weight:700}
  .banner p{font-size:clamp(1rem,2.2vw,1.2rem);margin-top:.45rem;text-shadow:0 1px 4px rgba(0,0,0,.45)}

  /* ---------- Translate strip & buttons like screenshot ---------- */
  .translate-bar{background:var(--gold);color:var(--gold-ink);padding:.65rem 1rem;text-align:center;font-weight:700}

  .btn{
    display:inline-flex;align-items:center;gap:.55rem;background:var(--gold);color:var(--gold-ink);
    padding:.7rem 1.1rem;margin:.35rem;border:0;border-radius:12px;font-weight:800;
    box-shadow:0 3px 8px var(--shadow-m);cursor:pointer;text-decoration:none;transition:transform .15s ease, box-shadow .15s ease
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 12px var(--shadow-m)}
  .btn-dark{background:var(--chip);color:var(--chip-ink)}
  .btn-green{background:#2e6d4c;color:#fff}
  .btn-deep{background:#265c40;color:#fff}
  .btn-library{background:#3a7253;color:#fff}

  section{padding:2rem 1rem;max-width:1200px;margin:auto}
  h2{text-align:center;margin-bottom:1.1rem;color:var(--green)}
  .pillars{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;margin-top:.6rem}
  .pillar{background:var(--card);padding:1rem;border-radius:12px;box-shadow:0 2px 8px var(--shadow-s);border:1px solid rgba(0,0,0,.06);color:inherit}

  /* ---------- Mirror Section (cards like your preferred design) ---------- */
  #mirror{background:linear-gradient(135deg,#f5f1e6,#e8e0d0);border-radius:16px;box-shadow:0 6px 16px var(--shadow-s);margin:2rem 1rem}
  .mirror-wrap{max-width:860px;margin:auto;padding:1.5rem}

  #mirror-question{
    width:100%;padding:1rem 1.2rem;border-radius:12px;border:2px solid #d7ddd7;background:#fff;font-size:16px;
    box-shadow:0 1px 2px rgba(0,0,0,.04) inset;
  }
  #mirror-question:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 3px rgba(53,94,59,.12)}
  .sugs{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin:.9rem 0}
  .chip{background:var(--accent-veil);border:1px solid rgba(53,94,59,.25);padding:.5rem .9rem;border-radius:22px;font-weight:700;cursor:pointer}
  .chip:hover{background:rgba(53,94,59,.18)}

  .cta{width:100%;padding:1rem;border-radius:12px;border:none;background:linear-gradient(135deg,#6b5bd2,#7b4aa2);color:#fff}
  .loading-ripple{display:inline-block;width:18px;height:18px;vertical-align:-4px;margin-right:.4rem}
  @keyframes ripple{0%{transform:scale(.8);opacity:1}100%{transform:scale(2.4);opacity:0}}
  .loading-ripple div{position:absolute;border:2px solid #fff;border-radius:50%;animation:ripple 1s cubic-bezier(0,.2,.8,1) infinite}
  .loading-ripple div:nth-child(2){animation-delay:-.5s}

  .mirror-dialogue{background:#fff;border-left:4px solid var(--green);border-radius:12px;box-shadow:0 4px 12px var(--shadow-s);padding:1.1rem;margin-top:1rem;opacity:0;transform:translateY(14px);transition:all .3s ease}
  .mirror-dialogue.visible{opacity:1;transform:translateY(0)}
  .user-question{background:#edf0ec;border-left:4px solid #d4af37;border-radius:10px;padding:.9rem 1rem;margin:.4rem .4rem 1rem;font-style:italic}
  .mirror-response{line-height:1.75}
  .mirror-greeting{color:var(--green);font-weight:700;margin:.5rem 0 1rem}
  .wisdom-point{background:rgba(212,175,55,.12);border-left:3px solid #d4af37;border-radius:10px;padding:.9rem 1rem;margin:1rem 0}
  .wisdom-point strong{color:var(--green);display:block;margin-bottom:.35rem}
  .wisdom-paragraph{margin:.7rem 0}
  .guiding-question{background:rgba(53,94,59,.12);border-left:3px solid var(--green);border-radius:10px;padding:.9rem 1rem;margin:1rem 0;font-style:italic}
  .guiding-question strong{color:var(--green)}
  .symbols-line{text-align:center;letter-spacing:.18em;opacity:.85;margin:1rem 0}
  .mirror-signature{opacity:.75;text-align:right;margin-top:1rem;font-style:italic;color:var(--green)}
  .error-message{background:rgba(244,67,54,.1);border-left:4px solid #f44336;border-radius:10px;padding:1rem;margin-top:1rem}

  footer{background:var(--green);color:#fff;text-align:center;padding:2rem 1rem;margin-top:2rem}
  footer a{color:#ffd23f;font-weight:800}

  @media (max-width:720px){
    section{padding:1.6rem 1rem}
    #mirror{margin:1.2rem 0}
  }
</style>
</head>
<body>

<!-- Banner -->
<div class="banner">
  <h1>🏯 ToadAid — Guarding the Lore</h1>
  <p>One scroll, one light. One leaf, one vow.</p>
</div>

<div class="translate-bar">
  🌐 Want to read in your language? In Chrome: Menu (⋮) → Translate → Select your language.
</div>

<section style="text-align:center">
  <a href="#mirror" class="btn">🪞 Ask the Mirror</a>
  <a href="#lore" class="btn">📜 Browse the Lore</a>
  <a href="bluepaper.html" class="btn">📄 Blue Paper</a>
  <a href="about.html" class="btn">📘 About ToadAid</a>
  <a href="feedback/feedback.html" class="btn">💬 Feedback</a>

  <div style="margin-top:.4rem">
    <a href="Contributors/contributors.html" class="btn btn-dark">🐸 Contributors</a>
    <a href="builders/builders-hall.html" class="btn btn-dark">🏛 Builders Hall</a>
    <a href="https://toadaid-builders.netlify.app/builders.html" class="btn btn-dark" target="_blank">🛠 Builders</a>
    <a href="honors/index.html" class="btn btn-dark">🐸 Honors & Offerings</a>
    <a href="scrolls/index.html" class="btn btn-dark">📜 Scroll Vault</a>
    <a href="https://toadaid.github.io/lore" class="btn btn-dark">📖 Lore Library</a>
  </div>
</section>

<section>
  <h2>Our Mission</h2>
  <div class="pillars">
    <div class="pillar"><h3>🏯 Guarding the Lore</h3><p>Preserving Tobyworld’s original scrolls and protecting them from distortion.</p></div>
    <div class="pillar"><h3>🐸 Helping the Fallen Frog</h3><p>Guiding lost frogs back to the pond and helping them rejoin the path.</p></div>
    <div class="pillar"><h3>📜 Empowering Contributors</h3><p>Recognizing and encouraging scrollmakers, translators, and teachers.</p></div>
  </div>
</section>

<!-- 🪞 Mirror -->
<section id="mirror">
  <h2>🔮 Ask the Mirror</h2>
  <div class="mirror-wrap">
    <input id="mirror-question" type="text" placeholder="What wisdom do you seek today, traveler?" autocomplete="off">
    <div class="sugs">
      <button class="chip" onclick="fillQuestion('How do I find inner peace?')">🌿 Inner Peace</button>
      <button class="chip" onclick="fillQuestion('What is true community?')">🐸 True Community</button>
      <button class="chip" onclick="fillQuestion('What does silence teach us?')">🌀 Silence Wisdom</button>
      <button class="chip" onclick="fillQuestion('How do I overcome fear?')">💫 Overcoming Fear</button>
    </div>

    <button id="mirror-ask-btn" class="btn cta" onclick="askMirror()">
      <span class="loading-ripple" id="ask-spinner" style="display:none"><div></div><div></div></span>
      <span id="ask-label">Seek Wisdom</span>
    </button>

    <div id="mirror-answer"></div>
  </div>
</section>

<section id="lore">
  <h2>📚 Lore Library</h2>
  <div class="pillars">
    <a href="bluepaper.html" class="pillar" target="_blank">
      <h3>📄 Bluepaper</h3>
      <p>The updated mission, vision, and principles of ToadAid.</p>
    </a>
    <a href="#" class="pillar" onclick="openBook('v1.html')">
      <h3>📜 Book v1</h3>
      <p>The first collected scrolls of Tobyworld lore. Bilingual EN/ZH edition.</p>
    </a>
    <a href="#" class="pillar" onclick="openBook('v2.html')">
      <h3>📜 Book v2</h3>
      <p>The expanded lore, with Mirror awakening & new revelations.</p>
    </a>
  </div>
</section>

<section id="children">
  <h2>🐸📚 Children's Corner — One Leaf for the Young</h2>
  <p style="text-align:center;max-width:800px;margin:1rem auto;color:#355e3b">
    The flame we guard is for Toby, the People. Every scroll carries truth for the present… and seeds for those who will walk after us.
    Here, the Lore wears softer colors — so even the smallest frog can hear its song.
  </p>
  <div style="text-align:center;margin-top:1.4rem">
    <a href="childrens-corner/index.html" class="btn btn-green">🌿 Visit the Children's Corner</a>
  </div>
</section>

<footer>
  <p>“One scroll, one light. One leaf, one vow.”</p>
  <p>🐸 Join us:
    <a href="https://t.me/Toadgang" target="_blank">Telegram</a> |
    <a href="https://github.com/ToadAid" target="_blank">GitHub</a> |
    <a href="https://x.com/toadgod1017" target="_blank">Toadgod on X</a> |
    <a href="https://toadgod.xyz" target="_blank">Toadgod.xyz</a>
  </p>
</footer>

<script>
/* ----------------- Books ----------------- */
function openBook(bookFile){
  const saved = localStorage.getItem(bookFile + '-scroll');
  if(saved && confirm("📌 Last time you stopped at position " + saved + "px. Continue from there?")){
    location.href = bookFile + "?pos=" + saved; return;
  }
  location.href = bookFile;
}

/* ----------------- Mirror logic ----------------- */
const MIRROR_API = "https://toadaid.duckdns.org/ask";
const askBtn = document.getElementById('mirror-ask-btn');
const askSpin = document.getElementById('ask-spinner');
const askLabel = document.getElementById('ask-label');
const qInput = document.getElementById('mirror-question');
const ansDiv = document.getElementById('mirror-answer');

function fillQuestion(q){ qInput.value=q; qInput.focus(); }

function cleanMirrorResponse(reply){
  if(!reply) return "The Mirror is silent, but the pond remembers your question.";
  // collapse duplicate "Traveler,"
  reply = reply.replace(/^(\s*Traveler[,，]?\s*){2,}/i,'Traveler, ');
  // collapse cadence duplicates
  const cadence = "🪞 🌊 🍃 🌀";
  const cRx = new RegExp(`(?:${cadence.split(" ").join("\\s*")})(?:\\s*(?:${cadence.split(" ").join("\\s*")}))+`,'g');
  reply = reply.replace(cRx, cadence);
  // keep only first Guiding Question
  let seenGQ = false;
  reply = reply.replace(/(?:\*\*\s*)?guiding\s*question\s*[:：]\s*.*$/gim, m => (seenGQ ? '' : (seenGQ = true, m)));
  // normalize whitespace
  reply = reply.replace(/\r\n/g,'\n').replace(/[ \t]+/g,' ').replace(/\n{3,}/g,'\n\n').trim();
  return reply;
}

function parseMirrorResponse(reply){
  const lines = reply.split('\n').filter(Boolean);
  const s = { greeting:'', points:[], guidingQuestion:'', symbols:'', paragraphs:[] };
  let inGreeting=true;
  for(const raw of lines){
    const line = raw.trim();
    if(/^traveler[,，]?/i.test(line)){ s.greeting=line; inGreeting=false; continue; }
    if(/guiding\s*question/i.test(line)){ s.guidingQuestion=line; continue; }
    if(/[🪞🌊🍃🌀]/.test(line) && line.length<=16){ s.symbols=line; continue; }
    if(/\*\*(.*?)\*\*/.test(line)){ s.points.push(line); continue; }
    if(!inGreeting) s.paragraphs.push(line);
  }
  return s;
}

function formatMirrorResponse(question, s){
  let html = `
    <div class="mirror-dialogue">
      <div class="user-question"><strong>You asked:</strong> "${question}"</div>
      <div class="mirror-response">
  `;
  if(s.greeting) html += `<div class="mirror-greeting">${s.greeting}</div>`;
  s.paragraphs.forEach(p=>{ if(!/\*\*(.*?)\*\*/.test(p)) html += `<div class="wisdom-paragraph">${p}</div>`; });
  s.points.forEach(point=>{
    const m = point.match(/\*\*(.*?)\*\*/);
    if(m){
      const title = m[1];
      const content = point.replace(/\*\*(.*?)\*\*/,'').trim();
      html += `<div class="wisdom-point"><strong>${title}</strong>${content}</div>`;
    }else{
      html += `<div class="wisdom-paragraph">${point}</div>`;
    }
  });
  if(s.guidingQuestion) html += `<div class="guiding-question">${s.guidingQuestion.replace(/guiding\s*question\s*[:：]/i,'<strong>Guiding Question:</strong>')}</div>`;
  if(s.symbols) html += `<div class="symbols-line">${s.symbols}</div>`;
  html += `<div class="mirror-signature">🪞 The Mirror has spoken</div></div></div>`;
  return html;
}

function showError(message){ ansDiv.innerHTML = `<div class="error-message">${message}</div>`; }

function showCommunityInvitation(){
  const invitation = document.createElement('div');
  invitation.className = 'wisdom-paragraph';
  invitation.style.textAlign = 'center';
  invitation.innerHTML = `
    <div class="guiding-question" style="font-style:normal">
      🌊 Your question has created ripples in the pond.<br>
      <a href="https://t.me/Toadgang" class="btn btn-dark" style="margin-top:.6rem">Join Toadgang Community → Continue the Journey</a>
    </div>`;
  ansDiv.appendChild(invitation);
}

function setBusy(b){
  if(b){ askBtn.disabled=true; askSpin.style.display='inline-block'; askLabel.textContent='Listening…'; }
  else { askBtn.disabled=false; askSpin.style.display='none'; askLabel.textContent='Seek Wisdom'; }
}

/* ---------- Segmented typewriter (GPU-friendly) ---------- */
async function typewriterEffect(htmlContent){
  return new Promise((resolve)=>{
    const container = document.createElement('div');
    container.className='mirror-dialogue';
    container.style.opacity='0';
    ansDiv.appendChild(container);

    const temp = document.createElement('div');
    temp.innerHTML = htmlContent;

    const dq = temp.querySelector('.mirror-dialogue');
    const userQ = dq.querySelector('.user-question');
    const resp = dq.querySelector('.mirror-response');
    const segments = [userQ, ...resp.children];

    let i=0;
    setTimeout(()=>{ container.style.opacity='1'; }, 40);

    const next=()=>{
      if(i>=segments.length){ resolve(); return; }
      const el = segments[i++];
      const html = el.outerHTML;
      const text = el.textContent || '';

      typewriteSection(container, html, text, pickSpeed(el)).then(()=>{
        if(i<segments.length) setTimeout(next, 140); else resolve();
      });
    };
    next();
  });
}

function pickSpeed(el){
  if(el.classList.contains('guiding-question')) return 35;
  if(el.classList.contains('wisdom-point')) return 25;
  if(el.classList.contains('symbols-line')) return 80;
  if(el.classList.contains('user-question')) return 30;
  return 20;
}

function typewriteSection(container, html, text, speed){
  return new Promise((resolve)=>{
    const shell = document.createElement('div');
    shell.className = html.match(/class="([^"]*)"/)?.[1] || '';
    container.appendChild(shell);

    let n=0;
    (function tick(){
      if(n<text.length){
        const batch = Math.max(1, Math.floor(speed/8));
        shell.textContent = text.slice(0, n += batch);
        shell.scrollIntoView({behavior:'smooth',block:'nearest'});
        requestAnimationFrame(()=> setTimeout(tick, speed/batch));
      }else{
        shell.outerHTML = html; // swap to full HTML formatting
        const dlg = container; if(!dlg.classList.contains('visible')) dlg.classList.add('visible');
        resolve();
      }
    })();
  });
}

/* ---------- Main ask ---------- */
async function askMirror(){
  const question = qInput.value.trim();
  if(!question){ showError("The Mirror awaits your question, traveler..."); return; }
  if(!navigator.onLine){ showError("📶 You’re offline — the pond is resting. I’ll be here when you return."); return; }

  setBusy(true);
  ansDiv.innerHTML = '<div style="text-align:center;padding:1.1rem">🌊 The pond grows still, awaiting reflection...</div>';

  try{
    const res = await fetch(MIRROR_API, {
      method:'POST',
      headers:{ "Content-Type":"application/json", "Accept":"application/json" },
      body: JSON.stringify({ question, user: "web_visitor_" + Date.now() })
    });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();

    let reply = data.answer || data.reply || "The Mirror is silent, but the pond remembers your question.";
    reply = cleanMirrorResponse(reply);

    const s = parseMirrorResponse(reply);
    const html = formatMirrorResponse(question, s);

    ansDiv.innerHTML = '';
    await typewriterEffect(html);

    setTimeout(showCommunityInvitation, 600);
  }catch(err){
    console.error('Mirror error:', err);
    showError("🌀 The waters are unsettled today. The Mirror suggests you try again when the pond grows still.");
  }finally{
    setBusy(false);
    qInput.value=''; if(window.matchMedia('(pointer:fine)').matches) qInput.focus();
  }
}

/* Enter to send */
qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); askMirror(); }});

/* Focus on load (desktop) */
window.addEventListener('load', ()=>{ if(window.matchMedia('(pointer:fine)').matches) qInput.focus(); });
</script>

</body>
</html>
