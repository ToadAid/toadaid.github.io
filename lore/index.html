<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üê∏ Toadgod Lore Library</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  :root{
    --bg:#f7f7f2; --paper:#ffffff; --ink:#222; --muted:#666; --ring:#ddd;
    --shadow:0 2px 6px rgba(0,0,0,.05);
  }
  *{box-sizing:border-box}
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    margin:0; background:var(--bg); color:var(--ink);
  }

  /* Header */
  header{
    position:sticky; top:0; z-index:40;
    background:#fff; border-bottom:1px solid var(--ring);
    display:flex; justify-content:space-between; align-items:center;
    gap:10px; padding:12px 16px;
  }
  header h1{margin:0; font-size:1.15rem; display:flex; align-items:center; gap:.45rem}
  .btn,.pill{
    padding:6px 10px; border:1px solid var(--ring); background:#fff; border-radius:8px;
    cursor:pointer;
  }
  .btn:hover{background:#fafafa}
  .hidden{display:none !important}

  /* Provenance line */
  .provenance{
    text-align:center; font-size:.9rem; color:#555; padding:6px 10px;
    background:#fafafa; border-bottom:1px solid var(--ring);
  }
  .provenance b{color:#2e6d4e}

  /* Resume bar */
  #resumeBar{
    display:none; text-align:center; font-size:.9rem; color:#444; padding:8px 10px;
    background:#f3f7f3; border-bottom:1px solid #dcdcdc;
  }

  /* Layout */
  #main{ display:flex; justify-content:center; gap:16px; padding:12px; }
  #adminInfo{ max-width:240px; width:100%; }
  .search input{width:100%; padding:8px; border:1px solid var(--ring); border-radius:8px}
  #tags{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}

  /* Content column centered */
  #content{
    display:flex; flex-direction:column; align-items:center; gap:14px; width:100%; padding:4px;
  }

  /* Each entry card */
  article.scroll{
    width:100%; max-width:820px; margin:0 auto; background:var(--paper);
    border:1px solid var(--ring); border-radius:12px; box-shadow:var(--shadow);
    overflow:hidden;
  }

  /* Accordion header */
  .acc-header{
    display:flex; align-items:flex-start; gap:10px; width:100%;
    padding:12px 14px; cursor:pointer; background:#fff;
    border-bottom:1px solid #eee;
  }
  .acc-header:hover{background:#fbfbfb}
  .acc-title{flex:1}
  .entry-meta{font-size:.85rem; color:#666}
  .entry-title{margin:.15rem 0; font-size:1.05rem}
  .acc-actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

  /* Accordion body (collapsed by default) */
  .acc-body{display:none; padding:12px 14px}
  .acc-body.open{display:block}
  .twocol{display:flex; gap:14px; flex-wrap:wrap}
  .panel{flex:1; min-width:260px; background:#fafafa; border:1px solid #eee; border-radius:10px; padding:10px}
  .panel h3{margin:0 0 6px 0; font-size:.95rem}

  .chips{margin-top:8px; display:flex; flex-wrap:wrap; gap:6px}
  .chip{font-size:.75rem; padding:2px 8px; border:1px solid #ccc; border-radius:999px; background:#fff}

  /* Bookmark button */
  .bm-btn{border:1px solid #ccc; background:#fff; border-radius:8px; padding:6px 10px; cursor:pointer}
  .bm-btn.active{background:#fffae0; border-color:#e2c75a}

  /* Mobile */
  @media (max-width: 768px){
    article.scroll{width:94%; max-width:100%}
  }

  /* Viewer/admin visibility by body class */
  body.viewer #adminInfo,
  body.viewer #exportBtn { display:none !important; }
  body.admin  #adminInfo,
  body.admin  #exportBtn { display:block !important; }
</style>
</head>

<body class="viewer">

<header>
  <h1>üê∏ Toadgod Lore Library</h1>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <button class="btn" id="toggleComm">Toggle Commentary</button>
    <button class="btn" id="fontPlus">A+</button>
    <button class="btn" id="fontMinus">A-</button>
    <button class="btn" id="toggleBookmarks">Bookmarks</button>
    <button class="btn" id="goLatest">Latest Lore</button>
    <button class="btn" id="enterAdmin">Enter Admin</button>
    <button class="btn hidden" id="exitAdmin">Exit Admin</button>
    <button class="btn hidden" id="exportBtn">Export JSON</button>
  </div>
</header>

<div class="provenance">
  ¬© Toadgod Lore ¬∑ Preserved by <b>ToadAid üê∏</b> ¬∑ Original tweets preserved for study; commentary provided for learning and reflection
</div>

<!-- Resume bar -->
<div id="resumeBar">
  <span id="resumeText"></span>
  <button id="resumeBtn" class="btn" style="margin-left:8px;">Continue</button>
  <button id="dismissResume" class="btn" style="margin-left:6px;">Dismiss</button>
</div>

<main id="main">
  <!-- Admin-only sidebar -->
  <aside id="adminInfo" class="hidden">
    <div class="search">
      <input id="q" placeholder="Search text, tags, dates‚Ä¶">
      <button class="pill" id="clear">Clear</button>
    </div>
    <div id="tags"></div>
  </aside>

  <!-- Content -->
  <section class="content" id="content"></section>
</main>

<footer style="text-align:center;margin:32px 0 20px;color:#777;font-size:.85rem">
  ¬© Toadgod Lore ¬∑ Preserved by <b>ToadAid üê∏</b>
</footer>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
/* ====== Config / State ====== */
const PASSPHRASE="TOADLOCK";
const LS_LAST_ID = "lore:lastId";
const LS_BOOKMARKS = "lore:bookmarks";
let isAdmin=false, showComm=true, fontScale=1;
let showingBookmarks=false;
let DATA=[], BOOKMARKS=new Set();

/* ====== Helpers ====== */
const $=s=>document.querySelector(s);
function md(s){
  const html = marked.parse(s||"");
  const d=document.createElement("div"); d.innerHTML=html;
  d.querySelectorAll("a").forEach(a=>{a.target="_blank";a.rel="noopener"});
  return d.innerHTML || "<p style='color:#999'>‚Äî</p>";
}
function matches(it,q){
  q=q.toLowerCase();
  return (it.title||"").toLowerCase().includes(q)||
         (it.original||"").toLowerCase().includes(q)||
         (it.comment||"").toLowerCase().includes(q)||
         (it.tags||"").toLowerCase().includes(q);
}
function normalizeEntry(x){
  const original = x.original ?? x.tweet_md ?? "";
  const comment  = x.comment  ?? x.commentary_md ?? "";
  const url      = x.url ?? x.tweet_url ?? "";
  const img      = (x.media && x.media.src) ?? x.img ?? "";
  const tagsStr  = Array.isArray(x.tags) ? x.tags.join(", ") : (x.tags || "");
  return { id: x.id || x._raw_id || "", date: x.date || "", title: x.title || "", original, comment, url, img, tags: tagsStr };
}
function toSafeId(v){
  return (v || "").toString().trim().toLowerCase().replace(/[^a-z0-9_-]+/g,"-") || "entry-" + Math.random().toString(36).slice(2,8);
}

/* Strip the first H2 heading so cards align (handles "## üåä Original ..." etc.) */
function stripFirstH2(mdText){
  if(!mdText) return mdText;
  return mdText.replace(/^\s*##\s*[^\n]+\n/, '');
}

/* ====== Storage ====== */
function loadBookmarks(){ try{ BOOKMARKS=new Set(JSON.parse(localStorage.getItem(LS_BOOKMARKS)||"[]")); }catch{ BOOKMARKS=new Set(); } }
function saveBookmarks(){ localStorage.setItem(LS_BOOKMARKS, JSON.stringify([...BOOKMARKS])); }
function isBookmarked(id){ return BOOKMARKS.has(id); }
function toggleBookmark(id){ BOOKMARKS.has(id)?BOOKMARKS.delete(id):BOOKMARKS.add(id); saveBookmarks(); }
function setLastRead(id){ if(id) localStorage.setItem(LS_LAST_ID,id); }
function updateResumeBar(){
  const rb=$("#resumeBar"); const lastId=localStorage.getItem(LS_LAST_ID);
  if(!lastId){ rb.style.display="none"; return; }
  const item = DATA.find(x => toSafeId(x.id || x.title) === lastId);
  if(!item){ rb.style.display="none"; return; }
  $("#resumeText").textContent = `Continue from: ${item.title || lastId}`;
  rb.style.display="block";
  $("#resumeBtn").onclick=()=>{
    const el = document.getElementById(lastId) || document.querySelector(`[data-entry-id="${lastId}"]`);
    if(el){
      const body = el.querySelector(".acc-body");
      if(body && !body.classList.contains("open")) body.classList.add("open");
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }
  };
  $("#dismissResume").onclick=()=>{ localStorage.removeItem(LS_LAST_ID); rb.style.display="none"; };
}

/* ====== Data ====== */
async function loadData(){
  const urls=["data.json","/lore/data.json"];
  let loaded=null;
  for(const u of urls){
    try{
      const r=await fetch(u,{cache:"no-store"});
      if(r.ok){ loaded=await r.json(); break; }
    }catch{}
  }
  if(!Array.isArray(loaded)) loaded=[];
  DATA = loaded.map(normalizeEntry);
}

/* ====== Tags (admin only) ====== */
function renderTags(){
  const box=$("#tags"); box.innerHTML="";
  if(!isAdmin){ $("#adminInfo").classList.add("hidden"); return; }
  const ALL = Array.from(new Set(DATA.flatMap(x=>(x.tags||"").split(",").map(s=>s.trim()).filter(Boolean)))).sort();
  $("#adminInfo").classList.remove("hidden");
  if(!ALL.length) return;
  const any=document.createElement("button"); any.className="pill"; any.textContent="All"; any.onclick=()=>{ $("#q").value=""; paint(); }; box.appendChild(any);
  ALL.forEach(t=>{ const b=document.createElement("button"); b.className="pill"; b.textContent=t; b.onclick=()=>{ $("#q").value=t; paint(); }; box.appendChild(b); });
}

/* ====== Accordion Card ====== */
function card(it,i){
  const safeId = toSafeId(it.id || it.title || ("entry-"+i));

  const art=document.createElement("article"); 
  art.className="scroll"; 
  art.id = safeId; 
  art.setAttribute("data-entry-id", safeId);

  const head=document.createElement("button"); head.type="button"; head.className="acc-header";
  const hLeft=document.createElement("div"); hLeft.className="acc-title";
  hLeft.innerHTML=`<div class="entry-meta">${it.date||""} ${it.url?` ¬∑ <a href="${it.url}" target="_blank" rel="noopener">Original ‚Üó</a>`:""}</div>
                   <div class="entry-title">${it.title||""}</div>`;
  const actions=document.createElement("div"); actions.className="acc-actions";

  const bm=document.createElement("button"); bm.className="bm-btn"; 
  const setBm=()=>{ const on=isBookmarked(safeId); bm.textContent= on?"‚òÖ Bookmarked":"‚òÜ Bookmark"; bm.classList.toggle("active", on); };
  setBm(); bm.onclick=(e)=>{ e.stopPropagation(); toggleBookmark(safeId); setBm(); };
  actions.appendChild(bm);

  /* Admin buttons inline (safeId-based edit/delete) */
  if(isAdmin){
    const ebtn=document.createElement("button"); ebtn.className="btn"; ebtn.textContent="Edit";
    ebtn.onclick=(e)=>{e.stopPropagation(); editEntryBySafeId(safeId);};

    const dbtn=document.createElement("button"); dbtn.className="btn"; dbtn.textContent="Delete";
    dbtn.onclick=(e)=>{e.stopPropagation(); delEntryBySafeId(safeId);};

    const nbtn=document.createElement("button"); nbtn.className="btn";  nbtn.textContent="+ New";
    nbtn.onclick=(e)=>{e.stopPropagation(); openFormNew();};

    actions.append(ebtn,dbtn,nbtn);
  }

  head.append(hLeft,actions);

  const body=document.createElement("div"); body.className="acc-body";
  const grid=document.createElement("div"); grid.className="twocol";
  const left=document.createElement("div"); left.className="panel"; left.innerHTML=`<h3>Original Lore</h3>${md(stripFirstH2(it.original))}`;
  const right=document.createElement("div"); right.className="panel"; right.style.display=showComm?"block":"none"; right.innerHTML=`<h3>Commentary</h3>${md(stripFirstH2(it.comment))}`;
  grid.append(left,right);

  if(it.img){
    const imgPanel=document.createElement("div");
    imgPanel.className="panel";
    imgPanel.innerHTML=`<h3>Image</h3><img src="${it.img}" alt="" style="max-width:100%;border-radius:8px">`;
    grid.append(imgPanel);
  }

  const chips=document.createElement("div"); chips.className="chips";
  (it.tags||"").split(",").map(s=>s.trim()).filter(Boolean).forEach(t=>{ const s=document.createElement("span"); s.className="chip"; s.textContent=t; chips.appendChild(s); });
  body.append(grid, chips);

  head.addEventListener("click", ()=>{
    body.classList.toggle("open");
    setLastRead(safeId);
  });

  const io=new IntersectionObserver((ents)=>{ ents.forEach(en=>{ if(en.isIntersecting){ setLastRead(safeId); io.disconnect(); } }); }, {threshold:0.4});
  io.observe(art);

  art.append(head, body);
  return art;
}

/* ====== Paint ====== */
function paint(){
  const q = $("#q") ? $("#q").value.trim().toLowerCase() : "";
  let list = DATA.slice();
  if (q) list = list.filter(it => matches(it,q));
  if (showingBookmarks) list = list.filter(it => BOOKMARKS.has(toSafeId(it.id || it.title)));

  const box=$("#content"); box.innerHTML="";
  list.forEach((it,i)=> box.appendChild(card(it,i)));

  renderTags();
  updateResumeBar();
}

/* ====== Admin UI ====== */
function enterAdmin(){ const pw=prompt("Enter passphrase:"); if(pw && pw.trim()===PASSPHRASE){isAdmin=true;applyAdmin();} else alert("Incorrect passphrase."); }
function exitAdmin(){ isAdmin=false; applyAdmin(); }
function applyAdmin(){
  document.body.classList.toggle("admin",isAdmin);
  document.body.classList.toggle("viewer",!isAdmin);
  $("#enterAdmin").classList.toggle("hidden",isAdmin);
  $("#exitAdmin").classList.toggle("hidden",!isAdmin);
  $("#exportBtn").classList.toggle("hidden",!isAdmin);
  paint();
}

/* ====== Editor (create + edit) ====== */
let editIdx = null; // index in DATA when editing (null = creating)

function openFormNew(){
  editIdx = null;
  fillForm({
    title:"", date:new Date().toISOString().slice(0,10),
    url:"", img:"", original:"", comment:"", tags:""
  });
  document.getElementById("entryForm").style.display="flex";
  setFormModeLabel("Save");
}
function openFormEdit(idx){
  editIdx = idx;
  const it = DATA[idx] || {};
  fillForm({
    title: it.title || "",
    date: it.date || new Date().toISOString().slice(0,10),
    url: it.url || "",
    img: it.img || "",
    original: it.original || "",
    comment: it.comment || "",
    tags: it.tags || ""
  });
  document.getElementById("entryForm").style.display="flex";
  setFormModeLabel("Update");
}
function closeForm(){ document.getElementById("entryForm").style.display="none"; }

function fillForm(v){
  document.getElementById("f_title").value = v.title || "";
  document.getElementById("f_date").value = v.date || "";
  document.getElementById("f_url").value = v.url || "";
  document.getElementById("f_img").value = v.img || "";
  document.getElementById("f_original").value = v.original || "";
  document.getElementById("f_comment").value = v.comment || "";
  document.getElementById("f_tags").value = v.tags || "";
}
function readForm(){
  return {
    title: document.getElementById("f_title").value.trim(),
    date:  document.getElementById("f_date").value.trim() || new Date().toISOString().slice(0,10),
    url:   document.getElementById("f_url").value.trim(),
    img:   document.getElementById("f_img").value.trim(),
    original: document.getElementById("f_original").value,
    comment:  document.getElementById("f_comment").value,
    tags:  document.getElementById("f_tags").value
  };
}
function setFormModeLabel(text){
  const btn = document.getElementById("saveBtn");
  if(btn) btn.textContent = text || "Save";
}
function saveEntry(){
  const v = readForm();

  if (editIdx === null) {
    // CREATE
    DATA.unshift({
      id: "TOBY_" + Date.now(),
      date: v.date, title: v.title, url: v.url, img: v.img,
      original: v.original, comment: v.comment, tags: v.tags
    });
  } else {
    // UPDATE
    const cur = DATA[editIdx] || {};
    DATA[editIdx] = {
      ...cur,
      date: v.date, title: v.title, url: v.url, img: v.img,
      original: v.original, comment: v.comment, tags: v.tags
    };
  }

  closeForm();
  paint();
}

/* ====== Edit/Delete by safeId (robust under filters) ====== */
function indexBySafeId(safeId){
  return DATA.findIndex(x => toSafeId(x.id || x.title) === safeId);
}
function editEntryBySafeId(safeId){
  const idx = indexBySafeId(safeId);
  if (idx < 0) return alert("Entry not found.");
  openFormEdit(idx);
}
function delEntryBySafeId(safeId){
  const idx = indexBySafeId(safeId);
  if (idx < 0) return alert("Entry not found.");
  if(confirm("Delete this entry?")){ DATA.splice(idx,1); paint(); }
}

/* Backward-compat shims */
function openForm(){ openFormNew(); }
function editEntry(i){ openFormEdit(i); }
function delEntry(i){ if(confirm("Delete this entry?")){ DATA.splice(i,1); paint(); } }

/* ====== Export (stable key order) ====== */
function ordered(it){
  return {
    id: it.id || "",
    date: it.date || "",
    title: it.title || "",
    url: it.url || "",
    img: it.img || "",
    original: it.original || "",
    comment: it.comment || "",
    tags: Array.isArray(it.tags) ? it.tags.join(", ") : (it.tags || "")
  };
}
function exportJSON(){
  try {
    const orderedData = DATA.map(ordered);
    const blob = new Blob([JSON.stringify(orderedData, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "data.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (e) {
    alert("Export failed: " + e);
  }
}

/* ====== Events ====== */
$("#toggleComm").addEventListener("click",()=>{ showComm=!showComm; paint(); });
$("#fontPlus").addEventListener("click",()=>{ fontScale=Math.min(1.4,fontScale+0.05); document.body.style.fontSize=fontScale+"rem"; });
$("#fontMinus").addEventListener("click",()=>{ fontScale=Math.max(0.9,fontScale-0.05); document.body.style.fontSize=fontScale+"rem"; });
$("#toggleBookmarks").addEventListener("click",()=>{
  showingBookmarks=!showingBookmarks;
  $("#toggleBookmarks").textContent = showingBookmarks? "All Entries":"Bookmarks";
  paint();
});
$("#enterAdmin").addEventListener("click",enterAdmin);
$("#exitAdmin").addEventListener("click",exitAdmin);
$("#clear").addEventListener("click",()=>{ if($("#q")) $("#q").value=""; paint(); });
$("#goLatest").addEventListener("click",()=>{
  // Clear filters so last item is visible
  const qEl = document.getElementById("q");
  if (qEl) qEl.value = "";
  showingBookmarks = false;
  const tb = document.getElementById("toggleBookmarks");
  if (tb) tb.textContent = "Bookmarks";
  paint();

  if(DATA.length){
    const latest = DATA[DATA.length-1];
    const id = toSafeId(latest.id || latest.title || "last");
    const el = document.getElementById(id) || document.querySelector(`[data-entry-id="${id}"]`);
    if(el){
      const body = el.querySelector(".acc-body");
      if(body && !body.classList.contains("open")) body.classList.add("open");
      el.scrollIntoView({behavior:"smooth", block:"start"});
      setLastRead(id);
    }
  }
});

/* ====== Boot ====== */
(async()=>{
  await loadData();
  loadBookmarks();
  applyAdmin();   // starts in viewer (clean), then paint
})();
</script>

<!-- Admin entry form -->
<div id="entryForm" style="position:fixed;top:0;left:0;width:100%;height:100%;
     background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:20px;border-radius:12px;max-width:700px;width:100%;box-shadow:0 4px 12px rgba(0,0,0,.25);">
    <h2>New Lore Entry</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
      <input id="f_title" placeholder="Title">
      <input id="f_date" placeholder="Date (YYYY-MM-DD)">
      <input id="f_url" placeholder="Original link (URL)">
      <input id="f_img" placeholder="Image URL">
      <textarea id="f_original" placeholder="Original lore (markdown)" style="grid-column:span 2;height:100px"></textarea>
      <textarea id="f_comment" placeholder="Commentary (markdown)" style="grid-column:span 2;height:80px"></textarea>
      <input id="f_tags" placeholder="Tags (comma separated)" style="grid-column:span 2">
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" id="saveBtn" onclick="saveEntry()">Save</button>
      <button class="btn" onclick="exportJSON()">Export JSON</button>
      <button class="btn" onclick="closeForm()">Cancel</button>
    </div>
  </div>
</div>

</body>
</html>
