<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Toadgod Lore Library</title>
<style>
  :root{
    --bg:#f5f5ef; --paper:#fff; --ink:#222; --muted:#666;
    --ring:rgba(0,0,0,.12);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

  /* Header */
  header{position:sticky;top:0;z-index:20;background:#ffffffcc;backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--ring)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  h1{margin:0;font-size:1.15rem}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .btn,.pill,.badge{border:1px solid var(--ring);background:var(--paper);border-radius:10px;padding:8px 10px;cursor:pointer}
  .badge{font-size:.85rem}
  .badge.viewer{background:#ffeec0}
  .badge.admin{background:#e8ffe8}

  /* Main grid */
  main{display:grid;grid-template-columns:320px 1fr;gap:18px;margin:16px auto;max-width:1200px;padding:0 16px}
  /* Centered single-column for viewer mode */
  main.single{grid-template-columns:1fr;max-width:1040px}
  main.single .toc{grid-column:1/-1;max-width:840px;margin:0 auto}
  main.single .content{grid-column:1/-1;max-width:840px;margin:0 auto}

  /* TOC + Content */
  .toc{background:var(--paper);border:1px solid var(--ring);border-radius:14px;padding:12px}
  .search{display:flex;gap:8px}
  .search input{flex:1;padding:8px;border:1px solid var(--ring);border-radius:8px}
  .content{display:flex;flex-direction:column;gap:18px}

  /* Scroll entry */
  article.scroll{background:var(--paper);border:1px solid var(--ring);border-radius:16px;padding:16px}
  .entry-head{margin-bottom:10px}
  .entry-head h2{margin:.2rem 0;font-size:1.15rem}
  .entry-meta{color:var(--muted);font-size:.9rem}
  .twocol{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:900px){ .twocol{grid-template-columns:42% 58%} }
  .panel{background:#fafafa;border:1px solid var(--ring);border-radius:12px;padding:12px}
  .panel h3{margin:0 0 6px}

  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:10px}
  .chip{font-size:.8rem;border:1px solid var(--ring);border-radius:999px;padding:2px 8px;background:#fff}

  footer{padding:20px;text-align:center;color:#666}
  footer b{color:#355e3b}

  /* Editor modal (simple) */
  #entryForm{position:fixed;inset:50% auto auto 50%;transform:translate(-50%,-50%);z-index:50;width:min(92vw,540px);display:none;flex-direction:column;gap:10px;background:#fff;border:1px solid var(--ring);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  #entryForm label{font-size:.85rem;color:#555}
  #entryForm input,#entryForm textarea{width:100%;padding:8px;border:1px solid var(--ring);border-radius:8px}
  #entryForm textarea{height:100px}
  #markdownHelp{display:none;background:#f9faf9;border:1px solid #dfe7df;border-radius:8px;padding:8px;font-size:.86rem;white-space:pre-wrap}
  .help-toggle{background:none;border:none;color:#b24;font-weight:600;text-align:left;cursor:pointer}
</style>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<header>
  <div class="wrap">
    <h1>üê∏ Toadgod Lore Library</h1>
    <div class="controls">
      <span id="modeBadge" class="badge viewer" title="Click to unlock Admin">üîí Viewer Mode</span>
      <button class="btn" id="toggleComm">Toggle Commentary</button>
      <button class="btn" id="fontPlus">A+</button>
      <button class="btn" id="fontMinus">A-</button>
      <button class="btn" id="exportBtn" style="display:none">Export JSON</button>
      <button class="btn" id="addEntry" style="display:none" style="display:none">+ Add Entry</button>
      <button class="btn" id="enterAdmin">Enter Admin</button>
      <button class="btn" id="exitAdmin" style="display:none">Lock</button>
    </div>
  </div>
</header>

<main id="main">
  <aside class="toc">
    <div class="search">
      <input id="q" placeholder="Search text, tags, dates‚Ä¶">
      <button class="pill" id="clear">Clear</button>
    </div>
    <!-- NEW: tiny banner shows where data came from -->
    <div id="loadStatus" style="margin:8px 0 4px; font-size:.85rem; color:#666;"></div>

    <div id="tags" style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap"></div>
  </aside>

  <section class="content" id="content"></section>
</main>

<!-- Editor Modal -->
<div id="entryForm" style="display:none">
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button class="btn" onclick="exportJSON()">‚¨á Export as data.json</button>
    <button class="btn" onclick="closeForm()">‚úñ Close</button>
  </div>
  <label>ID <input id="fid" placeholder="TOBY_T001 or TOBY_L001"></label>
  <label>Date <input id="fdate" type="date"></label>
  <label>Title <input id="ftitle" placeholder="The First Ripple"></label>
  <label>Original Lore (Markdown) <textarea id="foriginal" placeholder="### Original Tweet (EN)‚Ä¶"></textarea></label>
  <label>Commentary (Markdown) <textarea id="fcomment" placeholder="### ‚ú® Literal Explanation‚Ä¶"></textarea></label>
  <label>Tags (comma) <input id="ftags" placeholder="Identity, People"></label>
  <label>Tweet URL <input id="furl" placeholder="https://x.com/..."></label>
  <label>Image URL <input id="fimg" placeholder="lore-images/L001.jpg"></label>
  <button class="help-toggle" onclick="toggleHelp()">‚ùì Markdown help</button>
  <div id="markdownHelp">
# Heading  ¬∑  **bold**  ¬∑  *italic*
- list item
[Link](https://x.com/)

### ‚ú® Literal Explanation
### üå± Spiritual Interpretation
### üîÆ Symbolic Meaning
  </div>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button class="btn" onclick="saveEntry()">Save</button>
    <button class="btn" onclick="resetForm()">Reset</button>
  </div>
</div>

<footer>
  ¬© Toadgod Lore ¬∑ Preserved by <b>ToadAid</b> üê∏<br/>
  Original tweets preserved for study; commentary provided for learning and reflection.
</footer>

<script>
/* ====== State ====== */
const PASSPHRASE="TOADLOCK";
let isAdmin=false, showComm=true, fontScale=1;
let DATA=[]; let editIdx=null;

/* ====== Helpers ====== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const byId=id=>document.getElementById(id);
const md = s => {
  const html = marked.parse(s||"");
  const div = document.createElement("div"); div.innerHTML=html;
  div.querySelectorAll("a").forEach(a=>{a.target="_blank";a.rel="noopener"}); 
  return div.innerHTML || "<p style='color:#999'>‚Äî</p>";
};
const matches = (it,q)=> JSON.stringify(it).toLowerCase().includes(q);

/* ====== Layout toggles ====== */
function setLayoutMode(){
  const m=$("#main");
  m.classList.toggle("single", !isAdmin); // centered single column for viewer
}
function updateBadge(){
  const b=$("#modeBadge");
  b.className="badge "+(isAdmin?"admin":"viewer");
  b.textContent=isAdmin?"üîë Admin Mode":"üîí Viewer Mode";
  b.title=isAdmin?"Click to lock":"Click to unlock Admin";
}

/* ====== Data load ====== */
async function loadData(){
  // Try relative first (works at /lore/), then absolute fallback
  const urls = ["data.json", "/lore/data.json"];
  let loaded = null, src = "";
  for (const u of urls) {
    try {
      const r = await fetch(u, { cache: "no-store" });
      if (r.ok) { loaded = await r.json(); src = u; break; }
    } catch (e) { /* keep trying next */ }
  }
  if (!Array.isArray(loaded)) { loaded = []; src = "(none)"; }

  // Normalize old/new schemas
  DATA = loaded.map(normalizeEntry);

  // Show banner
  const ls = document.getElementById("loadStatus");
  if (ls) ls.textContent = `Loaded from ${src} (${DATA.length} entr${DATA.length===1?"y":"ies"})`;
}

// Accept both: old (tweet_md/commentary_md) and new (original/comment)
function normalizeEntry(x){
  const original = x.original ?? x.tweet_md ?? "";
  const comment  = x.comment  ?? x.commentary_md ?? "";
  const url      = x.url ?? x.tweet_url ?? "";
  const img      = (x.media && x.media.src) ?? x.img ?? "";
  const tagsStr  = Array.isArray(x.tags) ? x.tags.join(", ") : (x.tags || "");
  return {
    id: x.id || x._raw_id || "",
    date: x.date || "",
    title: x.title || "",
    original,
    comment,
    url,
    img,
    tags: tagsStr
  };
}


/* ====== Render ====== */
function renderTags(){
  const all = Array.from(new Set(DATA.flatMap(x=> (x.tags||"").split(",").map(s=>s.trim()).filter(Boolean)))).sort();
  const box=$("#tags"); box.innerHTML="";
  if(!all.length) return;
  const any=document.createElement("button"); any.className="pill"; any.textContent="All"; any.onclick=()=>{byId("q").value=""; paint();}; box.appendChild(any);
  all.forEach(t=>{
    const b=document.createElement("button"); b.className="pill"; b.textContent=t;
    b.onclick=()=>{byId("q").value=t; paint();};
    box.appendChild(b);
  });
}
function card(it, i){
  const art=document.createElement("article"); art.className="scroll";
  const head=document.createElement("div"); head.className="entry-head";
  head.innerHTML=`<div class="entry-meta">${it.date||""} ${it.url?` ¬∑ <a href="${it.url}" target="_blank" rel="noopener">Original Tweet ‚Üó</a>`:""}</div>
                  <h2>${it.title||""}</h2>`;
  const grid=document.createElement("div"); grid.className="twocol";
  const left=document.createElement("div"); left.className="panel"; left.innerHTML=`<h3>Original Lore</h3>${md(it.original)}`;
  const right=document.createElement("div"); right.className="panel"; right.style.display=showComm?"block":"none";
  right.innerHTML=`<h3>Commentary</h3>${md(it.comment)}`;
  grid.append(left,right); art.append(head,grid);

  const chips=document.createElement("div"); chips.className="chips";
  (it.tags||"").split(",").map(s=>s.trim()).filter(Boolean).forEach(t=>{
    const s=document.createElement("span"); s.className="chip"; s.textContent=t; chips.appendChild(s);
  });
  art.append(chips);

  if(isAdmin){
    const bar=document.createElement("div"); bar.style.marginTop="10px";
    bar.innerHTML=`<button class="btn" onclick="editEntry(${i})">Edit</button>
                   <button class="btn" onclick="delEntry(${i})">Delete</button>`;
    art.append(bar);
  }
  return art;
}
function paint(){
  const q=byId("q").value.trim().toLowerCase();
  const list = q ? DATA.filter(it=>matches(it,q)) : DATA.slice();
  $("#content").innerHTML="";
  list.forEach((it,i)=> $("#content").appendChild(card(it,i)));
  renderTags();
}

/* ====== Admin UI ====== */
function enterAdmin(){
  const pw = prompt("Enter passphrase:");
  if(pw && pw.trim()===PASSPHRASE){ isAdmin=true; applyAdmin(); }
  else alert("Incorrect passphrase.");
}
function exitAdmin(){ isAdmin=false; applyAdmin(); }
function applyAdmin(){
  $("#enterAdmin").style.display = isAdmin?"none":"inline-block";
  $("#exportBtn").style.display = isAdmin?"inline-block":"none";
  $("#addEntry").style.display = isAdmin?"inline-block":"none";
  $("#exitAdmin").style.display  = isAdmin?"inline-block":"none";
  updateBadge(); setLayoutMode(); paint();}

/* ====== Form ====== */
function openForm(){ $("#entryForm").style.display="flex"; }
function closeForm(){ $("#entryForm").style.display="none"; editIdx=null; }
function resetForm(){ ["fid","fdate","ftitle","foriginal","fcomment","ftags","furl","fimg"].forEach(id=>byId(id).value=""); }
function saveEntry(){
  const e={
    id:byId("fid").value, date:byId("fdate").value, title:byId("ftitle").value,
    original:byId("foriginal").value, comment:byId("fcomment").value,
    tags:byId("ftags").value, url:byId("furl").value, img:byId("fimg").value
  };
  if(editIdx!=null) DATA[editIdx]=e; else DATA.push(e);
  closeForm(); paint();
}
function editEntry(i){
  const e=DATA[i]; editIdx=i; openForm();
  byId("fid").value=e.id||""; byId("fdate").value=e.date||""; byId("ftitle").value=e.title||"";
  byId("foriginal").value=e.original||""; byId("fcomment").value=e.comment||"";
  byId("ftags").value=e.tags||""; byId("furl").value=e.url||""; byId("fimg").value=e.img||"";
}
function delEntry(i){ if(confirm("Delete this entry?")){ DATA.splice(i,1); paint(); } }
function exportJSON(){
  const blob=new Blob([JSON.stringify(DATA,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="data.json"; a.click();
}
function toggleHelp(){ const el=byId("markdownHelp"); el.style.display=(el.style.display==="block"?"none":"block"); }

/* ====== Events ====== */
$("#q").addEventListener("input",paint);
$("#clear").addEventListener("click",()=>{byId("q").value="";paint();});
$("#toggleComm").addEventListener("click",()=>{showComm=!showComm; paint();});
$("#fontPlus").addEventListener("click",()=>{fontScale=Math.min(1.4,fontScale+0.05); document.body.style.fontSize=fontScale+"rem";});
$("#fontMinus").addEventListener("click",()=>{fontScale=Math.max(0.9,fontScale-0.05); document.body.style.fontSize=fontScale+"rem";});
$("#modeBadge").addEventListener("click",()=> isAdmin?exitAdmin():enterAdmin());
$("#enterAdmin").addEventListener("click",enterAdmin);
$("#addEntry").addEventListener("click",()=>{ editIdx=null; resetForm(); openForm(); });
$("#exitAdmin").addEventListener("click",exitAdmin);

/* ====== Boot ====== */
(async()=>{ await loadData(); updateBadge(); setLayoutMode(); paint(); })();
</script>
</body>
</html>
