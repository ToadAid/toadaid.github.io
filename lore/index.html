<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üê∏ Toadgod Lore Library</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body{
    font-family: system-ui, sans-serif;
    margin:0; padding:0;
    background:#f7f7f2;
    color:#222;
  }
  header{
    display:flex;justify-content:space-between;align-items:center;
    padding:12px 16px;
    background:#fff;border-bottom:1px solid #ddd;
    position:sticky;top:0;z-index:40;
  }
  header h1{font-size:1.2rem;margin:0;display:flex;align-items:center;gap:6px}
  .btn{padding:6px 10px;border:1px solid #ccc;border-radius:6px;background:#fff;cursor:pointer}
  .pill{padding:4px 10px;border-radius:999px;border:1px solid #ccc;background:#fff;cursor:pointer}
  .hidden{display:none !important}

  /* Layout */
  #main{display:flex;justify-content:center;padding:12px}
  #content{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:18px;
    padding:12px;
    width:100%;
  }
  article.scroll{
    width:100%;
    max-width:820px;
    margin:0 auto;
    background:#fff;
    border:1px solid #ddd;
    border-radius:12px;
    padding:16px;
    box-shadow:0 2px 6px rgba(0,0,0,0.05);
  }
  .entry-head{margin-bottom:8px}
  .entry-meta{font-size:.85rem;color:#666}
  .twocol{display:flex;gap:14px;flex-wrap:wrap}
  .panel{flex:1;min-width:260px}
  .chips{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
  .chip{font-size:.75rem;padding:2px 8px;border:1px solid #ccc;border-radius:999px}

  footer{margin:40px 0;text-align:center;font-size:.8rem;color:#777}

  /* Mobile */
  @media(max-width:768px){
    article.scroll{width:94%;max-width:100%}
  }

  /* Viewer/admin visibility */
  body.viewer #adminInfo,
  body.viewer #exportBtn {display:none !important;}
  body.admin #adminInfo,
  body.admin #exportBtn {display:block !important;}
</style>
</head>

<body class="viewer">

<header>
  <h1>üê∏ Toadgod Lore Library</h1>
  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn" id="toggleComm">Toggle Commentary</button>
    <button class="btn" id="fontPlus">A+</button>
    <button class="btn" id="fontMinus">A-</button>
    <button class="btn" id="enterAdmin">Enter Admin</button>
    <button class="btn hidden" id="exitAdmin">Exit Admin</button>
    <button class="btn hidden" id="exportBtn">Export JSON</button>
  </div>
  
<main id="main">
  <aside id="adminInfo" class="hidden" style="max-width:240px;margin-right:14px">
    <div class="search">
      <input id="q" placeholder="Search text, tags, dates‚Ä¶" style="width:100%;margin-bottom:6px">
      <button class="pill" id="clear">Clear</button>
    </div>
    <div id="tags" style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap"></div>
  </aside>

  <section class="content" id="content"></section>
</main>

<footer>
  ¬© Toadgod Lore ¬∑ Preserved by <b>ToadAid üê∏</b><br>
  Original tweets preserved for study; commentary provided for learning and reflection.
</footer>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
const PASSPHRASE="TOADLOCK";
let DATA=[]; let isAdmin=false; let editIdx=null; let showComm=true; let fontScale=1;

/* ====== Helpers ====== */
const $=sel=>document.querySelector(sel);
function md(txt){return marked.parse(txt||"");}
function matches(it,q){
  q=q.toLowerCase();
  return (it.title||"").toLowerCase().includes(q)||
         (it.original||"").toLowerCase().includes(q)||
         (it.comment||"").toLowerCase().includes(q)||
         (it.tags||"").toLowerCase().includes(q);
}

/* ====== Load data.json ====== */
async function loadData(){
  try{
    const res=await fetch("data.json");
    if(res.ok) DATA=await res.json();
  }catch(e){ console.log("No data.json found"); }
}

/* ====== Render ====== */
function renderTags(){
  const wrapper=$("#adminInfo");
  const box=$("#tags");
  box.innerHTML="";
  if(!isAdmin){wrapper.classList.add("hidden");return;}
  const ALL_TAGS=Array.from(new Set(
    DATA.flatMap(x=>(x.tags||"").split(",").map(s=>s.trim()).filter(Boolean))
  )).sort();
  wrapper.classList.remove("hidden");
  if(!ALL_TAGS.length) return;
  const any=document.createElement("button");
  any.className="pill"; any.textContent="All";
  any.onclick=()=>{ $("#q").value=""; paint(); };
  box.appendChild(any);
  ALL_TAGS.forEach(t=>{
    const b=document.createElement("button");
    b.className="pill"; b.textContent=t;
    b.onclick=()=>{ $("#q").value=t; paint(); };
    box.appendChild(b);
  });
}

function card(it,i){
  const art=document.createElement("article"); art.className="scroll";
  const head=document.createElement("div"); head.className="entry-head";
  head.innerHTML=`<div class="entry-meta">${it.date||""} ${it.url?` ¬∑ <a href="${it.url}" target="_blank">Original Tweet ‚Üó</a>`:""}</div>
                  <h2>${it.title||""}</h2>`;
  const grid=document.createElement("div"); grid.className="twocol";
  const left=document.createElement("div"); left.className="panel"; left.innerHTML=`<h3>Original Lore</h3>${md(it.original)}`;
  const right=document.createElement("div"); right.className="panel"; right.style.display=showComm?"block":"none";
  right.innerHTML=`<h3>Commentary</h3>${md(it.comment)}`;
  grid.append(left,right); art.append(head,grid);

  const chips=document.createElement("div"); chips.className="chips";
  (it.tags||"").split(",").map(s=>s.trim()).filter(Boolean).forEach(t=>{
    const s=document.createElement("span"); s.className="chip"; s.textContent=t; chips.appendChild(s);
  });
  art.append(chips);

  if(isAdmin){
    const bar=document.createElement("div"); bar.style.marginTop="10px";
    bar.innerHTML=`<button class="btn" onclick="editEntry(${i})">Edit</button>
                   <button class="btn" onclick="delEntry(${i})">Delete</button>
                   <button class="btn" onclick="openForm()">+ New</button>`;
    art.append(bar);
  }
  return art;
}

function paint(){
  const q=$("#q")?$("#q").value.trim().toLowerCase():"";
  const list=q?DATA.filter(it=>matches(it,q)):DATA.slice();
  $("#content").innerHTML="";
  list.forEach((it,i)=> $("#content").appendChild(card(it,i)));
}

/* ====== Admin UI ====== */
function enterAdmin(){
  const pw=prompt("Enter passphrase:");
  if(pw && pw.trim()===PASSPHRASE){isAdmin=true;applyAdmin();}
  else alert("Incorrect passphrase.");
}
function exitAdmin(){isAdmin=false;applyAdmin();}
function applyAdmin(){
  document.body.classList.toggle("admin",isAdmin);
  document.body.classList.toggle("viewer",!isAdmin);
  $("#enterAdmin").classList.toggle("hidden",isAdmin);
  $("#exitAdmin").classList.toggle("hidden",!isAdmin);
  $("#exportBtn").classList.toggle("hidden",!isAdmin);
  renderTags(); paint();
}

/* ====== Form ====== */
function openForm(){resetForm();document.getElementById("entryForm").style.display="flex";}
function closeForm(){document.getElementById("entryForm").style.display="none";editIdx=null;}
function resetForm(){["fid","fdate","ftitle","foriginal","fcomment","ftags","furl","fimg"].forEach(id=>document.getElementById(id).value="");}
function saveEntry(){
  const e={id:fid.value,date:fdate.value,title:ftitle.value,
    original:foriginal.value,comment:fcomment.value,tags:ftags.value,
    url:furl.value,img:fimg.value};
  if(editIdx!=null)DATA[editIdx]=e;else DATA.push(e);
  closeForm();paint();
}
function editEntry(i){
  const e=DATA[i];editIdx=i;document.getElementById("entryForm").style.display="flex";
  fid.value=e.id||"";fdate.value=e.date||"";ftitle.value=e.title||"";
  foriginal.value=e.original||"";fcomment.value=e.comment||"";
  ftags.value=e.tags||"";furl.value=e.url||"";fimg.value=e.img||"";
}
function delEntry(i){if(confirm("Delete this entry?")){DATA.splice(i,1);paint();}}
function exportJSON(){
  const blob=new Blob([JSON.stringify(DATA,null,2)],{type:"application/json"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="data.json";a.click();
}

/* ====== Events ====== */
$("#clear").addEventListener("click",()=>{$("#q").value="";paint();});
$("#toggleComm").addEventListener("click",()=>{showComm=!showComm;paint();});
$("#fontPlus").addEventListener("click",()=>{fontScale=Math.min(1.4,fontScale+0.05);document.body.style.fontSize=fontScale+"rem";});
$("#fontMinus").addEventListener("click",()=>{fontScale=Math.max(0.9,fontScale-0.05);document.body.style.fontSize=fontScale+"rem";});
$("#enterAdmin").addEventListener("click",enterAdmin);
$("#exitAdmin").addEventListener("click",exitAdmin);

/* ====== Boot ====== */
(async()=>{ await loadData(); applyAdmin(); })();
</script>

<!-- Editor Modal -->
<div id="entryForm" class="hidden" style="position:fixed;inset:50% auto auto 50%;transform:translate(-50%,-50%);z-index:50;width:min(92vw,540px);display:none;flex-direction:column;gap:10px;background:#fff;border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)">
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button class="btn" onclick="exportJSON()">‚¨á Export as data.json</button>
    <button class="btn" onclick="closeForm()">‚úñ Close</button>
  </div>
  <label>ID <input id="fid" placeholder="TOBY_T001 or TOBY_L001"></label>
  <label>Date <input id="fdate" type="date"></label>
  <label>Title <input id="ftitle" placeholder="The First Ripple"></label>
  <label>Original Lore (Markdown) <textarea id="foriginal"></textarea></label>
  <label>Commentary (Markdown) <textarea id="fcomment"></textarea></label>
  <label>Tags (comma) <input id="ftags" placeholder="Identity, People"></label>
  <label>Tweet URL <input id="furl" placeholder="https://x.com/..."></label>
  <label>Image URL <input id="fimg" placeholder="lore-images/L001.jpg"></label>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
    <button class="btn" onclick="saveEntry()">Save</button>
    <button class="btn" onclick="resetForm()">Reset</button>
  </div>
</div>

</body>
</html>
