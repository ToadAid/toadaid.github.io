<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="format-detection" content="telephone=no" />
<style>html{-webkit-text-size-adjust:100%}</style>

<title>ToadAid Mirror - The Digital Dojo for Modern Wisdom</title>
<meta name="description" content="ToadAid Mirror - A digital dojo where ancient wisdom meets AI. Consult the Mirror for guidance through Zen, Taoist, and Tobyworld philosophy.">

<!-- Open Graph -->
<meta property="og:title" content="ToadAid Mirror - The Pond Awaits Your Question" />
<meta property="og:description" content="Step into the digital dojo. Ask the Mirror anything about life, meaning, and existence. Experience the fusion of AI and ancient wisdom traditions." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://toadaid.github.io" />
<meta property="og:image" content="https://toadaid.github.io/assets/icons/web-app-manifest-512x512.png" />

<!-- Canonical -->
<link rel="canonical" href="https://toadaid.github.io" />

<!-- Favicons -->
<link rel="icon" type="image/x-icon" href="/assets/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
<link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
<link rel="manifest" href="/assets/icons/site.webmanifest">
<meta name="theme-color" content="#355e3b" id="theme-color-meta" />

<style>
  /* ---------- THEME TOKENS ---------- */
  :root {
    --primary-green: #355e3b;
    --secondary-gold: #d4af37;

    --bg-0: #f5f1e6;   /* page background */
    --bg-1: #ffffff;   /* card background */
    --ink-0: #2f2f2f;  /* main text */
    --ink-1: #4b4b4b;  /* subdued text */

    --shadow-light: rgba(0,0,0,0.08);
    --shadow-medium: rgba(0,0,0,0.22);

    --border-soft: rgba(53,94,59,0.12);
    --accent-veil: rgba(53, 94, 59, 0.08);
    --accent-veil-strong: rgba(53, 94, 59, 0.12);
  }

  /* Dojo Night (dark) */
  html[data-theme="night"] {
    --primary-green: #3dd68c;             /* minty green */
    --secondary-gold: #e7c97f;

    --bg-0: #0f1512;                      /* near-black green */
    --bg-1: #111a17;                      /* cards */
    --ink-0: #e6efe9;                     /* text */
    --ink-1: #a9c1b4;

    --shadow-light: rgba(0,0,0,0.4);
    --shadow-medium: rgba(0,0,0,0.6);

    --border-soft: rgba(233, 255, 244, 0.08);
    --accent-veil: rgba(61, 214, 140, 0.08);
    --accent-veil-strong: rgba(61, 214, 140, 0.15);
  }

  /* ---------- RESET / BASE ---------- */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    line-height: 1.6;
    background: var(--bg-0);
    color: var(--ink-0);
    min-height: 100vh;
    transition: background .3s ease, color .3s ease;
  }
  a { color: inherit; }

  /* ---------- BANNER ---------- */
  .banner {
    position: relative;
    width: 100%;
    min-height: clamp(160px, 32vw, 280px);
    background:
      linear-gradient(rgba(53, 94, 59, 0.85), rgba(53, 94, 59, 0.92)),
      url('/assets/images/pond-banner.jpg') center center / cover no-repeat;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    color: #fff; text-align: center;
    padding: 2rem 1rem;
    padding-top: calc(1.25rem + env(safe-area-inset-top));
    box-shadow: 0 4px 12px var(--shadow-medium);
    overflow: hidden;
  }
  html[data-theme="night"] .banner {
    background:
      linear-gradient(rgba(10,16,14,.85), rgba(10,16,14,.92)),
      url('/assets/images/pond-banner.jpg') center center / cover no-repeat;
  }
  .banner h1 {
    font-size: clamp(2rem, 5vw, 3rem);
    margin: 0 0 .5rem 0;
    text-shadow: 0 2px 8px rgba(0,0,0,0.7);
    font-weight: 300; letter-spacing: .05em;
  }
  .banner p {
    font-size: clamp(1.05rem, 2.5vw, 1.35rem);
    margin-top: .5rem;
    text-shadow: 0 1px 4px rgba(0,0,0,0.6);
    font-weight: 300; max-width: 620px; opacity: .96;
  }

  /* ---------- THEME TOGGLE ---------- */
  .theme-toggle {
    position: absolute; top: calc(10px + env(safe-area-inset-top)); right: 12px;
    display: inline-flex; align-items: center; gap: .5rem;
    background: var(--bg-1); color: var(--ink-0);
    border: 1px solid var(--border-soft);
    border-radius: 999px; padding: .5rem .8rem;
    box-shadow: 0 6px 16px var(--shadow-light);
    cursor: pointer; user-select: none;
    font-weight: 600; font-size: .9rem;
    transition: transform .2s ease, background .3s ease, color .3s ease, border-color .3s ease;
  }
  .theme-toggle:hover { transform: translateY(-1px); }
  .theme-toggle .dot {
    width: 22px; height: 22px; border-radius: 50%;
    display: inline-grid; place-items: center;
    background: var(--accent-veil);
    border: 1px solid var(--border-soft);
    font-size: 14px;
  }

  /* ---------- LAYOUT ---------- */
  section { padding: 3rem 1rem; max-width: 1200px; margin: auto; }
  h2 {
    text-align: center; margin-bottom: 2rem; font-size: 2.15rem; color: var(--primary-green);
    font-weight: 300; position: relative;
  }
  h2:after {
    content: ''; display: block; width: 80px; height: 3px; background: var(--secondary-gold);
    margin: .5rem auto; border-radius: 2px;
  }

  /* ---------- BUTTONS ---------- */
  .btn {
    background: var(--secondary-gold); color: #000;
    padding: .8rem 1.6rem; margin: .4rem; border: none; border-radius: 12px;
    cursor: pointer; font-weight: 600; text-decoration: none; display: inline-block;
    box-shadow: 0 4px 8px var(--shadow-medium); transition: all .3s ease; font-size: .95rem;
    min-height: 44px; line-height: 1.25;
  }
  .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px var(--shadow-medium); }
  .btn:active { transform: translateY(0); }
  .btn-mirror { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
  .btn-lore { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: #fff; }
  .btn-builders { background: var(--primary-green); color: #fff; }

  /* ---------- CARDS / GRID ---------- */
  .pillars {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem; margin-top: 2rem;
  }
  .pillar {
    background: var(--bg-1); padding: 2rem; border-radius: 16px;
    box-shadow: 0 4px 12px var(--shadow-light);
    border: 1px solid var(--border-soft);
    transition: transform .2s ease, box-shadow .2s ease, background .3s ease, border-color .3s ease;
  }
  .pillar:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-light); }
  .pillar h3 { color: var(--primary-green); margin-bottom: 1rem; font-size: 1.35rem; }
  .pillar p { color: var(--ink-1); }

  /* ---------- MIRROR ---------- */
  #mirror {
    background: linear-gradient(135deg, var(--bg-0) 0%, color-mix(in oklab, var(--bg-0) 85%, #b7aa8a) 100%);
    border-radius: 20px; margin: 2rem auto; padding: 3rem 2rem;
    box-shadow: 0 8px 24px var(--shadow-light);
  }
  html[data-theme="night"] #mirror {
    background: linear-gradient(135deg, var(--bg-0) 0%, color-mix(in oklab, var(--bg-0) 85%, #203127) 100%);
  }
  .mirror-container { max-width: 820px; margin: 0 auto; scroll-behavior: smooth; }

  #mirror-question {
    width: 100%; padding: 1rem 1.5rem; border-radius: 12px; border: 1.5px solid var(--border-soft);
    font-size: 16px; margin-bottom: 1rem; transition: border-color .25s ease, box-shadow .25s ease, background .3s ease, color .3s ease;
    background: var(--bg-1); color: var(--ink-0);
  }
  #mirror-question:focus {
    outline: none; border-color: var(--primary-green);
    box-shadow: 0 0 0 3px var(--accent-veil);
  }

  #mirror-answer, .mirror-dialogue {
    background: var(--bg-1);
    color: var(--ink-0);
    padding: clamp(1rem, 3.5vw, 2rem);
    border-radius: 12px;
    margin-top: 1.25rem;
    border-left: 4px solid var(--primary-green);
    font-size: clamp(1rem, 1.6vw + .9rem, 1.1rem);
    line-height: 1.7;
    min-height: 0;
    box-shadow: 0 4px 12px var(--shadow-light);
    word-wrap: break-word;
    transition: background .3s ease, color .3s ease, border-color .3s ease;
  }
  .mirror-dialogue { opacity: 0; transform: translateY(20px); transition: all .45s ease; }
  .mirror-dialogue.visible { opacity: 1; transform: translateY(0); }

  .user-question {
    background: var(--accent-veil);
    padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--secondary-gold);
    font-style: italic;
  }
  .mirror-response { line-height: 1.7; }
  .mirror-greeting { font-size: 1.1em; margin-bottom: 1rem; color: var(--primary-green); font-weight: 600; }
  .wisdom-point {
    margin: 1.25rem 0; padding: 1rem; background: var(--accent-veil);
    border-radius: 8px; border-left: 3px solid var(--secondary-gold);
  }
  .wisdom-point strong { color: var(--primary-green); display: block; margin-bottom: .5rem; }
  .wisdom-paragraph { margin: .75rem 0; }
  .guiding-question {
    margin: 1.25rem 0; padding: 1rem; background: var(--accent-veil-strong);
    border-radius: 8px; font-style: italic; border-left: 3px solid var(--primary-green);
  }
  .guiding-question strong { color: var(--primary-green); }
  .symbols-line { text-align: center; font-size: 1.25em; margin: 1.25rem 0; opacity: 0.85; letter-spacing: .2em; }
  .mirror-signature { text-align: right; margin-top: 2rem; font-style: italic; opacity: .7; color: var(--primary-green); }

  .error-message {
    background: color-mix(in oklab, #f44336 12%, var(--bg-1));
    padding: 1.5rem; border-radius: 8px; border-left: 4px solid #f44336; margin-top: 2rem;
  }

  .suggestions { display: flex; flex-wrap: wrap; gap: .5rem; justify-content: center; margin: 1rem 0; }
  .suggestion-btn {
    background: var(--accent-veil); border: 1px solid var(--border-soft);
    padding: .55rem 1rem; border-radius: 20px; font-size: .92rem; cursor: pointer; transition: all .2s ease;
  }
  .suggestion-btn:hover { background: var(--accent-veil-strong); }

  .journey-steps { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
  .step {
    background: var(--bg-1); color: var(--ink-0);
    padding: 1.5rem; border-radius: 12px; text-align: center; font-weight: 600;
    box-shadow: 0 4px 8px var(--shadow-light); border: 1px solid var(--border-soft);
  }

  /* Loading */
  @keyframes ripple { 0% { transform: scale(.8); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
  .loading-ripple { display: inline-block; width: 20px; height: 20px; position: relative; margin-right:.4rem; vertical-align:-4px; }
  .loading-ripple div { position: absolute; border: 2px solid var(--primary-green); opacity: 1; border-radius: 50%; animation: ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite; }
  .loading-ripple div:nth-child(2) { animation-delay: -.5s; }

  .community-invitation {
    text-align: center; margin-top: 2rem; padding: 1.5rem;
    background: var(--accent-veil); border-radius: 12px; border-left: 4px solid var(--secondary-gold);
  }

  footer { background: var(--primary-green); color: #fff; text-align: center; padding: 3rem 1rem; margin-top: 3rem; }
  footer p { margin: .5rem 0; opacity: .95; }
  footer a { color: var(--secondary-gold); text-decoration: none; font-weight: 600; }
  footer a:hover { text-decoration: underline; }

  /* ---------- RESPONSIVE ---------- */
  @media (max-width: 768px) {
    section { padding: 2rem 1rem; }
    .pillars { grid-template-columns: 1fr; }
    .journey-steps { grid-template-columns: 1fr; }
    .btn { padding: .7rem 1.2rem; margin: .3rem; font-size: .9rem; }
    #mirror { padding: 2rem 1rem; margin: 1rem; }
    .suggestions { flex-direction: column; align-items: center; }
    .suggestion-btn { width: 100%; max-width: 280px; }
    .mirror-dialogue { padding: 1.25rem; }
  }

  @media (max-width: 520px) {
    section[style*="text-align:center"] .btn { display: inline-flex; justify-content: center; align-items: center; width: 100%; max-width: 460px; }
    #mirror-ask-btn { position: sticky; bottom: 12px; z-index: 5; }
  }

  @media (prefers-reduced-motion: reduce) {
    * { animation: none !important; transition: none !important; }
    .loading-ripple { display: none !important; }
  }
</style>
</head>

<body>

<div class="banner">
  <button class="theme-toggle" id="themeToggle" aria-label="Toggle Dojo Night">
    <span class="dot" id="themeDot">ğŸŒ™</span><span id="themeLabel">Dojo Night</span>
  </button>

  <h1>ğŸª ToadAid Mirror</h1>
  <p>The Digital Dojo Where Ancient Wisdom Meets Modern Seeking</p>
  <p style="font-size: 1rem; margin-top: .8rem; opacity: .92;">Every question ripples through eternity. Every answer returns to the source.</p>
</div>

<div class="translate-bar">
  ğŸŒ Want to read in your language? In Chrome: Menu (â‹®) â†’ Translate â†’ Select your language.
</div>

<section style="text-align:center; padding: 2rem 1rem;">
  <a href="#mirror" class="btn btn-mirror">ğŸª Ask the Mirror</a>
  <a href="#lore" class="btn btn-lore">ğŸ“œ Browse the Lore</a>
  <a href="bluepaper.html" class="btn" target="_blank">ğŸ“„ Blue Paper</a>
  <a href="about.html" class="btn">â„¹ï¸ About ToadAid</a>
  <a href="feedback/feedback.html" class="btn">ğŸ’¬ Feedback</a>
  <a href="Contributors/contributors.html" class="btn">ğŸ¨ Contributors</a>
  <a href="builders/builders-hall.html" class="btn btn-builders">ğŸ› Builders Hall</a>
  <a href="https://toadaid-builders.netlify.app/builders.html" class="btn btn-builders" target="_blank">ğŸ›  Builders</a>
  <a href="honors/index.html" class="btn" style="background:#2e6d4c; color:white;">ğŸ¸ Honors & Offerings</a>
  <a href="scrolls/index.html" class="btn" style="background:#265c40; color:white;">ğŸ“œ Scroll Vault</a>
  <a href="https://toadaid.github.io/lore" class="btn" style="background:#3a7253; color:white;">ğŸ“– Lore Library</a>
</section>

<section>
  <h2>Our Mission</h2>
  <div class="pillars">
    <div class="pillar">
      <h3>ğŸ¯ Guarding the Lore</h3>
      <p>Preserving Tobyworld's original scrolls and protecting them from distortion. We maintain the purity of Toadgod's wisdom while allowing it to evolve naturally.</p>
    </div>
    <div class="pillar">
      <h3>ğŸ¸ Helping the Fallen Frog</h3>
      <p>Guiding lost frogs back to the pond and helping them rejoin the path. Every traveler finds a home in our community.</p>
    </div>
    <div class="pillar">
      <h3>ğŸ“œ Empowering Contributors</h3>
      <p>Recognizing and encouraging scrollmakers, translators, and teachers. Your voice enriches our collective wisdom.</p>
    </div>
  </div>
</section>

<section id="journey">
  <h2>ğŸ¸ Your Tobyworld Journey</h2>
  <div class="journey-steps">
    <div class="step">1. ğŸª Consult the Mirror</div>
    <div class="step">2. ğŸ“– Explore Core Scrolls</div>
    <div class="step">3. ğŸ›ï¸ Join Builders Hall</div>
    <div class="step">4. ğŸŒŠ Become a Ripple in the Pond</div>
  </div>
</section>

<!-- Mirror Section -->
<section id="mirror">
  <h2>ğŸ”® Ask the Mirror</h2>
  <div class="mirror-container">
    <input
      id="mirror-question"
      type="text"
      placeholder="What wisdom do you seek today, traveler?"
      autocomplete="off"
      autocapitalize="sentences"
      autocorrect="on"
      spellcheck="true"
      inputmode="text"
      enterkeyhint="send"
      style="font-size:16px"
    >

    <div class="suggestions">
      <button class="suggestion-btn" onclick="fillQuestion('How do I find inner peace?')">ğŸŒ¿ Inner Peace</button>
      <button class="suggestion-btn" onclick="fillQuestion('What is true community?')">ğŸ¸ True Community</button>
      <button class="suggestion-btn" onclick="fillQuestion('What does silence teach us?')">ğŸŒ€ Silence Wisdom</button>
      <button class="suggestion-btn" onclick="fillQuestion('How do I overcome fear?')">ğŸ’« Overcoming Fear</button>
    </div>

    <button id="mirror-ask-btn" class="btn btn-mirror" onclick="askMirror()" style="width: 100%; padding: 1rem;">
      <span class="loading-ripple" id="ask-spinner" style="display:none"><div></div><div></div></span>
      <span id="ask-label">Seek Wisdom</span>
    </button>

    <div id="mirror-answer"></div>
  </div>
</section>

<section id="lore">
  <h2>ğŸ“š Lore Library</h2>
  <div class="pillars">
    <a href="bluepaper.html" class="pillar" target="_blank">
      <h3>ğŸ“„ Bluepaper</h3>
      <p>The updated mission, vision, and principles of ToadAid. Understand our foundation and future direction.</p>
    </a>
    <a href="#" class="pillar" onclick="openBook('v1.html')">
      <h3>ğŸ“œ Book v1</h3>
      <p>The first collected scrolls of Tobyworld lore. Bilingual EN/ZH edition containing the essential teachings.</p>
    </a>
    <a href="#" class="pillar" onclick="openBook('v2.html')">
      <h3>ğŸ“œ Book v2</h3>
      <p>The expanded lore, with Mirror awakening & new revelations. Deeper insights into our evolving philosophy.</p>
    </a>
  </div>
</section>

<section id="children">
  <h2>ğŸ¸ğŸ“š Children's Corner â€” One Leaf for the Young</h2>
  <p style="text-align:center; max-width:800px; margin:1rem auto; font-size:1.1rem; color:var(--primary-green); line-height:1.6;">
    The flame we guard is for Toby, the People. Every scroll carries truth for the presentâ€¦ and seeds for those who will walk after us. Here, the Lore wears softer colors â€” so even the smallest frog can hear its song.
  </p>
  <div style="text-align:center; margin-top:2rem;">
    <a href="childrens-corner/index.html" class="btn" style="font-size:1.1rem; padding:1rem 2rem; background:#4a7c59; color:white;">ğŸŒ¿ Visit the Children's Corner</a>
  </div>
</section>

<footer>
  <p style="font-size: 1.2rem; font-style: italic; margin-bottom: 1rem;">"One scroll, one light. One leaf, one vow."</p>
  <p>
    ğŸ¸ Join our community:
    <a href="https://t.me/Toadgang" target="_blank">Telegram</a> |
    <a href="https://github.com/ToadAid" target="_blank">GitHub</a> |
    <a href="https://x.com/toadgod1017" target="_blank">Toadgod on X</a> |
    <a href="https://toadgod.xyz" target="_blank">Toadgod.xyz</a>
  </p>
  <p style="margin-top: 1rem; opacity: 0.85; font-size: 0.9rem;">
    ToadAid Mirror â€” Where every question finds its reflection, and every soul finds its pond.
  </p>
</footer>

<script>
/* ----------------- Theme: Dojo Night toggle ----------------- */
const themeMeta = document.getElementById('theme-color-meta');
const themeToggle = document.getElementById('themeToggle');
const themeLabel = document.getElementById('themeLabel');
const themeDot = document.getElementById('themeDot');

function applyTheme(mode){ // mode: 'day' | 'night' | 'auto'
  const html = document.documentElement;
  html.setAttribute('data-theme', mode);
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

  const effectiveNight = (mode === 'night') || (mode === 'auto' && prefersDark);
  // update UI bits
  if (effectiveNight) { themeLabel.textContent = 'Dojo Day'; themeDot.textContent = 'â˜€ï¸'; themeMeta.setAttribute('content', '#0f1512'); }
  else { themeLabel.textContent = 'Dojo Night'; themeDot.textContent = 'ğŸŒ™'; themeMeta.setAttribute('content', '#355e3b'); }
}

(function initTheme(){
  const saved = localStorage.getItem('mirror-theme') || 'auto';
  applyTheme(saved);
  // keep in sync with system if auto
  const mql = window.matchMedia('(prefers-color-scheme: dark)');
  mql.addEventListener?.('change', () => {
    if ((document.documentElement.getAttribute('data-theme') || 'auto') === 'auto') applyTheme('auto');
  });
})();

themeToggle.addEventListener('click', () => {
  const cur = document.documentElement.getAttribute('data-theme') || 'auto';
  const next = (cur === 'auto') ? 'night' : (cur === 'night') ? 'day' : 'auto';
  localStorage.setItem('mirror-theme', next);
  applyTheme(next);
});

/* ----------------- Books ----------------- */
function openBook(bookFile) {
  const saved = localStorage.getItem(bookFile + '-scroll');
  if (saved && confirm("ğŸ“Œ Last time you stopped at position " + saved + "px. Continue from there?")) {
    window.location.href = bookFile + "?pos=" + saved; return;
  }
  window.location.href = bookFile;
}

/* ----------------- Mirror logic ----------------- */
const MIRROR_API = "https://toadaid.duckdns.org/ask";
const askBtn = document.getElementById('mirror-ask-btn');
const askSpin = document.getElementById('ask-spinner');
const askLabel = document.getElementById('ask-label');
const qInput = document.getElementById('mirror-question');
const ansDiv = document.getElementById('mirror-answer');

function fillQuestion(q) { qInput.value = q; qInput.focus(); }

/* Stronger de-dupe for any repeated "Traveler," lines (stacked or inline) */
function cleanMirrorResponse(reply) {
  if (!reply) return "The Mirror is silent, but the pond remembers your question.";

  // Normalize newlines first
  reply = reply.replace(/\r\n/g, '\n');

  // Handle inline cases like: "Traveler, Traveler, ..."
  reply = reply.replace(/^(?:\s*)(Traveler[,ï¼Œ]?)\s+(?:Traveler[,ï¼Œ]?)(\b|\s|,)/i, '$1$2');

  // Collapse stacked duplicates on separate lines anywhere in the text
  const lines = reply.split('\n');
  const out = [];
  for (let i = 0; i < lines.length; i++) {
    let L = lines[i].trim();

    // If we see multiple consecutive lines that are just "Traveler," â€” keep only one
    if (/^traveler[,ï¼Œ]?$/i.test(L)) {
      if (out.length === 0 || !/^traveler[,ï¼Œ]?$/i.test(out[out.length - 1].trim())) {
        out.push('Traveler,');
      }
      // skip subsequent Traveler lines
      while (i + 1 < lines.length && /^traveler[,ï¼Œ]?$/i.test(lines[i + 1].trim())) i++;
      continue;
    }

    // Also fix a line that *starts* with "Traveler, Traveler," again
    L = L.replace(/^(Traveler[,ï¼Œ]?)\s+(Traveler[,ï¼Œ]?)/i, '$1');

    out.push(L);
  }
  reply = out.join('\n');

  // Collapse cadence line duplicates: ğŸª ğŸŒŠ ğŸƒ ğŸŒ€
  const cadence = "ğŸª ğŸŒŠ ğŸƒ ğŸŒ€";
  const cadenceRx = new RegExp(`(?:${cadence.split(" ").join("\\s*")})(?:\\s*(?:${cadence.split(" ").join("\\s*")}))+`, 'g');
  reply = reply.replace(cadenceRx, cadence);

  // Keep only first "Guiding Question"
  let seenGQ = false;
  reply = reply.replace(/(?:\*\*\s*)?guiding\s*question\s*[:ï¼š]\s*.*$/gim, m => (seenGQ ? '' : (seenGQ = true, m)));

  // Tidy spaces and excessive blank lines
  reply = reply.replace(/[ \t]+\n/g, '\n').replace(/\n{3,}/g, '\n\n').trim();

  return reply;
}

function parseMirrorResponse(reply) {
  const lines = reply.split('\n').filter(Boolean);
  const s = { greeting: '', points: [], guidingQuestion: '', symbols: '', paragraphs: [] };
  let sawGreeting = false;

  for (const raw of lines) {
    const line = raw.trim();

    if (!sawGreeting && /^traveler[,ï¼Œ]?/i.test(line)) { s.greeting = line; sawGreeting = true; continue; }
    if (/guiding\s*question/i.test(line)) { s.guidingQuestion = line; continue; }
    if (/[ğŸªğŸŒŠğŸƒğŸŒ€]/.test(line) && line.replace(/\s+/g,'').length <= 8) { s.symbols = line; continue; }

    if (/\*\*(.*?)\*\*/.test(line)) { s.points.push(line); }
    else { s.paragraphs.push(line); }
  }

  return s;
}

function formatMirrorResponse(question, s) {
  let html = `
    <div class="mirror-dialogue">
      <div class="user-question"><strong>You asked:</strong> "${question}"</div>
      <div class="mirror-response">
  `;
  if (s.greeting) html += `<div class="mirror-greeting">${s.greeting}</div>`;
  s.paragraphs.forEach(p => { if (p) html += `<div class="wisdom-paragraph">${p}</div>`; });
  s.points.forEach(point => {
    const m = point.match(/\*\*(.*?)\*\*/);
    if (m) {
      const title = m[1];
      const content = point.replace(/\*\*(.*?)\*\*/, '').trim();
      html += `<div class="wisdom-point"><strong>${title}</strong>${content ? ' ' + content : ''}</div>`;
    } else {
      html += `<div class="wisdom-paragraph">${point}</div>`;
    }
  });
  if (s.guidingQuestion) html += `<div class="guiding-question">${s.guidingQuestion.replace(/guiding\s*question\s*[:ï¼š]/i,'<strong>Guiding Question:</strong>')}</div>`;
  if (s.symbols) html += `<div class="symbols-line">${s.symbols}</div>`;
  html += `<div class="mirror-signature">ğŸª The Mirror has spoken</div></div></div>`;
  return html;
}

function showError(message) {
  ansDiv.innerHTML = `<div class="error-message">${message}</div>`;
}

function showCommunityInvitation() {
  const invitation = document.createElement('div');
  invitation.className = 'community-invitation';
  invitation.innerHTML = `
    <p style="margin-bottom:1rem; font-style:italic;">ğŸŒŠ Your question has created ripples in the pond...</p>
    <a href="https://t.me/Toadgang" class="btn" style="background:var(--primary-green); color:white;" target="_blank">
      Join Toadgang Community â†’ Continue the Journey
    </a>
  `;
  ansDiv.appendChild(invitation);
}

function setBusy(b){
  if(b){ askBtn.disabled = true; askSpin.style.display='inline-block'; askLabel.textContent='Listeningâ€¦'; }
  else { askBtn.disabled = false; askSpin.style.display='none'; askLabel.textContent='Seek Wisdom'; }
}

async function askMirror() {
  const question = qInput.value.trim();
  if (!question) { showError("The Mirror awaits your question, traveler..."); return; }
  if (!navigator.onLine) { showError("ğŸ“¶ Youâ€™re offline â€” the pond is resting. Iâ€™ll be here when you return."); return; }

  setBusy(true);
  ansDiv.innerHTML = '<div style="text-align:center; padding:2rem;">ğŸŒŠ The pond grows still, awaiting reflection...</div>';

  try {
    const res = await fetch(MIRROR_API, {
      method: 'POST',
      headers: { "Content-Type": "application/json", "Accept": "application/json" },
      body: JSON.stringify({ question, user: "web_visitor_" + Date.now() })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    let reply = data.answer || data.reply || "The Mirror is silent, but the pond remembers your question.";
    reply = cleanMirrorResponse(reply);

    const s = parseMirrorResponse(reply);
    const html = formatMirrorResponse(question, s);

    ansDiv.innerHTML = html;
    setTimeout(() => {
      const dlg = ansDiv.querySelector('.mirror-dialogue');
      if (dlg) dlg.classList.add('visible');
    }, 15);

    setTimeout(showCommunityInvitation, 600);
  } catch (err) {
    console.error('Mirror error:', err);
    showError("ğŸŒ€ The waters are unsettled today. The Mirror suggests you try again when the pond grows still.");
  } finally {
    setBusy(false);
    qInput.value = '';
    if (window.matchMedia('(pointer:fine)').matches) qInput.focus();
  }
}

/* Enter-to-send */
qInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); askMirror(); }});

/* Focus on load (desktop) */
window.addEventListener('load', () => {
  if (window.matchMedia('(pointer:fine)').matches) qInput.focus();
});
</script>

</body>
</html>
