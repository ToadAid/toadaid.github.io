<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scroll Reader ‚Äî ToadAid</title>
<meta name="description" content="Reader for ToadAid Scrolls">
<link rel="icon" href="/assets/icons/favicon.ico">
<style>
  :root{
    --bg:#f5f1e6; --ink:#2f2f2f; --muted:#6b6b6b; --paper:#fffdf6; --ring:rgba(0,0,0,.08);
    --accent:#355e3b; --link:#2f6b3a;
  }
  [data-theme="dark"]{
    --bg:#0f1210; --ink:#e8f0e8; --muted:#a6b2a8; --paper:#0b0d0b; --ring:rgba(255,255,255,.06);
    --accent:#7ed6a0; --link:#9bd4a8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  a{color:var(--link);text-decoration:none}
  a:hover{text-decoration:underline}
  header{
    position:sticky;top:0;z-index:20;
    background:linear-gradient(180deg,rgba(53,94,59,.98),rgba(53,94,59,.92));
    color:#fff;border-bottom:1px solid #00000020;
  }
  .bar{max-width:1100px;margin:0 auto;padding:10px 14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .bar a.home{color:#fff;opacity:.95}
  .spacer{flex:1}
  .btn{
    background:#ffffff18;border:1px solid #ffffff35;color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer
  }
  .wrap{max-width:900px;margin:0 auto;padding:22px 16px 60px}
  .meta{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:.9rem;margin-bottom:16px}
  .title{font-weight:800;font-size:clamp(1.4rem,2.8vw,2rem);margin:6px 0 10px}
  .leadimg{width:100%;height:auto;border-radius:14px;background:#00000010}
  article{background:var(--paper);border:1px solid var(--ring);box-shadow:0 10px 28px var(--ring);border-radius:16px;padding:22px}
  article img{max-width:100%;height:auto;border-radius:8px}
  article h1,article h2,article h3{scroll-margin-top:80px}
  .foot{margin-top:18px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--ring);padding:4px 10px;border-radius:999px;color:var(--muted);font-size:.85rem}
  .toast{position:fixed;right:16px;bottom:16px;background:#000; color:#fff;padding:10px 12px;border-radius:10px;opacity:.9;display:none;z-index:50}
  .hidden{display:none}
  .searchbox{min-width:200px;padding:6px 8px;border-radius:10px;border:1px solid #ffffff40;background:#ffffff18;color:#fff;outline:none}
  .searchbox::placeholder{color:#ffffffcc}
  mark{background:#fff59d;color:#000;padding:0 2px;border-radius:4px}
  .note{margin-top:10px;color:#8aa07f;font-size:.9rem}

  /* Panel for All Scrolls */
  .panel{
    position:fixed; inset:0; display:none; z-index:40;
    background:rgba(0,0,0,.45); backdrop-filter: blur(2px);
  }
  .panel.open{display:block}
  .panelInner{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(900px,92vw); max-height:80vh; overflow:auto;
    background:var(--paper); border:1px solid var(--ring); box-shadow:0 20px 40px var(--ring); border-radius:16px;
    padding:14px;
  }
  .panelHeader{display:flex; align-items:center; gap:10px; margin:6px 0 12px}
  .panelHeader h3{margin:0; font-size:1.05rem}
  .grid{display:grid; gap:10px; grid-template-columns:repeat(auto-fill, minmax(260px,1fr))}
  .item{
    display:flex; gap:10px; align-items:center; padding:10px; border:1px solid var(--ring); border-radius:12px; background:var(--bg);
    cursor:pointer
  }
  .thumb{width:48px;height:48px;border-radius:10px;object-fit:cover;background:#00000010;flex:0 0 48px}
  .metaLine{color:var(--muted); font-size:.85rem}
</style>
</head>
<body>
<header>
  <div class="bar">
    <a class="home" href="/scrolls/">‚Üê Vault</a>
    <input id="q" class="searchbox" placeholder="Search in scroll‚Ä¶ (Enter)">
    <button id="aPlus" class="btn" title="Increase font">A+</button>
    <button id="aMinus" class="btn" title="Decrease font">A-</button>
    <button id="toggleTheme" class="btn" title="Theme">üåô Night</button>
    <div class="spacer"></div>

    <!-- NAV controls -->
    <button id="prevBtn" class="btn" title="Previous">‚óÄ Prev</button>
    <button id="openList" class="btn" title="All Scrolls">üìö All</button>
    <button id="nextBtn" class="btn" title="Next">Next ‚ñ∂</button>

    <button id="bookmarkBtn" class="btn" title="Bookmark">üîñ Bookmark</button>
    <button id="shareBtn" class="btn" title="Copy link">üîó Share</button>
  </div>
</header>

<main class="wrap">
  <div class="meta" id="meta"></div>
  <h1 class="title" id="title">Loading‚Ä¶</h1>
  <img id="lead" class="leadimg hidden" alt="">
  <article id="content">Fetching scroll‚Ä¶</article>
  <div class="foot" id="tags"></div>
  <div id="note" class="note"></div>
</main>

<!-- All Scrolls Panel -->
<div id="panel" class="panel" aria-hidden="true">
  <div class="panelInner">
    <div class="panelHeader">
      <h3>All Commentary Scrolls</h3>
      <div class="spacer"></div>
      <button id="closeList" class="btn">Close</button>
    </div>
    <div id="list" class="grid"></div>
  </div>
</div>

<div class="toast" id="toast">Copied!</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
(function(){
  const $ = s=>document.querySelector(s);
  const note = $('#note');
  const params = new URLSearchParams(location.search);
  const rawPath = params.get('path');       // site path OR github blob/raw
  const fromParam = params.get('from');     // optional override json
  const toast = $('#toast');

  // --- Theme ---
  const savedTheme = localStorage.getItem('scrollTheme');
  const prefersLight = matchMedia('(prefers-color-scheme: light)').matches;
  const initialTheme = savedTheme || (prefersLight ? 'light' : 'dark');
  document.documentElement.setAttribute('data-theme', initialTheme);
  const themeBtn = $('#toggleTheme');
  themeBtn.textContent = initialTheme==='light' ? 'üåô Night' : '‚òÄÔ∏è Day';
  themeBtn.onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'light';
    const next = cur==='light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('scrollTheme', next);
    themeBtn.textContent = next==='light' ? 'üåô Night' : '‚òÄÔ∏è Day';
  };

  // --- Font ---
  let fs = parseFloat(localStorage.getItem('scrollFS') || '16');
  document.body.style.fontSize = fs + 'px';
  $('#aPlus').onclick = ()=>{ fs=Math.min(fs+1,22); document.body.style.fontSize=fs+'px'; localStorage.setItem('scrollFS',fs); };
  $('#aMinus').onclick = ()=>{ fs=Math.max(fs-1,12); document.body.style.fontSize=fs+'px'; localStorage.setItem('scrollFS',fs); };

  // --- Share / Bookmark ---
  $('#shareBtn').onclick = async()=>{ try{ await navigator.clipboard.writeText(location.href); show('Link copied'); }catch{ show('Copy failed'); } };
  $('#bookmarkBtn').onclick = ()=>{ if(!rawPath) return; const k='scrollBookmarks'; const list=JSON.parse(localStorage.getItem(k)||'[]'); if(!list.includes(rawPath)){ list.push(rawPath); localStorage.setItem(k,JSON.stringify(list)); show('Bookmarked'); } else show('Already bookmarked'); };
  function show(t){ toast.textContent=t; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1200); }

  // --- Helpers ---
  function escapeHtml(s){ return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function guessTitle(md){ const m = md.match(/^\s*#\s+(.+)$/m); return m ? m[1].trim() : ''; }
  function parseYAML(y){
    const o={};
    y.split(/\r?\n/).forEach(line=>{
      const m=line.match(/^(\w+):\s*(.*)$/); if(!m) return;
      const k=m[1]; let v=m[2].trim();
      if(v.startsWith('[')&&v.endsWith(']')) o[k]=v.slice(1,-1).split(',').map(s=>s.trim().replace(/^["']|["']$/g,'')).filter(Boolean);
      else o[k]=v.replace(/^["']|["']$/g,'');
    }); return o;
  }
  function highlight(term){
    const art = $('#content'); const t=(term||'').trim();
    if(!t){ art.innerHTML = art.innerHTML.replace(/<\/?mark>/g,''); return; }
    const esc=t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    art.innerHTML = art.innerHTML.replace(/<\/?mark>/g,'');
    art.innerHTML = art.innerHTML.replace(new RegExp(`(${esc})`,'gi'),'<mark>$1</mark>');
    const first=art.querySelector('mark'); if(first) first.scrollIntoView({behavior:'smooth', block:'center'});
  }
  $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') highlight(e.target.value); });

  function resolvePath(p){
    if(!p) return '';
    try{ p = decodeURIComponent(p); }catch{}
    const mBlob = p.match(/^https?:\/\/github\.com\/[^\/]+\/[^\/]+\/blob\/[^\/]+\/(.+)$/);
    if(mBlob) return mBlob[1];
    const mRaw = p.match(/^https?:\/\/raw\.githubusercontent\.com\/[^\/]+\/[^\/]+\/[^\/]+\/(.+)$/);
    if(mRaw) return mRaw[1];
    return p.replace(/^\/+/, '');
  }
  const pathParam = resolvePath(rawPath);
  const norm = s => String(s||'').replace(/^\/+/, '');

  // JSON locations to try
  const jsonCandidates = [
    ...(fromParam ? [fromParam] : []),
    './commentary-scrolls/data.json',
    '/scrolls/commentary-scrolls/data.json'
  ];
  async function loadJson(){
    for(const u of jsonCandidates){
      try{ const r=await fetch(u,{cache:'no-store'}); if(r.ok) return {arr:await r.json(), from:u}; }catch{}
    }
    return {arr:null, from:null};
  }

  // NAV helpers
  function goTo(url, from){
    const target = `/scrolls/read.html?path=${encodeURIComponent(url)}&from=${encodeURIComponent(from||'/scrolls/commentary-scrolls/data.json')}`;
    location.href = target;
  }

  // Main
  (async function(){
    const {arr, from} = await loadJson();

    // If no ?path=, auto-open the first item from data.json
    if(!pathParam){
      if(arr && arr.length && arr[0].url){ goTo(arr[0].url, from); return; }
      $('#title').textContent='Missing ?path='; $('#content').textContent='No path and no data.json found.'; return;
    }

    // Build site path + RAW fallback (for Jekyll sites)
    const sitePath = '/'+pathParam.replace(/^\/+/, '');
    const rawURL   = 'https://raw.githubusercontent.com/ToadAid/toadaid.github.io/main/' + pathParam.replace(/^\/+/, '');

    let text = '';
    let res  = await fetch(sitePath, {cache:'no-store'});
    if(!res.ok){ res = await fetch(rawURL, {cache:'no-store'}); }
    if(!res.ok){
      $('#title').textContent='Not found';
      $('#content').innerHTML = `<p>Could not fetch:</p><code>${sitePath}</code><p>Tried fallback:</p><code>${rawURL}</code>`;
      note.textContent = 'If you prefer site paths to work, add a ".nojekyll" file at repo root.';
      return;
    }
    text = await res.text();

    // Front-matter (optional)
    let meta={}, body=text;
    const fm = text.match(/^---\s*?\n([\s\S]*?)\n---\s*?\n?/);
    if(fm){ try{ meta = parseYAML(fm[1]); body = text.slice(fm[0].length); }catch{} }

    // Merge metadata from data.json
    if(arr){
      const j = arr.find(x => norm(x.url) === norm(pathParam));
      if(j){
        meta.title = meta.title || j.title;
        meta.date  = meta.date  || j.date;
        meta.cover = meta.cover || j.img;
        meta.tags  = meta.tags  || j.tags;
        meta.id    = meta.id    || j.id;
      }
    }

    // Render
    $('#title').textContent = meta.title || guessTitle(body) || (pathParam.split('/').pop()||'').replace(/\.md$/,'');
    if(meta.cover){ const lead=$('#lead'); lead.src=meta.cover; lead.classList.remove('hidden'); lead.alt=meta.title||'Cover'; }
    $('#meta').innerHTML = [
      meta.id   ? `<span>üÜî ${escapeHtml(meta.id)}</span>` : '',
      meta.date ? `<span>üìÖ ${escapeHtml(meta.date)}</span>` : ''
    ].filter(Boolean).join('<span>‚Ä¢</span>');
    try{ $('#content').innerHTML = marked.parse(body); }catch{ $('#content').textContent = body; }
    const tags = Array.isArray(meta.tags) ? meta.tags : [];
    $('#tags').innerHTML = tags.map(t=>`<span class="pill">#${escapeHtml(String(t))}</span>`).join('');

    // ----- NAV wiring (Prev/Next + All list) -----
    const prevBtn = $('#prevBtn');
    const nextBtn = $('#nextBtn');
    const openList = $('#openList');
    const panel = $('#panel');
    const closeList = $('#closeList');
    const listEl = $('#list');

    if(arr && arr.length){
      // sort by date desc (when present)
      const list = [...arr].sort((a,b)=>{
        const da = Date.parse(a.date||''); const db = Date.parse(b.date||'');
        if (isNaN(da) && isNaN(db)) return 0;
        if (isNaN(da)) return 1;
        if (isNaN(db)) return -1;
        return db - da;
      });

      // index of current
      let idx = Math.max(0, list.findIndex(it => norm(it.url) === norm(pathParam)));
      if (idx === -1) idx = 0;

      // Prev/Next actions
      prevBtn.disabled = idx === 0;
      nextBtn.disabled = idx === list.length - 1;
      prevBtn.onclick = () => { if(idx>0) goTo(list[idx-1].url, from); };
      nextBtn.onclick = () => { if(idx<list.length-1) goTo(list[idx+1].url, from); };

      // Build panel list (with thumbnails if provided)
      listEl.innerHTML = list.map(it=>{
        const img = it.img ? `<img class="thumb" src="${it.img}" alt="">` : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;font-size:18px">üìú</div>`;
        const id = it.id ? `<strong>${escapeHtml(it.id)}</strong>` : '';
        const date = it.date ? ` ¬∑ ${escapeHtml(it.date)}` : '';
        return `<div class="item" data-url="${encodeURIComponent(it.url)}">
                  ${img}
                  <div>
                    <div>${id}${date}</div>
                    <div>${escapeHtml(it.title || '')}</div>
                    <div class="metaLine">${escapeHtml(it.url)}</div>
                  </div>
                </div>`;
      }).join('');

      // open/close panel
      function openPanel(){ panel.classList.add('open'); panel.setAttribute('aria-hidden','false'); }
      function closePanel(){ panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); }
      openList.onclick = openPanel;
      closeList.onclick = closePanel;
      panel.addEventListener('click', e=>{ if(e.target===panel) closePanel(); });

      // click item -> navigate
      listEl.addEventListener('click', e=>{
        const el = e.target.closest('.item'); if(!el) return;
        const url = decodeURIComponent(el.getAttribute('data-url'));
        goTo(url, from);
      });
    } else {
      // no JSON ‚Äî disable nav
      prevBtn.disabled = nextBtn.disabled = true;
      openList.disabled = true;
    }

    // clear any note
    note.textContent = '';
  })();
})();
</script>
</body>
</html>
