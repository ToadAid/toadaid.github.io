<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scroll Reader ‚Äî ToadAid</title>
<meta name="description" content="Reader for ToadAid Scrolls">
<link rel="icon" href="/assets/icons/favicon.ico">
<style>
  :root{
    --bg:#f5f1e6; --ink:#2f2f2f; --muted:#6b6b6b; --paper:#fffdf6; --ring:rgba(0,0,0,.08);
    --accent:#355e3b; --link:#2f6b3a;
  }
  [data-theme="dark"]{
    --bg:#0f1210; --ink:#e8f0e8; --muted:#a6b2a8; --paper:#0b0d0b; --ring:rgba(255,255,255,.06);
    --accent:#7ed6a0; --link:#9bd4a8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  a{color:var(--link);text-decoration:none}
  a:hover{text-decoration:underline}
  header{
    position:sticky;top:0;z-index:10;
    background:linear-gradient(180deg,rgba(53,94,59,.98),rgba(53,94,59,.92));
    color:#fff;border-bottom:1px solid #00000020;
  }
  .bar{max-width:1100px;margin:0 auto;padding:10px 14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .bar a.home{color:#fff;opacity:.95}
  .spacer{flex:1}
  .btn{
    background:#ffffff18;border:1px solid #ffffff35;color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer
  }
  .wrap{max-width:900px;margin:0 auto;padding:22px 16px 60px}
  .meta{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:.9rem;margin-bottom:16px}
  .title{font-weight:800;font-size:clamp(1.4rem,2.8vw,2rem);margin:6px 0 10px}
  .leadimg{width:100%;height:auto;border-radius:14px;background:#00000010}
  article{background:var(--paper);border:1px solid var(--ring);box-shadow:0 10px 28px var(--ring);border-radius:16px;padding:22px}
  article img{max-width:100%;height:auto;border-radius:8px}
  article h1,article h2,article h3{scroll-margin-top:80px}
  .foot{margin-top:18px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--ring);padding:4px 10px;border-radius:999px;color:var(--muted);font-size:.85rem}
  .toast{position:fixed;right:16px;bottom:16px;background:#000; color:#fff;padding:10px 12px;border-radius:10px;opacity:.9;display:none}
  .hidden{display:none}
  .searchbox{min-width:200px;padding:6px 8px;border-radius:10px;border:1px solid #ffffff40;background:#ffffff18;color:#fff;outline:none}
  .searchbox::placeholder{color:#ffffffcc}
  .note{margin:10px 0 0;color:#9a6; font-size:.9rem}
  mark{background:#fff59d;color:#000;padding:0 2px;border-radius:4px}
</style>
</head>
<body>
<header>
  <div class="bar">
    <a class="home" href="/scrolls/">‚Üê Vault</a>
    <input id="q" class="searchbox" placeholder="Search in scroll‚Ä¶ (Enter)">
    <button id="aPlus" class="btn" title="Increase font">A+</button>
    <button id="aMinus" class="btn" title="Decrease font">A-</button>
    <button id="toggleTheme" class="btn" title="Theme">üåô Night</button>
    <div class="spacer"></div>
    <button id="bookmarkBtn" class="btn" title="Bookmark">üîñ Bookmark</button>
    <button id="shareBtn" class="btn" title="Copy link">üîó Share</button>
  </div>
</header>

<main class="wrap">
  <div class="meta" id="meta"></div>
  <h1 class="title" id="title">Loading‚Ä¶</h1>
  <img id="lead" class="leadimg hidden" alt="">
  <article id="content">Fetching scroll‚Ä¶</article>
  <div class="foot" id="tags"></div>
  <div id="note" class="note"></div>
</main>

<div class="toast" id="toast">Copied!</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
(function(){
  const $ = s=>document.querySelector(s);
  const note = $('#note');
  function say(msg){ note.textContent = msg; }

  // ---- theme ----
  const themeBtn = $('#toggleTheme');
  const savedTheme = localStorage.getItem('scrollTheme');
  const prefersLight = matchMedia('(prefers-color-scheme: light)').matches;
  const initialTheme = savedTheme || (prefersLight ? 'light' : 'dark');
  document.documentElement.setAttribute('data-theme', initialTheme);
  themeBtn.textContent = initialTheme==='light' ? 'üåô Night' : '‚òÄÔ∏è Day';
  themeBtn.onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'light';
    const next = cur==='light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('scrollTheme', next);
    themeBtn.textContent = next==='light' ? 'üåô Night' : '‚òÄÔ∏è Day';
  };

  // ---- font ----
  let fs = parseFloat(localStorage.getItem('scrollFS') || '16');
  document.body.style.fontSize = fs + 'px';
  $('#aPlus').onclick = ()=>{ fs=Math.min(fs+1,22); document.body.style.fontSize=fs+'px'; localStorage.setItem('scrollFS',fs); };
  $('#aMinus').onclick = ()=>{ fs=Math.max(fs-1,12); document.body.style.fontSize=fs+'px'; localStorage.setItem('scrollFS',fs); };

  // ---- share / bookmark ----
  const toast = $('#toast');
  function toastMsg(t){ toast.textContent=t; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1200); }
  $('#shareBtn').onclick = async()=>{ try{ await navigator.clipboard.writeText(location.href); toastMsg('Link copied'); }catch{ toastMsg('Copy failed'); } };
  $('#bookmarkBtn').onclick = ()=>{ const p = new URLSearchParams(location.search).get('path'); if(!p) return; const k='scrollBookmarks'; const list=JSON.parse(localStorage.getItem(k)||'[]'); if(!list.includes(p)){ list.push(p); localStorage.setItem(k,JSON.stringify(list)); toastMsg('Bookmarked'); } else toastMsg('Already bookmarked'); };

  // ---- helpers ----
  function resolvePath(p){
    if(!p) return '';
    try{ p = decodeURIComponent(p); }catch{}
    const mBlob = p.match(/^https?:\/\/github\.com\/[^\/]+\/[^\/]+\/blob\/[^\/]+\/(.+)$/);
    if(mBlob) return mBlob[1];
    const mRaw  = p.match(/^https?:\/\/raw\.githubusercontent\.com\/[^\/]+\/[^\/]+\/[^\/]+\/(.+)$/);
    if(mRaw) return mRaw[1];
    return p.replace(/^\/+/, '');
  }
  function escapeHtml(s){ return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function guessTitle(md){ const m = md.match(/^\s*#\s+(.+)$/m); return m ? m[1].trim() : ''; }
  function parseYAML(y){
    const o={}; y.split(/\r?\n/).forEach(line=>{
      const m = line.match(/^(\w+):\s*(.*)$/); if(!m) return;
      const k=m[1]; let v=m[2].trim();
      if(v.startsWith('[') && v.endsWith(']')) o[k]=v.slice(1,-1).split(',').map(s=>s.trim().replace(/^["']|["']$/g,'')).filter(Boolean);
      else o[k]=v.replace(/^["']|["']$/g,'');
    }); return o;
  }
  function highlight(term){
    const art = $('#content'); const t = (term||'').trim();
    if(!t){ art.innerHTML = art.innerHTML.replace(/<\/?mark>/g,''); return; }
    const esc = t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    art.innerHTML = art.innerHTML.replace(/<\/?mark>/g,'');
    art.innerHTML = art.innerHTML.replace(new RegExp(`(${esc})`, 'gi'), '<mark>$1</mark>');
    const first = art.querySelector('mark'); if(first) first.scrollIntoView({behavior:'smooth', block:'center'});
  }

  // ---- main ----
  const params = new URLSearchParams(location.search);
  const rawPath = params.get('path');
  const path = resolvePath(rawPath);

  if(!path){
    $('#title').textContent = 'Missing ?path=';
    $('#content').innerHTML = '<p>Use <code>?path=scrolls/commentary-scrolls/FILE.md</code></p>';
    say('Example: /scrolls/read.html?path=scrolls/commentary-scrolls/TOBY_C004_TheFrogAsThePeople_2025-08-29_EN.md');
    return;
  }

  (async function(){
    // 1) Render markdown first (so page always shows)
    const mdUrl = '/'+path.replace(/^\/+/, '');
    let raw = '';
    try{
      const res = await fetch(mdUrl, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      raw = await res.text();
    }catch(e){
      $('#title').textContent='Not found';
      $('#content').textContent='Could not fetch '+mdUrl;
      say('Check that FILE.md exists at '+mdUrl);
      return;
    }

    let meta = {}, body = raw;
    const fm = raw.match(/^---\s*?\n([\s\S]*?)\n---\s*?\n?/);
    if(fm){ try{ meta = parseYAML(fm[1]); body = raw.slice(fm[0].length); }catch{} }

    $('#title').textContent = meta.title || guessTitle(body) || path.split('/').pop().replace(/\.md$/,'');
    try{ $('#content').innerHTML = marked.parse(body); }catch{ $('#content').textContent = body; }

    // 2) Then try to load metadata from data.json (optional)
    const jsonPaths = [
      params.get('from'),
      './commentary-scrolls/data.json',
      '/scrolls/commentary-scrolls/data.json'
    ].filter(Boolean);

    try{
      let arr=null;
      for(const jp of jsonPaths){
        const r = await fetch(jp, {cache:'no-store'});
        if(r.ok){ arr = await r.json(); break; }
      }
      if(arr){
        const norm = s => String(s||'').replace(/^\/+/, '');
        const it = arr.find(x => norm(x.url) === norm(path));
        if(it){
          // enrich header
          meta.title = meta.title || it.title;
          $('#title').textContent = meta.title;
          if(it.img){
            const lead = $('#lead'); lead.src = it.img; lead.classList.remove('hidden'); lead.alt = meta.title || 'Cover';
          }
          const dateBits = meta.date || it.date ? `<span>üìÖ ${escapeHtml(meta.date || it.date)}</span>` : '';
          const idBits   = meta.id ? `<span>üÜî ${escapeHtml(meta.id)}</span>` : '';
          $('#meta').innerHTML = [idBits, dateBits].filter(Boolean).join('<span>‚Ä¢</span>');
          const tags = Array.isArray(meta.tags) ? meta.tags : (Array.isArray(it.tags) ? it.tags : []);
          $('#tags').innerHTML = tags.map(t=>`<span class="pill">#${escapeHtml(String(t))}</span>`).join('');
          say(''); // clear note
        }else{
          say('Note: file rendered. No matching item in data.json for '+path);
        }
      }else{
        say('Note: file rendered. Could not load data.json (path mismatch).');
      }
    }catch{
      say('Note: file rendered. data.json fetch error.');
    }

    // search hook
    $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') highlight(e.target.value); });
  })();
})();
</script>
</body>
</html>
