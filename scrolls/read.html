<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scroll Reader ‚Äî ToadAid</title>
<meta name="description" content="Reader for ToadAid Scrolls">
<link rel="icon" href="/assets/icons/favicon.ico">
<style>
  :root{
    --bg:#f5f1e6; --ink:#2f2f2f; --muted:#6b6b6b; --paper:#fffdf6; --ring:rgba(0,0,0,.08);
    --accent:#355e3b; --link:#2f6b3a;
  }
  [data-theme="dark"]{
    --bg:#0f1210; --ink:#e8f0e8; --muted:#a6b2a8; --paper:#0b0d0b; --ring:rgba(255,255,255,.06);
    --accent:#7ed6a0; --link:#9bd4a8;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.7 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  a{color:var(--link);text-decoration:none}
  a:hover{text-decoration:underline}
  header{
    position:sticky;top:0;z-index:10;
    background:linear-gradient(180deg,rgba(53,94,59,.98),rgba(53,94,59,.92));
    color:#fff;border-bottom:1px solid #00000020;
  }
  .bar{max-width:1100px;margin:0 auto;padding:10px 14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .bar a.home{color:#fff;opacity:.95}
  .spacer{flex:1}
  .btn{
    background:#ffffff18;border:1px solid #ffffff35;color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer
  }
  .wrap{max-width:900px;margin:0 auto;padding:22px 16px 60px}
  .meta{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:.9rem;margin-bottom:16px}
  .title{font-weight:800;font-size:clamp(1.4rem,2.8vw,2rem);margin:6px 0 10px}
  .leadimg{width:100%;height:auto;border-radius:14px;background:#00000010}
  article{background:var(--paper);border:1px solid var(--ring);box-shadow:0 10px 28px var(--ring);border-radius:16px;padding:22px}
  article img{max-width:100%;height:auto;border-radius:8px}
  article h1,article h2,article h3{scroll-margin-top:80px}
  .foot{margin-top:18px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{border:1px solid var(--ring);padding:4px 10px;border-radius:999px;color:var(--muted);font-size:.85rem}
  .toast{position:fixed;right:16px;bottom:16px;background:#000; color:#fff;padding:10px 12px;border-radius:10px;opacity:.9;display:none}
  .hidden{display:none}
  .searchbox{min-width:200px;padding:6px 8px;border-radius:10px;border:1px solid #ffffff40;background:#ffffff18;color:#fff;outline:none}
  .searchbox::placeholder{color:#ffffffcc}
  mark{background:#fff59d;color:#000;padding:0 2px;border-radius:4px}
  .note{margin-top:10px;color:#8aa07f;font-size:.9rem}
</style>
</head>
<body>
<header>
  <div class="bar">
    <a class="home" href="/scrolls/">‚Üê Vault</a>
    <input id="q" class="searchbox" placeholder="Search in scroll‚Ä¶ (Enter)">
    <button id="aPlus" class="btn" title="Increase font">A+</button>
    <button id="aMinus" class="btn" title="Decrease font">A-</button>
    <button id="toggleTheme" class="btn" title="Theme">üåô Night</button>
    <div class="spacer"></div>
    <button id="bookmarkBtn" class="btn" title="Bookmark">üîñ Bookmark</button>
    <button id="shareBtn" class="btn" title="Copy link">üîó Share</button>
  </div>
</header>

<main class="wrap">
  <div class="meta" id="meta"></div>
  <h1 class="title" id="title">Loading‚Ä¶</h1>
  <img id="lead" class="leadimg hidden" alt="">
  <article id="content">Fetching scroll‚Ä¶</article>
  <div class="foot" id="tags"></div>
  <div id="note" class="note"></div>
</main>

<div class="toast" id="toast">Copied!</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
(function(){
  const $ = s=>document.querySelector(s);
  const note = $('#note');
  const params = new URLSearchParams(location.search);
  const rawPath = params.get('path');       // may be site path OR github blob/raw
  const fromParam = params.get('from');     // optional override for json
  const toast = $('#toast');

  // --- Theme ---
  const savedTheme = localStorage.getItem('scrollTheme');
  const prefersLight = matchMedia('(prefers-color-scheme: light)').matches;
  const initialTheme = savedTheme || (prefersLight ? 'light' : 'dark');
  document.documentElement.setAttribute('data-theme', initialTheme);
  const themeBtn = $('#toggleTheme');
  themeBtn.textContent = initialTheme==='light' ? 'üåô Night' : '‚òÄÔ∏è Day';
  themeBtn.onclick = ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'light';
    const next = cur==='light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('scrollTheme', next);
    themeBtn.textContent = next==='light' ? 'üåô Night' : '‚òÄÔ∏è Day';
  };

  // --- Font ---
  let fs = parseFloat(localStorage.getItem('scrollFS') || '16');
  document.body.style.fontSize = fs + 'px';
  $('#aPlus').onclick = ()=>{ fs=Math.min(fs+1,22); document.body.style.fontSize=fs+'px'; localStorage.setItem('scrollFS',fs); };
  $('#aMinus').onclick = ()=>{ fs=Math.max(fs-1,12); document.body.style.fontSize=fs+'px'; localStorage.setItem('scrollFS',fs); };

  // --- Share / Bookmark ---
  $('#shareBtn').onclick = async()=>{ try{ await navigator.clipboard.writeText(location.href); show('Link copied'); }catch{ show('Copy failed'); } };
  $('#bookmarkBtn').onclick = ()=>{ if(!rawPath) return; const k='scrollBookmarks'; const list=JSON.parse(localStorage.getItem(k)||'[]'); if(!list.includes(rawPath)){ list.push(rawPath); localStorage.setItem(k,JSON.stringify(list)); show('Bookmarked'); } else show('Already bookmarked'); };
  function show(t){ toast.textContent=t; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1200); }

  // --- Helpers ---
  function escapeHtml(s){ return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function guessTitle(md){ const m = md.match(/^\s*#\s+(.+)$/m); return m ? m[1].trim() : ''; }
  function parseYAML(y){
    const o={};
    y.split(/\r?\n/).forEach(line=>{
      const m=line.match(/^(\w+):\s*(.*)$/); if(!m) return;
      const k=m[1]; let v=m[2].trim();
      if(v.startsWith('[')&&v.endsWith(']')) o[k]=v.slice(1,-1).split(',').map(s=>s.trim().replace(/^["']|["']$/g,'')).filter(Boolean);
      else o[k]=v.replace(/^["']|["']$/g,'');
    }); return o;
  }
  function highlight(term){
    const art = $('#content'); const t=(term||'').trim();
    if(!t){ art.innerHTML = art.innerHTML.replace(/<\/?mark>/g,''); return; }
    const esc=t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    art.innerHTML = art.innerHTML.replace(/<\/?mark>/g,'');
    art.innerHTML = art.innerHTML.replace(new RegExp(`(${esc})`,'gi'),'<mark>$1</mark>');
    const first=art.querySelector('mark'); if(first) first.scrollIntoView({behavior:'smooth', block:'center'});
  }
  $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') highlight(e.target.value); });

  // Accept site paths + GitHub URLs
  function resolvePath(p){
    if(!p) return '';
    try{ p = decodeURIComponent(p); }catch{}
    const mBlob = p.match(/^https?:\/\/github\.com\/[^\/]+\/[^\/]+\/blob\/[^\/]+\/(.+)$/);
    if(mBlob) return mBlob[1];
    const mRaw = p.match(/^https?:\/\/raw\.githubusercontent\.com\/[^\/]+\/[^\/]+\/[^\/]+\/(.+)$/);
    if(mRaw) return mRaw[1];
    return p.replace(/^\/+/, '');
  }
  const pathParam = resolvePath(rawPath);

  // Try these JSON locations
  const jsonCandidates = [
    ...(fromParam ? [fromParam] : []),
    './commentary-scrolls/data.json',
    '/scrolls/commentary-scrolls/data.json'
  ];
  async function loadJson(){
    for(const u of jsonCandidates){
      try{ const r=await fetch(u,{cache:'no-store'}); if(r.ok) return await r.json(); }catch{}
    }
    return null;
  }

  // Main
  (async function(){
    // If no ?path=, auto-open the first item from data.json
    if(!pathParam){
      const arr = await loadJson();
      if(arr && arr.length && arr[0].url){
        location.replace(`/scrolls/read.html?path=${encodeURIComponent(arr[0].url)}&from=/scrolls/commentary-scrolls/data.json`);
        return;
      }
      $('#title').textContent='Missing ?path='; $('#content').textContent='No path and no data.json found.'; return;
    }

    // Build site path + RAW fallback
    const sitePath = '/'+pathParam.replace(/^\/+/, '');
    const rawURL   = 'https://raw.githubusercontent.com/ToadAid/toadaid.github.io/main/' + pathParam.replace(/^\/+/, '');

    // Fetch markdown (site first, then RAW)
    let text = '';
    let res  = await fetch(sitePath, {cache:'no-store'});
    if(!res.ok){ res = await fetch(rawURL, {cache:'no-store'}); }
    if(!res.ok){
      $('#title').textContent='Not found';
      $('#content').innerHTML = `<p>Could not fetch:</p><code>${sitePath}</code><p>Tried fallback:</p><code>${rawURL}</code>`;
      note.textContent = 'If you prefer site paths to work, add a ".nojekyll" file at repo root.';
      return;
    }
    text = await res.text();

    // Front-matter (optional)
    let meta={}, body=text;
    const fm = text.match(/^---\s*?\n([\s\S]*?)\n---\s*?\n?/);
    if(fm){ try{ meta = parseYAML(fm[1]); body = text.slice(fm[0].length); }catch{} }

    // Merge metadata from data.json
    const data = await loadJson();
    if(data){
      const norm = s => String(s||'').replace(/^\/+/, '');
      const j = data.find(x => norm(x.url) === norm(pathParam));
      if(j){
        meta.title = meta.title || j.title;
        meta.date  = meta.date  || j.date;
        meta.cover = meta.cover || j.img;
        meta.tags  = meta.tags  || j.tags;
        meta.id    = meta.id    || j.id;
      }
    }

    // Render
    $('#title').textContent = meta.title || guessTitle(body) || (pathParam.split('/').pop()||'').replace(/\.md$/,'');
    if(meta.cover){ const lead=$('#lead'); lead.src=meta.cover; lead.classList.remove('hidden'); lead.alt=meta.title||'Cover'; }
    $('#meta').innerHTML = [
      meta.id   ? `<span>üÜî ${escapeHtml(meta.id)}</span>` : '',
      meta.date ? `<span>üìÖ ${escapeHtml(meta.date)}</span>` : ''
    ].filter(Boolean).join('<span>‚Ä¢</span>');
    try{ $('#content').innerHTML = marked.parse(body); }catch{ $('#content').textContent = body; }
    const tags = Array.isArray(meta.tags) ? meta.tags : [];
    $('#tags').innerHTML = tags.map(t=>`<span class="pill">#${escapeHtml(String(t))}</span>`).join('');

    note.textContent = ''; // clear
  })();
})();
</script>
</body>
</html>
