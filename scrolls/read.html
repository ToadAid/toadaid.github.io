<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const params = new URLSearchParams(location.search);
  const rawPath = params.get('path');     // may be encoded, or a GitHub blob URL
  const fromParam = params.get('from');   // optional override
  const themeBtn = $('#toggleTheme');
  const toast = $('#toast');

  // ---------- Theme ----------
  const savedTheme = localStorage.getItem('scrollTheme');
  const prefersLight = matchMedia('(prefers-color-scheme: light)').matches;
  const initialTheme = savedTheme || (prefersLight ? 'light' : 'dark');
  document.documentElement.setAttribute('data-theme', initialTheme);
  themeBtn.textContent = initialTheme === 'light' ? '🌙 Night' : '☀️ Day';
  themeBtn.addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme') || 'light';
    const next = cur === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('scrollTheme', next);
    themeBtn.textContent = next === 'light' ? '🌙 Night' : '☀️ Day';
  });

  // ---------- Font ----------
  let fs = parseFloat(localStorage.getItem('scrollFS') || '16');
  document.body.style.fontSize = fs + 'px';
  $('#aPlus').onclick = ()=>{ fs=Math.min(fs+1,22); document.body.style.fontSize=fs+'px'; localStorage.setItem('scrollFS',fs); };
  $('#aMinus').onclick = ()=>{ fs=Math.max(fs-1,12); document.body.style.fontSize=fs+'px'; localStorage.setItem('scrollFS',fs); };

  // ---------- Share / Bookmark ----------
  $('#shareBtn').onclick = async()=>{ try{ await navigator.clipboard.writeText(location.href); toastMsg('Link copied'); }catch{ toastMsg('Copy failed'); } };
  $('#bookmarkBtn').onclick = ()=>{ if(!rawPath) return; const k='scrollBookmarks'; const list=JSON.parse(localStorage.getItem(k)||'[]'); if(!list.includes(rawPath)){ list.push(rawPath); localStorage.setItem(k,JSON.stringify(list)); toastMsg('Bookmarked'); } else toastMsg('Already bookmarked'); };
  function toastMsg(t){ toast.textContent=t; toast.style.display='block'; setTimeout(()=>toast.style.display='none',1200); }

  // ---------- Path resolution ----------
  function resolvePath(p){
    if(!p) return '';
    try { p = decodeURIComponent(p); } catch {}
    // GitHub blob/raw -> site path
    const mBlob = p.match(/^https?:\/\/github\.com\/[^\/]+\/[^\/]+\/blob\/[^\/]+\/(.+)$/);
    if(mBlob) return mBlob[1];
    const mRaw = p.match(/^https?:\/\/raw\.githubusercontent\.com\/[^\/]+\/[^\/]+\/[^\/]+\/(.+)$/);
    if(mRaw) return mRaw[1];
    return p.replace(/^\/+/, '');
  }
  const pathParam = resolvePath(rawPath);

  // ---------- JSON fetch (tries multiple locations) ----------
  async function tryFetchJson(urls){
    for(const u of urls){
      try{
        const res = await fetch(u, {cache:'no-store'});
        if(res.ok) return await res.json();
      }catch(e){}
    }
    return null;
  }

  // IMPORTANT: order matters (relative first because read.html is under /scrolls/)
  const jsonCandidates = [
    ...(fromParam ? [fromParam] : []),
    './commentary-scrolls/data.json',
    '/scrolls/commentary-scrolls/data.json'
  ];

  async function loadMeta(){
    const data = await tryFetchJson(jsonCandidates);
    if(!data){
      debug('Could not load data.json from:', jsonCandidates);
      return null;
    }
    const norm = s => String(s||'').replace(/^\/+/, '');
    const item = data.find(x => norm(x.url) === norm(pathParam)) || null;
    if(!item){
      debug('No item matched url=', pathParam);
    }
    return item;
  }

  // ---------- Markdown render ----------
  async function loadMD(){
    if(!pathParam){
      $('#title').textContent='Missing ?path=';
      $('#content').innerHTML='<p>Provide <code>?path=</code> to a <code>.md</code> file.</p>';
      return;
    }
    const mdPath = '/'+pathParam.replace(/^\/+/, '');
    const res = await fetch(mdPath, {cache:'no-store'});
    if(!res.ok){
      $('#title').textContent='Not found';
      $('#content').textContent='Could not fetch '+mdPath;
      debug('MD fetch failed:', mdPath, res.status);
      return;
    }
    const raw = await res.text();

    // front-matter
    let meta = {}, body = raw;
    const m = raw.match(/^---\s*?\n([\s\S]*?)\n---\s*?\n?/);
    if(m){ try{ meta = parseYAML(m[1]); body = raw.slice(m[0].length); }catch{} }

    // merge with data.json
    const j = await loadMeta();
    if(j){
      meta.title = meta.title || j.title;
      meta.date  = meta.date  || j.date;
      meta.cover = meta.cover || j.img;
      meta.tags  = meta.tags  || j.tags;
      meta.id    = meta.id    || j.id;
    }

    // header/meta
    $('#title').textContent = meta.title || guessTitle(body) || fileBase(mdPath);
    const lead = $('#lead');
    if(meta.cover){ lead.src = meta.cover; lead.classList.remove('hidden'); lead.alt = meta.title || 'Cover'; }
    $('#meta').innerHTML = [
      meta.id ? `<span>🆔 ${escapeHtml(meta.id)}</span>` : '',
      meta.date ? `<span>📅 ${escapeHtml(meta.date)}</span>` : ''
    ].filter(Boolean).join('<span>•</span>');

    // markdown
    try{ $('#content').innerHTML = marked.parse(body); }
    catch{ $('#content').textContent = body; }

    // tags
    const tags = Array.isArray(meta.tags) ? meta.tags : [];
    $('#tags').innerHTML = tags.map(t=>`<span class="pill">#${escapeHtml(String(t))}</span>`).join('');

    // search
    const q = $('#q');
    q.addEventListener('keydown', e=>{
      if(e.key !== 'Enter') return;
      highlight(q.value);
    });
  }

  // ---------- Helpers ----------
  function escapeHtml(s){ return (s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function guessTitle(md){ const m = md.match(/^\s*#\s+(.+)$/m); return m ? m[1].trim() : ''; }
  function parseYAML(y){
    const o={}; y.split(/\r?\n/).forEach(line=>{
      const m = line.match(/^(\w+):\s*(.*)$/); if(!m) return;
      const k=m[1]; let v=m[2].trim();
      if(v.startsWith('[') && v.endsWith(']')){
        o[k]=v.slice(1,-1).split(',').map(s=>s.trim().replace(/^["']|["']$/g,'')).filter(Boolean);
      }else{ o[k]=v.replace(/^["']|["']$/g,''); }
    }); return o;
  }
  function fileBase(p){ return (p.split('/').pop()||'').replace(/\.md$/,''); }
  function highlight(term){
    const art = $('#content'); const t = (term||'').trim();
    if(!t){ art.innerHTML = art.innerHTML.replace(/<\/?mark>/g,''); return; }
    const esc = t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    art.innerHTML = art.innerHTML.replace(/<\/?mark>/g,'');
    art.innerHTML = art.innerHTML.replace(new RegExp(`(${esc})`, 'gi'), '<mark>$1</mark>');
    const first = art.querySelector('mark'); if(first) first.scrollIntoView({behavior:'smooth', block:'center'});
  }

  // tiny on-page debug note (shows only if needed)
  function debug(...args){
    console.log('[reader]', ...args);
    let el = document.getElementById('debugnote');
    if(!el){
      el = document.createElement('div');
      el.id = 'debugnote';
      el.style.cssText = 'position:fixed;left:12px;bottom:12px;padding:6px 10px;border-radius:8px;background:#000000aa;color:#fff;font:12px system-ui';
      document.body.appendChild(el);
    }
    el.textContent = 'Note: metadata not found. Check data.json path or url match.';
  }

  // go
  loadMD();
})();
</script>
