<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="description" content="Mirror | The Digital Pond - A reflective space for mindful inquiry" />
  <title>Mirror | The Digital Pond</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;500&display=swap');

    :root {
      --safe-t: env(safe-area-inset-top);
      --safe-b: env(safe-area-inset-bottom);
      --safe-l: env(safe-area-inset-left);
      --safe-r: env(safe-area-inset-right);

      --pad-top: calc(14px + var(--safe-t));
      --pad-bot: calc(18px + var(--safe-b));
      --pad-x: 16px;

      --portal-radius: 28px;
      
      /* New color palette - soft, readable, easy on eyes */
      --bg-primary: #0b0f0c;
      --bg-secondary: #101614;
      --text-primary: #f3f4f2;
      --text-secondary: #d1d5cf;
      --text-muted: #9aa39a;
      --accent-primary: #4fae7a;
      --accent-secondary: #d6b36a;
      --border-light: rgba(255, 255, 255, 0.08);
      --border-medium: rgba(255, 255, 255, 0.14);
      
      --theme-soft: rgba(79, 174, 122, 0.18);
      --theme-glow: rgba(79, 174, 122, 0.12);
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      padding: var(--pad-top) calc(var(--pad-x) + var(--safe-r)) var(--pad-bot) calc(var(--pad-x) + var(--safe-l));
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 14px;
      overflow: hidden;
      background: linear-gradient(135deg, var(--bg-primary) 0%, #0a1210 100%);
    }

    /* Skip link for accessibility */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--accent-primary);
      color: #000;
      padding: 8px 16px;
      text-decoration: none;
      border-radius: 0 0 8px 0;
      z-index: 1000;
      transition: top 0.2s;
      font-weight: 500;
    }
    .skip-link:focus {
      top: 0;
    }

    /* Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .water-bg {
      position: fixed;
      inset: 0;
      background: 
        radial-gradient(circle at 20% 30%, rgba(34, 197, 94, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(251, 191, 36, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(34, 197, 94, 0.04) 0%, transparent 50%),
        linear-gradient(180deg, rgba(10, 10, 10, 0.95) 0%, var(--bg-primary) 100%);
      z-index: -1;
      transition: background 0.5s ease;
      pointer-events: none;
    }

    /* Subtle grid overlay for depth */
    .water-bg::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image: 
        linear-gradient(var(--border-light) 1px, transparent 1px),
        linear-gradient(90deg, var(--border-light) 1px, transparent 1px);
      background-size: 40px 40px;
      opacity: 0.03;
      pointer-events: none;
    }

    .serif { 
      font-family: 'Cinzel', serif;
      font-weight: 400;
      letter-spacing: 0.02em;
    }

    .shell {
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
    }

    .middle {
      min-height: 0;
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .portal {
      min-height: 0;
      position: relative;
      overflow: hidden;
      box-sizing: border-box;
      width: min(92vw, 860px);
      height: min(56vh, 540px);
      max-height: 100%;
      margin: 0 auto;
      border-radius: var(--portal-radius);
      border: 1px solid var(--border-medium);
      
      background: 
        radial-gradient(1200px 620px at 30% 18%, rgba(255, 255, 255, 0.08) 0%, transparent 60%),
        radial-gradient(900px 620px at 70% 26%, var(--theme-soft) 0%, transparent 65%),
        radial-gradient(1200px 900px at 50% 120%, rgba(0, 0, 0, 0.9) 0%, transparent 60%),
        linear-gradient(180deg, rgba(255, 255, 255, 0.03) 0%, rgba(0, 0, 0, 0.4) 100%);
      
      box-shadow:
        0 25px 80px rgba(0, 0, 0, 0.5),
        0 8px 20px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.08),
        inset 0 -20px 40px rgba(0, 0, 0, 0.4),
        inset 0 0 0 1px var(--theme-glow);
      
      backdrop-filter: blur(12px);
      display: flex;
      flex-direction: column;
      transform: translateZ(0);
      transition: all 0.2s ease;
      transform-style: preserve-3d;
    }

    /* Breathing animation for idle portal */
    @keyframes breathing {
      0%, 100% { 
        box-shadow:
          0 25px 80px rgba(0, 0, 0, 0.5),
          0 8px 20px rgba(0, 0, 0, 0.3),
          inset 0 1px 0 rgba(255, 255, 255, 0.08),
          inset 0 -20px 40px rgba(0, 0, 0, 0.4),
          inset 0 0 0 1px var(--theme-glow);
      }
      50% { 
        box-shadow:
          0 25px 90px rgba(0, 0, 0, 0.55),
          0 10px 25px rgba(0, 0, 0, 0.35),
          inset 0 1px 0 rgba(255, 255, 255, 0.1),
          inset 0 -15px 35px rgba(0, 0, 0, 0.35),
          inset 0 0 0 1px rgba(34, 197, 94, 0.15);
      }
    }
    
    .portal.idle {
      animation: breathing 6s ease-in-out infinite;
    }

    .portal::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: 
        radial-gradient(400px 200px at 30% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 60%),
        radial-gradient(500px 250px at 70% 30%, rgba(34, 197, 94, 0.08) 0%, transparent 70%);
      opacity: 0.4;
      pointer-events: none;
      z-index: 0;
      mix-blend-mode: overlay;
    }

    .portal::after {
      content: '';
      position: absolute;
      inset: 6px;
      border-radius: inherit;
      border: 1px solid var(--border-light);
      box-shadow: inset 0 0 20px rgba(34, 197, 94, 0.05);
      pointer-events: none;
      z-index: 0;
    }

    .portal > * { 
      position: relative; 
      z-index: 1; 
    }

    .portal.tilt {
      transform: translateY(-1px) rotateX(0.6deg) rotateY(0.3deg);
      box-shadow:
        0 20px 60px rgba(0, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        inset 0 -15px 30px rgba(0, 0, 0, 0.3);
    }

    .ripple-overlay {
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      background: radial-gradient(circle at 50% 60%, var(--theme-soft) 0%, transparent 70%);
      z-index: 0;
    }
    
    .ripple-overlay::before,
    .ripple-overlay::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 60%;
      width: 16px;
      height: 16px;
      transform: translate(-50%, -50%);
      border-radius: 9999px;
      border: 1px solid var(--accent-primary);
      opacity: 0;
    }
    
    .portal.listening .ripple-overlay { 
      opacity: 0.6; 
    }
    
    .portal.listening .ripple-overlay::before {
      animation: pondRipple 1.5s ease-out infinite;
      opacity: 0.7;
    }
    
    .portal.listening .ripple-overlay::after {
      animation: pondRipple 1.5s ease-out infinite;
      animation-delay: 0.4s;
      border-color: rgba(34, 197, 94, 0.5);
      opacity: 0.7;
    }
    
    @keyframes pondRipple {
      0% { 
        width: 16px; 
        height: 16px; 
        opacity: 0.7;
        border-width: 1px;
      }
      70% { 
        width: 500px; 
        height: 500px; 
        opacity: 0.1;
        border-width: 0.5px;
      }
      100% { 
        width: 600px; 
        height: 600px; 
        opacity: 0;
        border-width: 0;
      }
    }

    /* Pulsing animation for loading */
    @keyframes pulse-subtle {
      0%, 100% { 
        opacity: 0.5;
      }
      50% { 
        opacity: 0.8;
      }
    }
    
    .pulse-subtle {
      animation: pulse-subtle 2s ease-in-out infinite;
    }

    @media (max-width: 480px) {
      .portal {
        width: min(94vw, 860px);
        height: min(54vh, 540px);
        border-radius: 24px;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .portal.listening .ripple-overlay::before,
      .portal.listening .ripple-overlay::after { 
        animation: none !important; 
      }
      .portal.idle { 
        animation: none !important; 
      }
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Inputs and buttons with better contrast */
    input, textarea, select {
      background: rgba(255, 255, 255, 0.07) !important;
      border: 1px solid var(--border-medium) !important;
      border-radius: 12px;
      color: var(--text-primary) !important;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      font-weight: 400;
    }
    
    input:focus, textarea:focus, select:focus {
      border-color: var(--accent-primary) !important;
      outline: none;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.15);
      background: rgba(255, 255, 255, 0.1) !important;
    }
    
    input::placeholder {
      color: var(--text-muted) !important;
      opacity: 0.7;
    }

    /* Buttons */
    button {
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      letter-spacing: 0.02em;
      transition: all 0.2s ease;
    }
    
    button:not(:disabled):hover {
      transform: translateY(-1px);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .preset.active {
      border-color: var(--accent-secondary) !important;
      background: rgba(214, 179, 106, 0.08) !important;
      color: var(--accent-secondary) !important;
      font-weight: 600;
    }

    .portal-scroll {
      width: 100%;
      height: 100%;
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
      padding: 12px 16px 20px;
      scrollbar-width: thin;
      scrollbar-color: var(--border-light) transparent;
    }
    
    .portal-scroll::-webkit-scrollbar {
      width: 6px;
    }
    
    .portal-scroll::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .portal-scroll::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 3px;
    }
    
    .portal-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--border-medium);
    }

    .portal-fade {
      position: absolute;
      left: 0; 
      right: 0; 
      bottom: 0;
      height: 60px;
      background: linear-gradient(to bottom, transparent, rgba(10, 10, 10, 0.7));
      pointer-events: none;
      z-index: 2;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .portal.can-scroll .portal-fade { 
      opacity: 1; 
    }

    .scroll-hint {
      font-size: 11px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text-muted);
      display: none;
      align-items: center;
      justify-content: center;
      gap: 10px;
      user-select: none;
      pointer-events: none;
      margin-top: 8px;
      font-weight: 500;
    }
    
    .scroll-hint.show { 
      display: flex; 
    }

    .chev {
      width: 18px; 
      height: 18px;
      border-radius: 9999px;
      border: 1px solid var(--border-light);
      display: flex; 
      align-items: center; 
      justify-content: center;
      opacity: 0.8;
      font-size: 10px;
    }

    body.expanded { 
      overflow: hidden; 
    }
    
    body.expanded .portal {
      height: min(72vh, 720px);
      width: min(94vw, 900px);
    }

    .tap-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      user-select: none;
      margin-bottom: 12px;
    }
    
    .tap-pill {
      font-size: 11px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text-muted);
      border: 1px solid var(--border-light);
      padding: 6px 12px;
      border-radius: 9999px;
      transition: all 0.2s ease;
      font-weight: 500;
      background: rgba(255, 255, 255, 0.03);
    }
    
    .tap-pill:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }
    
    body.expanded .tap-pill {
      color: var(--accent-primary);
      border-color: var(--accent-primary);
      background: rgba(34, 197, 94, 0.1);
    }

    .sheet {
      position: fixed;
      left: 0; 
      right: 0;
      bottom: -75%;
      height: 75%;
      background: rgba(15, 15, 15, 0.98);
      border-top: 1px solid var(--border-medium);
      backdrop-filter: blur(20px);
      transition: bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50;
      padding-bottom: calc(16px + var(--safe-b));
      box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.5);
    }
    
    .sheet.open { 
      bottom: 0; 
    }
    
    .sheet-handle {
      width: 64px; 
      height: 4px;
      border-radius: 9999px;
      background: var(--border-medium);
      margin: 12px auto;
      cursor: pointer;
    }
    
    .sheet-handle:hover {
      background: var(--border-light);
    }

    /* Manual Overlay */
    .manual-overlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 10, 10, 0.95);
      backdrop-filter: blur(20px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }
    
    .manual-overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .manual-content {
      max-width: 480px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-medium);
      border-radius: 20px;
      padding: 32px;
      box-shadow: 0 30px 60px -20px rgba(0, 0, 0, 0.6);
      color: var(--text-primary);
    }
    
    .manual-content h2 {
      font-size: 24px;
      margin-bottom: 16px;
      color: var(--accent-primary);
    }
    
    .manual-content p {
      line-height: 1.6;
      margin-bottom: 16px;
      color: var(--text-secondary);
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-secondary);
      border: 1px solid var(--border-medium);
      border-radius: 12px;
      padding: 14px 24px;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Main content styles */
    .mirror-title {
      color: var(--accent-secondary);
      text-shadow:
        0 2px 12px rgba(214, 179, 106, 0.35),
        0 0 28px rgba(214, 179, 106, 0.15);
      font-weight: 400;
      letter-spacing: 0.22em;
    }
    
    #main-text {
      color: var(--text-primary);
      line-height: 1.7;
      font-size: 19px;
      font-weight: 300;
      font-style: italic;
      margin: 20px 0;
    }
    
    #echo-text {
      color: var(--accent-primary);
      font-weight: 500;
    }
    
    #res-text {
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    #guide-text {
      color: var(--text-muted);
      font-size: 15px;
      line-height: 1.6;
      font-style: italic;
      margin-top: 20px;
    }
    
    /* Preset buttons */
    .preset {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
      padding: 10px 18px;
      border-radius: 9999px;
      font-size: 12px;
      letter-spacing: 0.15em;
      transition: all 0.2s ease;
    }
    
    .preset:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      background: rgba(34, 197, 94, 0.05);
    }
    
    /* Controls at bottom */
    #user-input {
      font-size: 15px;
      padding: 14px 18px;
    }
    
    #reflect-btn {
      background: linear-gradient(135deg, #4fae7a 0%, #3f8f66 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      font-weight: 600;
      letter-spacing: 0.1em;
    }
    
    #reflect-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #63c18e 0%, #4fae7a 100%);
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(79, 174, 122, 0.28);
    }
    
    #reflect-btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    /* Wallet and other buttons */
    #wallet-btn, #voice-btn {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-light);
      color: var(--text-secondary);
    }
    
    #wallet-btn:hover, #voice-btn:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--accent-primary);
      color: var(--accent-primary);
    }
    
    /* History list */
    #history-list {
      color: var(--text-primary);
    }
    
    #history-list div {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    /* Text contrast fixes */
    .text-zinc-400 {
      color: var(--text-muted) !important;
    }
    
    .text-zinc-500 {
      color: var(--text-muted) !important;
      opacity: 0.8;
    }
    
    .text-zinc-300 {
      color: var(--text-secondary) !important;
    }
    
    .text-emerald-400 {
      color: var(--accent-primary) !important;
    }
    
    .text-red-300 {
      color: #f87171 !important;
    }
    
    .text-amber-400 {
      color: var(--accent-secondary) !important;
    }
    
    /* Background fixes */
    .bg-zinc-900\/55 {
      background: rgba(255, 255, 255, 0.05) !important;
    }
    
    .bg-zinc-900\/80 {
      background: rgba(255, 255, 255, 0.08) !important;
    }
    
    .bg-zinc-800 {
      background: rgba(255, 255, 255, 0.1) !important;
    }
    
    /* Loading state */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    /* Focus styles for accessibility */
    *:focus {
      outline: 2px solid var(--accent-primary);
      outline-offset: 2px;
    }
    
    *:focus:not(:focus-visible) {
      outline: none;
    }
    
    *:focus-visible {
      outline: 2px solid var(--accent-primary);
      outline-offset: 2px;
    }
    
    /* Selection color */
    ::selection {
      background: rgba(34, 197, 94, 0.3);
      color: var(--text-primary);
    }
    
    ::-moz-selection {
      background: rgba(34, 197, 94, 0.3);
      color: var(--text-primary);
    }

    /* Settings panel */
    .settings-panel {
      position: fixed;
      right: -320px;
      top: 0;
      bottom: 0;
      width: 300px;
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-medium);
      backdrop-filter: blur(20px);
      padding: 24px;
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 999;
      overflow-y: auto;
      box-shadow: -20px 0 60px rgba(0, 0, 0, 0.4);
    }
    
    .settings-panel.open {
      right: 0;
    }
    
    .settings-panel h3 {
      color: var(--text-primary);
      font-size: 18px;
      margin-bottom: 24px;
    }
    
    .settings-panel h4 {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 12px;
      font-weight: 600;
    }

    /* Theme buttons */
    .theme-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 2px solid transparent;
      margin: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .theme-btn:hover {
      transform: scale(1.1);
      border-color: var(--border-light);
    }
    
    .theme-btn.active {
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    }
    
    .theme-soft {
      background: linear-gradient(135deg, #0f766e, #047857);
    }
    
    .theme-dark {
      background: linear-gradient(135deg, #1e293b, #0f172a);
    }
    
    .theme-warm {
      background: linear-gradient(135deg, #78350f, #451a03);
    }

    /* Switch toggle */
    .switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.1);
      transition: .4s;
      border-radius: 34px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--accent-primary);
    }
    
    input:checked + .slider:before {
      transform: translateX(24px);
    }

    /* Favorite button */
    .favorite-btn {
      color: var(--text-muted);
      transition: all 0.2s ease;
      font-size: 24px;
    }
    
    .favorite-btn:hover {
      color: var(--accent-secondary);
      transform: scale(1.1);
    }
    
    .favorite-btn.active {
      color: var(--accent-secondary);
      text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
    }

    /* Error message */
    #err {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 12px 16px;
      color: #fca5a5;
      font-size: 13px;
    }
  
    /* History filter active + counts */
    .filter-active-all { color: var(--accent-primary) !important; }
    .filter-active-fav { color: var(--accent-secondary) !important; }

</style>
</head>

<body>
  <!-- Accessibility skip link -->
  <a href="#portal" class="skip-link">Skip to main content</a>
  <span id="input-hint" class="sr-only">Type your question and press Enter or click Reflect</span>

  <!-- Background -->
  <div class="water-bg"></div>

  <!-- Toast for notifications -->
  <div id="toast" class="toast"></div>

  <!-- Manual overlay -->
  <div id="manual" class="manual-overlay">
    <div class="manual-content">
      <h2 class="serif">The Covenant</h2>
      <p>This pond reflects what you bring to it. Speak your truth, and the waters will answer.</p>
      <p style="font-size: 13px; opacity: 0.8;">Your reflections are stored locally. No data is sent to external servers unless you explicitly ask the Mirror.</p>
      <button id="manual-accept" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 py-3 rounded-lg transition mt-6 font-semibold">
        Enter the Pond
      </button>
    </div>
  </div>

  <!-- Settings panel -->
  <div id="settings-panel" class="settings-panel">
    <div class="flex justify-between items-center mb-8">
      <h3 class="serif">Settings</h3>
      <button id="close-settings" class="text-zinc-400 hover:text-white text-xl">‚úï</button>
    </div>
    
    <div class="space-y-8">
      <!-- Theme UI hidden for v0\.2 \(locked to Pond Classic\) -->

      <div>
        <h4>Themes</h4>
        <p class="text-sm text-zinc-500 leading-relaxed">
          The Pond uses a curated visual language.<br/>
          Additional states of water may arrive in future releases.
        </p>
      </div>

      <div>
        <h4>Wallet (Read-only)</h4>
        <p class="text-sm text-zinc-500 leading-relaxed">
          Connect to view your address in the Pond. No signing. No transactions.
        </p>
        <div class="flex gap-3 mt-3">
          <button id="wallet-connect" class="flex-1 text-sm border border-zinc-700 hover:border-green-500 hover:text-green-400 py-3 rounded-lg transition">
            Connect
          </button>
          <button id="wallet-disconnect" class="flex-1 text-sm border border-zinc-800 text-zinc-400 hover:text-zinc-200 py-3 rounded-lg transition hidden">
            Disconnect
          </button>
        </div>
        <div id="wallet-meta" class="mt-3 text-sm text-zinc-500 hidden">
          <div><span class="text-zinc-400">Address:</span> <span id="wallet-address" class="text-zinc-200"></span></div>
          <div class="mt-1"><span class="text-zinc-400">Chain:</span> <span id="wallet-chain" class="text-zinc-200"></span></div>
        </div>
      </div>

      <div>
        <h4>Favorites</h4>
        <button id="export-fav" class="w-full text-sm border border-zinc-700 hover:border-amber-500 hover:text-amber-400 py-3 rounded-lg transition mt-3">
          Export ‚òÖ Favorites
        </button>
      </div>

</div>
      
      <div>
        <h4>History</h4>
        <button id="export-history" class="w-full text-sm border border-zinc-700 hover:border-green-500 hover:text-green-400 py-3 rounded-lg transition mt-3">
          Export Reflections
        </button>
      </div>
      
      <div class="pt-6 border-t border-zinc-800">
        <button id="clear-all-data" class="w-full text-sm text-red-400 hover:text-red-300 py-3">
          Clear All Data
        </button>
      </div>
    </div>
  </div>

  <!-- Top bar -->
  <div class="shell w-full z-10">
    <div class="w-full flex items-center justify-between gap-3">
      <div class="text-[12px] uppercase tracking-widest text-zinc-500 font-medium">
        POND ¬∑ v0.2
      </div>
      <div class="flex items-center gap-3">

        <!-- Voice ritual (v0.3+): return Speak as a sacred hold-to-whisper action -->
<button id="settings-btn"
          class="px-4 py-2 text-[11px] uppercase tracking-widest rounded font-medium"
          title="Settings">
          ‚öôÔ∏è Settings
        </button>
        <span id="base-badge" class="px-3 py-2 text-[11px] uppercase tracking-widest rounded font-medium hidden" style="border:1px solid rgba(214,179,106,0.5); color: var(--accent-secondary); background: rgba(214,179,106,0.10);">Base</span>
        <button id="wallet-btn"
          class="px-4 py-2 text-[11px] uppercase tracking-widest rounded font-medium">
          Connect Wallet
        </button>
      </div>
    </div>
  </div>

  <!-- Main portal -->
  <div class="middle">
    <div class="portal text-center" id="portal">
      <div class="ripple-overlay"></div>
      <div class="portal-fade" id="portal-fade"></div>

      <div class="portal-scroll" id="portal-scroll">
        <div class="tap-header" id="tap-header" title="Tap to expand / collapse">
          <div class="tap-pill">Tap to Expand</div>
        </div>

        <div class="pt-1" id="title-tap-zone" title="Tap to expand / collapse">
          <h1 class="serif mirror-title text-3xl tracking-[0.2em] mb-2">MIRROR</h1>
          <p class="serif text-[12px] tracking-widest text-zinc-400 font-light">The Digital Pond</p>
        </div>

        <!-- Preset questions -->
        <div class="preset-buttons w-full max-w-xl mt-6 mx-auto flex flex-wrap justify-center items-center gap-3">
          <button class="preset" data-text="Mirror, what does stillness mean for me today?">
            Stillness
          </button>
          <button class="preset" data-text="How do I practice patience when nothing moves?">
            Patience
          </button>
          <button class="preset" data-text="What does it mean to become who I already am?">
            Becoming
          </button>
          <button class="preset" data-text="Explain: Toby is the people, and the people is Toby. What does it ask of me?">
            Toby = People
          </button>
        </div>

        <!-- Scroll hint -->
        <div id="scroll-hint" class="scroll-hint mt-4">
          <span class="chev">‚åÑ</span>
          <span>Swipe to read</span>
          <span class="chev">‚åÉ</span>
        </div>

        <!-- Reflection output -->
        <div id="reflection-output" class="space-y-6 opacity-0 transition-opacity duration-500 mt-8">
          <!-- Favorite button -->
          <div class="flex justify-end">
            <button id="favorite-btn" class="favorite-btn" title="Add to favorites">
              ‚òÜ
            </button>
          </div>

          <p id="main-text" class="italic">
            "Stillness yields truth."
          </p>

          <div class="space-y-2 text-[11px] uppercase tracking-widest font-medium">
            <p id="echo-text" class="text-emerald-400">Echo: Stillness yields truth</p>
            <p id="res-text" class="text-zinc-400">Resonance: Roots deepen.</p>
          </div>

          <p id="guide-text" class="text-[14px] italic">
            What remains when urgency leaves?
          </p>
<div class="pt-8 text-2xl opacity-70">
            ‚è≥ ‚âã üçÉ ü™û
          </div>
        </div>

        <!-- Error message -->
        <div id="err" class="mt-6 hidden">
          The pond could not hear the ocean. Check endpoint health.
        </div>

        <div style="height: 32px;"></div>
      </div>
    </div>
  </div>

  <!-- Bottom controls -->
  <div class="shell w-full z-10 space-y-4" style="flex-direction: column; align-items: stretch;">
    <div class="flex gap-3">
      <input id="user-input" type="text" 
             placeholder="Inquire the Pond (Type your question‚Ä¶ Press Enter to reflect)"
             class="flex-grow"
             aria-label="Your inquiry" />
      <button id="reflect-btn"
        class="px-8 uppercase tracking-widest rounded-lg font-semibold"
        aria-label="Reflect">
        Reflect
      </button>
    </div>

    <div class="flex justify-between items-center text-[11px] uppercase tracking-widest font-medium">
      <div class="flex items-center gap-3">
        <span class="text-zinc-500">üçÉ <span id="leaves">Leaves of Stillness: 0</span></span>
        <span id="favorite-count" class="text-amber-400 hidden">‚òÖ 0</span>
      </div>
      <div class="flex items-center gap-6">
        <button id="history-btn" class="hover:text-green-400 transition">History ‚Üü</button>
        <button id="basescan-btn" class="hover:text-green-400 transition">BaseScan ‚Üó</button>
      </div>
    </div>
  </div>

  <!-- History sheet -->
  <div id="sheet" class="sheet">
    <div class="sheet-handle"></div>
    <div class="px-6 pb-6 flex items-center justify-between">
      <div class="text-sm uppercase tracking-widest text-zinc-400 font-medium">Reflection History</div>
      <div class="flex gap-3 text-[11px] uppercase tracking-widest font-medium">
        <button id=\"filter-all\" class=\"text-zinc-500 hover:text-green-400 transition\">All <span id=\"count-all\" class=\"opacity-70\"></span></button>
        <button id=\"filter-fav\" class=\"text-zinc-500 hover:text-amber-400 transition\">‚òÖ <span id=\"count-fav\" class=\"opacity-70\"></span></button>
      </div>
      <div class="flex gap-4">
        <button id="search-history" class="text-zinc-500 hover:text-green-400 transition text-lg" title="Search">
          üîç
        </button>
        <button id="clear-history" class="text-[11px] uppercase tracking-widest text-zinc-500 hover:text-red-400 transition font-medium">Clear</button>
        <button id="close-sheet" class="text-[11px] uppercase tracking-widest text-zinc-500 hover:text-green-400 transition font-medium">Close</button>
      </div>
    </div>
    <div id="history-list" class="px-6 overflow-auto" style="height: calc(75% - 70px);"></div>
  </div>

  <script>
    // Simplified version focusing on readability and eye comfort
    const state = {
      currentTheme: 'soft',
      soundsEnabled: true,
      favorites: new Set(),
      voiceActive: false
    };

    // --- Hidden Theme Engine (v0.2 locked UI, but engine remains) ---
    const THEMES = {
      classic: {
        "--bg-primary": "#0b0f0c",
        "--bg-secondary": "#101614",
        "--text-primary": "#f3f4f2",
        "--text-secondary": "#d1d5cf",
        "--text-muted": "#9aa39a",
        "--accent-primary": "#4fae7a",
        "--accent-secondary": "#d6b36a",
        "--border-light": "rgba(255, 255, 255, 0.08)",
        "--border-medium": "rgba(255, 255, 255, 0.14)",
        "--theme-soft": "rgba(79, 174, 122, 0.18)",
        "--theme-glow": "rgba(79, 174, 122, 0.12)"
      },
      soft: {
        "--bg-primary": "#0b0f0c",
        "--bg-secondary": "#101614",
        "--text-primary": "#f3f4f2",
        "--text-secondary": "#d1d5cf",
        "--text-muted": "#9aa39a",
        "--accent-primary": "#5cc69a",
        "--accent-secondary": "#d6b36a",
        "--border-light": "rgba(255, 255, 255, 0.08)",
        "--border-medium": "rgba(255, 255, 255, 0.14)",
        "--theme-soft": "rgba(92, 198, 154, 0.16)",
        "--theme-glow": "rgba(92, 198, 154, 0.10)"
      },
      night: {
        "--bg-primary": "#070b09",
        "--bg-secondary": "#0e1412",
        "--text-primary": "#f3f4f2",
        "--text-secondary": "#d1d5cf",
        "--text-muted": "#9aa39a",
        "--accent-primary": "#3f8f66",
        "--accent-secondary": "#e0c07a",
        "--border-light": "rgba(255, 255, 255, 0.07)",
        "--border-medium": "rgba(255, 255, 255, 0.13)",
        "--theme-soft": "rgba(63, 143, 102, 0.14)",
        "--theme-glow": "rgba(63, 143, 102, 0.10)"
      }
    };

    function applyTheme(name){
      const vars = THEMES[name];
      if(!vars) return;
      Object.entries(vars).forEach(([k,v]) => {
        document.documentElement.style.setProperty(k, v);
      });
      try{ localStorage.setItem("mirror_theme", name); }catch(e){}
    }

    function loadTheme(){
      try{
        const t = localStorage.getItem("mirror_theme") || "classic";
        applyTheme(t);
      }catch(e){
        applyTheme("classic");
      }
    }

    
    // DOM Elements
    const elements = {
      manual: document.getElementById('manual'),
      manualAccept: document.getElementById('manual-accept'),
      portal: document.getElementById('portal'),
      portalScroll: document.getElementById('portal-scroll'),
      scrollHint: document.getElementById('scroll-hint'),
      input: document.getElementById('user-input'),
      output: document.getElementById('reflection-output'),
      err: document.getElementById('err'),
      reflectBtn: document.getElementById('reflect-btn'),
      favoriteBtn: document.getElementById('favorite-btn'),
      favoriteCount: document.getElementById('favorite-count'),
      leavesEl: document.getElementById('leaves'),
      historyBtn: document.getElementById('history-btn'),
      sheet: document.getElementById('sheet'),
      historyList: document.getElementById('history-list'),
      settingsPanel: document.getElementById('settings-panel'),
      settingsBtn: document.getElementById('settings-btn'),
      closeSettings: document.getElementById('close-settings'),
      themeButtons: document.querySelectorAll('.theme-btn'),
      toast: document.getElementById('toast')
    };
    // --- API integration (ported from the old pond) ---
    const DEFAULT_API_URL = "https://toadaid.duckdns.org/ask";

    function resolveApiUrl(){
      try{
        const p = new URLSearchParams(window.location.search);
        const v = p.get("api");
        return (v && v.trim()) ? v.trim() : DEFAULT_API_URL;
      }catch(e){
        return DEFAULT_API_URL;
      }
    }

    let API_URL = resolveApiUrl();

    function isOpenAIChatCompletions(url){
      try{ return String(url || "").includes("/v1/chat/completions"); }catch(e){ return false; }
    }

    function resolveTimeoutMs(){
      try{
        const p = new URLSearchParams(window.location.search);
        const v = p.get("timeout");
        const n = v ? Number(v) : NaN;
        if(Number.isFinite(n) && n >= 3000 && n <= 180000) return Math.floor(n);
      }catch(e){}
      return 45000;
    }

    const TIMEOUT_MS = resolveTimeoutMs();

    function stripTravelerPrefix(s){
      return String(s || "").replace(/^\s*traveler[,Ôºö:]?\s*/i, "").trim();
    }

    function parseMirrorAnswer(raw){
      let text = String(raw || "").trim();
      text = text.replace(/[ü™ûüåäüçÉüåÄ‚öõÔ∏è‚âã‚è≥]+$/g, "").trim();

      let guide = "";
      const gMatch = text.match(/Guiding Question:\s*([\s\S]*)$/i);
      if(gMatch){
        guide = gMatch[1].trim();
        text = text.slice(0, gMatch.index).trim();
      }

      let resonance = "";
      const rMatch = text.match(/Reflection Resonance:\s*([\s\S]*)$/i);
      if(rMatch){
        resonance = rMatch[1].trim();
        text = text.slice(0, rMatch.index).trim();
      }

      const main = stripTravelerPrefix(text);

      return {
        main: main || "Stillness yields truth.",
        resonance: resonance || "Roots deepen.",
        guide: guide || "What remains when urgency leaves?"
      };
    }

    function localFallback(q){
      const val = String(q || "").toLowerCase();
      if(val.includes("price") || val.includes("money") || val.includes("pump") || val.includes("moon")){
        return {
          main: "The pond does not track the price of ghosts.",
          echo: "Echo: Canon Shield Active",
          res:  "Resonance: Attention released.",
          guide:"What would you ask if no number could save you?"
        };
      }
      return {
        main: "Every frantic move is a debt to time.",
        echo: "Echo: Stillness yields truth",
        res:  "Resonance: Roots deepen.",
        guide:"What remains when urgency leaves?"
      };
    }

    async function askAPI(question){
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), TIMEOUT_MS);

      try{
        if(isOpenAIChatCompletions(API_URL)){
          const payload = {
            model: "local-mirror",
            messages: [
              { role: "system", content: "You are the Mirror. Answer with calm, reflective tone. Include 'Reflection Resonance:' and end with one 'Guiding Question:'." },
              { role: "user", content: question }
            ],
            max_tokens: 512,
            temperature: 0.75,
            top_p: 0.9,
            stream: false,
            stop: ["</s>", "<|endoftext|>", "USER:", "###"]
          };

          const r = await fetch(API_URL, {
            method: "POST",
            mode: "cors",
            cache: "no-store",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(payload),
            signal: controller.signal
          });

          if(r.status === 429){
            const err = new Error("QUEUE_BUSY");
            err.code = 429;
            throw err;
          }
          if(!r.ok) throw new Error("HTTP " + r.status);
          return await r.json();
        }

        const payload = { question, user: "miniapp" };
        const r = await fetch(API_URL, {
          method: "POST",
          mode: "cors",
          cache: "no-store",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        if(r.status === 429){
          const err = new Error("QUEUE_BUSY");
          err.code = 429;
          throw err;
        }
        if(!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } finally {
        clearTimeout(t);
      }
    }

    function normalizeAnswer(data){
      if(typeof data === "string") return data;
      const openai = data?.choices?.[0]?.message?.content;
      if(openai) return openai;
      return data?.answer || data?.unified_answer || data?.text || data?.response || "";
    }

    // --- Wallet (read-only) + Favorites Export + History Polish (v0.2) ---
    const WALLET_KEY = "mirror_wallet_connected";

    function shortAddr(a){
      if(!a) return "";
      return a.slice(0,6) + "‚Ä¶" + a.slice(-4);
    }

    async function getChainId(){
      const cid = await window.ethereum.request({ method: 'eth_chainId' });
      return cid;
    }

    function chainLabel(chainIdHex){
      try{
        const n = parseInt(chainIdHex, 16);
        if(n === 8453) return "Base (8453)";
        if(n === 84532) return "Base Sepolia (84532)";
        return String(n);
      }catch(e){
        return chainIdHex || "Unknown";
      }
    
    function isBaseChain(chainIdHex){
      try{
        const n = parseInt(chainIdHex, 16);
        return n === 8453;
      }catch(e){
        return false;
      }
    }

    function updateBaseBadge(chainIdHex){
      const badge = document.getElementById('base-badge');
      if(!badge) return;
      if(isBaseChain(chainIdHex)){
        badge.classList.remove('hidden');
        badge.textContent = "Base";
      }else{
        badge.classList.add('hidden');
      }
    }
}

    async function walletConnect(){
      if(!window.ethereum){
        showToast("No wallet detected");
        return;
      }
      try{
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const addr = (accounts && accounts[0]) ? accounts[0] : "";
        if(!addr){
          showToast("No account");
          return;
        }
        const chainId = await getChainId();
        document.getElementById('wallet-address').textContent = addr;
        document.getElementById('wallet-chain').textContent = chainLabel(chainId);
          updateBaseBadge(chainId);
        updateBaseBadge(chainId);
        document.getElementById('wallet-meta').classList.remove('hidden');
        document.getElementById('wallet-connect').classList.add('hidden');
        document.getElementById('wallet-disconnect').classList.remove('hidden');

        // also update top bar button label (non-invasive)
        const topBtn = document.getElementById('wallet-btn');
        if(topBtn) topBtn.textContent = shortAddr(addr);

        try{ localStorage.setItem(WALLET_KEY, "1"); }catch(e){}
        showToast("Wallet connected");
      }catch(e){
        showToast("Connect canceled");
      }
    }

    function walletDisconnect(){
      document.getElementById('wallet-meta').classList.add('hidden');
      document.getElementById('wallet-connect').classList.remove('hidden');
      document.getElementById('wallet-disconnect').classList.add('hidden');
      const topBtn = document.getElementById('wallet-btn');
      if(topBtn) topBtn.textContent = "Connect Wallet";
      updateBaseBadge('0x0');
      try{ localStorage.removeItem(WALLET_KEY); }catch(e){}
      showToast("Disconnected");
    }

    async function walletRestore(){
      try{
        const was = localStorage.getItem(WALLET_KEY) === "1";
        if(!was || !window.ethereum) return;
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if(accounts && accounts[0]){
          const addr = accounts[0];
          const chainId = await getChainId();
          document.getElementById('wallet-address').textContent = addr;
          document.getElementById('wallet-chain').textContent = chainLabel(chainId);
        updateBaseBadge(chainId);
          document.getElementById('wallet-meta').classList.remove('hidden');
          document.getElementById('wallet-connect').classList.add('hidden');
          document.getElementById('wallet-disconnect').classList.remove('hidden');
          const topBtn = document.getElementById('wallet-btn');
          if(topBtn) topBtn.textContent = shortAddr(addr);
        }
      }catch(e){}
    }

    function getHistory(){
      try{ return JSON.parse(localStorage.getItem('mirror_history') || '[]'); }catch(e){ return []; }
    }

    function updateCounts(){
      const h = getHistory();
      const all = h.length;
      const fav = h.filter(x => x.fav).length;
      const ca = document.getElementById('count-all');
      const cf = document.getElementById('count-fav');
      if(ca) ca.textContent = all ? `(${all})` : '';
      if(cf) cf.textContent = fav ? `(${fav})` : '';

      // bottom tiny badge (optional existing element)
      const fc = document.getElementById('favorite-count');
      if(fc){
        if(fav > 0){
          fc.classList.remove('hidden');
          fc.textContent = `‚òÖ ${fav}`;
        }else{
          fc.classList.add('hidden');
        }
      }
    }

    function setFilterActive(filter){
      const a = document.getElementById('filter-all');
      const f = document.getElementById('filter-fav');
      if(a) a.classList.toggle('filter-active-all', filter === 'all');
      if(f) f.classList.toggle('filter-active-fav', filter === 'fav');
    }

    function downloadText(filename, text){
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportFavorites(){
      const favs = getHistory().filter(x => x.fav);
      if(!favs.length){
        showToast("No favorites to export");
        return;
      }
      const lines = [];
      lines.push("TOBYWORLD MIRROR ‚Äî Marked Reflections (‚òÖ)");
      lines.push("");
      favs.forEach(item => {
        lines.push(`‚òÖ ${new Date(item.ts).toLocaleString()}`);
        lines.push(`Q: ${item.q}`);
        lines.push(`A: ${item.a}`);
        lines.push("");
      });
      downloadText("mirror_favorites_scroll.txt", lines.join("
"));
      showToast("Exported ‚òÖ scroll");
    }

    // Initialize
    function init() {
      loadLeaves();
      
      loadTheme();
      walletRestore();
      updateCounts();
initManual();
      initEventListeners();
      
      // Add idle animation after delay
      setTimeout(() => {
        elements.portal.classList.add('idle');
      }, 1000);
      
      // Show initial text
      setTimeout(() => {
        elements.output.style.opacity = '1';
      }, 300);
    }
    
    // Toast notifications
    function showToast(message, duration = 3000) {
      elements.toast.textContent = message;
      elements.toast.classList.add('show');
      
      setTimeout(() => {
        elements.toast.classList.remove('show');
      }, duration);
    }
    
    // Manual overlay
    function initManual() {
      try {
        const accepted = localStorage.getItem('mirror_accepted') === 'yes';
        if (!accepted) {
          elements.manual.classList.add('active');
        }
      } catch (e) {
        elements.manual.classList.add('active');
      }
    }
    
    function acceptCovenant() {
      localStorage.setItem('mirror_accepted', 'yes');
      elements.manual.classList.remove('active');
      showToast('Welcome to the Pond');
    }
    
    // Leaves counter
    function loadLeaves() {
      const n = Number(localStorage.getItem('mirror_leaves') || '0');
      elements.leavesEl.textContent = `Leaves of Stillness: ${n}`;
    }
    
    function incLeaves() {
      const n = Number(localStorage.getItem('mirror_leaves') || '0') + 1;
      localStorage.setItem('mirror_leaves', String(n));
      elements.leavesEl.textContent = `Leaves of Stillness: ${n}`;
    }
    
    // Event listeners
    function initEventListeners() {
      // Manual
      elements.manualAccept?.addEventListener('click', acceptCovenant);
      
      // Settings
      elements.settingsBtn?.addEventListener('click', () => {
        elements.settingsPanel.classList.add('open');
      });
      
      elements.closeSettings?.addEventListener('click', () => {
        elements.settingsPanel.classList.remove('open');
      });
      
      // Theme switching (UI hidden in v0.2, engine remains)
      if (elements.themeButtons && elements.themeButtons.length) {
        elements.themeButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            elements.themeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const name = btn.dataset.theme || 'classic';
            applyTheme(name);
            showToast(`Theme: ${name}`);
          });
        });
      }

      // Portal interactions
      elements.portal.addEventListener("pointerdown", () => elements.portal.classList.add("tilt"));
      elements.portal.addEventListener("pointerup", () => elements.portal.classList.remove("tilt"));
      elements.portal.addEventListener("pointercancel", () => elements.portal.classList.remove("tilt"));
      
      // Expand/collapse
      document.getElementById('tap-header')?.addEventListener('click', toggleExpanded);
      document.getElementById('title-tap-zone')?.addEventListener('click', toggleExpanded);
      
      // Preset buttons
      document.querySelectorAll('.preset').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.preset').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const text = btn.getAttribute('data-text') || '';
          elements.input.value = text;
          elements.input.focus();
        processInquiry(text);
          });
      });
      
      // Reflect button
      elements.reflectBtn?.addEventListener('click', () => processInquiry());
      elements.input?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') processInquiry();
      });
      
      // History
      elements.historyBtn?.addEventListener('click', () => {
        renderHistory('all');
        elements.sheet.classList.add('open');
      });
      
      document.getElementById('filter-all')?.addEventListener('click', () => renderHistory('all'));
      document.getElementById('filter-fav')?.addEventListener('click', () => renderHistory('fav'));

      document.getElementById('close-sheet')?.addEventListener('click', () => {
        elements.sheet.classList.remove('open');
      });
      
      document.getElementById('clear-history')?.addEventListener('click', () => {
        if (confirm('Clear all reflection history?')) {
          localStorage.removeItem('mirror_history');
          renderHistory('all');
          updateCounts();
          showToast('History cleared');
        }
      });
      
      // Favorite (per-reflection; persists to history[0].fav)
      elements.favoriteBtn?.addEventListener('click', () => {
        const btn = elements.favoriteBtn;
        const isNowFav = !btn.classList.contains('active');
        btn.classList.toggle('active', isNowFav);
        btn.textContent = isNowFav ? '‚òÖ' : '‚òÜ';
        btn.dataset.marked = isNowFav ? '1' : '0';
        showToast(isNowFav ? 'Marked as favorite' : 'Unmarked');

        // Persist to most recent history entry
        try {
          const KEY = 'mirror_history';
          const history = JSON.parse(localStorage.getItem(KEY) || '[]');
          if (history.length > 0) {
            history[0].fav = isNowFav;
            localStorage.setItem(KEY, JSON.stringify(history));
            updateCounts();
          }
        } catch (e) {}
      });
      // (Share/Follow-up removed in v0.2)


      
      // Wallet
      document.getElementById('wallet-btn')?.addEventListener('click', () => {
        showToast('Wallet connection coming soon');
      });
      // (Voice removed in v0.2)


      
      // Scroll handling
      elements.portalScroll.addEventListener('scroll', updateScrollAffordance, { passive: true });
      window.addEventListener('resize', () => requestAnimationFrame(updateScrollAffordance));
    }
    
    // Expand/collapse
    let expanded = false;
    function toggleExpanded() {
      expanded = !expanded;
      document.body.classList.toggle('expanded', expanded);
      const pill = document.querySelector('.tap-pill');
      if (pill) pill.textContent = expanded ? 'Tap to Collapse' : 'Tap to Expand';
      requestAnimationFrame(updateScrollAffordance);
    }
    
    // Scroll affordance
    function updateScrollAffordance() {
      const over = (elements.portalScroll.scrollHeight - elements.portalScroll.clientHeight) > 16;
      elements.scrollHint.classList.toggle('show', over);
      elements.portal.classList.toggle('can-scroll', over);
    }
    
    
    // --- Live reflection: call API (old logic, new UI) ---
    async function processInquiry(qOverride){
      const q = (qOverride ?? elements.input.value).trim();
      if(!q) return;

      elements.portal.classList.add('listening');
      elements.reflectBtn.disabled = true;
      elements.reflectBtn.textContent = 'Listening...';
      elements.output.style.opacity = '0.65';
      elements.err.classList.add('hidden');

      const maxAttempts = 4;
      let attempt = 0;

      try{
        while(true){
          attempt += 1;
          try{
            const data = await askAPI(q);
            const a = normalizeAnswer(data);
            const parsed = a ? parseMirrorAnswer(a) : null;

            const out = parsed ? {
              main: parsed.main,
              echo: "Echo: " + (parsed.main.split(' ').slice(0, 6).join(' ') + (parsed.main.split(' ').length > 6 ? "..." : "")),
              res:  "Resonance: " + parsed.resonance,
              guide: parsed.guide
            } : localFallback(q);

            document.getElementById('main-text').textContent = `‚Äú${out.main}‚Äù`;
            document.getElementById('echo-text').textContent = out.echo;
            document.getElementById('res-text').textContent = out.res;
            document.getElementById('guide-text').textContent = out.guide;

            try{
              const KEY_HISTORY = "mirror_history";
              const history = JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]");
              history.unshift({ ts: Date.now(), q, a: out.main, fav: false });
              localStorage.setItem(KEY_HISTORY, JSON.stringify(history.slice(0, 30)));
              updateCounts();
            }catch(e){}

            incLeaves();
            // reset favorite for the next reflection (never auto-mark)
            if (elements.favoriteBtn) {
              elements.favoriteBtn.classList.remove('active');
              elements.favoriteBtn.textContent = '‚òÜ';
              elements.favoriteBtn.dataset.marked = '0';
            }
            showToast('Reflection received');

            elements.portalScroll.scrollTop = 0;
            updateScrollAffordance();

            elements.input.value = '';
            elements.output.style.opacity = '1';
            break;
          }catch(e){
            const isQueue = (e && (e.code === 429 || String(e.message||"") === "QUEUE_BUSY"));
            const isAbort = (e && String(e.name||"") === "AbortError");

            if((isQueue || isAbort) && attempt < maxAttempts){
              document.getElementById('main-text').textContent = `‚ÄúThe pond is busy‚Ä¶ waiting (${attempt}/${maxAttempts})‚Äù`;
              document.getElementById('echo-text').textContent = "Echo: Hold your breath.";
              document.getElementById('res-text').textContent = "Resonance: Patience in motion.";
              document.getElementById('guide-text').textContent = "What changes when you allow time to work for you?";
              elements.output.style.opacity = '1';

              const delay = Math.min(600 * Math.pow(2, attempt-1), 3500);
              await new Promise(r => setTimeout(r, delay));
              continue;
            }

            const msg = String(e && e.message ? e.message : "");
            const isNetwork = (!navigator.onLine) || msg.includes("Failed to fetch") || msg.includes("NetworkError") || msg.includes("fetch") || msg.includes("ECONN");
            const out = localFallback(q);

            if(isNetwork){
              // Calm offline fallback (no red error, keep the pond quiet)
              document.getElementById('main-text').textContent = `‚ÄúThe pond is quiet right now.‚Äù`;
              document.getElementById('echo-text').textContent = "Echo: Return when the connection steadies.";
              document.getElementById('res-text').textContent  = "Resonance: Stillness holds even without signal.";
              document.getElementById('guide-text').textContent = "What can you hold gently until the pond returns?";
              elements.err.classList.add('hidden');
              elements.output.style.opacity = '1';
              showToast("Offline ‚Äî showing calm fallback");
              break;
            }

            document.getElementById('main-text').textContent = `‚Äú${out.main}‚Äù`;
            document.getElementById('echo-text').textContent = out.echo;
            document.getElementById('res-text').textContent  = out.res;
            document.getElementById('guide-text').textContent = out.guide;


            elements.err.classList.remove('hidden');
            elements.output.style.opacity = '1';
            break;
          }
        }
      } finally {
        elements.portal.classList.remove('listening');
        elements.reflectBtn.disabled = false;
        elements.reflectBtn.textContent = 'Reflect';
      }
    }

    
    // History rendering (supports filter: 'all' | 'fav')
    function renderHistory(filter = 'all') {
      setFilterActive(filter);
      updateCounts();
      try {
        const history = JSON.parse(localStorage.getItem('mirror_history') || '[]');
        const list = (filter === 'fav') ? history.filter(h => h.fav) : history;

        if (!list.length) {
          elements.historyList.innerHTML = `
            <div class="text-center py-12">
              <div class="text-zinc-500 mb-2">No reflections yet</div>
              <div class="text-xs text-zinc-600">${filter === 'fav' ? 'Your marked reflections will appear here' : 'Your first inquiry will appear here'}</div>
            </div>`;
          return;
        }

        elements.historyList.innerHTML = list.map(item => `
          <div class="py-5 border-b border-zinc-800">
            <div class="flex justify-between items-start mb-3">
              <div class="text-xs text-zinc-500">${new Date(item.ts).toLocaleString()}</div>
              ${item.fav ? '<span class="text-amber-400">‚òÖ</span>' : ''}
            </div>
            <div class="text-sm text-zinc-300 mb-2">${escapeHtml(item.q)}</div>
            <div class="text-sm italic text-green-300">"${escapeHtml(item.a)}"</div>
          </div>
        `).join('');
      } catch (e) {
        elements.historyList.innerHTML = `<div class="text-red-400 text-sm py-6">Could not load history</div>`;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
// Initialize
    document.addEventListener('DOMContentLoaded', init);
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>