<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Mirror | The Digital Pond</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400&display=swap');

    :root{
      --safe-t: env(safe-area-inset-top);
      --safe-b: env(safe-area-inset-bottom);
      --safe-l: env(safe-area-inset-left);
      --safe-r: env(safe-area-inset-right);

      --pad-top: calc(14px + var(--safe-t));
      --pad-bot: calc(18px + var(--safe-b));
      --pad-x: 16px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background-color: #030303;
      color: #d1d1d1;
      font-family: 'Inter', sans-serif;
      overflow: hidden; 
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    body{
      padding: var(--pad-top) calc(var(--pad-x) + var(--safe-r)) var(--pad-bot) calc(var(--pad-x) + var(--safe-l));
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 14px;
      overflow: hidden;
    }

    .water-bg{
      position: fixed;
      inset: 0;
      background:
        radial-gradient(1200px 800px at 50% 35%, rgba(16,185,129,0.06), transparent 55%),
        radial-gradient(900px 600px at 50% 70%, rgba(255,255,255,0.03), transparent 60%),
        linear-gradient(rgba(0,0,0,0.92), rgba(0,0,0,0.98));
      z-index: -1;
    }

    .serif { font-family: 'Cinzel', serif; }

    .shell{
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
    }

    .middle{
      min-height: 0;
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .portal{
      position: relative;
      overflow: hidden;           
      box-sizing: border-box;

      width: 100%;
      max-width: min(720px, calc(100vw - 32px));
      max-height: calc(100% - 8px); 
      height: 100%;

      border-radius: 26px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.42);
      backdrop-filter: blur(8px);
      box-shadow: 0 0 100px rgba(0,0,0,0.8);

      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .portal::after{
      content:'';
      position:absolute;
      inset: 8px;
      border-radius: 22px;
      border: 1px solid rgba(16,185,129,0.10);
      animation:pulse 8s infinite;
      pointer-events:none;
    }

    @keyframes pulse{
      0%,100%{opacity:0.14;transform:scale(1)}
      50%{opacity:0.48;transform:scale(1.01)}
    }

    @media (max-width: 480px){
      .portal{ border-radius: 22px; }
      .portal::after{ inset: 7px; border-radius: 18px; }
    }

    @media (prefers-reduced-motion: reduce){
      .portal::after{ animation:none; }
      .portal.listening .ripple-overlay::before,
      .portal.listening .ripple-overlay::after{ animation:none !important; }
      .answer-text{ transition: none !important; }
    }

    .portal-scroll{
      width: 100%;
      flex: 1;
      min-height: 0;                 
      overflow-y: auto;
      -webkit-overflow-scrolling: touch; 
      overscroll-behavior: contain;
      touch-action: pan-y;            
      padding: 1.3rem 1.2rem 1.1rem;
    }

    .portal-fade-top, .portal-fade-bot{
      position: absolute;
      left: 0; right: 0;
      height: 24px;
      pointer-events: none;
      z-index: 5;
    }
    .portal-fade-top{
      top: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,0.90), rgba(0,0,0,0));
    }
    .portal-fade-bot{
      bottom: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.90), rgba(0,0,0,0));
    }

    .manual-text { font-size: 0.7rem; color:#888; line-height:1.4; }

    input{
      background: rgba(255,255,255,0.05) !important;
      border: 1px solid rgba(255,255,255,0.1) !important;
      border-radius: 12px;
    }

    .portal .ripple-overlay{
      position:absolute;
      inset:0;
      border-radius: 26px;
      pointer-events:none;
      opacity:0;
      transition: opacity .25s ease;
      background: radial-gradient(circle at 50% 45%, rgba(16,185,129,0.10), transparent 55%);
      z-index: 2;
    }

    .portal .ripple-overlay::before,
    .portal .ripple-overlay::after{
      content:"";
      position:absolute;
      left:50%;
      top:46%;
      width:14px;height:14px;
      transform:translate(-50%,-50%);
      border-radius:9999px;
      border:1px solid rgba(16,185,129,0.26);
      opacity:0;
    }

    .portal.listening .ripple-overlay{ opacity:1; }

    .portal.listening .ripple-overlay::before{
      animation: pondRipple 1.45s ease-out infinite;
      opacity:1;
    }
    .portal.listening .ripple-overlay::after{
      animation: pondRipple 1.45s ease-out infinite;
      animation-delay:.38s;
      border-color: rgba(16,185,129,0.18);
      opacity:1;
    }

    @keyframes pondRipple{
      0%{width:14px;height:14px;opacity:.70}
      70%{width:540px;height:540px;opacity:.10}
      100%{width:660px;height:660px;opacity:0}
    }

    .preset.active{
      border-color: rgba(16,185,129,0.65) !important;
      box-shadow: 0 0 0 1px rgba(16,185,129,0.18), 0 0 22px rgba(16,185,129,0.12);
      background: rgba(16,185,129,0.06) !important;
    }

    .sheet{
      position:fixed;
      left:0; right:0;
      bottom:-75%;
      height:75%;
      background: rgba(5,5,5,0.92);
      border-top: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      transition: bottom .35s ease;
      z-index:50;
      padding-bottom: calc(16px + var(--safe-b));
    }
    .sheet.open{ bottom:0; }
    .sheet-handle{
      width:64px; height:4px;
      border-radius:9999px;
      background: rgba(255,255,255,0.18);
      margin: 10px auto;
    }

    #reflect-btn:active{ transform: translateY(1px); }

    .answer-wrap{
      width: 100%;
      max-width: 560px;
      margin: 0 auto;
      position: relative;
    }

    .answer-text{
      display: block;
      max-height: 8.2em; 
      overflow: hidden;
      transition: max-height 0.45s cubic-bezier(0.22, 0.61, 0.36, 1);
    }

    .answer-wrap.clamped::after{
      content: "";
      position: absolute;
      left: 0; right: 0; bottom: 0;
      height: 2.2em;
      background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.92));
      pointer-events: none;
      border-radius: 12px;
    }

    .answer-wrap.expandable{ cursor: pointer; }

    .answer-wrap.expanded .answer-text{
      max-height: 2000px; 
    }
    .answer-wrap.expanded::after{ display:none; }
  </style>
</head>

<body>
  <div class="water-bg"></div>

  <div class="shell w-full z-10">
    <button id="manual-toggle"
      class="manual-text max-w-xs uppercase tracking-tighter text-left hover:text-zinc-200 transition"
      aria-label="Toggle manual">
      <span class="text-emerald-500 font-bold">The Manual for the Fallen</span><br>
      <span class="manual-lines">
        I. The Three Breaths: Acknowledge, Release, Inquire.<br>
        II. The Law of the Question: Character over Capital.<br>
        III. Stillness Yields Truth.
      </span>
    </button>

    <div class="flex items-start gap-3">
      <div id="pond-ver" class="text-[10px] uppercase tracking-widest text-zinc-500 mt-2">Pond ¬∑ v0.1</div>
      <button id="wallet-btn"
        class="bg-zinc-900/80 border border-zinc-700 px-4 py-2 text-[10px] uppercase tracking-widest rounded hover:border-emerald-500 transition">
        Connect Wallet (Base)
      </button>
    </div>
  </div>

  <div class="middle">
    <div class="portal text-center">
      <div class="ripple-overlay"></div>
      <div class="portal-fade-top"></div>
      <div class="portal-fade-bot"></div>

      <div class="portal-scroll">
        <h1 class="serif text-3xl tracking-[0.32em] text-white mt-1 mb-2">MIRROR</h1>
        <p class="serif text-xs tracking-widest text-zinc-400 mb-5">The Digital Pond</p>

        <div class="w-full max-w-md mb-5 flex flex-wrap gap-2 justify-center mx-auto">
          <button class="preset bg-zinc-900/60 border border-zinc-800 hover:border-emerald-500 px-4 py-2 rounded-full text-[11px] uppercase tracking-widest transition"
            data-text="I feel lost. What should I do today?">Lost</button>
          <button class="preset bg-zinc-900/60 border border-zinc-800 hover:border-emerald-500 px-4 py-2 rounded-full text-[11px] uppercase tracking-widest transition"
            data-text="Mirror, what does stillness mean for me today?">Stillness</button>
          <button class="preset bg-zinc-900/60 border border-zinc-800 hover:border-emerald-500 px-4 py-2 rounded-full text-[11px] uppercase tracking-widest transition"
            data-text="How do I hold patience when nothing moves?">Patience</button>
          <button class="preset bg-zinc-900/60 border border-zinc-800 hover:border-emerald-500 px-4 py-2 rounded-full text-[11px] uppercase tracking-widest transition"
            data-text="What am I becoming, beneath the surface?">Becoming</button>
          <button class="preset bg-zinc-900/60 border border-zinc-800 hover:border-emerald-500 px-4 py-2 rounded-full text-[11px] uppercase tracking-widest transition"
            data-text="In Rune 3, what is the still-water garden teaching me?">Rune3</button>
          <button class="preset bg-zinc-900/60 border border-zinc-800 hover:border-emerald-500 px-4 py-2 rounded-full text-[11px] uppercase tracking-widest transition"
            data-text="Explain: ‚ÄòToby is the people, and the people is Toby.‚Äô">Toby = The People</button>
        </div>

        <div id="reflection-output" class="space-y-5 opacity-0 transition-opacity duration-700 max-w-[560px] mx-auto">
          <div id="answer-wrap" class="answer-wrap">
            <p id="main-text" class="answer-text italic text-lg text-zinc-200 leading-relaxed">
              ‚ÄúStillness yields truth.‚Äù
            </p>
          </div>

          <div class="space-y-2 text-[10px] uppercase tracking-widest font-bold">
            <p id="echo-text" class="text-emerald-400">Echo: Stillness yields truth</p>
            <p id="res-text" class="text-zinc-400">Resonance: Roots deepen.</p>
          </div>

          <p id="guide-text" class="text-sm italic text-zinc-500">What remains when urgency leaves?</p>
          <div class="pt-1" style="font-size:1.4rem; letter-spacing:0.45rem; opacity:.85;">‚öõÔ∏è ‚âã üçÉ üåÄ</div>
        </div>

        <div id="err" class="mt-4 hidden text-[11px] text-red-300">
          The pond could not hear the ocean. Check endpoint health.
        </div>

        <div style="height: 22px;"></div>
      </div>
    </div>
  </div>

  <div class="shell w-full z-10 space-y-3" style="flex-direction: column; align-items: stretch;">
    <div class="flex gap-2">
      <input id="user-input" type="text" placeholder="Inquire the Pond (Type your question... Enter to reflect)"
        class="flex-grow p-3 text-sm text-emerald-300 placeholder-zinc-700 focus:outline-none focus:ring-2 focus:ring-emerald-600/30"
        aria-label="Your inquiry" />
      <button id="reflect-btn"
        class="bg-zinc-800 border border-zinc-600 px-6 py-2 text-xs uppercase tracking-widest hover:bg-emerald-600 hover:text-black transition duration-500 rounded-lg"
        aria-label="Reflect">
        Reflect
      </button>
    </div>

    <div class="flex justify-between items-center text-[10px] text-zinc-500 uppercase tracking-widest">
      <div class="flex items-center gap-2">
        üçÉ <span id="leaves">Leaves of Stillness: 0</span>
      </div>
      <div class="flex items-center gap-4">
        <button id="history-btn" class="hover:text-white transition">History ‚Üü</button>
        <button id="basescan-btn" class="hover:text-white transition">View Karmic Record on BaseScan ‚Üó</button>
      </div>
    </div>
  </div>

  <div id="sheet" class="sheet">
    <div class="sheet-handle"></div>
    <div class="px-5 pb-4 flex items-center justify-between">
      <div class="text-xs uppercase tracking-widest text-zinc-400">Karmic Record (Local)</div>
      <div class="flex gap-3">
        <button id="clear-history" class="text-[10px] uppercase tracking-widest text-zinc-500 hover:text-red-300 transition">Clear</button>
        <button id="close-sheet" class="text-[10px] uppercase tracking-widest text-zinc-500 hover:text-white transition">Close</button>
      </div>
    </div>
    <div id="history-list" class="px-5 overflow-auto" style="height: calc(75% - 64px);"></div>
  </div>

  <script>
    const API_URL = "https://toadaid.duckdns.org/ask";
    const KEY_LEAVES = "mirror_leaves";
    const KEY_HISTORY = "mirror_history_v1";

    const input = document.getElementById("user-input");
    const output = document.getElementById("reflection-output");
    const err = document.getElementById("err");
    const reflectBtn = document.getElementById("reflect-btn");
    const leavesEl = document.getElementById("leaves");
    const historyBtn = document.getElementById("history-btn");
    const sheet = document.getElementById("sheet");
    const historyList = document.getElementById("history-list");
    const portalEl = document.querySelector(".portal");
    const portalScroll = document.querySelector(".portal-scroll");

    const mainText = document.getElementById("main-text");
    const echoText = document.getElementById("echo-text");
    const resText  = document.getElementById("res-text");
    const guideText= document.getElementById("guide-text");

    const answerWrap = document.getElementById("answer-wrap");

    function loadLeaves(){
      const n = Number(localStorage.getItem(KEY_LEAVES) || "0");
      leavesEl.textContent = `Leaves of Stillness: ${n}`;
    }
    function incLeaves(){
      const n = Number(localStorage.getItem(KEY_LEAVES) || "0") + 1;
      localStorage.setItem(KEY_LEAVES, String(n));
      leavesEl.textContent = `Leaves of Stillness: ${n}`;
    }
    function getHistory(){
      try { return JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]"); }
      catch(e){ return []; }
    }
    function setHistory(arr){
      localStorage.setItem(KEY_HISTORY, JSON.stringify(arr.slice(0, 30)));
    }
    function addHistory(item){
      const arr = getHistory();
      arr.unshift(item);
      setHistory(arr);
    }
    function renderHistory(){
      const arr = getHistory();
      if(!arr.length){
        historyList.innerHTML = `<div class="text-sm text-zinc-500 py-6">No record yet. The first ripple will be written here.</div>`;
        return;
      }
      historyList.innerHTML = arr.map((x) => `
        <div class="py-4 border-b border-white/5">
          <div class="text-[10px] uppercase tracking-widest text-zinc-500">${new Date(x.ts).toLocaleString()}</div>
          <div class="mt-2 text-sm text-zinc-200">${escapeHtml(x.q)}</div>
          <div class="mt-2 text-sm italic text-emerald-200/90">‚Äú${escapeHtml(x.a)}‚Äù</div>
        </div>
      `).join("");
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    loadLeaves();

    function setLoading(isLoading){
      if(isLoading) portalEl.classList.add("listening");
      else portalEl.classList.remove("listening");
      err.classList.add("hidden");

      if(isLoading){
        output.style.opacity = "0";
        reflectBtn.disabled = true;
        reflectBtn.textContent = "Listening‚Ä¶";
        reflectBtn.classList.add("opacity-70");
      }else{
        reflectBtn.disabled = false;
        reflectBtn.textContent = "Reflect";
        reflectBtn.classList.remove("opacity-70");
      }
    }
    function showOutput(){ output.style.opacity = "1"; }

    function openSheet(){ renderHistory(); sheet.classList.add("open"); }
    function closeSheet(){ sheet.classList.remove("open"); }

    function stripTravelerPrefix(s){
      return s.replace(/^\s*traveler[,Ôºö:]?\s*/i, "").trim();
    }
    function parseMirrorAnswer(raw){
      let text = String(raw || "").trim();
      text = text.replace(/[ü™ûüåäüçÉüåÄ‚öõÔ∏è‚âã]+$/g, "").trim();

      let guide = "";
      const gMatch = text.match(/Guiding Question:\s*([\s\S]*)$/i);
      if(gMatch){
        guide = gMatch[1].trim();
        text = text.slice(0, gMatch.index).trim();
      }

      let resonance = "";
      const rMatch = text.match(/Reflection Resonance:\s*([\s\S]*)$/i);
      if(rMatch){
        resonance = rMatch[1].trim();
        text = text.slice(0, rMatch.index).trim();
      }

      const main = stripTravelerPrefix(text);

      return {
        main: main || "Stillness yields truth.",
        resonance: resonance || "Roots deepen.",
        guide: guide || "What remains when urgency leaves?"
      };
    }

    function localFallback(q){
      const val = q.toLowerCase();
      if(val.includes("price") || val.includes("money") || val.includes("pump") || val.includes("moon")){
        return {
          main: "The pond does not track the price of ghosts.",
          echo: "Echo: Canon Shield Active",
          res:  "Resonance: Attention Released",
          guide:"What would you ask if no number could save you?"
        };
      }
      return {
        main: "Every frantic move is a debt to time.",
        echo: "Echo: Stillness yields truth",
        res:  "Resonance: Roots deepen.",
        guide:"What remains when urgency leaves?"
      };
    }

    async function askAPI(question){
      const payload = { question, user: "miniapp" };
      const r = await fetch(API_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-store",
        redirect: "follow",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      if(!r.ok) throw new Error("HTTP " + r.status);
      return await r.json();
    }

    function normalizeAnswer(data){
      if(typeof data === "string") return data;
      return data?.answer || data?.unified_answer || data?.text || data?.response || "";
    }

    function applyClampIfNeeded(){
      answerWrap.classList.remove("clamped", "expanded", "expandable");
      requestAnimationFrame(() => {
        const el = mainText;
        const tooTall = el.scrollHeight > el.clientHeight + 2;
        if(tooTall){
          answerWrap.classList.add("clamped", "expandable");
        }
      });
    }

    answerWrap.addEventListener("click", () => {
      if(!answerWrap.classList.contains("clamped")) return;
      answerWrap.classList.toggle("expanded");
      requestAnimationFrame(() => {
        portalScroll.scrollTop = portalScroll.scrollTop; 
      });
    });

    async function processInquiry(qOverride){
      const q = (qOverride ?? input.value).trim();
      if(!q) return;

      setLoading(true);

      try{
        const data = await askAPI(q);
        const a = normalizeAnswer(data);
        const parsed = a ? parseMirrorAnswer(a) : null;

        const out = parsed ? {
          main: parsed.main,
          echo: "Echo: Stillness yields truth",
          res:  `Resonance: ${parsed.resonance}`,
          guide: parsed.guide
        } : localFallback(q);

        mainText.textContent = `‚Äú${out.main}‚Äù`;
        echoText.textContent = out.echo;
        resText.textContent  = out.res;
        guideText.textContent= out.guide;

        incLeaves();
        addHistory({ ts: Date.now(), q, a: out.main });

        showOutput();
        input.value = "";

        applyClampIfNeeded();

        requestAnimationFrame(() => {
          portalScroll.scrollTo({ top: 9999, behavior: "smooth" });
          setTimeout(() => portalScroll.scrollTo({ top: 0, behavior: "smooth" }), 380);
        });

      }catch(e){
        const out = localFallback(q);
        mainText.textContent = `‚Äú${out.main}‚Äù`;
        echoText.textContent = out.echo;
        resText.textContent  = out.res;
        guideText.textContent= out.guide;
        err.classList.remove("hidden");
        showOutput();
        applyClampIfNeeded();
      }finally{
        setLoading(false);
      }
    }

    reflectBtn.addEventListener("click", () => processInquiry());
    input.addEventListener("keydown", (e) => { if(e.key === "Enter") processInquiry(); });

    document.querySelectorAll(".preset").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".preset").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const t = btn.getAttribute("data-text") || "";
        input.value = t;
        processInquiry(t);
      });
    });

    historyBtn.addEventListener("click", openSheet);
    document.getElementById("close-sheet").addEventListener("click", closeSheet);
    document.getElementById("clear-history").addEventListener("click", () => {
      localStorage.removeItem(KEY_HISTORY);
      renderHistory();
    });

    document.getElementById("manual-toggle").addEventListener("click", () => {
      const lines = document.querySelector(".manual-lines");
      if(!lines) return;
      lines.style.display = (lines.style.display === "none") ? "inline" : "none";
    });

    const walletBtn = document.getElementById("wallet-btn");
    let walletState = "disconnected";
    walletBtn.addEventListener("click", async () => {
      if(walletState === "disconnected"){
        walletState = "connecting";
        walletBtn.textContent = "Connecting‚Ä¶";
        walletBtn.classList.add("opacity-70");
        await new Promise(r => setTimeout(r, 700));
        walletState = "connected";
        walletBtn.classList.remove("opacity-70");
        walletBtn.textContent = "0x12‚Ä¶89 (Base)";
      }else{
        walletState = "disconnected";
        walletBtn.textContent = "Connect Wallet (Base)";
      }
    });

    document.getElementById("basescan-btn").addEventListener("click", () => {
      alert("Coming soon: onchain karmic record. (Local history works now.)");
    });

    setTimeout(() => {
      output.style.opacity = "1";
      applyClampIfNeeded();
    }, 250);
  </script>
</body>
</html>
