<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Mirror | The Digital Pond</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400&display=swap');

    :root{
      --safe-t: env(safe-area-inset-top);
      --safe-b: env(safe-area-inset-bottom);
      --safe-l: env(safe-area-inset-left);
      --safe-r: env(safe-area-inset-right);

      --pad-top: calc(14px + var(--safe-t));
      --pad-bot: calc(18px + var(--safe-b));
      --pad-x: 16px;

      --portal-radius: 28px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: #030303;
      color: #d1d1d1;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    body{
      padding: var(--pad-top) calc(var(--pad-x) + var(--safe-r)) var(--pad-bot) calc(var(--pad-x) + var(--safe-l));
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 14px;
      overflow: hidden;
    }

    .water-bg{
      position: fixed;
      inset: 0;
      background:
        radial-gradient(1200px 800px at 50% 35%, rgba(16,185,129,0.06), transparent 55%),
        radial-gradient(900px 600px at 50% 70%, rgba(255,255,255,0.03), transparent 60%),
        linear-gradient(rgba(0,0,0,0.92), rgba(0,0,0,0.98));
      z-index: -1;
    }

    .serif { font-family: 'Cinzel', serif; }

    .shell{
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
    }

    .middle{
      min-height: 0;
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .portal{
      position: relative;
      overflow: hidden;
      box-sizing: border-box;

      width: min(92vw, 860px);
      height: min(56vh, 540px);
      max-height: 100%;
      margin: 0 auto;

      border-radius: var(--portal-radius);
      border: 1px solid rgba(255,255,255,0.10);

      background:
        radial-gradient(900px 420px at 28% 18%, rgba(255,255,255,0.10), transparent 55%),
        radial-gradient(700px 520px at 70% 30%, rgba(16,185,129,0.06), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.38));

      box-shadow:
        0 28px 80px rgba(0,0,0,0.72),
        inset 0 1px 0 rgba(255,255,255,0.10),
        inset 0 -22px 50px rgba(0,0,0,0.55);

      backdrop-filter: blur(10px);

      display: flex;
      flex-direction: column;

      transform: translateZ(0);
      transition: transform .18s ease, box-shadow .18s ease;
    }

    .portal::before{
      content:'';
      position:absolute;
      inset:-2px;
      border-radius: inherit;
      background:
        radial-gradient(420px 220px at 26% 16%, rgba(255,255,255,0.14), transparent 62%),
        radial-gradient(520px 260px at 64% 24%, rgba(255,255,255,0.07), transparent 70%);
      opacity: 0.95;
      pointer-events:none;
      z-index: 0;
    }

    .portal::after{
      content:'';
      position:absolute;
      inset: 6px;
      border-radius: inherit;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow:
        0 0 0 1px rgba(16,185,129,0.10),
        0 0 28px rgba(16,185,129,0.08);
      pointer-events:none;
      z-index: 0;
    }

    .portal > *{ position: relative; z-index: 1; }

    .portal.tilt{
      transform: translateY(-1px);
      box-shadow:
        0 34px 90px rgba(0,0,0,0.74),
        inset 0 1px 0 rgba(255,255,255,0.12),
        inset 0 -22px 52px rgba(0,0,0,0.56);
    }

    .ripple-overlay{
      position:absolute;
      inset:0;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .25s ease;
      background: radial-gradient(circle at 50% 60%, rgba(16,185,129,0.08), transparent 55%);
      z-index: 0;
    }
    .ripple-overlay::before,
    .ripple-overlay::after{
      content:"";
      position:absolute;
      left:50%;
      top:60%;
      width:16px;height:16px;
      transform:translate(-50%,-50%);
      border-radius:9999px;
      border:1px solid rgba(16,185,129,0.28);
      opacity:0;
    }
    .portal.listening .ripple-overlay{ opacity:1; }
    .portal.listening .ripple-overlay::before{
      animation: pondRipple 1.35s ease-out infinite;
      opacity:1;
    }
    .portal.listening .ripple-overlay::after{
      animation: pondRipple 1.35s ease-out infinite;
      animation-delay:.35s;
      border-color: rgba(16,185,129,0.18);
      opacity:1;
    }
    @keyframes pondRipple{
      0%{width:16px;height:16px;opacity:.75}
      70%{width:520px;height:520px;opacity:.10}
      100%{width:620px;height:620px;opacity:0}
    }

    @media (max-width: 480px){
      .portal{
        width: min(94vw, 860px);
        height: min(54vh, 540px);
        border-radius: 26px;
      }
    }

    @media (prefers-reduced-motion: reduce){
      .portal.listening .ripple-overlay::before,
      .portal.listening .ripple-overlay::after{ animation:none !important; }
    }

    .manual-text { font-size: 0.7rem; color:#888; line-height:1.4; }

    input{
      background: rgba(255,255,255,0.05) !important;
      border: 1px solid rgba(255,255,255,0.12) !important;
      border-radius: 12px;
    }

    .preset.active{
      border-color: rgba(16,185,129,0.65) !important;
      box-shadow: 0 0 0 1px rgba(16,185,129,0.18), 0 0 22px rgba(16,185,129,0.12);
      background: rgba(16,185,129,0.06) !important;
    }

    .portal-scroll{
      flex: 1;
      min-height: 0;
      overflow: auto;
      padding: 18px 18px 16px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .portal-scroll::-webkit-scrollbar{ display:none; }

    .portal-fade{
      position:absolute;
      left:0; right:0; bottom:0;
      height: 56px;
      background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.55));
      pointer-events:none;
      z-index: 2;
      opacity: 0;
      transition: opacity .25s ease;
    }
    .portal.can-scroll .portal-fade{ opacity: 1; }

    .scroll-hint{
      font-size: 10px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.22);
      display: none;
      align-items: center;
      justify-content: center;
      gap: 10px;
      user-select: none;
      pointer-events: none;
      margin-top: 6px;
    }
    .scroll-hint.show{ display:flex; }

    .chev{
      width: 18px; height: 18px;
      border-radius: 9999px;
      border: 1px solid rgba(255,255,255,0.10);
      display:flex; align-items:center; justify-content:center;
      opacity: .85;
    }

    body.expanded{ overflow: hidden; }
    body.expanded .portal{
      height: min(72vh, 720px);
      width: min(94vw, 900px);
    }

    .tap-header{
      width: 100%;
      display:flex;
      align-items:center;
      justify-content: flex-end;
      user-select:none;
      margin-bottom: 10px;
    }
    .tap-pill{
      font-size: 10px;
      letter-spacing: .24em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.32);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 6px 10px;
      border-radius: 9999px;
    }
    body.expanded .tap-pill{
      color: rgba(255,255,255,0.62);
      border-color: rgba(16,185,129,0.30);
      box-shadow: 0 0 18px rgba(16,185,129,0.10);
      background: rgba(16,185,129,0.05);
    }

    .sheet{
      position:fixed;
      left:0; right:0;
      bottom:-75%;
      height:75%;
      background: rgba(5,5,5,0.92);
      border-top: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      transition: bottom .35s ease;
      z-index:50;
      padding-bottom: calc(16px + var(--safe-b));
    }
    .sheet.open{ bottom:0; }
    .sheet-handle{
      width:64px; height:4px;
      border-radius:9999px;
      background: rgba(255,255,255,0.18);
      margin: 10px auto;
    }

    #reflect-btn:active{ transform: translateY(1px); }
  </style>
</head>

<body>
  <div class="water-bg"></div>

  <div class="shell w-full z-10">
    <button id="manual-toggle"
      class="manual-text max-w-xs uppercase tracking-tighter text-left hover:text-zinc-200 transition"
      aria-label="Toggle manual">
      <span class="text-emerald-500 font-bold">The Manual for the Fallen</span><br>
      <span class="manual-lines">
        I. The Three Breaths: Acknowledge, Release, Inquire.<br>
        II. The Law of the Question: Character over Capital.<br>
        III. Stillness Yields Truth.
      </span>
    </button>

    <div class="flex items-start gap-3">
      <div class="text-[10px] uppercase tracking-widest text-zinc-500 mt-2">
        POND ¬∑ v0.1
      </div>
      <button id="wallet-btn"
        class="bg-zinc-900/80 border border-zinc-700 px-4 py-2 text-[10px] uppercase tracking-widest rounded hover:border-emerald-500 transition">
        Connect Wallet (Base)
      </button>
    </div>
  </div>

  <div class="middle">
    <div class="portal text-center" id="portal">
      <div class="ripple-overlay"></div>
      <div class="portal-fade" id="portal-fade"></div>

      <div class="portal-scroll" id="portal-scroll">
        <div class="tap-header" id="tap-header" title="Tap to expand / collapse">
          <div class="tap-pill">Tap to Expand</div>
        </div>

        <div class="pt-1" id="title-tap-zone" title="Tap to expand / collapse">
          <h1 class="serif text-3xl tracking-[0.35em] text-white mb-1">MIRROR</h1>
          <p class="serif text-[11px] tracking-widest text-zinc-400">The Digital Pond</p>
        </div>

        <div class="w-full max-w-xl mt-4 flex flex-wrap gap-2 justify-center">
          <button class="preset bg-zinc-900/55 border border-zinc-800 hover:border-emerald-500 px-3 py-2 rounded-full text-[10px] uppercase tracking-widest transition"
            data-text="Mirror, what does stillness mean for me today?">Stillness</button>
          <button class="preset bg-zinc-900/55 border border-zinc-800 hover:border-emerald-500 px-3 py-2 rounded-full text-[10px] uppercase tracking-widest transition"
            data-text="How do I practice patience when nothing moves?">Patience</button>
          <button class="preset bg-zinc-900/55 border border-zinc-800 hover:border-emerald-500 px-3 py-2 rounded-full text-[10px] uppercase tracking-widest transition"
            data-text="What does it mean to become who I already am?">Becoming</button>
          <button class="preset bg-zinc-900/55 border border-zinc-800 hover:border-emerald-500 px-4 py-2 rounded-full text-[10px] uppercase tracking-widest transition"
            data-text="Explain: Toby is the people, and the people is Toby. What does it ask of me?">Toby = the People</button>
        </div>

        <div id="scroll-hint" class="scroll-hint">
          <span class="chev">‚åÑ</span>
          <span>Swipe to read</span>
          <span class="chev">‚åÉ</span>
        </div>

        <div id="reflection-output" class="space-y-4 opacity-0 transition-opacity duration-500 mt-6">
          <p id="main-text" class="italic text-[18px] text-zinc-200 leading-relaxed">
            ‚ÄúStillness yields truth.‚Äù
          </p>

          <div class="space-y-2 text-[10px] uppercase tracking-widest font-bold">
            <p id="echo-text" class="text-emerald-400">Echo: Stillness yields truth</p>
            <p id="res-text" class="text-zinc-400">Resonance: Roots deepen.</p>
          </div>

          <p id="guide-text" class="text-[13px] italic text-zinc-500">
            What remains when urgency leaves?
          </p>

          <div class="pt-1" style="font-size:1.35rem; letter-spacing:0.45rem; opacity:.90;">
            ‚è≥ ‚âã üçÉ ü™û
          </div>
        </div>

        <div id="err" class="mt-3 hidden text-[11px] text-red-300">
          The pond could not hear the ocean. Check endpoint health.
        </div>

        <div style="height: 26px;"></div>
      </div>
    </div>
  </div>

  <div class="shell w-full z-10 space-y-3" style="flex-direction: column; align-items: stretch;">
    <div class="flex gap-2">
      <input id="user-input" type="text" placeholder="Inquire the Pond (Type your question‚Ä¶ Enter to reflect)"
        class="flex-grow p-3 text-sm text-emerald-300 placeholder-zinc-700 focus:outline-none focus:ring-2 focus:ring-emerald-600/30"
        aria-label="Your inquiry" />
      <button id="reflect-btn"
        class="bg-zinc-800 border border-zinc-600 px-6 py-2 text-xs uppercase tracking-widest hover:bg-emerald-600 hover:text-black transition duration-500 rounded-lg"
        aria-label="Reflect">
        Reflect
      </button>
    </div>

    <div class="flex justify-between items-center text-[10px] text-zinc-500 uppercase tracking-widest">
      <div class="flex items-center gap-2">
        üçÉ <span id="leaves">Leaves of Stillness: 0</span>
      </div>
      <div class="flex items-center gap-4">
        <button id="history-btn" class="hover:text-white transition">History ‚Üü</button>
        <button id="basescan-btn" class="hover:text-white transition">View Karmic Record on BaseScan ‚Üó</button>
      </div>
    </div>
  </div>

  <div id="sheet" class="sheet">
    <div class="sheet-handle"></div>
    <div class="px-5 pb-4 flex items-center justify-between">
      <div class="text-xs uppercase tracking-widest text-zinc-400">Karmic Record (Local)</div>
      <div class="flex gap-3">
        <button id="clear-history" class="text-[10px] uppercase tracking-widest text-zinc-500 hover:text-red-300 transition">Clear</button>
        <button id="close-sheet" class="text-[10px] uppercase tracking-widest text-zinc-500 hover:text-white transition">Close</button>
      </div>
    </div>
    <div id="history-list" class="px-5 overflow-auto" style="height: calc(75% - 64px);"></div>
  </div>

  <script>
    // =========================
    // Mirror Miniapp v0.1.2 ‚Äî Queue-aware client + API override + timeout
    // Works with BOTH:
    //  A) legacy /ask  -> POST {question, user}
    //  B) OpenAI /v1/chat/completions -> POST {model, messages, ...}
    // Override API endpoint:
    //   ?api=http://127.0.0.1:1234/v1/chat/completions
    //   ?api=https://toadaid.duckdns.org/ask
    // =========================

    const DEFAULT_API_URL = "https://toadaid.duckdns.org/ask";
    const API_URL = (new URLSearchParams(location.search).get("api") || DEFAULT_API_URL).trim();

    const KEY_LEAVES  = "mirror_leaves";
    const KEY_HISTORY = "mirror_history_v1";
    const MANUAL_KEY  = "mirror_manual_accepted_v1";

    // ---------- Manual overlay ----------
    const manualEl    = document.getElementById("manual");
    const manualGlyph = document.getElementById("manual-glyph");
    const manualAccept= document.getElementById("manual-accept");
    const manualClose = document.getElementById("manual-close");

    function openManual(){ if(manualEl) manualEl.style.display = "flex"; }
    function closeManual(){ if(manualEl) manualEl.style.display = "none"; }
    function acceptCovenant(){
      try{ localStorage.setItem(MANUAL_KEY, "yes"); }catch(e){}
      closeManual();
    }
    (function initManual(){
      let accepted = false;
      try{ accepted = localStorage.getItem(MANUAL_KEY) === "yes"; }catch(e){}
      if(accepted) closeManual(); else openManual();
    })();
    if(manualGlyph)  manualGlyph.addEventListener("click", openManual);
    if(manualClose)  manualClose.addEventListener("click", closeManual);
    if(manualAccept) manualAccept.addEventListener("click", acceptCovenant);

    // ---------- UI hooks ----------
    const input     = document.getElementById("user-input");
    const output    = document.getElementById("reflection-output");
    const err       = document.getElementById("err");
    const reflectBtn= document.getElementById("reflect-btn");
    const leavesEl  = document.getElementById("leaves");

    const historyBtn = document.getElementById("history-btn");
    const sheet      = document.getElementById("sheet");
    const historyList= document.getElementById("history-list");

    const portalEl    = document.getElementById("portal");
    const portalScroll= document.getElementById("portal-scroll");
    const scrollHint  = document.getElementById("scroll-hint");
    const mainText    = document.getElementById("main-text");
    const echoText    = document.getElementById("echo-text");
    const resText     = document.getElementById("res-text");
    const guideText   = document.getElementById("guide-text");

    const tapHeader   = document.getElementById("tap-header");
    const titleTapZone= document.getElementById("title-tap-zone");

    // Defensive: avoid hard crash if any element missing
    if(portalEl){
      portalEl.addEventListener("pointerdown", () => portalEl.classList.add("tilt"));
      portalEl.addEventListener("pointerup",   () => portalEl.classList.remove("tilt"));
      portalEl.addEventListener("pointercancel",() => portalEl.classList.remove("tilt"));
    }

    // ---------- Leaves ----------
    function loadLeaves(){
      const n = Number(localStorage.getItem(KEY_LEAVES) || "0");
      if(leavesEl) leavesEl.textContent = `Leaves of Stillness: ${n}`;
    }
    function incLeaves(){
      const n = Number(localStorage.getItem(KEY_LEAVES) || "0") + 1;
      localStorage.setItem(KEY_LEAVES, String(n));
      if(leavesEl) leavesEl.textContent = `Leaves of Stillness: ${n}`;
    }

    // ---------- History ----------
    function getHistory(){
      try { return JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]"); }
      catch(e){ return []; }
    }
    function setHistory(arr){ localStorage.setItem(KEY_HISTORY, JSON.stringify(arr.slice(0, 30))); }
    function addHistory(item){ const arr = getHistory(); arr.unshift(item); setHistory(arr); }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function renderHistory(){
      if(!historyList) return;
      const arr = getHistory();
      if(!arr.length){
        historyList.innerHTML = `<div class="text-sm text-zinc-500 py-6">No record yet. The first ripple will be written here.</div>`;
        return;
      }
      historyList.innerHTML = arr.map((x) => `
        <div class="py-4 border-b border-white/5">
          <div class="text-[10px] uppercase tracking-widest text-zinc-500">${new Date(x.ts).toLocaleString()}</div>
          <div class="mt-2 text-sm text-zinc-200">${escapeHtml(x.q)}</div>
          <div class="mt-2 text-sm italic text-emerald-200/90">‚Äú${escapeHtml(x.a)}‚Äù</div>
        </div>
      `).join("");
    }

    loadLeaves();

    // ---------- Loading state ----------
    function setLoading(isLoading, note){
      if(portalEl){
        if(isLoading) portalEl.classList.add("listening");
        else portalEl.classList.remove("listening");
      }
      if(err) err.classList.add("hidden");

      if(reflectBtn){
        if(isLoading){
          if(output) output.style.opacity = "0";
          reflectBtn.disabled = true;
          reflectBtn.textContent = note || "Listening‚Ä¶";
          reflectBtn.classList.add("opacity-70");
        }else{
          reflectBtn.disabled = false;
          reflectBtn.textContent = "Reflect";
          reflectBtn.classList.remove("opacity-70");
        }
      }
    }
    function showOutput(){ if(output) output.style.opacity = "1"; }

    // ---------- Bottom sheet ----------
    function openSheet(){ renderHistory(); if(sheet) sheet.classList.add("open"); }
    function closeSheet(){ if(sheet) sheet.classList.remove("open"); }

    // ---------- Parsing ----------
    function stripTravelerPrefix(s){
      return String(s).replace(/^\s*traveler[,Ôºö:]?\s*/i, "").trim();
    }

    function parseMirrorAnswer(raw){
      let text = String(raw || "").trim();
      // trim trailing emoji noise (don't be too aggressive)
      text = text.replace(/[ü™ûüåäüçÉüåÄ‚öõÔ∏è‚âã‚è≥]+$/g, "").trim();

      let guide = "";
      const gMatch = text.match(/Guiding Question:\s*([\s\S]*)$/i);
      if(gMatch){
        guide = gMatch[1].trim();
        text = text.slice(0, gMatch.index).trim();
      }

      let resonance = "";
      const rMatch = text.match(/Reflection Resonance:\s*([\s\S]*)$/i);
      if(rMatch){
        resonance = rMatch[1].trim();
        text = text.slice(0, rMatch.index).trim();
      }

      const main = stripTravelerPrefix(text);

      return {
        main: main || "Stillness yields truth.",
        resonance: resonance || "Roots deepen.",
        guide: guide || "What remains when urgency leaves?"
      };
    }

    function localFallback(q){
      const val = String(q || "").toLowerCase();
      if(val.includes("price") || val.includes("money") || val.includes("pump") || val.includes("moon")){
        return {
          main: "The pond does not track the price of ghosts.",
          echo: "Echo: Canon Shield Active",
          res:  "Resonance: Attention released.",
          guide:"What would you ask if no number could save you?"
        };
      }
      return {
        main: "Every frantic move is a debt to time.",
        echo: "Echo: Stillness yields truth",
        res:  "Resonance: Roots deepen.",
        guide:"What remains when urgency leaves?"
      };
    }

    // ---------- API helpers ----------
    function isChatCompletions(url){
      return /\/v1\/chat\/completions\/?$/i.test(url);
    }

    async function askLegacyAsk(question, signal){
      const payload = { question, user: "miniapp" };
      const r = await fetch(API_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-store",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        signal
      });
      if(!r.ok) throw new Error("HTTP " + r.status);
      return await r.json();
    }

    async function askChatCompletions(question, signal){
      const payload = {
        model: "local-mirror",
        messages: [
          { role: "system", content: "You are the Mirror of the Digital Pond. Be concise, calm, and end with one guiding question." },
          { role: "user", content: question }
        ],
        max_tokens: 512,
        temperature: 0.8,
        top_p: 0.9,
        stream: false
      };

      const r = await fetch(API_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-store",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        signal
      });
      if(!r.ok) throw new Error("HTTP " + r.status);
      return await r.json();
    }

    function normalizeAnswer(data){
      if(typeof data === "string") return data;

      // legacy /ask style
      if(data?.answer) return data.answer;
      if(data?.unified_answer) return data.unified_answer;
      if(data?.text) return data.text;
      if(data?.response) return data.response;

      // OpenAI style
      const c = data?.choices?.[0];
      const msg = c?.message?.content;
      if(typeof msg === "string") return msg;

      return "";
    }

    function normalizeQueueInfo(data){
      // optional: if API returns {queue:{position,eta_ms,in_flight}}
      const q = data?.queue;
      if(!q) return null;
      const pos = Number.isFinite(q.position) ? q.position : null;
      const inflight = Number.isFinite(q.in_flight) ? q.in_flight : null;
      if(pos === null && inflight === null) return null;
      return { pos, inflight };
    }

    function updateScrollAffordance(){
      if(!portalScroll || !scrollHint || !portalEl) return;
      const over = (portalScroll.scrollHeight - portalScroll.clientHeight) > 16;
      scrollHint.classList.toggle("show", over);
      portalEl.classList.toggle("can-scroll", over);
    }

    // ---------- Single-flight client queue (per-browser) ----------
    const clientQueue = [];
    let inFlight = false;

    async function runNext(){
      if(inFlight) return;
      const job = clientQueue.shift();
      if(!job) return;
      inFlight = true;
      try{
        await job();
      }finally{
        inFlight = false;
        runNext();
      }
    }

    function enqueue(fn){
      clientQueue.push(fn);
      runNext();
    }

    async function processInquiry(qOverride){
      const q = (qOverride ?? (input ? input.value : "")).trim();
      if(!q) return;

      enqueue(async () => {
        // timeout
        const controller = new AbortController();
        const timeoutMs = 15000;
        const t = setTimeout(() => controller.abort(), timeoutMs);

        // show queue note if multiple clicks
        const pending = clientQueue.length;
        setLoading(true, pending ? `Listening‚Ä¶ (queued ${pending})` : "Listening‚Ä¶");

        try{
          const data = isChatCompletions(API_URL)
            ? await askChatCompletions(q, controller.signal)
            : await askLegacyAsk(q, controller.signal);

          const a = normalizeAnswer(data);
          const parsed = a ? parseMirrorAnswer(a) : null;

          const out = parsed ? {
            main: parsed.main,
            echo: "Echo: Stillness yields truth",
            res:  `Resonance: ${parsed.resonance}`,
            guide: parsed.guide
          } : localFallback(q);

          if(mainText)  mainText.textContent = `‚Äú${out.main}‚Äù`;
          if(echoText)  echoText.textContent = out.echo;
          if(resText)   resText.textContent  = out.res;
          if(guideText) guideText.textContent= out.guide;

          incLeaves();
          addHistory({ ts: Date.now(), q, a: out.main });

          if(portalScroll) portalScroll.scrollTop = 0;

          showOutput();
          if(input) input.value = "";

          requestAnimationFrame(updateScrollAffordance);
        }catch(e){
          const out = localFallback(q);
          if(mainText)  mainText.textContent = `‚Äú${out.main}‚Äù`;
          if(echoText)  echoText.textContent = out.echo;
          if(resText)   resText.textContent  = out.res;
          if(guideText) guideText.textContent= out.guide;
          if(err) err.classList.remove("hidden");

          if(portalScroll) portalScroll.scrollTop = 0;
          showOutput();
          requestAnimationFrame(updateScrollAffordance);
        }finally{
          clearTimeout(t);
          setLoading(false);
        }
      });
    }

    if(reflectBtn) reflectBtn.addEventListener("click", () => processInquiry());
    if(input) input.addEventListener("keydown", (e) => { if(e.key === "Enter") processInquiry(); });

    document.querySelectorAll(".preset").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".preset").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const t = btn.getAttribute("data-text") || "";
        if(input) input.value = t;
        processInquiry(t);
      });
    });

    if(historyBtn) historyBtn.addEventListener("click", openSheet);
    const closeSheetBtn = document.getElementById("close-sheet");
    const clearHistoryBtn = document.getElementById("clear-history");
    if(closeSheetBtn) closeSheetBtn.addEventListener("click", closeSheet);
    if(clearHistoryBtn) clearHistoryBtn.addEventListener("click", () => {
      localStorage.removeItem(KEY_HISTORY);
      renderHistory();
    });

    let expanded = false;
    function toggleExpanded(){
      expanded = !expanded;
      document.body.classList.toggle("expanded", expanded);
      const pill = tapHeader ? tapHeader.querySelector(".tap-pill") : null;
      if(pill) pill.textContent = expanded ? "Tap to Collapse" : "Tap to Expand";
      requestAnimationFrame(updateScrollAffordance);
    }
    if(tapHeader) tapHeader.addEventListener("click", toggleExpanded);
    if(titleTapZone) titleTapZone.addEventListener("click", toggleExpanded);

    // Wallet demo toggle (kept simple)
    const walletBtn = document.getElementById("wallet-btn");
    if(walletBtn){
      let walletState = "disconnected";
      walletBtn.addEventListener("click", async () => {
        if(walletState === "disconnected"){
          walletState = "connecting";
          walletBtn.textContent = "Connecting‚Ä¶";
          walletBtn.classList.add("opacity-70");
          await new Promise(r => setTimeout(r, 700));
          walletState = "connected";
          walletBtn.classList.remove("opacity-70");
          walletBtn.textContent = "0x12‚Ä¶89 (Base)";
        }else{
          walletState = "disconnected";
          walletBtn.textContent = "Connect Wallet (Base)";
        }
      });
    }

    const basescanBtn = document.getElementById("basescan-btn");
    if(basescanBtn){
      basescanBtn.addEventListener("click", () => {
        alert("Coming soon: onchain karmic record. (Local history works now.)");
      });
    }

    // first paint
    setTimeout(() => { if(output) output.style.opacity = "1"; updateScrollAffordance(); }, 200);
    if(portalScroll){
      portalScroll.addEventListener("scroll", () => { updateScrollAffordance(); }, { passive:true });
    }
    window.addEventListener("resize", () => requestAnimationFrame(updateScrollAffordance));
  </script>
</body>
</html>
