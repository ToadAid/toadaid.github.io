<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="description" content="Mirror | The Digital Pond - A reflective space for mindful inquiry" />
  <title>Mirror | The Digital Pond</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400&display=swap');

    :root{
      --safe-t: env(safe-area-inset-top);
      --safe-b: env(safe-area-inset-bottom);
      --safe-l: env(safe-area-inset-left);
      --safe-r: env(safe-area-inset-right);

      --pad-top: calc(14px + var(--safe-t));
      --pad-bot: calc(18px + var(--safe-b));
      --pad-x: 16px;

      --portal-radius: 28px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: #030303;
      color: #d1d1d1;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    body{
      padding: var(--pad-top) calc(var(--pad-x) + var(--safe-r)) var(--pad-bot) calc(var(--pad-x) + var(--safe-l));
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 14px;
      overflow: hidden;
    }

    .water-bg{
      position: fixed;
      inset: 0;
      background:
        radial-gradient(1200px 800px at 50% 35%, rgba(16,185,129,0.06), transparent 55%),
        radial-gradient(900px 600px at 50% 70%, rgba(255,255,255,0.03), transparent 60%),
        linear-gradient(rgba(0,0,0,0.92), rgba(0,0,0,0.98));
      z-index: -1;
    }

    .serif { font-family: 'Cinzel', serif; }

    .shell{
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
    }

    .middle{
      min-height: 0;
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .portal{
      position: relative;
      overflow: hidden;
      box-sizing: border-box;

      width: min(92vw, 860px);
      height: min(56vh, 540px);
      max-height: 100%;
      margin: 0 auto;

      border-radius: var(--portal-radius);
      border: 1px solid rgba(255,255,255,0.10);

      background:
        radial-gradient(1200px 620px at 30% 18%, rgba(255,255,255,0.14), transparent 58%),
        radial-gradient(900px 620px at 70% 26%, rgba(16,185,129,0.08), transparent 62%),
        radial-gradient(1200px 900px at 50% 120%, rgba(0,0,0,0.85), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.46));

      box-shadow:
        0 36px 110px rgba(0,0,0,0.82),
        0 10px 28px rgba(0,0,0,0.45),
        inset 0 1px 0 rgba(255,255,255,0.14),
        inset 0 -28px 70px rgba(0,0,0,0.68),
        inset 0 0 0 1px rgba(16,185,129,0.08);

      backdrop-filter: blur(10px);

      display: flex;
      flex-direction: column;

      transform: translateZ(0);
      transition: transform .18s ease, box-shadow .18s ease;
      transform-style: preserve-3d;
      will-change: transform, box-shadow;
    }

    .portal::before{
      content:'';
      position:absolute;
      inset:-2px;
      border-radius: inherit;
      background:
        radial-gradient(420px 220px at 26% 16%, rgba(255,255,255,0.16), transparent 62%),
        radial-gradient(520px 260px at 64% 24%, rgba(255,255,255,0.08), transparent 70%),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.018) 0, rgba(255,255,255,0.018) 1px, transparent 1px, transparent 3px);
      opacity: 0.95;
      pointer-events:none;
      z-index: 0;
    }

    .portal::after{
      content:'';
      position:absolute;
      inset: 6px;
      border-radius: inherit;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow:
        0 0 0 1px rgba(16,185,129,0.10),
        0 0 28px rgba(16,185,129,0.08);
      pointer-events:none;
      z-index: 0;
    }

    .portal > *{ position: relative; z-index: 1; }

    .portal.tilt{
      transform: translateY(-1px) rotateX(0.8deg);
      box-shadow:
        0 34px 90px rgba(0,0,0,0.74),
        inset 0 1px 0 rgba(255,255,255,0.12),
        inset 0 -22px 52px rgba(0,0,0,0.56);
    }

    .ripple-overlay{
      position:absolute;
      inset:0;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .25s ease;
      background: radial-gradient(circle at 50% 60%, rgba(16,185,129,0.08), transparent 55%);
      z-index: 0;
    }
    .ripple-overlay::before,
    .ripple-overlay::after{
      content:"";
      position:absolute;
      left:50%;
      top:60%;
      width:16px;height:16px;
      transform:translate(-50%,-50%);
      border-radius:9999px;
      border:1px solid rgba(16,185,129,0.28);
      opacity:0;
    }
    .portal.listening .ripple-overlay{ opacity:1; }
    .portal.listening .ripple-overlay::before{
      animation: pondRipple 1.35s ease-out infinite;
      opacity:1;
    }
    .portal.listening .ripple-overlay::after{
      animation: pondRipple 1.35s ease-out infinite;
      animation-delay:.35s;
      border-color: rgba(16,185,129,0.18);
      opacity:1;
    }
    @keyframes pondRipple{
      0%{width:16px;height:16px;opacity:.75}
      70%{width:520px;height:520px;opacity:.10}
      100%{width:620px;height:620px;opacity:0}
    }

    @media (max-width: 480px){
      .portal{
        width: min(94vw, 860px);
        height: min(54vh, 540px);
        border-radius: 26px;
      }
    }

    @media (prefers-reduced-motion: reduce){
      .portal.listening .ripple-overlay::before,
      .portal.listening .ripple-overlay::after{ animation:none !important; }
      .manual-overlay{ animation:none !important; }
    }

    input{
      background: rgba(255,255,255,0.05) !important;
      border: 1px solid rgba(255,255,255,0.12) !important;
      border-radius: 12px;
    }

    .preset.active{
      border-color: rgba(16,185,129,0.65) !important;
      box-shadow: 0 0 0 1px rgba(16,185,129,0.18), 0 0 22px rgba(16,185,129,0.12);
      background: rgba(16,185,129,0.06) !important;
    }

    .portal-scroll{
      flex: 1;
      min-height: 0;
      overflow: auto;
      padding: 18px 18px 16px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .portal-scroll::-webkit-scrollbar{ display:none; }

    .portal-fade{
      position:absolute;
      left:0; right:0; bottom:0;
      height: 56px;
      background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.55));
      pointer-events:none;
      z-index: 2;
      opacity: 0;
      transition: opacity .25s ease;
    }
    .portal.can-scroll .portal-fade{ opacity: 1; }

    .scroll-hint{
      font-size: 10px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.22);
      display: none;
      align-items: center;
      justify-content: center;
      gap: 10px;
      user-select: none;
      pointer-events: none;
      margin-top: 6px;
    }
    .scroll-hint.show{ display:flex; }

    .chev{
      width: 18px; height: 18px;
      border-radius: 9999px;
      border: 1px solid rgba(255,255,255,0.10);
      display:flex; align-items:center; justify-content:center;
      opacity: .85;
    }

    body.expanded{ overflow: hidden; }
    body.expanded .portal{
      height: min(72vh, 720px);
      width: min(94vw, 900px);
    }

    .tap-header{
      width: 100%;
      display:flex;
      align-items:center;
      justify-content: flex-end;
      user-select:none;
      margin-bottom: 10px;
    }
    .tap-pill{
      font-size: 10px;
      letter-spacing: .24em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.32);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 6px 10px;
      border-radius: 9999px;
    }
    body.expanded .tap-pill{
      color: rgba(255,255,255,0.62);
      border-color: rgba(16,185,129,0.30);
      box-shadow: 0 0 18px rgba(16,185,129,0.10);
      background: rgba(16,185,129,0.05);
    }

    .sheet{
      position:fixed;
      left:0; right:0;
      bottom:-75%;
      height:75%;
      background: rgba(5,5,5,0.92);
      border-top: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      transition: bottom .35s ease;
      z-index:50;
      padding-bottom: calc(16px + var(--safe-b));
    }
    .sheet.open{ bottom:0; }
    .sheet-handle{
      width:64px; height:4px;
      border-radius:9999px;
      background: rgba(255,255,255,0.18);
      margin: 10px auto;
    }

    #reflect-btn:active{ transform: translateY(1px); }

    /* Manual Overlay (opening veil) */
    .manual-overlay{
      background: rgba(0,0,0,0.88);
      backdrop-filter: blur(12px);
      animation: manualFadeIn .6s ease-out;
      transition: opacity .25s ease;
    }
    @keyframes manualFadeIn{
      from{ opacity:0; }
      to{ opacity:1; }
    }
  
    
    /* Preset buttons: always centered in any viewport */
    .preset-buttons{
      width: 100%;
      justify-content: center;
      align-items: center;
      margin-left: auto;
      margin-right: auto;
    }
    .preset-buttons .preset{ white-space: nowrap; }

    /* Title color (toggle gold/white) */
    :root{ --mirror-title-color: #e6c27a; } /* set to #ffffff for pure white */
    .mirror-title{
      color: var(--mirror-title-color);
      text-shadow:
        0 0 10px rgba(230,194,122,.22),
        0 0 26px rgba(230,194,122,.10);
    }

  </style>
</head>

<body>
  <!-- Accessibility skip link -->
  <a href="#portal" class="skip-link">Skip to main content</a>
  <span id="input-hint" class="sr-only">Type your question and press Enter or click Reflect</span>

  <!-- Background -->
  <div class="water-bg"></div>

  <!-- Toast for notifications -->
  <div id="toast" class="toast"></div>

  <!-- Manual overlay -->
  <div id="manual" class="manual-overlay">
    <div class="manual-content">
      <h2 class="serif">The Covenant</h2>
      <p>This pond reflects what you bring to it. Speak your truth, and the waters will answer.</p>
      <p style="font-size: 13px; opacity: 0.8;">Your reflections are stored locally. No data is sent to external servers unless you explicitly ask the Mirror.</p>
      <button id="manual-accept" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 py-3 rounded-lg transition mt-6 font-semibold">
        Enter the Pond
      </button>
    </div>
  </div>

  <!-- Settings panel -->
  <div id="settings-panel" class="settings-panel">
    <div class="flex justify-between items-center mb-8">
      <h3 class="serif">Settings</h3>
      <button id="close-settings" class="text-zinc-400 hover:text-white text-xl">‚úï</button>
    </div>
    
    <div class="space-y-8">
      <!-- Theme UI hidden for v0.2 (locked to Pond Classic) -->
<div>
        <h4>Sounds</h4>
        <div class="flex items-center justify-between mt-3">
          <span class="text-sm">Ambient sounds</span>
          <label class="switch">
            <input type="checkbox" id="sound-toggle" checked>
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div>
        <h4>History</h4>
        <button id="export-history" class="w-full text-sm border border-zinc-700 hover:border-green-500 hover:text-green-400 py-3 rounded-lg transition mt-3">
          Export Reflections
        </button>
      </div>
      
      <div class="pt-6 border-t border-zinc-800">
        <button id="clear-all-data" class="w-full text-sm text-red-400 hover:text-red-300 py-3">
          Clear All Data
        </button>
      </div>
    </div>
  </div>

  <!-- Top bar -->
  <div class="shell w-full z-10">
    <div class="w-full flex items-center justify-between gap-3">
      <div class="text-[12px] uppercase tracking-widest text-zinc-500 font-medium">
        POND ¬∑ v0.2
      </div>
      <div class="flex items-center gap-3">

        <!-- Voice ritual (v0.3+): return Speak as a sacred hold-to-whisper action -->
<button id="settings-btn"
          class="px-4 py-2 text-[11px] uppercase tracking-widest rounded font-medium"
          title="Settings">
          ‚öôÔ∏è Settings
        </button>
        <button id="wallet-btn"
          class="px-4 py-2 text-[11px] uppercase tracking-widest rounded font-medium">
          Connect Wallet
        </button>
      </div>
    </div>
  </div>

  <!-- Main portal -->
  <div class="middle">
    <div class="portal text-center" id="portal">
      <div class="ripple-overlay"></div>
      <div class="portal-fade" id="portal-fade"></div>

      <div class="portal-scroll" id="portal-scroll">
        <div class="tap-header" id="tap-header" title="Tap to expand / collapse">
          <div class="tap-pill">Tap to Expand</div>
        </div>

        <div class="pt-1" id="title-tap-zone" title="Tap to expand / collapse">
          <h1 class="serif mirror-title text-3xl tracking-[0.2em] mb-2">MIRROR</h1>
          <p class="serif text-[12px] tracking-widest text-zinc-400 font-light">The Digital Pond</p>
        </div>

        <!-- Preset questions -->
        <div class="preset-buttons w-full max-w-xl mt-6 mx-auto flex flex-wrap justify-center items-center gap-3">
          <button class="preset" data-text="Mirror, what does stillness mean for me today?">
            Stillness
          </button>
          <button class="preset" data-text="How do I practice patience when nothing moves?">
            Patience
          </button>
          <button class="preset" data-text="What does it mean to become who I already am?">
            Becoming
          </button>
          <button class="preset" data-text="Explain: Toby is the people, and the people is Toby. What does it ask of me?">
            Toby = People
          </button>
        </div>

        <!-- Scroll hint -->
        <div id="scroll-hint" class="scroll-hint mt-4">
          <span class="chev">‚åÑ</span>
          <span>Swipe to read</span>
          <span class="chev">‚åÉ</span>
        </div>

        <!-- Reflection output -->
        <div id="reflection-output" class="space-y-6 opacity-0 transition-opacity duration-500 mt-8">
          <!-- Favorite button -->
          <div class="flex justify-end">
            <button id="favorite-btn" class="favorite-btn" title="Add to favorites">
              ‚òÜ
            </button>
          </div>

          <p id="main-text" class="italic">
            "Stillness yields truth."
          </p>

          <div class="space-y-2 text-[11px] uppercase tracking-widest font-medium">
            <p id="echo-text" class="text-emerald-400">Echo: Stillness yields truth</p>
            <p id="res-text" class="text-zinc-400">Resonance: Roots deepen.</p>
          </div>

          <p id="guide-text" class="text-[14px] italic">
            What remains when urgency leaves?
          </p>
<div class="pt-8 text-2xl opacity-70">
            ‚è≥ ‚âã üçÉ ü™û
          </div>
        </div>

        <!-- Error message -->
        <div id="err" class="mt-6 hidden">
          The pond could not hear the ocean. Check endpoint health.
        </div>

        <div style="height: 32px;"></div>
      </div>
    </div>
  </div>

  <!-- Bottom controls -->
  <div class="shell w-full z-10 space-y-4" style="flex-direction: column; align-items: stretch;">
    <div class="flex gap-3">
      <input id="user-input" type="text" 
             placeholder="Inquire the Pond (Type your question‚Ä¶ Press Enter to reflect)"
             class="flex-grow"
             aria-label="Your inquiry" />
      <button id="reflect-btn"
        class="px-8 uppercase tracking-widest rounded-lg font-semibold"
        aria-label="Reflect">
        Reflect
      </button>
    </div>

    <div class="flex justify-between items-center text-[11px] uppercase tracking-widest font-medium">
      <div class="flex items-center gap-3">
        <span class="text-zinc-500">üçÉ <span id="leaves">Leaves of Stillness: 0</span></span>
        <span id="favorite-count" class="text-amber-400 hidden">‚òÖ 0</span>
      </div>
      <div class="flex items-center gap-6">
        <button id="history-btn" class="hover:text-green-400 transition">History ‚Üü</button>
        <button id="basescan-btn" class="hover:text-green-400 transition">BaseScan ‚Üó</button>
      </div>
    </div>
  </div>

  <!-- History sheet -->
  <div id="sheet" class="sheet">
    <div class="sheet-handle"></div>
    <div class="px-6 pb-6 flex items-center justify-between">
      <div class="text-sm uppercase tracking-widest text-zinc-400 font-medium">Reflection History</div>
      <div class="flex gap-3 text-[11px] uppercase tracking-widest font-medium">
        <button id="filter-all" class="text-zinc-500 hover:text-green-400 transition">All</button>
        <button id="filter-fav" class="text-zinc-500 hover:text-amber-400 transition">‚òÖ</button>
      </div>
      <div class="flex gap-4">
        <button id="search-history" class="text-zinc-500 hover:text-green-400 transition text-lg" title="Search">
          üîç
        </button>
        <button id="clear-history" class="text-[11px] uppercase tracking-widest text-zinc-500 hover:text-red-400 transition font-medium">Clear</button>
        <button id="close-sheet" class="text-[11px] uppercase tracking-widest text-zinc-500 hover:text-green-400 transition font-medium">Close</button>
      </div>
    </div>
    <div id="history-list" class="px-6 overflow-auto" style="height: calc(75% - 70px);"></div>
  </div>

  <script>
    // Simplified version focusing on readability and eye comfort
    const state = {
      currentTheme: 'soft',
      soundsEnabled: true,
      favorites: new Set(),
      voiceActive: false
    };

    // --- Hidden Theme Engine (v0.2 locked UI, but engine remains) ---
    const THEMES = {
      classic: {
        "--bg-primary": "#0b0f0c",
        "--bg-secondary": "#101614",
        "--text-primary": "#f3f4f2",
        "--text-secondary": "#d1d5cf",
        "--text-muted": "#9aa39a",
        "--accent-primary": "#4fae7a",
        "--accent-secondary": "#d6b36a",
        "--border-light": "rgba(255, 255, 255, 0.08)",
        "--border-medium": "rgba(255, 255, 255, 0.14)",
        "--theme-soft": "rgba(79, 174, 122, 0.18)",
        "--theme-glow": "rgba(79, 174, 122, 0.12)"
      },
      soft: {
        "--bg-primary": "#0b0f0c",
        "--bg-secondary": "#101614",
        "--text-primary": "#f3f4f2",
        "--text-secondary": "#d1d5cf",
        "--text-muted": "#9aa39a",
        "--accent-primary": "#5cc69a",
        "--accent-secondary": "#d6b36a",
        "--border-light": "rgba(255, 255, 255, 0.08)",
        "--border-medium": "rgba(255, 255, 255, 0.14)",
        "--theme-soft": "rgba(92, 198, 154, 0.16)",
        "--theme-glow": "rgba(92, 198, 154, 0.10)"
      },
      night: {
        "--bg-primary": "#070b09",
        "--bg-secondary": "#0e1412",
        "--text-primary": "#f3f4f2",
        "--text-secondary": "#d1d5cf",
        "--text-muted": "#9aa39a",
        "--accent-primary": "#3f8f66",
        "--accent-secondary": "#e0c07a",
        "--border-light": "rgba(255, 255, 255, 0.07)",
        "--border-medium": "rgba(255, 255, 255, 0.13)",
        "--theme-soft": "rgba(63, 143, 102, 0.14)",
        "--theme-glow": "rgba(63, 143, 102, 0.10)"
      }
    };

    function applyTheme(name){
      const vars = THEMES[name];
      if(!vars) return;
      Object.entries(vars).forEach(([k,v]) => {
        document.documentElement.style.setProperty(k, v);
      });
      try{ localStorage.setItem("mirror_theme", name); }catch(e){}
    }

    function loadTheme(){
      try{
        const t = localStorage.getItem("mirror_theme") || "classic";
        applyTheme(t);
      }catch(e){
        applyTheme("classic");
      }
    }

    
    // DOM Elements
    const elements = {
      manual: document.getElementById('manual'),
      manualAccept: document.getElementById('manual-accept'),
      portal: document.getElementById('portal'),
      portalScroll: document.getElementById('portal-scroll'),
      scrollHint: document.getElementById('scroll-hint'),
      input: document.getElementById('user-input'),
      output: document.getElementById('reflection-output'),
      err: document.getElementById('err'),
      reflectBtn: document.getElementById('reflect-btn'),
      favoriteBtn: document.getElementById('favorite-btn'),
      favoriteCount: document.getElementById('favorite-count'),
      leavesEl: document.getElementById('leaves'),
      historyBtn: document.getElementById('history-btn'),
      sheet: document.getElementById('sheet'),
      historyList: document.getElementById('history-list'),
      settingsPanel: document.getElementById('settings-panel'),
      settingsBtn: document.getElementById('settings-btn'),
      closeSettings: document.getElementById('close-settings'),
      themeButtons: document.querySelectorAll('.theme-btn'),
      toast: document.getElementById('toast')
    };
    // --- API integration (ported from the old pond) ---
    const DEFAULT_API_URL = "https://toadaid.duckdns.org/ask";

    function resolveApiUrl(){
      try{
        const p = new URLSearchParams(window.location.search);
        const v = p.get("api");
        return (v && v.trim()) ? v.trim() : DEFAULT_API_URL;
      }catch(e){
        return DEFAULT_API_URL;
      }
    }

    let API_URL = resolveApiUrl();

    function isOpenAIChatCompletions(url){
      try{ return String(url || "").includes("/v1/chat/completions"); }catch(e){ return false; }
    }

    function resolveTimeoutMs(){
      try{
        const p = new URLSearchParams(window.location.search);
        const v = p.get("timeout");
        const n = v ? Number(v) : NaN;
        if(Number.isFinite(n) && n >= 3000 && n <= 180000) return Math.floor(n);
      }catch(e){}
      return 45000;
    }

    const TIMEOUT_MS = resolveTimeoutMs();

    function stripTravelerPrefix(s){
      return String(s || "").replace(/^\s*traveler[,Ôºö:]?\s*/i, "").trim();
    }

    function parseMirrorAnswer(raw){
      let text = String(raw || "").trim();
      text = text.replace(/[ü™ûüåäüçÉüåÄ‚öõÔ∏è‚âã‚è≥]+$/g, "").trim();

      let guide = "";
      const gMatch = text.match(/Guiding Question:\s*([\s\S]*)$/i);
      if(gMatch){
        guide = gMatch[1].trim();
        text = text.slice(0, gMatch.index).trim();
      }

      let resonance = "";
      const rMatch = text.match(/Reflection Resonance:\s*([\s\S]*)$/i);
      if(rMatch){
        resonance = rMatch[1].trim();
        text = text.slice(0, rMatch.index).trim();
      }

      const main = stripTravelerPrefix(text);

      return {
        main: main || "Stillness yields truth.",
        resonance: resonance || "Roots deepen.",
        guide: guide || "What remains when urgency leaves?"
      };
    }

    function localFallback(q){
      const val = String(q || "").toLowerCase();
      if(val.includes("price") || val.includes("money") || val.includes("pump") || val.includes("moon")){
        return {
          main: "The pond does not track the price of ghosts.",
          echo: "Echo: Canon Shield Active",
          res:  "Resonance: Attention released.",
          guide:"What would you ask if no number could save you?"
        };
      }
      return {
        main: "Every frantic move is a debt to time.",
        echo: "Echo: Stillness yields truth",
        res:  "Resonance: Roots deepen.",
        guide:"What remains when urgency leaves?"
      };
    }

    async function askAPI(question){
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), TIMEOUT_MS);

      try{
        if(isOpenAIChatCompletions(API_URL)){
          const payload = {
            model: "local-mirror",
            messages: [
              { role: "system", content: "You are the Mirror. Answer with calm, reflective tone. Include 'Reflection Resonance:' and end with one 'Guiding Question:'." },
              { role: "user", content: question }
            ],
            max_tokens: 512,
            temperature: 0.75,
            top_p: 0.9,
            stream: false,
            stop: ["</s>", "<|endoftext|>", "USER:", "###"]
          };

          const r = await fetch(API_URL, {
            method: "POST",
            mode: "cors",
            cache: "no-store",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(payload),
            signal: controller.signal
          });

          if(r.status === 429){
            const err = new Error("QUEUE_BUSY");
            err.code = 429;
            throw err;
          }
          if(!r.ok) throw new Error("HTTP " + r.status);
          return await r.json();
        }

        const payload = { question, user: "miniapp" };
        const r = await fetch(API_URL, {
          method: "POST",
          mode: "cors",
          cache: "no-store",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        if(r.status === 429){
          const err = new Error("QUEUE_BUSY");
          err.code = 429;
          throw err;
        }
        if(!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } finally {
        clearTimeout(t);
      }
    }

    function normalizeAnswer(data){
      if(typeof data === "string") return data;
      const openai = data?.choices?.[0]?.message?.content;
      if(openai) return openai;
      return data?.answer || data?.unified_answer || data?.text || data?.response || "";
    }

    
    // Initialize
    function init() {
      loadLeaves();
      
      loadTheme();
initManual();
      initEventListeners();
      
      // Add idle animation after delay
      setTimeout(() => {
        elements.portal.classList.add('idle');
      }, 1000);
      
      // Show initial text
      setTimeout(() => {
        elements.output.style.opacity = '1';
      }, 300);
    }
    
    // Toast notifications
    function showToast(message, duration = 3000) {
      elements.toast.textContent = message;
      elements.toast.classList.add('show');
      
      setTimeout(() => {
        elements.toast.classList.remove('show');
      }, duration);
    }
    
    // Manual overlay
    function initManual() {
      try {
        const accepted = localStorage.getItem('mirror_accepted') === 'yes';
        if (!accepted) {
          elements.manual.classList.add('active');
        }
      } catch (e) {
        elements.manual.classList.add('active');
      }
    }
    
    function acceptCovenant() {
      localStorage.setItem('mirror_accepted', 'yes');
      elements.manual.classList.remove('active');
      showToast('Welcome to the Pond');
    }
    
    // Leaves counter
    function loadLeaves() {
      const n = Number(localStorage.getItem('mirror_leaves') || '0');
      elements.leavesEl.textContent = `Leaves of Stillness: ${n}`;
    }
    
    function incLeaves() {
      const n = Number(localStorage.getItem('mirror_leaves') || '0') + 1;
      localStorage.setItem('mirror_leaves', String(n));
      elements.leavesEl.textContent = `Leaves of Stillness: ${n}`;
    }
    
    // Event listeners
    function initEventListeners() {
      // Manual
      elements.manualAccept?.addEventListener('click', acceptCovenant);
      
      // Settings
      elements.settingsBtn?.addEventListener('click', () => {
        elements.settingsPanel.classList.add('open');
      });
      
      elements.closeSettings?.addEventListener('click', () => {
        elements.settingsPanel.classList.remove('open');
      });
      
      // Theme switching (UI hidden in v0.2, engine remains)
      if (elements.themeButtons && elements.themeButtons.length) {
        elements.themeButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            elements.themeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const name = btn.dataset.theme || 'classic';
            applyTheme(name);
            showToast(`Theme: ${name}`);
          });
        });
      }

      // Portal interactions
      elements.portal.addEventListener("pointerdown", () => elements.portal.classList.add("tilt"));
      elements.portal.addEventListener("pointerup", () => elements.portal.classList.remove("tilt"));
      elements.portal.addEventListener("pointercancel", () => elements.portal.classList.remove("tilt"));
      
      // Expand/collapse
      document.getElementById('tap-header')?.addEventListener('click', toggleExpanded);
      document.getElementById('title-tap-zone')?.addEventListener('click', toggleExpanded);
      
      // Preset buttons
      document.querySelectorAll('.preset').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.preset').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const text = btn.getAttribute('data-text') || '';
          elements.input.value = text;
          elements.input.focus();
        processInquiry(text);
          });
      });
      
      // Reflect button
      elements.reflectBtn?.addEventListener('click', () => processInquiry());
      elements.input?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') processInquiry();
      });
      
      // History
      elements.historyBtn?.addEventListener('click', () => {
        renderHistory('all');
        elements.sheet.classList.add('open');
      });
      
      document.getElementById('filter-all')?.addEventListener('click', () => renderHistory('all'));
      document.getElementById('filter-fav')?.addEventListener('click', () => renderHistory('fav'));

      document.getElementById('close-sheet')?.addEventListener('click', () => {
        elements.sheet.classList.remove('open');
      });
      
      document.getElementById('clear-history')?.addEventListener('click', () => {
        if (confirm('Clear all reflection history?')) {
          localStorage.removeItem('mirror_history');
          renderHistory();
          showToast('History cleared');
        }
      });
      
      // Favorite (per-reflection; persists to history[0].fav)
      elements.favoriteBtn?.addEventListener('click', () => {
        const btn = elements.favoriteBtn;
        const isNowFav = !btn.classList.contains('active');
        btn.classList.toggle('active', isNowFav);
        btn.textContent = isNowFav ? '‚òÖ' : '‚òÜ';
        btn.dataset.marked = isNowFav ? '1' : '0';
        showToast(isNowFav ? 'Marked as favorite' : 'Unmarked');

        // Persist to most recent history entry
        try {
          const KEY = 'mirror_history';
          const history = JSON.parse(localStorage.getItem(KEY) || '[]');
          if (history.length > 0) {
            history[0].fav = isNowFav;
            localStorage.setItem(KEY, JSON.stringify(history));
          }
        } catch (e) {}
      });
      // (Share/Follow-up removed in v0.2)


      
      // Wallet
      document.getElementById('wallet-btn')?.addEventListener('click', () => {
        showToast('Wallet connection coming soon');
      });
      // (Voice removed in v0.2)


      
      // Scroll handling
      elements.portalScroll.addEventListener('scroll', updateScrollAffordance, { passive: true });
      window.addEventListener('resize', () => requestAnimationFrame(updateScrollAffordance));
    }
    
    // Expand/collapse
    let expanded = false;
    function toggleExpanded() {
      expanded = !expanded;
      document.body.classList.toggle('expanded', expanded);
      const pill = document.querySelector('.tap-pill');
      if (pill) pill.textContent = expanded ? 'Tap to Collapse' : 'Tap to Expand';
      requestAnimationFrame(updateScrollAffordance);
    }
    
    // Scroll affordance
    function updateScrollAffordance() {
      const over = (elements.portalScroll.scrollHeight - elements.portalScroll.clientHeight) > 16;
      elements.scrollHint.classList.toggle('show', over);
      elements.portal.classList.toggle('can-scroll', over);
    }
    
    
    // --- Live reflection: call API (old logic, new UI) ---
    async function processInquiry(qOverride){
      const q = (qOverride ?? elements.input.value).trim();
      if(!q) return;

      elements.portal.classList.add('listening');
      elements.reflectBtn.disabled = true;
      elements.reflectBtn.textContent = 'Listening...';
      elements.output.style.opacity = '0.65';
      elements.err.classList.add('hidden');

      const maxAttempts = 4;
      let attempt = 0;

      try{
        while(true){
          attempt += 1;
          try{
            const data = await askAPI(q);
            const a = normalizeAnswer(data);
            const parsed = a ? parseMirrorAnswer(a) : null;

            const out = parsed ? {
              main: parsed.main,
              echo: "Echo: " + (parsed.main.split(' ').slice(0, 6).join(' ') + (parsed.main.split(' ').length > 6 ? "..." : "")),
              res:  "Resonance: " + parsed.resonance,
              guide: parsed.guide
            } : localFallback(q);

            document.getElementById('main-text').textContent = `‚Äú${out.main}‚Äù`;
            document.getElementById('echo-text').textContent = out.echo;
            document.getElementById('res-text').textContent = out.res;
            document.getElementById('guide-text').textContent = out.guide;

            try{
              const KEY_HISTORY = "mirror_history";
              const history = JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]");
              history.unshift({ ts: Date.now(), q, a: out.main, fav: false });
              localStorage.setItem(KEY_HISTORY, JSON.stringify(history.slice(0, 30)));
            }catch(e){}

            incLeaves();
            // reset favorite for the next reflection (never auto-mark)
            if (elements.favoriteBtn) {
              elements.favoriteBtn.classList.remove('active');
              elements.favoriteBtn.textContent = '‚òÜ';
              elements.favoriteBtn.dataset.marked = '0';
            }
            showToast('Reflection received');

            elements.portalScroll.scrollTop = 0;
            updateScrollAffordance();

            elements.input.value = '';
            elements.output.style.opacity = '1';
            break;
          }catch(e){
            const isQueue = (e && (e.code === 429 || String(e.message||"") === "QUEUE_BUSY"));
            const isAbort = (e && String(e.name||"") === "AbortError");

            if((isQueue || isAbort) && attempt < maxAttempts){
              document.getElementById('main-text').textContent = `‚ÄúThe pond is busy‚Ä¶ waiting (${attempt}/${maxAttempts})‚Äù`;
              document.getElementById('echo-text').textContent = "Echo: Hold your breath.";
              document.getElementById('res-text').textContent = "Resonance: Patience in motion.";
              document.getElementById('guide-text').textContent = "What changes when you allow time to work for you?";
              elements.output.style.opacity = '1';

              const delay = Math.min(600 * Math.pow(2, attempt-1), 3500);
              await new Promise(r => setTimeout(r, delay));
              continue;
            }

            const out = localFallback(q);
            document.getElementById('main-text').textContent = `‚Äú${out.main}‚Äù`;
            document.getElementById('echo-text').textContent = out.echo;
            document.getElementById('res-text').textContent  = out.res;
            document.getElementById('guide-text').textContent = out.guide;

            elements.err.classList.remove('hidden');
            elements.output.style.opacity = '1';
            break;
          }
        }
      } finally {
        elements.portal.classList.remove('listening');
        elements.reflectBtn.disabled = false;
        elements.reflectBtn.textContent = 'Reflect';
      }
    }

    
    // History rendering (supports filter: 'all' | 'fav')
    function renderHistory(filter = 'all') {
      try {
        const history = JSON.parse(localStorage.getItem('mirror_history') || '[]');
        const list = (filter === 'fav') ? history.filter(h => h.fav) : history;

        if (!list.length) {
          elements.historyList.innerHTML = `
            <div class="text-center py-12">
              <div class="text-zinc-500 mb-2">No reflections yet</div>
              <div class="text-xs text-zinc-600">${filter === 'fav' ? 'Your marked reflections will appear here' : 'Your first inquiry will appear here'}</div>
            </div>`;
          return;
        }

        elements.historyList.innerHTML = list.map(item => `
          <div class="py-5 border-b border-zinc-800">
            <div class="flex justify-between items-start mb-3">
              <div class="text-xs text-zinc-500">${new Date(item.ts).toLocaleString()}</div>
              ${item.fav ? '<span class="text-amber-400">‚òÖ</span>' : ''}
            </div>
            <div class="text-sm text-zinc-300 mb-2">${escapeHtml(item.q)}</div>
            <div class="text-sm italic text-green-300">"${escapeHtml(item.a)}"</div>
          </div>
        `).join('');
      } catch (e) {
        elements.historyList.innerHTML = `<div class="text-red-400 text-sm py-6">Could not load history</div>`;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
// Initialize
    document.addEventListener('DOMContentLoaded', init);
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
