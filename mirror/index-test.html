<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Mirror | The Digital Pond</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- MiniKit for Base wallet + onchain actions -->
  <script src="https://minikit.worldcoin.org/minikit.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400&display=swap');

    :root{
      --safe-t: env(safe-area-inset-top);
      --safe-b: env(safe-area-inset-bottom);
      --safe-l: env(safe-area-inset-left);
      --safe-r: env(safe-area-inset-right);

      --pad-top: calc(14px + var(--safe-t));
      --pad-bot: calc(18px + var(--safe-b));
      --pad-x: 16px;

      --portal-radius: 28px;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: #030303;
      color: #d1d1d1;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    body{
      padding: var(--pad-top) calc(var(--pad-x) + var(--safe-r)) var(--pad-bot) calc(var(--pad-x) + var(--safe-l));
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 14px;
      overflow: hidden;
    }

    .water-bg{
      position: fixed;
      inset: 0;
      background:
        radial-gradient(1200px 800px at 50% 35%, rgba(16,185,129,0.06), transparent 55%),
        radial-gradient(900px 600px at 50% 70%, rgba(255,255,255,0.03), transparent 60%),
        linear-gradient(rgba(0,0,0,0.92), rgba(0,0,0,0.98));
      z-index: -1;
    }

    .serif { font-family: 'Cinzel', serif; }

    .shell{
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
    }

    .middle{
      min-height: 0;
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .portal{
      position: relative;
      overflow: hidden;
      box-sizing: border-box;

      width: min(92vw, 860px);
      height: min(56vh, 540px);
      max-height: 100%;
      margin: 0 auto;

      border-radius: var(--portal-radius);
      border: 1px solid rgba(255,255,255,0.10);

      background:
        radial-gradient(1200px 620px at 30% 18%, rgba(255,255,255,0.14), transparent 58%),
        radial-gradient(900px 620px at 70% 26%, rgba(16,185,129,0.08), transparent 62%),
        radial-gradient(1200px 900px at 50% 120%, rgba(0,0,0,0.85), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.46));

      box-shadow:
        0 36px 110px rgba(0,0,0,0.82),
        0 10px 28px rgba(0,0,0,0.45),
        inset 0 1px 0 rgba(255,255,255,0.14),
        inset 0 -28px 70px rgba(0,0,0,0.68),
        inset 0 0 0 1px rgba(16,185,129,0.08);

      backdrop-filter: blur(10px);

      display: flex;
      flex-direction: column;

      transform: translateZ(0);
      transition: transform .18s ease, box-shadow .18s ease;
      transform-style: preserve-3d;
      will-change: transform, box-shadow;
    }

    .portal::before{
      content:'';
      position:absolute;
      inset:-2px;
      border-radius: inherit;
      background:
        radial-gradient(420px 220px at 26% 16%, rgba(255,255,255,0.16), transparent 62%),
        radial-gradient(520px 260px at 64% 24%, rgba(255,255,255,0.08), transparent 70%),
        repeating-linear-gradient(0deg, rgba(255,255,255,0.018) 0, rgba(255,255,255,0.018) 1px, transparent 1px, transparent 3px);
      opacity: 0.95;
      pointer-events:none;
      z-index: 0;
    }

    .portal::after{
      content:'';
      position:absolute;
      inset: 6px;
      border-radius: inherit;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow:
        0 0 0 1px rgba(16,185,129,0.10),
        0 0 28px rgba(16,185,129,0.08);
      pointer-events:none;
      z-index: 0;
    }

    .portal > *{ position: relative; z-index: 1; }

    .portal.tilt{
      transform: translateY(-1px) rotateX(0.8deg);
      box-shadow:
        0 34px 90px rgba(0,0,0,0.74),
        inset 0 1px 0 rgba(255,255,255,0.12),
        inset 0 -22px 52px rgba(0,0,0,0.56);
    }

    .ripple-overlay{
      position:absolute;
      inset:0;
      border-radius: inherit;
      pointer-events:none;
      opacity:0;
      transition: opacity .25s ease;
      background: radial-gradient(circle at 50% 60%, rgba(16,185,129,0.08), transparent 55%);
      z-index: 0;
    }
    .ripple-overlay::before,
    .ripple-overlay::after{
      content:"";
      position:absolute;
      left:50%;
      top:60%;
      width:16px;height:16px;
      transform:translate(-50%,-50%);
      border-radius:9999px;
      border:1px solid rgba(16,185,129,0.28);
      opacity:0;
    }
    .portal.listening .ripple-overlay{ opacity:1; }
    .portal.listening .ripple-overlay::before{
      animation: pondRipple 1.35s ease-out infinite;
      opacity:1;
    }
    .portal.listening .ripple-overlay::after{
      animation: pondRipple 1.35s ease-out infinite;
      animation-delay:.35s;
      border-color: rgba(16,185,129,0.18);
      opacity:1;
    }
    @keyframes pondRipple{
      0%{width:16px;height:16px;opacity:.75}
      70%{width:520px;height:520px;opacity:.10}
      100%{width:620px;height:620px;opacity:0}
    }

    @media (max-width: 480px){
      .portal{
        width: min(94vw, 860px);
        height: min(54vh, 540px);
        border-radius: 26px;
      }
    }

    @media (prefers-reduced-motion: reduce){
      .portal.listening .ripple-overlay::before,
      .portal.listening .ripple-overlay::after{ animation:none !important; }
      .manual-overlay{ animation:none !important; }
    }

    input{
      background: rgba(255,255,255,0.05) !important;
      border: 1px solid rgba(255,255,255,0.12) !important;
      border-radius: 12px;
    }

    .preset.active{
      border-color: rgba(16,185,129,0.65) !important;
      box-shadow: 0 0 0 1px rgba(16,185,129,0.18), 0 0 22px rgba(16,185,129,0.12);
      background: rgba(16,185,129,0.06) !important;
    }

    .portal-scroll{
      flex: 1;
      min-height: 0;
      overflow: auto;
      padding: 18px 18px 16px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .portal-scroll::-webkit-scrollbar{ display:none; }

    .portal-fade{
      position:absolute;
      left:0; right:0; bottom:0;
      height: 56px;
      background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.55));
      pointer-events:none;
      z-index: 2;
      opacity: 0;
      transition: opacity .25s ease;
    }
    .portal.can-scroll .portal-fade{ opacity: 1; }

    .scroll-hint{
      font-size: 10px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.22);
      display: none;
      align-items: center;
      justify-content: center;
      gap: 10px;
      user-select: none;
      pointer-events: none;
      margin-top: 6px;
    }
    .scroll-hint.show{ display:flex; }

    .chev{
      width: 18px; height: 18px;
      border-radius: 9999px;
      border: 1px solid rgba(255,255,255,0.10);
      display:flex; align-items:center; justify-content:center;
      opacity: .85;
    }

    body.expanded{ overflow: hidden; }
    body.expanded .portal{
      height: min(72vh, 720px);
      width: min(94vw, 900px);
    }

    .tap-header{
      width: 100%;
      display:flex;
      align-items:center;
      justify-content: flex-end;
      user-select:none;
      margin-bottom: 10px;
    }
    .tap-pill{
      font-size: 10px;
      letter-spacing: .24em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.32);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 6px 10px;
      border-radius: 9999px;
    }
    body.expanded .tap-pill{
      color: rgba(255,255,255,0.62);
      border-color: rgba(16,185,129,0.30);
      box-shadow: 0 0 18px rgba(16,185,129,0.10);
      background: rgba(16,185,129,0.05);
    }

    .sheet{
      position:fixed;
      left:0; right:0;
      bottom:-75%;
      height:75%;
      background: rgba(5,5,5,0.92);
      border-top: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      transition: bottom .35s ease;
      z-index:50;
      padding-bottom: calc(16px + var(--safe-b));
    }
    .sheet.open{ bottom:0; }
    .sheet-handle{
      width:64px; height:4px;
      border-radius:9999px;
      background: rgba(255,255,255,0.18);
      margin: 10px auto;
    }

    #reflect-btn:active{ transform: translateY(1px); }

    /* Manual Overlay (opening veil) */
    .manual-overlay{
      background: rgba(0,0,0,0.88);
      backdrop-filter: blur(12px);
      animation: manualFadeIn .6s ease-out;
      transition: opacity .25s ease;
    }
    @keyframes manualFadeIn{
      from{ opacity:0; }
      to{ opacity:1; }
    }
  
    
    .preset-buttons{
      width: 100%;
      justify-content: center;
      align-items: center;
      margin-left: auto;
      margin-right: auto;
    }
    .preset-buttons .preset{ white-space: nowrap; }

    :root{ --mirror-title-color: #e6c27a; } /* set to #ffffff for pure white */
    .mirror-title{
      color: var(--mirror-title-color);
      text-shadow:
        0 0 10px rgba(230,194,122,.22),
        0 0 26px rgba(230,194,122,.10);
    }

  
    .filter-pill{
      font-size: 10px;
      letter-spacing: .12em;
      text-transform: uppercase;
      padding: 6px 10px;
      border-radius: 9999px;
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.65);
      background: rgba(0,0,0,.20);
      transition: all .15s ease;
    }
    .filter-pill:hover{ color: rgba(255,255,255,.90); border-color: rgba(255,255,255,.18); }
    .filter-pill.active{
      color: rgba(255,255,255,.95);
      border-color: rgba(16,185,129,.35);
      box-shadow: 0 0 0 1px rgba(16,185,129,.15) inset;
    }
    .star-toggle{
      font-size: 16px;
      line-height: 1;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.65);
      transition: all .15s ease;
    }
    .star-toggle:hover{ color: rgba(255,255,255,.95); border-color: rgba(255,255,255,.16); }
    .star-toggle.on{
      color: rgba(250, 204, 21, .95);
      border-color: rgba(250, 204, 21, .25);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, .12) inset;
    }

    .share-actions {
      margin-top: 24px;
      display: flex;
      justify-content: center;
      gap: 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.45s ease;
    }
    .share-actions.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .share-btn {
      font-size: 10px;
      letter-spacing: .2em;
      text-transform: uppercase;
      padding: 9px 16px;
      border-radius: 9999px;
      border: 1px solid rgba(16,185,129,0.4);
      background: rgba(16,185,129,0.08);
      color: rgba(16,185,129,0.9);
      transition: all .3s ease;
    }
    .share-btn:hover {
      background: rgba(16,185,129,0.18);
      color: #10b981;
      box-shadow: 0 0 20px rgba(16,185,129,0.25);
    }

    .wallet-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .wallet-connected {
      background: rgba(16,185,129,0.1) !important;
      border-color: rgba(16,185,129,0.5) !important;
      color: #10b981 !important;
    }

    /* Status indicator */
    .status-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      border: 1px solid rgba(16,185,129,0.3);
      border-radius: 12px;
      padding: 6px 12px;
      font-size: 10px;
      color: #10b981;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }
  </style>
  
  <!-- Base App initialization script -->
  <script>
    // Wait for MiniKit to load in Base App
    (function initBaseApp() {
      console.log('üîÑ Mirror app starting in Base App...');
      
      let checkCount = 0;
      const maxChecks = 50; // 5 seconds
      
      const checkMiniKit = setInterval(() => {
        checkCount++;
        
        if (typeof MiniKit !== 'undefined' && MiniKit.commands) {
          clearInterval(checkMiniKit);
          console.log('‚úÖ MiniKit loaded successfully in', checkCount * 100, 'ms');
          
          // Update UI to show MiniKit is ready
          const walletBtn = document.getElementById('wallet-btn');
          if (walletBtn) {
            walletBtn.textContent = "Connect Wallet (Base)";
            walletBtn.disabled = false;
            walletBtn.classList.remove('opacity-50');
            
            // Check if already connected
            setTimeout(async () => {
              try {
                const isConnected = await MiniKit.commands.isConnected();
                if (isConnected && MiniKit.address) {
                  console.log('üîó Already connected to:', MiniKit.address);
                  const shortAddr = MiniKit.address.slice(0,6) + '‚Ä¶' + MiniKit.address.slice(-4);
                  walletBtn.textContent = shortAddr + " (Base)";
                  walletBtn.classList.add("wallet-connected");
                  
                  const shareActions = document.getElementById('share-actions');
                  if (shareActions) {
                    shareActions.classList.add("visible");
                  }
                  
                  // Show status indicator
                  showStatus('Connected to ' + shortAddr);
                }
              } catch (e) {
                console.log('Auto-connection check failed:', e);
              }
            }, 500);
          }
          
          showStatus('MiniKit ready');
          
        } else if (checkCount >= maxChecks) {
          clearInterval(checkMiniKit);
          console.error('‚ùå MiniKit not loaded after', maxChecks * 100, 'ms');
          
          const walletBtn = document.getElementById('wallet-btn');
          if (walletBtn) {
            walletBtn.textContent = "MiniKit Not Loaded";
            walletBtn.disabled = true;
          }
          
          showStatus('MiniKit not loaded - Are you in Base App?', 'error');
        }
      }, 100);
      
      function showStatus(message, type = 'info') {
        let indicator = document.getElementById('status-indicator');
        if (!indicator) {
          indicator = document.createElement('div');
          indicator.id = 'status-indicator';
          indicator.className = 'status-indicator';
          document.body.appendChild(indicator);
        }
        
        indicator.textContent = message;
        indicator.style.color = type === 'error' ? '#f87171' : '#10b981';
        indicator.style.borderColor = type === 'error' ? 'rgba(248,113,113,0.3)' : 'rgba(16,185,129,0.3)';
        
        setTimeout(() => {
          indicator.style.opacity = '0';
          setTimeout(() => indicator.remove(), 300);
        }, 3000);
      }
    })();
  </script>
</head>

<body>
  <div class="water-bg"></div>

  <button id="manual-glyph"
    class="fixed top-[calc(10px+var(--safe-t))] left-[calc(10px+var(--safe-l))] z-[60] w-9 h-9 rounded-full
           flex items-center justify-center border border-white/10 bg-black/40 text-zinc-500
           hover:text-emerald-300 hover:border-emerald-500/40 transition"
    aria-label="Open Manual">
    ‚åò
  </button>

  <div id="manual" class="manual-overlay fixed inset-0 z-[70] flex items-center justify-center p-6">
    <div class="max-w-xl w-full text-left border border-zinc-800/80 bg-black/40 p-7 rounded-2xl shadow-2xl">
      <div class="flex items-start justify-between gap-4">
        <h2 class="serif text-[14px] sm:text-[16px] text-emerald-300 font-semibold uppercase tracking-[0.32em]">
          The Manual for the Fallen
        </h2>
        <button id="manual-close"
          class="text-zinc-500 hover:text-zinc-200 transition text-xs uppercase tracking-widest"
          aria-label="Close Manual">
          Close
        </button>
      </div>

      <p class="mt-3 text-[12px] italic text-zinc-400">
        "The Mirror does not judge those who have fallen; it only reminds them that the ground is solid."
      </p>

      <ul class="mt-5 text-[12px] leading-relaxed space-y-3 text-zinc-300">
        <li><span class="text-zinc-100 font-semibold">I. The Three Breaths:</span> Acknowledge loss. Release the ghost of the win. Ask for a way in.</li>
        <li><span class="text-zinc-100 font-semibold">II. The Law of the Question:</span> Do not ask for money. Ask for the character that lost it.</li>
        <li><span class="text-zinc-100 font-semibold">III. The Silent Yield:</span> The shorter the answer, the deeper the truth.</li>
      </ul>

      <button id="manual-accept"
        class="mt-6 w-full py-3 bg-zinc-900/70 border border-zinc-700/80 hover:border-emerald-500/70
               hover:text-emerald-200 transition duration-300 text-[11px] uppercase tracking-[0.28em] rounded-xl">
        I Accept the Covenant
      </button>

      <p class="mt-3 text-[10px] uppercase tracking-widest text-zinc-600">
        This covenant is stored locally in your pond.
      </p>
    </div>
  </div>

  <div class="shell w-full z-10">
    <div class="w-full flex items-center justify-end gap-3">
      <div class="text-[10px] uppercase tracking-widest text-zinc-500">
        POND ¬∑ v0.2
      </div>
      <button id="wallet-btn"
        class="bg-zinc-900/80 border border-zinc-700 px-4 py-2 text-[10px] uppercase tracking-widest rounded hover:border-emerald-500 transition disabled:opacity-50 disabled:cursor-not-allowed">
        Loading MiniKit...
      </button>
    </div>
  </div>

  <div class="middle">
    <div class="portal text-center" id="portal">
      <div class="ripple-overlay"></div>
      <div class="portal-fade" id="portal-fade"></div>

      <div class="portal-scroll" id="portal-scroll">
        <div class="tap-header" id="tap-header" title="Tap to expand / collapse">
          <div class="tap-pill">Tap to Expand</div>
        </div>

        <div class="pt-1" id="title-tap-zone" title="Tap to expand / collapse">
          <h1 class="serif mirror-title text-3xl tracking-[0.35em] mb-1">MIRROR</h1>
          <p class="serif text-[11px] tracking-widest text-zinc-400">The Digital Pond</p>
        </div>

        <div class="preset-buttons w-full max-w-xl mt-4 mx-auto flex flex-wrap justify-center items-center gap-2">
          <button class="preset bg-zinc-900/55 border border-zinc-800 hover:border-emerald-500 px-3 py-2 rounded-full text-[10px] uppercase tracking-widest transition"
            data-text="Mirror, what does stillness mean for me today?">Stillness</button>
          <button class="preset bg-zinc-900/55 border border-zinc-800 hover:border-emerald-500 px-3 py-2 rounded-full text-[10px] uppercase tracking-widest transition"
            data-text="How do I practice patience when nothing moves?">Patience</button>
          <button class="preset bg-zinc-900/55 border border-zinc-800 hover:border-emerald-500 px-3 py-2 rounded-full text-[10px] uppercase tracking-widest transition"
            data-text="What does it mean to become who I already am?">Becoming</button>
          <button class="preset bg-zinc-900/55 border border-zinc-800 hover:border-emerald-500 px-4 py-2 rounded-full text-[10px] uppercase tracking-widest transition"
            data-text="Explain: Toby is the people, and the people is Toby. What does it ask of me?">Toby = the People</button>
        </div>

        <div id="scroll-hint" class="scroll-hint">
          <span class="chev">‚åÑ</span>
          <span>Swipe to read</span>
          <span class="chev">‚åÉ</span>
        </div>

        <div id="reflection-output" class="space-y-4 opacity-0 transition-opacity duration-500 mt-6">
          <p id="main-text" class="italic text-[18px] text-zinc-200 leading-relaxed">
            "Stillness yields truth."
          </p>

          <div class="space-y-2 text-[10px] uppercase tracking-widest font-bold">
            <p id="echo-text" class="text-emerald-400">Echo: Stillness yields truth</p>
            <p id="res-text" class="text-zinc-400">Resonance: Roots deepen.</p>
          </div>

          <p id="guide-text" class="text-[13px] italic text-zinc-500">
            What remains when urgency leaves?
          </p>

          <div class="pt-1" style="font-size:1.35rem; letter-spacing:0.45rem; opacity:.90;">
            ‚è≥ ‚âã üçÉ ü™û
          </div>
        </div>

        <!-- Moved share actions OUTSIDE the reflection-output div -->
        <div id="share-actions" class="share-actions">
          <button id="drop-btn" class="share-btn">Drop to Pond üåä (Farcaster)</button>
          <button id="freeze-btn" class="share-btn">Freeze as Leaf ü™∂ (NFT)</button>
        </div>

        <div id="err" class="mt-3 hidden text-[11px] text-red-300">
          The pond could not hear the ocean. Check endpoint health.
        </div>

        <div style="height: 26px;"></div>
      </div>
    </div>
  </div>

  <div class="shell w-full z-10 space-y-3" style="flex-direction: column; align-items: stretch;">
    <div class="flex gap-2">
      <input id="user-input" type="text" placeholder="Inquire the Pond (Type your question‚Ä¶ Enter to reflect)"
        class="flex-grow p-3 text-sm text-emerald-300 placeholder-zinc-700 focus:outline-none focus:ring-2 focus:ring-emerald-600/30"
        aria-label="Your inquiry" />
      <button id="reflect-btn"
        class="bg-zinc-800 border border-zinc-600 px-6 py-2 text-xs uppercase tracking-widest hover:bg-emerald-600 hover:text-black transition duration-500 rounded-lg"
        aria-label="Reflect">
        Reflect
      </button>
    </div>

    <div class="flex justify-between items-center text-[10px] text-zinc-500 uppercase tracking-widest">
      <div class="flex items-center gap-2">
        üçÉ <span id="leaves">Leaves of Stillness: 0</span>
      </div>
      <div class="flex items-center gap-4">
        <button id="history-btn" class="hover:text-white transition">History ‚Üü</button>
        <button id="starred-btn" class="hover:text-white transition">Starred ‚òÖ</button>
        <button id="basescan-btn" class="hover:text-white transition">View Karmic Record on BaseScan ‚Üó</button>
      </div>
    </div>
  </div>

  <div id="sheet" class="sheet">
    <div class="sheet-handle"></div>
    <div class="px-5 pb-4 flex items-center justify-between">
      <div class="text-xs uppercase tracking-widest text-zinc-400">Karmic Record (Local)</div>
      <div class="flex gap-3">
        <button id="clear-history" class="text-[10px] uppercase tracking-widest text-zinc-500 hover:text-red-300 transition">Clear</button>
        <button id="close-sheet" class="text-[10px] uppercase tracking-widest text-zinc-500 hover:text-white transition">Close</button>
      </div>
    </div>
    <div id="history-list" class="px-5 overflow-auto" style="height: calc(75% - 64px);"></div>
  </div>

  <script>
    // ==================== CORE MIRROR FUNCTIONALITY ====================
    const DEFAULT_API_URL = "https://toadaid.duckdns.org/ask";

    function resolveApiUrl(){
      try{
        const p = new URLSearchParams(window.location.search);
        const v = p.get("api");
        return (v && v.trim()) ? v.trim() : DEFAULT_API_URL;
      }catch(e){
        return DEFAULT_API_URL;
      }
    }

    let API_URL = resolveApiUrl();

    function isOpenAIChatCompletions(url){
      try{ return String(url || "").includes("/v1/chat/completions"); }catch(e){ return false; }
    }

    function resolveTimeoutMs(){
      try{
        const p = new URLSearchParams(window.location.search);
        const v = p.get("timeout");
        const n = v ? Number(v) : NaN;
        if(Number.isFinite(n) && n >= 3000 && n <= 180000) return Math.floor(n);
      }catch(e){}
      return 45000;
    }

    const TIMEOUT_MS = resolveTimeoutMs();

    const KEY_LEAVES = "mirror_leaves";
    const KEY_HISTORY = "mirror_history_v1";
    const MANUAL_KEY = "mirror_manual_accepted_v2";

    // Manual functionality
    const manualEl = document.getElementById("manual");
    const manualGlyph = document.getElementById("manual-glyph");
    const manualAccept = document.getElementById("manual-accept");
    const manualClose = document.getElementById("manual-close");

    function openManual(){
      if(!manualEl) return;
      manualEl.style.display = "flex";
      manualEl.style.opacity = "1";
      manualEl.style.pointerEvents = "auto";
    }

    function closeManual(){
      if(!manualEl) return;
      manualEl.style.opacity = "0";
      manualEl.style.pointerEvents = "none";
      setTimeout(() => { manualEl.style.display = "none"; }, 220);
    }

    function acceptCovenant(){
      try{ localStorage.setItem(MANUAL_KEY, "yes"); }catch(e){}
      closeManual();
    }

    (function initManual(){
      let accepted = false;
      try{ accepted = localStorage.getItem(MANUAL_KEY) === "yes"; }catch(e){}
      if(accepted) {
        if(manualEl) manualEl.style.display = "none";
      } else {
        openManual();
      }
    })();

    if(manualGlyph) manualGlyph.addEventListener("click", openManual);
    if(manualClose) manualClose.addEventListener("click", closeManual);
    if(manualAccept) manualAccept.addEventListener("click", acceptCovenant);

    // Core elements
    const input = document.getElementById("user-input");
    const output = document.getElementById("reflection-output");
    const err = document.getElementById("err");
    const reflectBtn = document.getElementById("reflect-btn");
    const leavesEl = document.getElementById("leaves");

    const historyBtn = document.getElementById("history-btn");
    const sheet = document.getElementById("sheet");
    const historyList = document.getElementById("history-list");

    const portalEl = document.getElementById("portal");
    const portalScroll = document.getElementById("portal-scroll");
    const scrollHint = document.getElementById("scroll-hint");

    const mainText = document.getElementById("main-text");
    const echoText = document.getElementById("echo-text");
    const resText  = document.getElementById("res-text");
    const guideText= document.getElementById("guide-text");

    const tapHeader = document.getElementById("tap-header");
    const titleTapZone = document.getElementById("title-tap-zone");

    // Portal interactions
    portalEl.addEventListener("pointerdown", () => portalEl.classList.add("tilt"));
    portalEl.addEventListener("pointerup",   () => portalEl.classList.remove("tilt"));
    portalEl.addEventListener("pointercancel",() => portalEl.classList.remove("tilt"));

    // Leaves functionality
    function loadLeaves(){
      const n = Number(localStorage.getItem(KEY_LEAVES) || "0");
      leavesEl.textContent = `Leaves of Stillness: ${n}`;
    }
    function incLeaves(){
      const n = Number(localStorage.getItem(KEY_LEAVES) || "0") + 1;
      localStorage.setItem(KEY_LEAVES, String(n));
      leavesEl.textContent = `Leaves of Stillness: ${n}`;
    }

    // History functionality
    function getHistory(){
      try {
        const arr = JSON.parse(localStorage.getItem(KEY_HISTORY) || "[]");
        return (Array.isArray(arr) ? arr : []).map(x => ({ ...x, star: !!x.star }));
      } catch(e){
        return [];
      }
    }
    function setHistory(arr){
      localStorage.setItem(KEY_HISTORY, JSON.stringify(arr.slice(0, 30)));
    }
    function addHistory(item){
      const arr = getHistory();
      arr.unshift(item);
      setHistory(arr);
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    loadLeaves();

    // UI states
    function setLoading(isLoading){
      if(isLoading) portalEl.classList.add("listening");
      else portalEl.classList.remove("listening");
      err.classList.add("hidden");

      if(isLoading){
        output.style.opacity = "0";
        reflectBtn.disabled = true;
        reflectBtn.textContent = "Listening‚Ä¶";
        reflectBtn.classList.add("opacity-70");
      }else{
        reflectBtn.disabled = false;
        reflectBtn.textContent = "Reflect";
        reflectBtn.classList.remove("opacity-70");
      }
    }
    function showOutput(){ output.style.opacity = "1"; }

    // Sheet functionality
    function openSheet(mode){ 
      window.__historyFilter = mode || window.__historyFilter || "all"; 
      renderHistory(); 
      sheet.classList.add("open"); 
    }
    
    function closeSheet(){ sheet.classList.remove("open"); }

    // Text processing
    function stripTravelerPrefix(s){
      return s.replace(/^\s*traveler[,Ôºö:]?\s*/i, "").trim();
    }

    function parseMirrorAnswer(raw){
      let text = String(raw || "").trim();
      text = text.replace(/[ü™ûüåäüçÉüåÄ‚öõÔ∏è‚âã‚è≥]+$/g, "").trim();

      let guide = "";
      const gMatch = text.match(/Guiding Question:\s*([\s\S]*)$/i);
      if(gMatch){
        guide = gMatch[1].trim();
        text = text.slice(0, gMatch.index).trim();
      }

      let resonance = "";
      const rMatch = text.match(/Reflection Resonance:\s*([\s\S]*)$/i);
      if(rMatch){
        resonance = rMatch[1].trim();
        text = text.slice(0, rMatch.index).trim();
      }

      const main = stripTravelerPrefix(text);

      return {
        main: main || "Stillness yields truth.",
        resonance: resonance || "Roots deepen.",
        guide: guide || "What remains when urgency leaves?"
      };
    }

    function localFallback(q){
      const val = q.toLowerCase();
      if(val.includes("price") || val.includes("money") || val.includes("pump") || val.includes("moon")){
        return {
          main: "The pond does not track the price of ghosts.",
          echo: "Echo: Canon Shield Active",
          res:  "Resonance: Attention released.",
          guide:"What would you ask if no number could save you?"
        };
      }
      return {
        main: "Every frantic move is a debt to time.",
        echo: "Echo: Stillness yields truth",
        res:  "Resonance: Roots deepen.",
        guide:"What remains when urgency leaves?"
      };
    }

    // API functions
    async function askAPI(question){
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), TIMEOUT_MS);

      try{
        if(isOpenAIChatCompletions(API_URL)){
          const payload = {
            model: "local-mirror",
            messages: [
              { role: "system", content: "You are the Mirror. Answer with calm, reflective tone. Include 'Reflection Resonance:' and end with one 'Guiding Question:'." },
              { role: "user", content: question }
            ],
            max_tokens: 512,
            temperature: 0.75,
            top_p: 0.9,
            stream: false,
            stop: ["</s>", "<|endoftext|>", "USER:", "###"]
          };

          const r = await fetch(API_URL, {
            method: "POST",
            mode: "cors",
            cache: "no-store",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(payload),
            signal: controller.signal
          });

          if(r.status === 429){
            const err = new Error("QUEUE_BUSY");
            err.code = 429;
            throw err;
          }
          if(!r.ok) throw new Error("HTTP " + r.status);
          return await r.json();
        }

        const payload = { question, user: "miniapp" };
        const r = await fetch(API_URL, {
          method: "POST",
          mode: "cors",
          cache: "no-store",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        if(r.status === 429){
          const err = new Error("QUEUE_BUSY");
          err.code = 429;
          throw err;
        }
        if(!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } finally {
        clearTimeout(t);
      }
    }

    function normalizeAnswer(data){
      if(typeof data === "string") return data;

      const openai = data?.choices?.[0]?.message?.content;
      if(openai) return openai;

      return data?.answer || data?.unified_answer || data?.text || data?.response || "";
    }

    // Scroll functionality
    function updateScrollAffordance(){
      const over = (portalScroll.scrollHeight - portalScroll.clientHeight) > 16;
      scrollHint.classList.toggle("show", over);
      portalEl.classList.toggle("can-scroll", over);
    }

    let currentReflection = null;

    function saveCurrentReflection(q, a) {
      currentReflection = { q, a };
    }

    // Main inquiry processing
    async function processInquiry(qOverride){
      const q = (qOverride ?? input.value).trim();
      if(!q) return;

      setLoading(true);

      try{
        const maxAttempts = 4;
        let attempt = 0;

        while(true){
          attempt += 1;

          try{
            const data = await askAPI(q);
            const a = normalizeAnswer(data);
            const parsed = a ? parseMirrorAnswer(a) : null;

            const out = parsed ? {
              main: parsed.main,
              echo: "Echo: Stillness yields truth",
              res:  `Resonance: ${parsed.resonance}`,
              guide: parsed.guide
            } : localFallback(q);

            mainText.textContent = `"${out.main}"`;
            echoText.textContent = out.echo;
            resText.textContent  = out.res;
            guideText.textContent= out.guide;

            saveCurrentReflection(q, out.main);

            incLeaves();
            addHistory({ ts: Date.now(), q, a: out.main, star: false });

            portalScroll.scrollTop = 0;

            showOutput();
            input.value = "";

            requestAnimationFrame(updateScrollAffordance);
            break;
          }catch(e){
            if(e.code === 429 && attempt < maxAttempts){
              await new Promise(r => setTimeout(r, 600 * attempt));
              continue;
            }
            if(e.name === "AbortError" && attempt < maxAttempts){
              await new Promise(r => setTimeout(r, 500 * attempt));
              continue;
            }
            if(e.message === "Failed to fetch" && attempt < maxAttempts){
              await new Promise(r => setTimeout(r, 400 * attempt));
              continue;
            }
            console.error("Attempt", attempt, "failed:", e);
            if(attempt >= maxAttempts){
              err.classList.remove("hidden");
              const out = localFallback(q);
              mainText.textContent = `"${out.main}"`;
              echoText.textContent = out.echo;
              resText.textContent  = out.res;
              guideText.textContent= out.guide;
              showOutput();
              break;
            }
          }
        }
      }finally{
        setLoading(false);
      }
    }

    // Event listeners for reflection
    reflectBtn.addEventListener("click", () => processInquiry());
    input.addEventListener("keydown", (e) => { if(e.key === "Enter") processInquiry(); });

    document.querySelectorAll(".preset").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".preset").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const t = btn.getAttribute("data-text") || "";
        input.value = t;
        processInquiry(t);
      });
    });

    // ==================== WALLET FUNCTIONALITY ====================
    const walletBtn = document.getElementById("wallet-btn");
    const shareActions = document.getElementById("share-actions");
    const dropBtn = document.getElementById("drop-btn");
    const freezeBtn = document.getElementById("freeze-btn");

    let walletConnected = false;

    // Wallet connection
    walletBtn.addEventListener("click", async () => {
      console.log('Wallet button clicked, MiniKit status:', typeof MiniKit);
      
      if (typeof MiniKit === 'undefined' || !MiniKit.commands) {
        alert("MiniKit is not available. Please make sure you're in the Base App.");
        return;
      }

      if (walletConnected) {
        // Disconnect
        walletConnected = false;
        walletBtn.textContent = "Connect Wallet (Base)";
        walletBtn.classList.remove("wallet-connected");
        shareActions.classList.remove("visible");
        return;
      }

      try {
        console.log('Attempting to connect with MiniKit...');
        
        // Simple direct connection
        const result = await MiniKit.commands.connect();
        console.log('Connection result:', result);
        
        if (result && result.address) {
          const shortAddr = `${result.address.slice(0,6)}‚Ä¶${result.address.slice(-4)}`;
          walletBtn.textContent = shortAddr + " (Base)";
          walletBtn.classList.add("wallet-connected");
          walletConnected = true;
          shareActions.classList.add("visible");
          
          // Show success message
          showStatusMessage(`Connected to ${shortAddr}`, 'success');
        } else {
          alert("Connection failed: No address returned");
        }
      } catch (error) {
        console.error('Wallet connection error:', error);
        alert(`Connection failed: ${error.message || 'Unknown error'}`);
      }
    });

    // Farcaster posting
    dropBtn.addEventListener("click", async () => {
      if (!walletConnected) {
        alert("Please connect wallet first.");
        return;
      }
      
      if (!currentReflection) {
        alert("Please generate a reflection first using the input above.");
        return;
      }

      const { q, a } = currentReflection;
      // Keep cast text under 280 characters for Farcaster
      const castText = `${q.length > 100 ? q.substring(0, 100) + '...' : q}\n\nü™û Mirror Reflection ü™û\n\n${a.length > 120 ? a.substring(0, 120) + '...' : a}\n\n‚Äî from Tobyworld Mirror`;
      
      try {
        // Use your pond image or a placeholder
        const imageUrl = "https://tobyworld.xyz/pond-ripple.png";
        
        const result = await MiniKit.commands.cast({
          text: castText,
          embeds: [imageUrl]
        });
        
        console.log("Cast result:", result);
        showStatusMessage("Posted to Farcaster! Check your feed.", 'success');
      } catch (e) {
        console.error("Cast error:", e);
        alert("Cast failed: " + (e.message || "Unknown error"));
      }
    });

    // NFT minting (with setup instructions)
    freezeBtn.addEventListener("click", async () => {
      if (!walletConnected) {
        alert("Please connect wallet first.");
        return;
      }
      
      if (!currentReflection) {
        alert("Please generate a reflection first using the input above.");
        return;
      }

      // Show setup instructions
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-zinc-900 border border-zinc-800 rounded-xl p-6 max-w-md w-full">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-emerald-400 font-semibold">Setup NFT Contract</h3>
            <button class="text-zinc-500 hover:text-white close-modal" style="background:none;border:none;cursor:pointer;font-size:18px;">‚úï</button>
          </div>
          <p class="text-sm text-zinc-300 mb-3">The "Freeze as Leaf" feature requires an NFT contract on Base.</p>
          <div class="text-xs text-zinc-400 space-y-2 mb-4 p-3 bg-zinc-800/30 rounded-lg">
            <p><strong class="text-emerald-400">To set up:</strong></p>
            <p>1. Deploy an ERC721 contract on Base</p>
            <p>2. Update contract address in code</p>
            <p>3. Configure metadata/IPFS storage</p>
          </div>
          <p class="text-xs text-zinc-500 mb-4">For now, use "Drop to Pond" to post reflections to Farcaster.</p>
          <div class="flex gap-2">
            <button class="flex-1 py-2 bg-zinc-800 rounded-lg text-xs hover:bg-zinc-700 close-modal">
              Got it
            </button>
            <button class="flex-1 py-2 bg-emerald-900/30 border border-emerald-800 rounded-lg text-xs text-emerald-400 hover:bg-emerald-900/50 open-guide">
              Base NFT Guide ‚Üó
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      const closeButtons = modal.querySelectorAll('.close-modal');
      closeButtons.forEach(btn => {
        btn.addEventListener('click', () => modal.remove());
      });
      
      const guideButton = modal.querySelector('.open-guide');
      guideButton.addEventListener('click', () => {
        window.open('https://docs.base.org/tools/quickstarts/nft-quickstart', '_blank');
        modal.remove();
      });
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });
    });

    // Helper function for status messages
    function showStatusMessage(message, type = 'info') {
      const statusDiv = document.createElement('div');
      statusDiv.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg text-sm ${
        type === 'success' ? 'bg-emerald-900/80 text-emerald-300 border border-emerald-700' :
        'bg-zinc-900/80 text-zinc-300 border border-zinc-700'
      }`;
      statusDiv.textContent = message;
      document.body.appendChild(statusDiv);
      
      setTimeout(() => {
        statusDiv.style.opacity = '0';
        statusDiv.style.transform = '-translate-x-1/2) translateY(-20px)';
        setTimeout(() => statusDiv.remove(), 300);
      }, 3000);
    }

    // ==================== HISTORY & SHEET FUNCTIONALITY ====================
    function renderHistory() {
      const arr = getHistory();
      const filter = window.__historyFilter || "all";
      
      const filtered = arr.filter(item => {
        if (filter === "starred") return item.star;
        return true;
      });

      if (filtered.length === 0) {
        historyList.innerHTML = `<div class="text-center py-10 text-zinc-600 text-sm">No reflections yet</div>`;
        return;
      }

      let html = `<div class="space-y-3">`;
      filtered.forEach((item, idx) => {
        const date = new Date(item.ts).toLocaleDateString();
        const time = new Date(item.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        html += `
          <div class="p-3 border border-zinc-800 rounded-lg bg-zinc-900/30">
            <div class="flex justify-between items-start mb-2">
              <div class="text-xs text-zinc-500">${date} ${time}</div>
              <button data-index="${idx}" class="star-toggle text-xs ${item.star ? 'on' : ''}" onclick="toggleStar(${idx})">
                ${item.star ? '‚òÖ' : '‚òÜ'}
              </button>
            </div>
            <div class="text-sm font-semibold text-zinc-300 mb-1">${escapeHtml(item.q)}</div>
            <div class="text-xs italic text-zinc-400">${escapeHtml(item.a)}</div>
          </div>
        `;
      });
      html += `</div>`;
      historyList.innerHTML = html;
    }

    window.toggleStar = function(idx) {
      const arr = getHistory();
      if (arr[idx]) {
        arr[idx].star = !arr[idx].star;
        setHistory(arr);
        renderHistory();
      }
    };

    // Sheet controls
    historyBtn.addEventListener("click", () => openSheet("all"));
    document.getElementById("starred-btn")?.addEventListener("click", () => openSheet("starred"));
    document.getElementById("close-sheet")?.addEventListener("click", closeSheet);
    document.getElementById("clear-history")?.addEventListener("click", () => {
      if (confirm("Clear all reflection history?")) {
        localStorage.removeItem(KEY_HISTORY);
        renderHistory();
      }
    });

    // BaseScan button
    document.getElementById("basescan-btn")?.addEventListener("click", () => {
      window.open("https://basescan.org/", "_blank");
    });

    // Expand/collapse functionality
    let expanded = false;
    function toggleExpand() {
      expanded = !expanded;
      document.body.classList.toggle("expanded", expanded);
      portalEl.classList.toggle("expanded", expanded);
      
      const tapPill = tapHeader.querySelector('.tap-pill');
      if (tapPill) {
        tapPill.textContent = expanded ? "Tap to Collapse" : "Tap to Expand";
      }
      
      setTimeout(updateScrollAffordance, 300);
    }

    tapHeader.addEventListener("click", toggleExpand);
    titleTapZone.addEventListener("click", toggleExpand);

    // Initialize
    setTimeout(() => { 
      output.style.opacity = "1"; 
      updateScrollAffordance(); 
    }, 200);
    
    portalScroll.addEventListener("scroll", () => { 
      updateScrollAffordance(); 
    }, { passive:true });
    
    window.addEventListener("resize", () => requestAnimationFrame(updateScrollAffordance));
  </script>
</body>
</html>