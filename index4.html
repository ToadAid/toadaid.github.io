<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>ToadAid Mirror - The Digital Dojo for Modern Wisdom</title>
<meta name="description" content="ToadAid Mirror - A digital dojo where ancient wisdom meets AI. Consult the Mirror for guidance through Zen, Taoist, and Tobyworld philosophy.">

<!-- Open Graph -->
<meta property="og:title" content="ToadAid Mirror - The Pond Awaits Your Question" />
<meta property="og:description" content="Step into the digital dojo. Ask the Mirror anything about life, meaning, and existence. Experience the fusion of AI and ancient wisdom traditions." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://toadaid.github.io" />
<meta property="og:image" content="https://toadaid.github.io/assets/icons/web-app-manifest-512x512.png" />

<!-- Canonical -->
<link rel="canonical" href="https://toadaid.github.io" />

<!-- Favicons -->
<link rel="icon" type="image/x-icon" href="/assets/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
<link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
<link rel="manifest" href="/assets/icons/site.webmanifest">
<meta name="theme-color" content="#355e3b" />

<style>
  :root {
    --primary-green: #355e3b;
    --secondary-gold: #d4af37;
    --light-cream: #f5f1e6;
    --dark-text: #2f2f2f;
    --shadow-light: rgba(0,0,0,0.1);
    --shadow-medium: rgba(0,0,0,0.25);
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: transparent;
  }
  
  html {
    scroll-behavior: smooth;
    -webkit-text-size-adjust: 100%;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    line-height: 1.6;
    background: var(--light-cream);
    color: var(--dark-text);
    min-height: 100vh;
    overflow-x: hidden;
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
  }
  
  /* Banner Section - Mobile Optimized */
  .banner {
    position: relative;
    width: 100%;
    min-height: 40vh;
    max-height: 50vh;
    background: 
      linear-gradient(rgba(53, 94, 59, 0.8), rgba(53, 94, 59, 0.9)),
      url('/assets/images/pond-banner.jpg') center center / cover no-repeat;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    text-align: center;
    padding: 1.5rem 1rem;
    box-shadow: 0 2px 8px var(--shadow-medium);
    overflow: hidden;
  }
  
  .banner h1 {
    font-size: clamp(1.8rem, 6vw, 2.5rem);
    margin: 0 0 0.5rem 0;
    text-shadow: 0 2px 8px rgba(0,0,0,0.7);
    font-weight: 400;
    letter-spacing: 0.03em;
    line-height: 1.2;
  }
  
  .banner p {
    font-size: clamp(1rem, 3.5vw, 1.2rem);
    margin-top: 0.5rem;
    text-shadow: 0 1px 4px rgba(0,0,0,0.6);
    font-weight: 300;
    max-width: 90%;
    opacity: 0.95;
    line-height: 1.4;
  }
  
  /* Translate Bar */
  .translate-bar {
    background: var(--secondary-gold);
    color: #000;
    padding: 0.7rem;
    font-size: 0.85rem;
    text-align: center;
    font-weight: 500;
    line-height: 1.3;
  }
  
  /* Button Styles - Mobile Optimized */
  .btn {
    background: var(--secondary-gold);
    color: #000;
    padding: 0.9rem 1.2rem;
    margin: 0.3rem;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    box-shadow: 0 2px 5px var(--shadow-medium);
    transition: all 0.2s ease;
    font-size: 0.9rem;
    min-height: 44px;
    min-width: 44px;
    text-align: center;
    line-height: 1.2;
    touch-action: manipulation;
  }
  
  .btn:hover, .btn:active {
    transform: translateY(-1px);
    box-shadow: 0 3px 8px var(--shadow-medium);
  }
  
  .btn-mirror {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  
  .btn-lore {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
  }
  
  .btn-community {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
  }
  
  .btn-builders {
    background: var(--primary-green);
    color: white;
  }
  
  /* Section Styles - Mobile Optimized */
  section {
    padding: 1.5rem 1rem;
    max-width: 100%;
    margin: auto;
  }
  
  h2 {
    text-align: center;
    margin-bottom: 1.5rem;
    font-size: 1.8rem;
    color: var(--primary-green);
    font-weight: 400;
    position: relative;
    line-height: 1.2;
  }
  
  h2:after {
    content: '';
    display: block;
    width: 60px;
    height: 2px;
    background: var(--secondary-gold);
    margin: 0.5rem auto;
    border-radius: 2px;
  }
  
  /* Pillars Grid - Mobile Optimized */
  .pillars {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    margin-top: 1.5rem;
  }
  
  .pillar {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px var(--shadow-light);
    transition: all 0.2s ease;
    color: inherit;
    text-decoration: none;
    border: 1px solid rgba(53, 94, 59, 0.1);
  }
  
  .pillar:active {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow-light);
  }
  
  .pillar h3 {
    color: var(--primary-green);
    margin-bottom: 0.8rem;
    font-size: 1.2rem;
  }
  
  .pillar p {
    color: #666;
    line-height: 1.5;
    font-size: 0.95rem;
  }
  
  /* Mirror Section - Mobile Optimized */
  #mirror {
    background: linear-gradient(135deg, #f5f1e6 0%, #e8e0d0 100%);
    border-radius: 15px;
    margin: 1rem;
    padding: 1.5rem 1rem;
    box-shadow: 0 4px 12px var(--shadow-light);
  }
  
  .mirror-container {
    max-width: 100%;
    margin: 0 auto;
  }
  
  #mirror-question {
    width: 100%;
    padding: 1rem;
    border-radius: 10px;
    border: 2px solid #ddd;
    font-size: 1rem;
    margin-bottom: 1rem;
    transition: border-color 0.2s ease;
    background: white;
    -webkit-appearance: none;
    min-height: 50px;
  }
  
  #mirror-question:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 2px rgba(53, 94, 59, 0.1);
  }
  
  /* Mirror Response Styling - Mobile Optimized */
  .mirror-dialogue {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    line-height: 1.5;
    background: rgba(255, 255, 255, 0.95);
    padding: 1.5rem;
    border-radius: 10px;
    margin-top: 1.5rem;
    border-left: 3px solid var(--primary-green);
    box-shadow: 0 2px 8px var(--shadow-light);
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  
  .user-question {
    background: rgba(53, 94, 59, 0.1);
    padding: 0.8rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    border-left: 3px solid var(--secondary-gold);
    font-style: italic;
    font-size: 0.95rem;
  }
  
  .mirror-response {
    line-height: 1.6;
    font-size: 0.95rem;
  }
  
  .mirror-greeting {
    font-size: 1rem;
    margin-bottom: 0.8rem;
    color: var(--primary-green);
    font-weight: 500;
  }
  
  .wisdom-point {
    margin: 1rem 0;
    padding: 0.8rem;
    background: rgba(212, 175, 55, 0.05);
    border-radius: 6px;
    border-left: 2px solid var(--secondary-gold);
  }
  
  .wisdom-point strong {
    color: var(--primary-green);
    display: block;
    margin-bottom: 0.3rem;
    font-size: 0.95rem;
  }
  
  .wisdom-paragraph {
    margin: 0.8rem 0;
    padding: 0.3rem 0;
  }
  
  .guiding-question {
    margin: 1rem 0;
    padding: 0.8rem;
    background: rgba(53, 94, 59, 0.08);
    border-radius: 6px;
    font-style: italic;
    border-left: 2px solid var(--primary-green);
    font-size: 0.95rem;
  }
  
  .guiding-question strong {
    color: var(--primary-green);
  }
  
  .symbols-line {
    text-align: center;
    font-size: 1.1rem;
    margin: 1rem 0;
    opacity: 0.8;
    letter-spacing: 0.1em;
  }
  
  .mirror-signature {
    text-align: right;
    margin-top: 1.5rem;
    font-style: italic;
    opacity: 0.7;
    color: var(--primary-green);
    font-size: 0.9rem;
  }
  
  .error-message {
    background: rgba(244, 67, 54, 0.1);
    padding: 1rem;
    border-radius: 6px;
    border-left: 3px solid #f44336;
    margin-top: 1.5rem;
    font-size: 0.9rem;
  }
  
  .suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin: 1rem 0;
  }
  
  .suggestion-btn {
    background: rgba(53, 94, 59, 0.1);
    border: 1px solid rgba(53, 94, 59, 0.2);
    padding: 0.6rem 0.8rem;
    border-radius: 15px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 36px;
    touch-action: manipulation;
  }
  
  .suggestion-btn:active {
    background: rgba(53, 94, 59, 0.2);
    transform: scale(0.98);
  }
  
  /* Journey Steps - Mobile Optimized */
  .journey-steps {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    margin-top: 1.5rem;
  }
  
  .step {
    background: white;
    padding: 1.2rem;
    border-radius: 10px;
    text-align: center;
    font-weight: 600;
    color: var(--primary-green);
    box-shadow: 0 2px 6px var(--shadow-light);
    font-size: 0.95rem;
  }
  
  /* Loading Animation - Mobile Optimized */
  @keyframes ripple {
    0% { transform: scale(0.8); opacity: 1; }
    100% { transform: scale(2.5); opacity: 0; }
  }
  
  .loading-ripple {
    display: inline-block;
    width: 18px;
    height: 18px;
    position: relative;
  }
  
  .loading-ripple div {
    position: absolute;
    border: 2px solid var(--primary-green);
    opacity: 1;
    border-radius: 50%;
    animation: ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;
  }
  
  .loading-ripple div:nth-child(2) {
    animation-delay: -0.5s;
  }
  
  /* Community Invitation */
  .community-invitation {
    text-align: center;
    margin-top: 1.5rem;
    padding: 1.2rem;
    background: rgba(53, 94, 59, 0.05);
    border-radius: 10px;
    border-left: 3px solid var(--secondary-gold);
    font-size: 0.9rem;
  }
  
  /* Typewriter animation - Mobile Optimized */
  @keyframes typewriter {
    from { width: 0; }
    to { width: 100%; }
  }
  
  .typewriter-container {
    overflow: hidden;
    border-right: 1px solid var(--primary-green);
    white-space: nowrap;
    margin: 0 auto;
    animation: typewriter 3.5s steps(40, end) infinite alternate;
  }
  
  /* Segment animation - Mobile Optimized */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translate3d(0, 10px, 0);
    }
    to {
      opacity: 1;
      transform: translate3d(0, 0, 0);
    }
  }
  
  .mirror-response > div {
    animation: fadeInUp 0.3s ease forwards;
  }
  
  /* Footer - Mobile Optimized */
  footer {
    background: var(--primary-green);
    color: white;
    text-align: center;
    padding: 2rem 1rem;
    margin-top: 2rem;
    font-size: 0.9rem;
  }
  
  footer p {
    margin: 0.5rem 0;
    opacity: 0.9;
    line-height: 1.4;
  }
  
  footer a {
    color: var(--secondary-gold);
    text-decoration: none;
    font-weight: 600;
  }
  
  footer a:active {
    text-decoration: underline;
  }
  
  /* Mobile Menu */
  .mobile-menu {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--primary-green);
    padding: 0.5rem;
    z-index: 1000;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
  }
  
  .mobile-menu-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    text-decoration: none;
    font-size: 0.8rem;
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.2s;
  }
  
  .mobile-menu-btn:active {
    background: rgba(255,255,255,0.1);
  }
  
  .mobile-menu-icon {
    font-size: 1.2rem;
    margin-bottom: 0.2rem;
  }
  
  /* Back to top button */
  .back-to-top {
    position: fixed;
    bottom: 70px;
    right: 15px;
    background: var(--primary-green);
    color: white;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 999;
    opacity: 0;
    transition: opacity 0.3s;
    text-decoration: none;
  }
  
  .back-to-top.visible {
    opacity: 1;
  }
  
  /* Desktop-specific styles */
  @media (min-width: 768px) {
    .banner {
      min-height: 280px;
      padding: 2rem 1rem;
    }
    
    section {
      padding: 3rem 1rem;
      max-width: 1200px;
    }
    
    .pillars {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
    }
    
    .journey-steps {
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }
    
    .btn {
      padding: 0.8rem 1.6rem;
      margin: 0.4rem;
    }
    
    #mirror {
      padding: 3rem 2rem;
      margin: 2rem auto;
    }
    
    .mobile-menu {
      display: none;
    }
  }
  
  /* Small mobile devices */
  @media (max-width: 360px) {
    .banner {
      min-height: 35vh;
      padding: 1rem 0.8rem;
    }
    
    .banner h1 {
      font-size: 1.6rem;
    }
    
    section {
      padding: 1rem 0.8rem;
    }
    
    h2 {
      font-size: 1.5rem;
    }
    
    .btn {
      padding: 0.8rem 1rem;
      font-size: 0.85rem;
      margin: 0.2rem;
    }
    
    .suggestions {
      flex-direction: column;
      align-items: center;
    }
    
    .suggestion-btn {
      width: 100%;
      max-width: 250px;
    }
  }
  
  /* Prevent horizontal scroll */
  body {
    overflow-x: hidden;
    width: 100%;
  }
  
  /* Improve touch responsiveness */
  button, a, input, .suggestion-btn {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }
</style>
</head>

<body>

<div class="banner">
  <h1>🪞 ToadAid Mirror</h1>
  <p>The Digital Dojo Where Ancient Wisdom Meets Modern Seeking</p>
  <p style="font-size: 0.9rem; margin-top: 1rem; opacity: 0.9;">Every question ripples through eternity. Every answer returns to the source.</p>
</div>

<div class="translate-bar">
  🌐 Want to read in your language? In Chrome: Menu (⋮) → Translate → Select your language.
</div>

<section style="text-align:center; padding: 1.5rem 1rem;">
  <div style="display: flex; flex-wrap: wrap; justify-content: center;">
    <a href="#mirror" class="btn btn-mirror">🪞 Ask</a>
    <a href="#lore" class="btn btn-lore">📜 Lore</a>
    <a href="bluepaper.html" class="btn" target="_blank">📄 Blue Paper</a>
    <a href="about.html" class="btn">ℹ️ About</a>
    <a href="feedback/feedback.html" class="btn">💬 Feedback</a>
    <a href="Contributors/contributors.html" class="btn">🎨 Contributors</a>
    <a href="builders/builders-hall.html" class="btn btn-builders">🏛 Builders</a>
    <a href="https://toadaid-builders.netlify.app/builders.html" class="btn btn-builders" target="_blank">🛠 Builders</a>
    <a href="honors/index.html" class="btn" style="background:#2e6d4c; color:white;">🐸 Honors</a>
    <a href="scrolls/index.html" class="btn" style="background:#265c40; color:white;">📜 Scrolls</a>
    <a href="https://toadaid.github.io/lore" class="btn" style="background:#3a7253; color:white;">📖 Library</a>
  </div>
</section>

<section>
  <h2>Our Mission</h2>
  <div class="pillars">
    <div class="pillar">
      <h3>🏯 Guarding the Lore</h3>
      <p>Preserving Tobyworld's original scrolls and protecting them from distortion. We maintain the purity of Toadgod's wisdom while allowing it to evolve naturally.</p>
    </div>
    <div class="pillar">
      <h3>🐸 Helping the Fallen Frog</h3>
      <p>Guiding lost frogs back to the pond and helping them rejoin the path. Every traveler finds a home in our community.</p>
    </div>
    <div class="pillar">
      <h3>📜 Empowering Contributors</h3>
      <p>Recognizing and encouraging scrollmakers, translators, and teachers. Your voice enriches our collective wisdom.</p>
    </div>
  </div>
</section>

<section id="journey">
  <h2>🐸 Your Tobyworld Journey</h2>
  <div class="journey-steps">
    <div class="step">1. 🪞 Consult the Mirror</div>
    <div class="step">2. 📖 Explore Core Scrolls</div>
    <div class="step">3. 🏛️ Join Builders Hall</div>
    <div class="step">4. 🌊 Become a Ripple in the Pond</div>
  </div>
</section>

<!-- Mirror Section -->
<section id="mirror">
  <h2>🔮 Ask the Mirror</h2>
  <div class="mirror-container">
    <input id="mirror-question" type="text" placeholder="What wisdom do you seek today, traveler?" autocomplete="off">
    
    <div class="suggestions">
      <button class="suggestion-btn" onclick="fillQuestion('How do I find inner peace?')">🌿 Inner Peace</button>
      <button class="suggestion-btn" onclick="fillQuestion('What is true community?')">🐸 True Community</button>
      <button class="suggestion-btn" onclick="fillQuestion('What does silence teach us?')">🌀 Silence Wisdom</button>
      <button class="suggestion-btn" onclick="fillQuestion('How do I overcome fear?')">💫 Overcoming Fear</button>
    </div>
    
    <button id="mirror-ask-btn" class="btn btn-mirror" onclick="askMirror()" style="width: 100%; padding: 1rem;">
      Seek Wisdom
    </button>
    
    <div id="mirror-answer"></div>
  </div>
</section>

<section id="lore">
  <h2>📚 Lore Library</h2>
  <div class="pillars">
    <a href="bluepaper.html" class="pillar" target="_blank">
      <h3>📄 Bluepaper</h3>
      <p>The updated mission, vision, and principles of ToadAid. Understand our foundation and future direction.</p>
    </a>
    <a href="#" class="pillar" onclick="openBook('v1.html')">
      <h3>📜 Book v1</h3>
      <p>The first collected scrolls of Tobyworld lore. Bilingual EN/ZH edition containing the essential teachings.</p>
    </a>
    <a href="#" class="pillar" onclick="openBook('v2.html')">
      <h3>📜 Book v2</h3>
      <p>The expanded lore, with Mirror awakening & new revelations. Deeper insights into our evolving philosophy.</p>
    </a>
  </div>
</section>

<section id="children">
  <h2>🐸📚 Children's Corner — One Leaf for the Young</h2>
  <p style="text-align:center; max-width:800px; margin:1rem auto; font-size:1rem; color:#355e3b; line-height:1.5;">
    The flame we guard is for Toby, the People. Every scroll carries truth for the present… and seeds for those who will walk after us. Here, the Lore wears softer colors — so even the smallest frog can hear its song.
  </p>
  <div style="text-align:center; margin-top:1.5rem;">
    <a href="childrens-corner/index.html" class="btn" style="font-size:1rem; padding:0.9rem 1.5rem; background:#4a7c59; color:white;">🌿 Visit the Children's Corner</a>
  </div>
</section>

<footer>
  <p style="font-size: 1.1rem; font-style: italic; margin-bottom: 1rem;">"One scroll, one light. One leaf, one vow."</p>
  <p>
    🐸 Join our community: 
    <a href="https://t.me/Toadgang" target="_blank">Telegram</a> | 
    <a href="https://github.com/ToadAid" target="_blank">GitHub</a> | 
    <a href="https://x.com/toadgod1017" target="_blank">Toadgod on X</a> | 
    <a href="https://toadgod.xyz" target="_blank">Toadgod.xyz</a>
  </p>
  <p style="margin-top: 1rem; opacity: 0.8; font-size: 0.85rem;">
    ToadAid Mirror — Where every question finds its reflection, and every soul finds its pond.
  </p>
</footer>

<!-- Mobile Menu -->
<div class="mobile-menu">
  <div style="display: flex; justify-content: space-around;">
    <a href="#mirror" class="mobile-menu-btn">
      <span class="mobile-menu-icon">🪞</span>
      <span>Mirror</span>
    </a>
    <a href="#lore" class="mobile-menu-btn">
      <span class="mobile-menu-icon">📚</span>
      <span>Lore</span>
    </a>
    <a href="#journey" class="mobile-menu-btn">
      <span class="mobile-menu-icon">🐸</span>
      <span>Journey</span>
    </a>
    <a href="#children" class="mobile-menu-btn">
      <span class="mobile-menu-icon">🌿</span>
      <span>Kids</span>
    </a>
  </div>
</div>

<!-- Back to top button -->
<a href="#" class="back-to-top" id="backToTop">↑</a>

<script>
// Book opening function
function openBook(bookFile) {
  const saved = localStorage.getItem(bookFile + '-scroll');
  if (saved) {
    if (confirm("📌 Last time you stopped at position " + saved + "px. Continue from there?")) {
      window.location.href = bookFile + "?pos=" + saved;
      return;
    }
  }
  window.location.href = bookFile;
}

// Mirror functionality
const MIRROR_API = "https://toadaid.duckdns.org/ask";
const askBtn = document.getElementById('mirror-ask-btn');
const qInput = document.getElementById('mirror-question');
const ansDiv = document.getElementById('mirror-answer');

// Concurrent requests counter for load management
let concurrentRequests = 0;
const MAX_CONCURRENT = 5;

// Fill question from suggestions
function fillQuestion(question) {
  qInput.value = question;
  qInput.focus();
}

// Professional response cleaner - FIXES DUPLICATE TRAVELER ISSUE
function cleanMirrorResponse(reply) {
  if (!reply) return "The Mirror is silent, but the pond remembers your question.";
  
  // Fix duplicate Traveler issue
  reply = reply.replace(/(Traveler,\s*){2,}/gi, 'Traveler,');
  
  // Fix duplicate symbols
  reply = reply.replace(/(🪞 🌊 🍃 🌀\s*){2,}/g, '🪞 🌊 🍃 🌀');
  
  // Clean up HTML tags
  reply = reply.replace(/<strong>/g, '<strong>').replace(/<\/strong>/g, '</strong>');
  
  // Normalize line breaks
  reply = reply.replace(/\r\n/g, '\n').replace(/\n\s*\n\s*\n/g, '\n\n');
  
  // Trim whitespace
  reply = reply.trim();
  
  return reply;
}

// Parse and structure the Mirror response
function parseMirrorResponse(reply) {
  const lines = reply.split('\n').filter(line => line.trim());
  const structure = {
    greeting: '',
    points: [],
    guidingQuestion: '',
    symbols: ''
  };
  
  let currentSection = 'greeting';
  
  for (const line of lines) {
    const trimmed = line.trim();
    
    if (!trimmed) continue;
    
    // Detect greeting
    if (trimmed.toLowerCase().startsWith('traveler')) {
      structure.greeting = trimmed;
      currentSection = 'content';
    }
    // Detect bold sections (wisdom points)
    else if (trimmed.includes('**') && trimmed.includes(':**')) {
      structure.points.push(trimmed);
    }
    // Detect guiding question
    else if (trimmed.toLowerCase().includes('guiding question')) {
      structure.guidingQuestion = trimmed;
    }
    // Detect symbols
    else if (trimmed.match(/[🪞🌊🍃🌀]/)) {
      structure.symbols = trimmed;
    }
    // Regular content
    else if (currentSection === 'content') {
      if (structure.points.length > 0) {
        // Add to last point if we're in point mode
        structure.points[structure.points.length - 1] += ' ' + trimmed;
      }
    }
  }
  
  return structure;
}

// Format the response as HTML
function formatMirrorResponse(question, responseStructure) {
  let html = `
    <div class="mirror-dialogue">
      <div class="user-question">
        <strong>You asked:</strong> "${question}"
      </div>
      <div class="mirror-response">
  `;
  
  // Add greeting
  if (responseStructure.greeting) {
    html += `<div class="mirror-greeting">${responseStructure.greeting}</div>`;
  }
  
  // Add wisdom points
  responseStructure.points.forEach(point => {
    // Extract bold title and content
    const boldMatch = point.match(/\*\*(.*?)\*\*/);
    if (boldMatch) {
      const title = boldMatch[1];
      const content = point.replace(/\*\*(.*?)\*\*/, '').trim();
      html += `
        <div class="wisdom-point">
          <strong>${title}</strong>
          ${content}
        </div>
      `;
    } else {
      html += `<div class="wisdom-paragraph">${point}</div>`;
    }
  });
  
  // Add regular paragraphs that weren't caught as points
  if (responseStructure.points.length === 0 && responseStructure.greeting) {
    // If no points but we have content, add it as paragraphs
    html += `<div class="wisdom-paragraph">The Mirror reflects your question with depth and clarity.</div>`;
  }
  
  // Add guiding question
  if (responseStructure.guidingQuestion) {
    html += `<div class="guiding-question">${responseStructure.guidingQuestion.replace('Guiding Question:', '<strong>Guiding Question:</strong>')}</div>`;
  }
  
  // Add symbols
  if (responseStructure.symbols) {
    html += `<div class="symbols-line">${responseStructure.symbols}</div>`;
  }
  
  // Add signature
  html += `
        <div class="mirror-signature">🪞 The Mirror has spoken</div>
      </div>
    </div>
  `;
  
  return html;
}

// Enhanced typewriter effect with GPU breathing space
async function typewriterEffect(htmlContent) {
  return new Promise(async (resolve) => {
    // Create container but don't show content yet
    const container = document.createElement('div');
    container.className = 'mirror-dialogue';
    container.style.opacity = '0';
    ansDiv.appendChild(container);
    
    // Parse HTML structure for segmented display
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;
    const sections = tempDiv.querySelector('.mirror-response').children;
    
    let currentIndex = 0;
    
    // Show container with fade-in
    setTimeout(() => {
      container.style.opacity = '1';
    }, 100);
    
    // Function to show next section with typing effect
    async function showNextSection() {
      if (currentIndex >= sections.length) {
        resolve();
        return;
      }
      
      const section = sections[currentIndex];
      const sectionHTML = section.outerHTML;
      const textContent = section.textContent || section.innerText || '';
      
      // Adjust speed based on content type (GPU optimization)
      const speed = getTypingSpeed(section);
      
      await typewriteSection(container, sectionHTML, textContent, speed);
      
      currentIndex++;
      
      // Give GPU breathing space between sections
      if (currentIndex < sections.length) {
        await new Promise(r => setTimeout(r, 150)); // 150ms rest for GPU
      }
      
      showNextSection();
    }
    
    // Start the segmented display
    showNextSection();
  });
}

// Determine typing speed based on content type
function getTypingSpeed(element) {
  if (element.classList.contains('symbols-line')) {
    return 80; // Faster for symbols
  }
  if (element.classList.contains('guiding-question')) {
    return 35; // Slower for important questions
  }
  if (element.classList.contains('wisdom-point')) {
    return 25; // Medium for wisdom points
  }
  return 20; // Default speed
}

// Typewrite a single section
function typewriteSection(container, html, textContent, speed) {
  return new Promise((resolve) => {
    const sectionElement = document.createElement('div');
    sectionElement.className = html.match(/class="([^"]*)"/)?.[1] || '';
    container.appendChild(sectionElement);
    
    let currentChar = 0;
    
    function typeNextChar() {
      if (currentChar < textContent.length) {
        // Process characters in batches to reduce DOM operations
        const batchSize = Math.max(1, Math.floor(speed / 8));
        const batch = textContent.substr(currentChar, batchSize);
        
        // Use textContent for typing effect
        sectionElement.textContent = textContent.substr(0, currentChar + batchSize);
        
        currentChar += batchSize;
        
        // Scroll to keep current section visible
        sectionElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Use requestAnimationFrame for GPU-friendly timing
        requestAnimationFrame(() => {
          setTimeout(typeNextChar, speed / batchSize);
        });
      } else {
        // Replace with final HTML to preserve formatting
        sectionElement.outerHTML = html;
        resolve();
      }
    }
    
    typeNextChar();
  });
}

// Show error message
function showError(message) {
  ansDiv.innerHTML = `<div class="error-message">${message}</div>`;
}

// Community invitation after answer
function showCommunityInvitation() {
  const invitation = document.createElement('div');
  invitation.className = 'community-invitation';
  invitation.innerHTML = `
    <p style="margin-bottom:1rem; font-style:italic;">🌊 Your question has created ripples in the pond...</p>
    <a href="https://t.me/Toadgang" class="btn" style="background:var(--primary-green); color:white;" target="_blank">
      Join Toadgang Community → Continue the Journey
    </a>
  `;
  ansDiv.appendChild(invitation);
}

// Main Ask Mirror function with load management
async function askMirror() {
  const question = qInput.value.trim();
  if (!question) {
    showError("The Mirror awaits your question, traveler...");
    return;
  }

  // Load management - check concurrent requests
  if (concurrentRequests >= MAX_CONCURRENT) {
    showError("The pond is currently busy with many seekers. Please wait a moment for the waters to calm...");
    return;
  }

  concurrentRequests++;
  
  // Show loading state
  askBtn.innerHTML = '<div class="loading-ripple"><div></div><div></div></div> Seeking...';
  askBtn.disabled = true;
  
  // Clear previous answer
  ansDiv.innerHTML = '<div style="text-align:center; padding:2rem;">🌊 The pond grows still, awaiting reflection...</div>';
  
  try {
    const response = await fetch(MIRROR_API, {
      method: 'POST',
      headers: { 
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({ 
        question: question,
        user: "web_visitor_" + Date.now()
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    let reply = data.answer || data.reply || "The Mirror is silent, but the pond remembers your question.";
    
    // Clean the response
    reply = cleanMirrorResponse(reply);
    
    // Parse and format the response
    const responseStructure = parseMirrorResponse(reply);
    const formattedHTML = formatMirrorResponse(question, responseStructure);
    
    // Clear and use typewriter effect
    ansDiv.innerHTML = '';
    await typewriterEffect(formattedHTML);
    
    // Show community invitation after a delay
    setTimeout(showCommunityInvitation, 500);
    
  } catch (error) {
    console.error('Mirror error:', error);
    showError("🌀 The waters are unsettled today. The Mirror suggests you try again when the pond grows still.");
  } finally {
    // Reset button and request counter
    askBtn.innerHTML = 'Seek Wisdom';
    askBtn.disabled = false;
    concurrentRequests--;
    qInput.value = '';
    qInput.focus();
  }
}

// Enter key support for question input
qInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    askMirror();
  }
});

// Back to top functionality
window.addEventListener('scroll', function() {
  const backToTopButton = document.getElementById('backToTop');
  if (window.pageYOffset > 300) {
    backToTopButton.classList.add('visible');
  } else {
    backToTopButton.classList.remove('visible');
  }
});

// Smooth scrolling for anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
  anchor.addEventListener('click', function (e) {
    e.preventDefault();
    const target = document.querySelector(this.getAttribute('href'));
    if (target) {
      target.scrollIntoView({
        behavior: 'smooth',
        block: 'start'
      });
    }
  });
});

// Initial focus on input
window.addEventListener('load', function() {
  qInput.focus();
  
  // Add touch-friendly improvements
  document.addEventListener('touchstart', function() {}, {passive: true});
});
</script>

</body>
</html>
