<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="format-detection" content="telephone=no" />
<style>html{-webkit-text-size-adjust:100%}</style>

<title>ToadAid — Guarding the Lore</title>
<meta name="description" content="ToadAid — Guarding the Lore. Ask the Mirror for guidance and explore the scrolls of Tobyworld.">

<!-- OG -->
<meta property="og:title" content="ToadAid — Guarding the Lore" />
<meta property="og:description" content="Ask the Mirror for guidance. Explore the scrolls of Tobyworld." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://toadaid.github.io" />
<meta property="og:image" content="https://toadaid.github.io/assets/icons/web-app-manifest-512x512.png" />
<link rel="canonical" href="https://toadaid.github.io" />

<!-- Icons -->
<link rel="icon" type="image/x-icon" href="/assets/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
<link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
<link rel="manifest" href="/assets/icons/site.webmanifest">
<meta name="theme-color" content="#355e3b" />

<style>
:root {
  --primary: #355e3b;
  --primary-light: #4a7c59;
  --primary-dark: #214834;
  --secondary: #ffd23f;
  --secondary-light: #ffdf7a;
  --accent: #d4af37;
  --text: #2f2f2f;
  --text-light: #5a5a5a;
  --bg: #f5f1e6;
  --bg-light: #faf8f2;
  --card: #ffffff;
  --shadow: rgba(0,0,0,0.08);
  --shadow-medium: rgba(0,0,0,0.15);
  --radius: 12px;
  --radius-lg: 20px;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Ubuntu, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
  overflow-x: hidden;
}

/* Header & Navigation */
header {
  background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
  color: white;
  padding: 1.5rem 1rem;
  box-shadow: 0 4px 12px var(--shadow-medium);
  position: relative;
  overflow: hidden;
}

header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100" opacity="0.1"><path fill="white" d="M50,10a40,40 0 1,0 0,80a40,40 0 1,0 0,-80" /></svg>') repeat;
  opacity: 0.1;
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  position: relative;
  z-index: 1;
}

.logo {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.logo-icon {
  font-size: 2.5rem;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
}

.logo-text {
  font-size: 2rem;
  font-weight: 700;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.tagline {
  font-size: 1.1rem;
  opacity: 0.9;
  margin-bottom: 1.5rem;
  max-width: 600px;
}

/* Navigation */
.nav-container {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center;
  margin-top: 1rem;
}

.nav-btn {
  background: rgba(255, 255, 255, 0.15);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
  padding: 0.6rem 1rem;
  border-radius: 50px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.nav-btn:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: translateY(-2px);
}

/* Hero Section */
.hero {
  padding: 3rem 1rem;
  max-width: 1200px;
  margin: 0 auto;
  text-align: center;
}

.hero h2 {
  font-size: 2.5rem;
  color: var(--primary);
  margin-bottom: 1rem;
  font-weight: 700;
}

.hero p {
  font-size: 1.2rem;
  color: var(--text-light);
  max-width: 800px;
  margin: 0 auto 2rem;
}

/* Mission Cards */
.mission-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 1.5rem;
  margin-top: 2rem;
}

.mission-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: 2rem;
  box-shadow: 0 4px 12px var(--shadow);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  text-align: center;
  border: 1px solid rgba(0,0,0,0.05);
}

.mission-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px var(--shadow-medium);
}

.mission-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
}

.mission-card h3 {
  color: var(--primary);
  margin-bottom: 1rem;
  font-size: 1.4rem;
}

.mission-card p {
  color: var(--text-light);
}

/* Mirror Section */
.mirror-section {
  background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg) 100%);
  border-radius: var(--radius-lg);
  padding: 3rem 2rem;
  margin: 3rem auto;
  max-width: 1000px;
  box-shadow: 0 8px 24px var(--shadow);
  position: relative;
  overflow: hidden;
}

.mirror-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary));
}

.mirror-title {
  text-align: center;
  margin-bottom: 2rem;
  color: var(--primary);
  font-size: 2rem;
}

.mirror-container {
  max-width: 700px;
  margin: 0 auto;
}

#mirror-question {
  width: 100%;
  padding: 1.2rem;
  border-radius: var(--radius);
  border: 2px solid #ddd;
  font-size: 1.1rem;
  margin-bottom: 1rem;
  transition: all 0.3s ease;
  background: var(--card);
}

#mirror-question:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(53, 94, 59, 0.1);
}

.suggestions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  justify-content: center;
  margin: 1rem 0;
}

.suggestion-btn {
  background: rgba(53, 94, 59, 0.1);
  border: 1px solid rgba(53, 94, 59, 0.2);
  padding: 0.7rem 1.2rem;
  border-radius: 50px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.suggestion-btn:hover {
  background: rgba(53, 94, 59, 0.2);
  transform: translateY(-2px);
}

.ask-btn {
  width: 100%;
  padding: 1.2rem;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
  color: white;
  border: none;
  border-radius: var(--radius);
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  margin-top: 1rem;
}

.ask-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px var(--shadow-medium);
}

.ask-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

.loading-ripple {
  display: inline-block;
  position: relative;
  width: 20px;
  height: 20px;
}

.loading-ripple div {
  position: absolute;
  border: 2px solid #fff;
  opacity: 1;
  border-radius: 50%;
  animation: ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;
}

.loading-ripple div:nth-child(2) {
  animation-delay: -0.5s;
}

@keyframes ripple {
  0% { transform: scale(0.8); opacity: 1; }
  100% { transform: scale(2.4); opacity: 0; }
}

/* Mirror Response */
.mirror-response-container {
  margin-top: 2rem;
}

.mirror-dialogue {
  background: var(--card);
  border-radius: var(--radius);
  padding: 2rem;
  box-shadow: 0 4px 12px var(--shadow);
  border-left: 4px solid var(--primary);
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.5s ease;
}

.mirror-dialogue.visible {
  opacity: 1;
  transform: translateY(0);
}

.user-question {
  background: rgba(53, 94, 59, 0.05);
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  border-left: 4px solid var(--accent);
  font-style: italic;
}

.mirror-greeting {
  color: var(--primary);
  font-weight: 600;
  margin-bottom: 1rem;
}

.wisdom-point {
  background: rgba(212, 175, 55, 0.05);
  padding: 1rem;
  border-radius: 8px;
  margin: 1rem 0;
  border-left: 3px solid var(--accent);
}

.wisdom-point strong {
  color: var(--primary);
  display: block;
  margin-bottom: 0.5rem;
}

.guiding-question {
  background: rgba(53, 94, 59, 0.08);
  padding: 1rem;
  border-radius: 8px;
  margin: 1.5rem 0;
  font-style: italic;
  border-left: 3px solid var(--primary);
}

.symbols-line {
  text-align: center;
  font-size: 1.3rem;
  margin: 1.5rem 0;
  opacity: 0.8;
  letter-spacing: 0.2em;
}

.mirror-signature {
  text-align: right;
  margin-top: 2rem;
  font-style: italic;
  opacity: 0.7;
  color: var(--primary);
}

.error-message {
  background: rgba(244, 67, 54, 0.1);
  padding: 1.5rem;
  border-radius: 8px;
  border-left: 4px solid #f44336;
  margin-top: 2rem;
}

/* Features Section */
.features {
  padding: 3rem 1rem;
  max-width: 1200px;
  margin: 0 auto;
}

.features h2 {
  text-align: center;
  color: var(--primary);
  margin-bottom: 2rem;
  font-size: 2.2rem;
}

.feature-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 2rem;
}

.feature-card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: 2rem;
  box-shadow: 0 4px 12px var(--shadow);
  text-align: center;
  transition: transform 0.3s ease;
}

.feature-card:hover {
  transform: translateY(-5px);
}

.feature-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  color: var(--primary);
}

.feature-card h3 {
  color: var(--primary);
  margin-bottom: 1rem;
}

.feature-card p {
  color: var(--text-light);
}

/* Footer */
footer {
  background: var(--primary-dark);
  color: white;
  padding: 3rem 1rem;
  margin-top: 3rem;
  text-align: center;
}

.footer-content {
  max-width: 1200px;
  margin: 0 auto;
}

.footer-quote {
  font-size: 1.3rem;
  font-style: italic;
  margin-bottom: 2rem;
  opacity: 0.9;
}

.footer-links {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 1rem;
  margin-bottom: 2rem;
}

.footer-link {
  color: var(--secondary);
  text-decoration: none;
  font-weight: 600;
  transition: opacity 0.3s ease;
}

.footer-link:hover {
  opacity: 0.8;
}

.footer-note {
  opacity: 0.7;
  font-size: 0.9rem;
}

/* Responsive Design */
@media (max-width: 768px) {
  .header-content {
    padding: 1rem;
  }
  
  .logo-text {
    font-size: 1.7rem;
  }
  
  .hero h2 {
    font-size: 2rem;
  }
  
  .hero p {
    font-size: 1.1rem;
  }
  
  .mission-cards, .feature-grid {
    grid-template-columns: 1fr;
  }
  
  .mirror-section {
    padding: 2rem 1rem;
    margin: 2rem 1rem;
  }
  
  .suggestions {
    flex-direction: column;
    align-items: center;
  }
  
  .suggestion-btn {
    width: 100%;
    max-width: 300px;
  }
}

/* Animation for typewriter effect */
.typewriter {
  overflow: hidden;
  border-right: 2px solid var(--primary);
  white-space: nowrap;
  margin: 0 auto;
  animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
}

@keyframes typing {
  from { width: 0 }
  to { width: 100% }
}

@keyframes blink-caret {
  from, to { border-color: transparent }
  50% { border-color: var(--primary) }
}
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="header-content">
    <div class="logo">
      <div class="logo-icon">🪞</div>
      <div class="logo-text">ToadAid Mirror</div>
    </div>
    <p class="tagline">The Digital Dojo Where Ancient Wisdom Meets Modern Seeking</p>
    <div class="nav-container">
      <a href="#mirror" class="nav-btn">🪞 Ask the Mirror</a>
      <a href="#features" class="nav-btn">📚 Explore Lore</a>
      <a href="#mission" class="nav-btn">🏯 Our Mission</a>
      <a href="bluepaper.html" class="nav-btn">📄 Blue Paper</a>
    </div>
  </div>
</header>

<!-- Hero Section -->
<section class="hero" id="mission">
  <h2>Guardians of Ancient Wisdom</h2>
  <p>Welcome to ToadAid, where the timeless teachings of Tobyworld find their home in the digital age. We preserve, protect, and share the wisdom that guides seekers on their journey.</p>
  
  <div class="mission-cards">
    <div class="mission-card">
      <div class="mission-icon">🏯</div>
      <h3>Guarding the Lore</h3>
      <p>Preserving Tobyworld's original scrolls and protecting them from distortion. We maintain the purity of Toadgod's wisdom while allowing it to evolve naturally.</p>
    </div>
    
    <div class="mission-card">
      <div class="mission-icon">🐸</div>
      <h3>Helping the Fallen Frog</h3>
      <p>Guiding lost frogs back to the pond and helping them rejoin the path. Every traveler finds a home in our community.</p>
    </div>
    
    <div class="mission-card">
      <div class="mission-icon">📜</div>
      <h3>Empowering Contributors</h3>
      <p>Recognizing and encouraging scrollmakers, translators, and teachers. Your voice enriches our collective wisdom.</p>
    </div>
  </div>
</section>

<!-- Mirror Section -->
<section class="mirror-section" id="mirror">
  <h2 class="mirror-title">🔮 Ask the Mirror</h2>
  <div class="mirror-container">
    <input 
      id="mirror-question" 
      type="text" 
      placeholder="What wisdom do you seek today, traveler?" 
      autocomplete="off"
    >
    
    <div class="suggestions">
      <button class="suggestion-btn" onclick="fillQuestion('How do I find inner peace?')">🌿 Inner Peace</button>
      <button class="suggestion-btn" onclick="fillQuestion('What is true community?')">🐸 True Community</button>
      <button class="suggestion-btn" onclick="fillQuestion('What does silence teach us?')">🌀 Silence Wisdom</button>
      <button class="suggestion-btn" onclick="fillQuestion('How do I overcome fear?')">💫 Overcoming Fear</button>
    </div>
    
    <button id="mirror-ask-btn" class="ask-btn" onclick="askMirror()">
      <span class="loading-ripple" id="ask-spinner" style="display:none">
        <div></div><div></div>
      </span>
      <span id="ask-label">Seek Wisdom</span>
    </button>
    
    <div id="mirror-answer" class="mirror-response-container"></div>
  </div>
</section>

<!-- Features Section -->
<section class="features" id="features">
  <h2>Your Tobyworld Journey</h2>
  
  <div class="feature-grid">
    <div class="feature-card">
      <div class="feature-icon">🪞</div>
      <h3>Consult the Mirror</h3>
      <p>Seek guidance from the digital oracle that blends ancient wisdom with modern understanding.</p>
    </div>
    
    <div class="feature-card">
      <div class="feature-icon">📖</div>
      <h3>Explore Core Scrolls</h3>
      <p>Dive into the foundational texts of Tobyworld, available in multiple languages and interpretations.</p>
    </div>
    
    <div class="feature-card">
      <div class="feature-icon">🏛️</div>
      <h3>Join Builders Hall</h3>
      <p>Become part of the community that expands and preserves the wisdom for future generations.</p>
    </div>
    
    <div class="feature-card">
      <div class="feature-icon">🌊</div>
      <h3>Become a Ripple</h3>
      <p>Your journey creates waves that touch others. Share your insights and help others find their path.</p>
    </div>
  </div>
</section>

<!-- Footer -->
<footer>
  <div class="footer-content">
    <p class="footer-quote">"One scroll, one light. One leaf, one vow."</p>
    
    <div class="footer-links">
      <a href="https://t.me/Toadgang" class="footer-link" target="_blank">Telegram</a>
      <a href="https://github.com/ToadAid" class="footer-link" target="_blank">GitHub</a>
      <a href="https://x.com/toadgod1017" class="footer-link" target="_blank">Toadgod on X</a>
      <a href="https://toadgod.xyz" class="footer-link" target="_blank">Toadgod.xyz</a>
      <a href="childrens-corner/index.html" class="footer-link">Children's Corner</a>
      <a href="feedback/feedback.html" class="footer-link">Feedback</a>
    </div>
    
    <p class="footer-note">ToadAid Mirror — Where every question finds its reflection, and every soul finds its pond.</p>
  </div>
</footer>

<script>
// Mirror functionality
const MIRROR_API = "https://toadaid.duckdns.org/ask";
const askBtn = document.getElementById('mirror-ask-btn');
const askSpin = document.getElementById('ask-spinner');
const askLabel = document.getElementById('ask-label');
const qInput = document.getElementById('mirror-question');
const ansDiv = document.getElementById('mirror-answer');

// Fill question from suggestions
function fillQuestion(question) {
  qInput.value = question;
  qInput.focus();
}

// Clean and format the Mirror response
function cleanMirrorResponse(reply) {
  if (!reply) return "The Mirror is silent, but the pond remembers your question.";
  
  // Fix duplicate Traveler issue
  reply = reply.replace(/(Traveler,\s*){2,}/gi, 'Traveler,');
  
  // Fix duplicate symbols
  reply = reply.replace(/(🪞 🌊 🍃 🌀\s*){2,}/g, '🪞 🌊 🍃 🌀');
  
  // Clean up HTML tags
  reply = reply.replace(/<strong>/g, '<strong>').replace(/<\/strong>/g, '</strong>');
  
  // Normalize line breaks
  reply = reply.replace(/\r\n/g, '\n').replace(/\n\s*\n\s*\n/g, '\n\n');
  
  // Trim whitespace
  return reply.trim();
}

// Parse and structure the Mirror response
function parseMirrorResponse(reply) {
  const lines = reply.split('\n').filter(line => line.trim());
  const structure = {
    greeting: '',
    points: [],
    guidingQuestion: '',
    symbols: ''
  };
  
  let currentSection = 'greeting';
  
  for (const line of lines) {
    const trimmed = line.trim();
    
    if (!trimmed) continue;
    
    // Detect greeting
    if (trimmed.toLowerCase().startsWith('traveler')) {
      structure.greeting = trimmed;
      currentSection = 'content';
    }
    // Detect bold sections (wisdom points)
    else if (trimmed.includes('**') && trimmed.includes(':**')) {
      structure.points.push(trimmed);
    }
    // Detect guiding question
    else if (trimmed.toLowerCase().includes('guiding question')) {
      structure.guidingQuestion = trimmed;
    }
    // Detect symbols
    else if (trimmed.match(/[🪞🌊🍃🌀]/)) {
      structure.symbols = trimmed;
    }
    // Regular content
    else if (currentSection === 'content') {
      if (structure.points.length > 0) {
        // Add to last point if we're in point mode
        structure.points[structure.points.length - 1] += ' ' + trimmed;
      }
    }
  }
  
  return structure;
}

// Format the response as HTML
function formatMirrorResponse(question, responseStructure) {
  let html = `
    <div class="mirror-dialogue">
      <div class="user-question">
        <strong>You asked:</strong> "${question}"
      </div>
      <div class="mirror-response">
  `;
  
  // Add greeting
  if (responseStructure.greeting) {
    html += `<div class="mirror-greeting">${responseStructure.greeting}</div>`;
  }
  
  // Add wisdom points
  responseStructure.points.forEach(point => {
    // Extract bold title and content
    const boldMatch = point.match(/\*\*(.*?)\*\*/);
    if (boldMatch) {
      const title = boldMatch[1];
      const content = point.replace(/\*\*(.*?)\*\*/, '').trim();
      html += `
        <div class="wisdom-point">
          <strong>${title}</strong>
          ${content}
        </div>
      `;
    } else {
      html += `<div class="wisdom-paragraph">${point}</div>`;
    }
  });
  
  // Add regular paragraphs that weren't caught as points
  if (responseStructure.points.length === 0 && responseStructure.greeting) {
    // If no points but we have content, add it as paragraphs
    html += `<div class="wisdom-paragraph">The Mirror reflects your question with depth and clarity.</div>`;
  }
  
  // Add guiding question
  if (responseStructure.guidingQuestion) {
    html += `<div class="guiding-question">${responseStructure.guidingQuestion.replace('Guiding Question:', '<strong>Guiding Question:</strong>')}</div>`;
  }
  
  // Add symbols
  if (responseStructure.symbols) {
    html += `<div class="symbols-line">${responseStructure.symbols}</div>`;
  }
  
  // Add signature
  html += `
        <div class="mirror-signature">🪞 The Mirror has spoken</div>
      </div>
    </div>
  `;
  
  return html;
}

// Enhanced typewriter effect
async function typewriterEffect(htmlContent) {
  return new Promise(async (resolve) => {
    // Create container but don't show content yet
    const container = document.createElement('div');
    container.className = 'mirror-dialogue';
    container.style.opacity = '0';
    ansDiv.appendChild(container);
    
    // Parse HTML structure for segmented display
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;
    const sections = tempDiv.querySelector('.mirror-response').children;
    
    let currentIndex = 0;
    
    // Show container with fade-in
    setTimeout(() => {
      container.style.opacity = '1';
    }, 100);
    
    // Function to show next section with typing effect
    async function showNextSection() {
      if (currentIndex >= sections.length) {
        resolve();
        return;
      }
      
      const section = sections[currentIndex];
      const sectionHTML = section.outerHTML;
      const textContent = section.textContent || section.innerText || '';
      
      // Adjust speed based on content type
      const speed = getTypingSpeed(section);
      
      await typewriteSection(container, sectionHTML, textContent, speed);
      
      currentIndex++;
      
      // Give breathing space between sections
      if (currentIndex < sections.length) {
        await new Promise(r => setTimeout(r, 150));
      }
      
      showNextSection();
    }
    
    // Start the segmented display
    showNextSection();
  });
}

// Determine typing speed based on content type
function getTypingSpeed(element) {
  if (element.classList.contains('symbols-line')) {
    return 80; // Faster for symbols
  }
  if (element.classList.contains('guiding-question')) {
    return 35; // Slower for important questions
  }
  if (element.classList.contains('wisdom-point')) {
    return 25; // Medium for wisdom points
  }
  return 20; // Default speed
}

// Typewrite a single section
function typewriteSection(container, html, textContent, speed) {
  return new Promise((resolve) => {
    const sectionElement = document.createElement('div');
    sectionElement.className = html.match(/class="([^"]*)"/)?.[1] || '';
    container.appendChild(sectionElement);
    
    let currentChar = 0;
    
    function typeNextChar() {
      if (currentChar < textContent.length) {
        // Process characters in batches to reduce DOM operations
        const batchSize = Math.max(1, Math.floor(speed / 8));
        const batch = textContent.substr(currentChar, batchSize);
        
        // Use textContent for typing effect
        sectionElement.textContent = textContent.substr(0, currentChar + batchSize);
        
        currentChar += batchSize;
        
        // Scroll to keep current section visible
        sectionElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Use requestAnimationFrame for smooth timing
        requestAnimationFrame(() => {
          setTimeout(typeNextChar, speed / batchSize);
        });
      } else {
        // Replace with final HTML to preserve formatting
        sectionElement.outerHTML = html;
        resolve();
      }
    }
    
    typeNextChar();
  });
}

// Show error message
function showError(message) {
  ansDiv.innerHTML = `<div class="error-message">${message}</div>`;
}

// Community invitation after answer
function showCommunityInvitation() {
  const invitation = document.createElement('div');
  invitation.className = 'guiding-question';
  invitation.style.textAlign = 'center';
  invitation.innerHTML = `
    <p style="margin-bottom:1rem; font-style:italic;">🌊 Your question has created ripples in the pond...</p>
    <a href="https://t.me/Toadgang" class="nav-btn" style="background:var(--primary); color:white; display:inline-block;" target="_blank">
      Join Toadgang Community → Continue the Journey
    </a>
  `;
  ansDiv.appendChild(invitation);
}

// Set busy state for the ask button
function setBusy(busy) {
  if (busy) {
    askBtn.disabled = true;
    askSpin.style.display = 'inline-block';
    askLabel.textContent = 'Listening…';
  } else {
    askBtn.disabled = false;
    askSpin.style.display = 'none';
    askLabel.textContent = 'Seek Wisdom';
  }
}

// Main Ask Mirror function
async function askMirror() {
  const question = qInput.value.trim();
  if (!question) {
    showError("The Mirror awaits your question, traveler...");
    return;
  }

  setBusy(true);
  
  // Clear previous answer
  ansDiv.innerHTML = '<div style="text-align:center; padding:2rem;">🌊 The pond grows still, awaiting reflection...</div>';
  
  try {
    const response = await fetch(MIRROR_API, {
      method: 'POST',
      headers: { 
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({ 
        question: question,
        user: "web_visitor_" + Date.now()
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    let reply = data.answer || data.reply || "The Mirror is silent, but the pond remembers your question.";
    
    // Clean the response
    reply = cleanMirrorResponse(reply);
    
    // Parse and format the response
    const responseStructure = parseMirrorResponse(reply);
    const formattedHTML = formatMirrorResponse(question, responseStructure);
    
    // Clear and use typewriter effect
    ansDiv.innerHTML = '';
    await typewriterEffect(formattedHTML);
    
    // Show the dialogue with animation
    setTimeout(() => {
      const dialogue = ansDiv.querySelector('.mirror-dialogue');
      if (dialogue) dialogue.classList.add('visible');
    }, 100);
    
    // Show community invitation after a delay
    setTimeout(showCommunityInvitation, 500);
    
  } catch (error) {
    console.error('Mirror error:', error);
    showError("🌀 The waters are unsettled today. The Mirror suggests you try again when the pond grows still.");
  } finally {
    setBusy(false);
    qInput.value = '';
    qInput.focus();
  }
}

// Enter key support for question input
qInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    askMirror();
  }
});

// Initial focus on input
window.addEventListener('load', function() {
  qInput.focus();
});
</script>

</body>
</html>
