<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="format-detection" content="telephone=no" />
<style>html{-webkit-text-size-adjust:100%}</style>
<title>ToadAid â€” Guarding the Lore</title>
<meta name="description" content="ToadAid â€” Guarding the Lore. Ask the Mirror for guidance and explore the scrolls of Tobyworld.">
<meta property="og:title" content="ToadAid â€” Guarding the Lore" />
<meta property="og:description" content="Ask the Mirror for guidance. Explore the scrolls of Tobyworld." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://toadaid.github.io" />
<meta property="og:image" content="https://toadaid.github.io/assets/icons/web-app-manifest-512x512.png" />
<link rel="canonical" href="https://toadaid.github.io" />
<link rel="icon" type="image/x-icon" href="/assets/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
<link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
<link rel="manifest" href="/assets/icons/site.webmanifest">
<meta name="theme-color" content="#355e3b" />
<!-- styles omitted here for brevity, keep your original full CSS -->
</head>
<body>
<!-- (keep all banner, buttons, mirror section, footer identical to your copy) -->

<script>
/* all helper functions stay identical until askMirror() */

/* ---------------- Adaptive timeout + auto-retry ---------------- */
function chooseTimeoutMs(question){
  const base = window.matchMedia('(pointer:fine)').matches ? 200000 : 160000; // 200s desktop
  const len = question.length;
  const extra = Math.min(100000, Math.floor(len / 2) * 10); // small scaler
  return Math.min(300000, base + extra); // cap 300s
}
async function fetchJsonWithTimeout(url, opts={}, timeoutMs=60000){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), timeoutMs);
  try{
    const res = await fetch(url, { ...opts, signal: controller.signal, cache:'no-store' });
    if(!res.ok) return { ok:false, status:res.status, data:null };
    const data = await res.json();
    return { ok:true, status:res.status, data };
  } finally { clearTimeout(t); }
}

async function askMirror(){
  const question = qInput.value.trim();
  if(!question){ showError("The Mirror awaits your question, traveler..."); return; }
  if(!navigator.onLine){ showError("ğŸ“¶ You're offline â€” the pond is resting. I'll be here when you return."); return; }

  setBusy(true);
  ansDiv.innerHTML = '<div style="text-align:center;padding:1.1rem">ğŸŒŠ The pond grows still, awaiting reflection...</div>';

  const payload = { question, user: "web_visitor_" + Date.now() };
  const headers = { "Content-Type":"application/json", "Accept":"application/json" };
  const t0 = performance.now();
  const timeout1 = chooseTimeoutMs(question);
  const timeout2 = Math.min(300000, timeout1 + 60000); // retry longer

  try{
    let r = await fetchJsonWithTimeout(MIRROR_API, { method:'POST', headers, body: JSON.stringify(payload) }, timeout1);
    if (!r.ok && (r.status === undefined || r.status === 0)) {
      // first attempt timed out â†’ retry once
      r = await fetchJsonWithTimeout(MIRROR_API, { method:'POST', headers, body: JSON.stringify({ ...payload, mode:"fast" }) }, timeout2);
    }

    if (!r.ok || !r.data) {
      if (r.status === 429) return showError("â³ Many travelers at once. The Mirror asks for a moment between ripples (rate limited).");
      if (r.status >= 500) return showError("ğŸŒ€ The waters churn on the server (5xx). Try again when the pond grows still.");
      return showError("ğŸŒ€ The waters are unsettled today. Try again when the pond grows still.");
    }

    const t1 = performance.now();
    let reply = r.data.answer || r.data.reply || "The Mirror is silent, but the pond remembers your question.";
    reply = cleanMirrorResponse(reply);
    const s = parseMirrorResponse(reply);
    const html = formatMirrorResponse(question, s) +
      `<div style="opacity:.6;margin:.5rem 0;text-align:center">â± ${Math.round(t1 - t0)} ms</div>`;
    ansDiv.innerHTML = '';
    await typewriterEffect(html);
    if (!s.offRamp) setTimeout(showCommunityInvitation, 600);

  } catch (err){
    console.error('Mirror error:', err);
    if (err.name === 'AbortError')
      showError("ğŸŒ€ The Mirror is taking longer to reflect today. The pond suggests patience, or try a simpler question.");
    else
      showError("ğŸŒ« The pond canâ€™t be reached right now. It may be sleeping or far away.");
  } finally {
    setBusy(false);
    qInput.value=''; if(window.matchMedia('(pointer:fine)').matches) qInput.focus();
  }
}

/* enter key + focus */
qInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); askMirror(); }});
window.addEventListener('load',()=>{ if(window.matchMedia('(pointer:fine)').matches) qInput.focus(); });
</script>
</body>
</html>
