<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ToadAid Contributors</title>
<style>
  :root{ --bg:#f5f1e6; --ink:#2f2f2f; --leaf:#355e3b; --gold:#d9b200; --card:#fff; }
  *{ box-sizing:border-box }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
    text-align:center; padding:20px;
  }
  h1{
    color:var(--leaf); font-size:2rem; position:relative; display:inline-block; padding-bottom:6px; margin:0;
  }
  h1::after{
    content:""; position:absolute; left:0; bottom:0; height:4px; width:100%;
    background:var(--gold); border-radius:2px;
  }

  /* Grid & Card */
  .grid{
    display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap:16px; margin:20px auto 0; max-width:1200px; padding:0 6px;
  }
  .card{
    background:var(--card); border-radius:16px; padding:12px; text-align:left;
    box-shadow:0 8px 24px rgba(0,0,0,.08);
    border-left:6px solid var(--gold);      /* 左侧金色细条 */
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .card:hover{ transform:translateY(-3px); box-shadow:0 10px 28px rgba(0,0,0,.12) }

  /* Media：保留原始比例（不裁切），最大高度做保护，避免超长图撑爆布局 */
  .media{
    width:100%; background:#eee; border-radius:12px; overflow:hidden; border:1px solid #eee;
  }
  .media img, .media video{
    display:block; width:100%; height:auto;           /* 保留自然比例 */
    max-height:80vh;                                   /* 保护：极长图在手机也不至于太夸张 */
    transition:opacity .35s ease;
    opacity:0;                                         /* 进入视口淡入 */
  }
  .reveal{ opacity:1 !important }

  .meta{ margin:10px 0 4px; color:#425a47; font-size:.95rem }
  .title{ margin:0 0 6px; font-weight:700 }
  .desc{ margin:6px 0 10px; line-height:1.45 }
  .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
  .chip{ font-size:.8rem; background:#f0ead4; border:1px solid #e2d9b3; border-radius:999px; padding:4px 8px }
  .spacer{ flex:1 }
  .btn{ border:1px solid #d9d9d9; background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer; }
  .btn:hover{ background:#f7f7f7 }
  a{ color:var(--leaf); text-decoration:none }
  a:hover{ text-decoration:underline }
  footer{ margin-top:46px; color:var(--leaf); font-size:.9rem }

  /* Lightbox */
  .lightbox{
    position:fixed; inset:0; background:rgba(0,0,0,.8);
    display:none; align-items:center; justify-content:center; z-index:50; padding:16px;
  }
  .lightbox.open{ display:flex }
  .lightbox .content > img, .lightbox .content > video{
    max-width:min(96vw,1200px); max-height:90vh; object-fit:contain; border-radius:12px; background:#000;
  }
  .lightbox .close{
    position:absolute; top:12px; right:12px; background:#000; color:#fff;
    border:1px solid #333; border-radius:10px; padding:8px 10px; cursor:pointer;
  }
</style>
</head>
<body>

<h1>ToadAid Contributor Art</h1>

<div id="contributors" class="grid" aria-live="polite"></div>

<footer>© 2025 ToadAid — Built by the people, for the people.</footer>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Media preview">
  <button class="close" aria-label="Close preview">✕</button>
  <div class="content" id="lightboxContent"></div>
</div>

<script>
const PLACEHOLDER = 'https://via.placeholder.com/1200x800?text=ToadAid';
const grid = document.getElementById('contributors');

/* 观察器：图片/视频进视口淡入；视频进视口播放、离开暂停 */
let revealObserver, videoObserver;
function initObservers(){
  revealObserver = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        e.target.classList.add('reveal');
        revealObserver.unobserve(e.target);
      }
    });
  }, {threshold:.2});

  videoObserver = new IntersectionObserver((entries)=>{
    entries.forEach(entry=>{
      const v = entry.target;
      if(entry.isIntersecting){
        // 确保自动播放
        const p = v.play();
        if(p && typeof p.catch==='function'){ p.catch(()=>{}); }
      }else{
        try{ v.pause(); }catch(e){}
      }
    });
  }, {threshold:.4});
}

async function loadContributors(){
  try{
    const res = await fetch('contributors.json?v='+Date.now());
    let contributors = await res.json();
    contributors.sort((a,b)=> new Date(a.date) - new Date(b.date));

    initObservers();
    contributors.forEach(c => grid.appendChild(renderCard(c)));
  }catch(err){
    console.error('Error loading contributors:', err);
    grid.innerHTML = "<p style='text-align:center;margin:24px 0;'>Failed to load contributor list.</p>";
  }
}

function renderCard(c){
  const card = document.createElement('article');
  card.className = 'card';
  card.setAttribute('aria-label', `${c.title} by ${c.artist}`);

  // 媒体（保留自然比例）
  const media = document.createElement('div');
  media.className = 'media';

  if(c.media_type === 'video'){
    const v = document.createElement('video');
    v.autoplay = true; v.muted = true; v.loop = true; v.playsInline = true;
    v.preload = 'metadata';
    if(c.poster) v.poster = c.poster;
    v.src = c.file;
    v.onerror = ()=>{ v.poster = PLACEHOLDER; };
    v.addEventListener('click', ()=>openLightbox('video', c.file, c.poster || ''));
    media.appendChild(v);

    // 观察：淡入 + 自动播放控制
    revealObserver.observe(v);
    videoObserver.observe(v);
  }else{
    const img = document.createElement('img');
    img.loading = 'lazy';
    img.alt = `${c.title} by ${c.artist}`;
    img.src = c.file;
    img.onerror = ()=>{ img.src = PLACEHOLDER; };
    img.addEventListener('click', ()=>openLightbox('image', c.file, ''));
    media.appendChild(img);

    // 观察：淡入
    revealObserver.observe(img);
  }

  const artistHTML = (() => {
    if((c.artist_type||'').toLowerCase()==='x handle'){
      const clean = (c.artist||'').replace('@','');
      return `<strong>Artist:</strong> <a href="https://x.com/${clean}" target="_blank">@${clean}</a> (${c.artist_type})`;
    }
    return `<strong>Artist:</strong> ${c.artist||'Unknown'}`;
  })();

  const rowHTML = `
    <div class="row">
      <span class="chip">${c.date || ''}</span>
      <span class="spacer"></span>
      <button class="btn" type="button" onclick='shareItem(${JSON.stringify(JSON.stringify({title:c.title, artist:c.artist}))})'>Share</button>
    </div>
  `;

  card.innerHTML = `
    ${media.outerHTML}
    <p class="meta">${artistHTML}</p>
    <p class="title">${c.title || 'Untitled'}</p>
    ${c.description ? `<p class="desc">${c.description}</p>` : ''}
    ${rowHTML}
  `;

  // 由于用了 outerHTML，给新节点重新绑定
  const newMedia = card.querySelector('.media');
  if(c.media_type === 'video'){
    const v2 = newMedia.querySelector('video');
    v2.addEventListener('click', ()=>openLightbox('video', c.file, c.poster || ''));
    revealObserver.observe(v2);
    videoObserver.observe(v2);
  }else{
    const img2 = newMedia.querySelector('img');
    img2.addEventListener('click', ()=>openLightbox('image', c.file, ''));
    revealObserver.observe(img2);
  }

  return card;
}

/* Share / Copy 链接 */
async function shareItem(payloadStr){
  const p = JSON.parse(payloadStr);
  const url = location.href;
  const text = `${p.title} by ${p.artist} — ToadAid Contributor Art`;
  try{
    if(navigator.share){ await navigator.share({title:p.title, text, url}); }
    else { await navigator.clipboard.writeText(url); alert('Link copied to clipboard.'); }
  }catch(e){
    try{ await navigator.clipboard.writeText(url); alert('Link copied to clipboard.'); }catch(_){}
  }
}

/* Lightbox */
const lb = document.getElementById('lightbox');
const lbContent = document.getElementById('lightboxContent');
document.querySelector('#lightbox .close').addEventListener('click', closeLightbox);
lb.addEventListener('click', e => { if(e.target===lb) closeLightbox(); });
document.addEventListener('keydown', e => { if(e.key==='Escape') closeLightbox(); });

function openLightbox(kind, src, poster){
  lbContent.innerHTML = '';
  if(kind==='video'){
    const v = document.createElement('video');
    v.controls = true; v.autoplay = true; v.playsInline = true; v.muted = false;
    if(poster) v.poster = poster;
    v.src = src;
    lbContent.appendChild(v);
  }else{
    const img = document.createElement('img');
    img.src = src; img.alt = 'Preview';
    img.onerror = ()=>{ img.src = PLACEHOLDER; };
    lbContent.appendChild(img);
  }
  lb.classList.add('open');
}
function closeLightbox(){ lb.classList.remove('open'); lbContent.innerHTML = ''; }

loadContributors();
</script>
</body>
</html>
