<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ToadAid Contributors</title>
<meta name="description" content="Explore unique art contributed by Toadgang members worldwide. Every piece is part of the ToadAid legacy.">

<!-- Open Graph -->
<meta property="og:title" content="ToadAid — Contributor Art Vault" />
<meta property="og:description" content="Explore unique art contributed by Toadgang members worldwide. Every piece is part of the ToadAid legacy." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://toadaid.github.io/Contributors/" />
<meta property="og:image" content="https://toadaid.github.io/assets/icons/web-app-manifest-512x512.png" />

<!-- Canonical -->
<link rel="canonical" href="https://toadaid.github.io/Contributors/" />

<!-- Favicons (served from /assets/icons/) -->
<link rel="icon" type="image/x-icon" href="/assets/icons/favicon.ico">
<link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
<link rel="icon" type="image/svg+xml" href="/assets/icons/favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
<link rel="manifest" href="/assets/icons/site.webmanifest">
<meta name="theme-color" content="#355e3b" />
  
<style>
  :root{ --bg:#f5f1e6; --ink:#2f2f2f; --leaf:#355e3b; --gold:#d9b200; --card:#fff; }
  *{ box-sizing:border-box }
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
    text-align:center; padding:20px;
  }
  h1{
    color:var(--leaf); font-size:2rem; position:relative; display:inline-block; padding-bottom:6px; margin:0;
  }
  h1::after{
    content:""; position:absolute; left:0; bottom:0; height:4px; width:100%;
    background:var(--gold); border-radius:2px;
  }

  /* Grid & Card */
  .grid{
    display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap:16px; margin:20px auto 0; max-width:1200px; padding:0 6px;
  }
  .card{
    background:var(--card); border-radius:16px; padding:12px; text-align:left;
    box-shadow:0 8px 24px rgba(0,0,0,.08);
    border-left:6px solid var(--gold);
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .card:hover{ transform:translateY(-3px); box-shadow:0 10px 28px rgba(0,0,0,.12) }

  /* Media：保留原比例，不强裁切；加最大高度保护与淡入 */
  .media{
    width:100%; background:#eee; border-radius:12px; overflow:hidden; border:1px solid #eee;
  }
  .media img, .media video{
    display:block; width:100%; height:auto;
    max-height:80vh;
    transition:opacity .35s ease;
    opacity:0;
  }
  .reveal{ opacity:1 !important }

  .meta{ margin:10px 0 4px; color:#425a47; font-size:.95rem }
  .title{ margin:0 0 6px; font-weight:700 }
  .desc{ margin:6px 0 10px; line-height:1.45 }
  .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
  .chip{ font-size:.8rem; background:#f0ead4; border:1px solid #e2d9b3; border-radius:999px; padding:4px 8px }
  .spacer{ flex:1 }
  .btn{ border:1px solid #d9d9d9; background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer; }
  .btn:hover{ background:#f7f7f7 }
  a{ color:var(--leaf); text-decoration:none }
  a:hover{ text-decoration:underline }
  footer{ margin-top:46px; color:var(--leaf); font-size:.9rem }

  /* Lightbox */
  .lightbox{
    position:fixed; inset:0; background:rgba(0,0,0,.8);
    display:none; align-items:center; justify-content:center; z-index:50; padding:16px;
  }
  .lightbox.open{ display:flex }
  .lightbox .content > img, .lightbox .content > video{
    max-width:min(96vw,1200px); max-height:90vh; object-fit:contain; border-radius:12px; background:#000;
  }
  .lightbox .close{
    position:absolute; top:12px; right:12px; background:#000; color:#fff;
    border:1px solid #333; border-radius:10px; padding:8px 10px; cursor:pointer;
  }

  /* Respect users who prefer reduced motion */
  @media (prefers-reduced-motion: reduce) {
    * { animation: none !important; transition: none !important; }
    .media img, .media video { opacity:1 !important; }
  }
</style>
</head>
<body>

<h1>ToadAid Contributor Art</h1>

<div id="contributors" class="grid" aria-live="polite"></div>

<footer>© 2025 ToadAid — Built by the people, for the people.</footer>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Media preview">
  <button class="close" aria-label="Close preview">✕</button>
  <div class="content" id="lightboxContent"></div>
</div>

<script>
/* ========= constants & helpers ========= */
const ROOT = '/'; // ensure JSON "assets/..." resolves from site root
const PLACEHOLDER = 'https://via.placeholder.com/1200x800?text=ToadAid';
const grid = document.getElementById('contributors');
const REDUCE_MOTION = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

function fileURL(path=''){
  if(!path) return '';
  return path.startsWith('/') ? path : ROOT + path.replace(/^\.?\//,'');
}
function escapeHTML(str=''){
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}
function fmtDate(iso){
  if(!iso) return '';
  try{
    const d = new Date(iso);
    return isNaN(d) ? iso : d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' });
  }catch{ return iso; }
}

/* ============ 深链工具（slug + URL 构造） ============ */
function getSlug(c){
  const base = (c.file||'').split('/').pop().replace(/\.[^/.]+$/, '');
  const raw  = (c.title ? `${c.title}-${base}` : base) || 'item';
  return raw.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
}
function buildItemUrl(slug){
  const u = new URL(location.href);
  u.searchParams.set('item', slug);
  return u.toString();
}

/* ============ 媒体淡入 & 自动播放观察器 ============ */
let revealObserver, ioPlay;
function initObservers(){
  // 媒体淡入
  revealObserver = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(e.isIntersecting){
        e.target.classList.add('reveal');
        revealObserver.unobserve(e.target);
      }
    });
  }, {threshold:.2});

  // 进入视口播放/离开暂停（仅视频）
  ioPlay = new IntersectionObserver((entries)=>{
    entries.forEach(entry=>{
      const v = entry.target;
      if(entry.isIntersecting){
        ensureAutoplay(v);
      }else{
        try{ v.pause(); }catch(_){}
      }
    });
  }, {threshold:.4});
}

/* ============ 加载 & 渲染 ============ */
async function loadContributors(){
  try{
    // bump this version string when JSON changes to refresh cache
    const res = await fetch('./contributors.json?v=2025-10-04');
    let contributors = await res.json();

    // newest first
    contributors.sort((a,b)=> new Date(b.date) - new Date(a.date));

    initObservers();
    contributors.forEach(c => grid.appendChild(renderCard(c)));

    // 首次交互兜底（极少数机型需要手势）
    window.addEventListener('pointerdown', kickAllVideosOnce, { once:true });
    document.addEventListener('visibilitychange', ()=> {
      if (document.visibilityState === 'visible') {
        document.querySelectorAll('video.ta-auto').forEach(v => ensureAutoplay(v));
      } else {
        document.querySelectorAll('video.ta-auto').forEach(v => { try{ v.pause(); }catch(_){} });
      }
    });

    // 渲染完成后处理 ?item=slug
    openItemFromQuery();
    // 前进/后退时也处理
    window.addEventListener('popstate', openItemFromQuery);
  }catch(err){
    console.error('Error loading contributors:', err);
    grid.innerHTML = "<p style='text-align:center;margin:24px 0;'>Failed to load contributor list.</p>";
  }
}

function renderCard(c){
  const slug = getSlug(c);
  const src   = fileURL(c.file);
  const poster= c.poster ? fileURL(c.poster) : '';

  const card = document.createElement('article');
  card.className = 'card';
  card.id = 'art-' + slug;
  card.setAttribute('aria-label', `${c.title||'Untitled'} by ${c.artist||'Unknown'}`);

  // 媒体（保留原始比例）
  const mediaWrap = document.createElement('div');
  mediaWrap.className = 'media';

  if((c.media_type||'image').toLowerCase()==='video'){
    const v = document.createElement('video');
    v.className = 'ta-auto';
    // 自动播放关键：muted + playsinline
    v.autoplay = !REDUCE_MOTION; // respect reduced motion
    v.muted = true; v.playsInline = true; v.loop = true;
    v.setAttribute('muted',''); v.setAttribute('playsinline','');
    v.preload = REDUCE_MOTION ? 'none' : 'metadata';
    if(poster) v.poster = poster;
    v.src = src;
    v.onerror = ()=>{ v.poster = PLACEHOLDER; };
    v.addEventListener('click', ()=>{
      history.pushState(null, '', buildItemUrl(slug));
      openLightbox('video', src, poster);
    });
    mediaWrap.appendChild(v);

    // 观察：淡入 + 视口内播放
    revealObserver.observe(v);
    ioPlay.observe(v);
    if(!REDUCE_MOTION){
      v.addEventListener('loadedmetadata', ()=>ensureAutoplay(v), { once:true });
      v.addEventListener('canplay', ()=>ensureAutoplay(v));
    }
  }else{
    const img = document.createElement('img');
    img.loading = 'lazy';
    img.alt = `${c.title||'Untitled'} by ${c.artist||'Unknown'}`;
    img.src = src;
    img.onerror = ()=>{ img.src = PLACEHOLDER; };
    img.addEventListener('click', ()=>{
      history.pushState(null, '', buildItemUrl(slug));
      openLightbox('image', src, '');
    });
    mediaWrap.appendChild(img);
    revealObserver.observe(img);
  }

  // 文案（安全渲染）
  const meta = document.createElement('p');
  meta.className = 'meta';
  const artist = c.artist || 'Unknown';
  const atype = c.artist_type || '';
  const xHandle = artist.startsWith('@') ? artist.slice(1) : null;
  meta.innerHTML = xHandle
    ? `<strong>Artist:</strong> <a href="https://x.com/${encodeURIComponent(xHandle)}" target="_blank" rel="noopener noreferrer">@${escapeHTML(xHandle)}</a>${atype ? ' ('+escapeHTML(atype)+')' : ''}`
    : `<strong>Artist:</strong> ${escapeHTML(artist)}${atype ? ' ('+escapeHTML(atype)+')' : ''}`;

  const title = document.createElement('p');
  title.className = 'title';
  title.textContent = c.title || 'Untitled';

  const desc = document.createElement('p');
  desc.className = 'desc';
  if (c.description) desc.textContent = c.description;

  // 行尾：日期 + 分享按钮
  const row = document.createElement('div');
  row.className = 'row';
  const chip = document.createElement('span');
  chip.className = 'chip';
  chip.textContent = fmtDate(c.date || '');
  const spacer = document.createElement('span'); spacer.className = 'spacer';
  const btn = document.createElement('button');
  btn.className = 'btn'; btn.type = 'button'; btn.textContent = 'Share';
  btn.addEventListener('click', ()=> shareItem(slug));

  row.append(chip, spacer, btn);

  // 组装
  card.appendChild(mediaWrap);
  card.appendChild(meta);
  card.appendChild(title);
  if (c.description) card.appendChild(desc);
  card.appendChild(row);

  return card;
}

/* ============ 深链：从 ?item=slug 定位并开灯箱 ============ */
function openItemFromQuery(){
  const slug = new URLSearchParams(location.search).get('item');
  if(!slug) return;
  const el = document.getElementById('art-' + slug);
  if(!el) return;
  el.scrollIntoView({ behavior:'smooth', block:'center' });
  const media = el.querySelector('img,video');
  if(media){
    setTimeout(()=> media.click(), 250); // 等滚动停一下
  }
}

/* ============ 自动播放兜底（尊重 reduced motion） ============ */
function ensureAutoplay(v){
  if (!v || REDUCE_MOTION) return;
  v.muted = true; v.setAttribute('muted',''); v.playsInline = true; v.setAttribute('playsinline','');
  const tryPlay = () => {
    const p = v.play();
    if (p && typeof p.catch === 'function') p.catch(()=>{});
  };
  tryPlay(); setTimeout(tryPlay, 150); setTimeout(tryPlay, 400);
}
function kickAllVideosOnce(){
  if (REDUCE_MOTION) return;
  document.querySelectorAll('video.ta-auto').forEach(v => ensureAutoplay(v));
}

/* ============ Share：带 item 深链（URL only） ============ */
async function shareItem(slug){
  const url = buildItemUrl(slug);
  try{
    if (navigator.share) {
      await navigator.share({ url });
    } else {
      await navigator.clipboard.writeText(url);
      alert('Link copied to clipboard.');
    }
  }catch(e){
    try{
      await navigator.clipboard.writeText(url);
      alert('Link copied to clipboard.');
    }catch(_){}
  }
}

/* ============ Lightbox ============ */
const lb = document.getElementById('lightbox');
const lbContent = document.getElementById('lightboxContent');
document.querySelector('#lightbox .close').addEventListener('click', closeLightbox);
lb.addEventListener('click', e => { if(e.target===lb) closeLightbox(); });
document.addEventListener('keydown', e => { if(e.key==='Escape') closeLightbox(); });

function openLightbox(kind, src, poster){
  lbContent.innerHTML = '';
  if(kind==='video'){
    const v = document.createElement('video');
    v.controls = true; v.autoplay = !REDUCE_MOTION; v.playsInline = true; v.muted = false;
    if(poster) v.poster = poster;
    v.src = src;
    lbContent.appendChild(v);
  }else{
    const img = document.createElement('img');
    img.src = src; img.alt = 'Preview';
    img.onerror = ()=>{ img.src = PLACEHOLDER; };
    lbContent.appendChild(img);
  }
  lb.classList.add('open');
}
function closeLightbox(){ lb.classList.remove('open'); lbContent.innerHTML = ''; }

/* 启动 */
loadContributors();
</script>
</body>
</html>
