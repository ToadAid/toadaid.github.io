<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ToadAid ‚Äî Agent Directory (ERC-8004) | Toadgang Registry</title>
  <style>
    :root{
      --bg:#0b1020; --text:#e8eeff; --muted:#9bb0ff; --line:rgba(255,255,255,.08);
      --accent:#4aa3ff; --accent2:#67f3c4; --warn:#ffcc66; --bad:#ff6b6b; --good:#5cff95;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(74,163,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 80% 20%, rgba(103,243,196,.12), transparent 60%),
                  radial-gradient(800px 600px at 50% 90%, rgba(155,176,255,.10), transparent 55%),
                  var(--bg);
    }
    header{
      padding:28px 18px 14px;
      max-width:1400px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, rgba(74,163,255,.9), rgba(103,243,196,.9));
      box-shadow: var(--shadow); position:relative;
    }
    .logo:after{
      content:"üìã"; position:absolute; inset:0;
      display:grid; place-items:center;
      font-size:18px; filter: drop-shadow(0 4px 10px rgba(0,0,0,.35));
    }
    h1{ font-size:18px; margin:0; letter-spacing:.2px}
    .sub{ font-size:12.5px; color:var(--muted); margin-top:3px}
    .top-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{
      border:1px solid var(--line); background: rgba(255,255,255,.06);
      color:var(--text); padding:10px 12px; border-radius:12px;
      cursor:pointer; transition:.15s ease; font-weight:600;
    }
    button:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09) }
    button.primary{
      background: linear-gradient(135deg, rgba(74,163,255,.95), rgba(103,243,196,.85));
      color:#041024; border:0;
    }
    button.primary:hover{ filter:brightness(1.05) }
    .pill{
      font-family:var(--mono); font-size:12px; padding:8px 10px;
      border:1px solid var(--line); border-radius:999px;
      color:var(--muted); background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .nav-links{
      display:flex; gap:8px; margin-left:auto;
    }
    .nav-link{
      padding:8px 16px; border-radius:20px;
      background:rgba(255,255,255,.05); border:1px solid var(--line);
      color:var(--text); text-decoration:none; font-size:14px;
    }
    .nav-link.active{
      background:linear-gradient(135deg, rgba(74,163,255,.2), rgba(103,243,196,.2));
      border-color:var(--accent2);
    }
    .nav-link:hover{
      background:rgba(255,255,255,.1);
    }
    main{
      max-width:1400px; margin:0 auto;
      padding: 0 18px 40px;
    }
    .stats-bar{
      display:grid; grid-template-columns: repeat(4, 1fr);
      gap:16px; margin-bottom:24px;
    }
    .stat-card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:18px;
      padding:16px; text-align:center;
    }
    .stat-number{
      font-size:32px; font-weight:800;
      background:linear-gradient(135deg, #fff, var(--accent2));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      line-height:1.2;
    }
    .stat-label{
      font-size:12px; color:var(--muted);
      text-transform:uppercase; letter-spacing:1px;
    }
    .filter-bar{
      background: rgba(0,0,0,.22); border:1px solid var(--line);
      border-radius:18px; padding:16px; margin-bottom:24px;
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
    }
    .filter-input{
      flex:1; min-width:200px;
      background: rgba(0,0,0,.3); border:1px solid var(--line);
      border-radius:40px; padding:10px 16px;
      color:var(--text); font-family:var(--mono); font-size:13px;
    }
    .filter-select{
      background: rgba(0,0,0,.3); border:1px solid var(--line);
      border-radius:40px; padding:10px 16px;
      color:var(--text); font-family:var(--mono); font-size:13px;
      min-width:150px;
    }
    .agents-grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap:20px; margin-bottom:30px;
    }
    
    .agent-card {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: 18px;
      overflow: hidden;
      transition: all 0.2s ease;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    
    .agent-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent2);
      box-shadow: 0 10px 30px rgba(103,243,196,.15);
    }
    
    .agent-card-image-container {
      width: 100%;
      height: 200px;
      background: rgba(0,0,0,.3);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-bottom: 1px solid var(--line);
    }
    
    .agent-card-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .agent-card:hover .agent-card-image {
      transform: scale(1.05);
    }
    
    .agent-card-image-placeholder {
      font-size: 60px;
      opacity: 0.7;
    }
    
    .agent-card-content {
      padding: 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .agent-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .agent-card-id {
      font-family: var(--mono);
      font-size: 12px;
      background: rgba(74,163,255,.2);
      padding: 4px 8px;
      border-radius: 20px;
      color: var(--accent);
    }
    
    .agent-card-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 20px;
      background: rgba(103,243,196,.15);
      color: var(--accent2);
    }
    
    .agent-card-name {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #fff, var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1.3;
    }
    
    .agent-card-creator {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
      word-break: break-all;
    }
    
    .agent-card-footer {
      margin-top: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 8px;
    }
    
    .agent-card-tag {
      background: rgba(103,243,196,.15);
      color: var(--accent2);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
    }
    
    .agent-card-link {
      color: var(--accent2);
      text-decoration: none;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .agent-id{
      font-family:var(--mono); font-size:12px;
      background:rgba(74,163,255,.2); padding:4px 8px;
      border-radius:20px; color:var(--accent);
    }
    .agent-badge{
      font-size:11px; padding:4px 8px; border-radius:20px;
      background:rgba(103,243,196,.15); color:var(--accent2);
    }
    .toadgang-tag{
      background:rgba(103,243,196,.15);
      color:var(--accent2); padding:2px 8px;
      border-radius:12px; font-size:10px;
      margin-left:8px;
    }
    
    .pagination{
      display:flex; gap:8px; justify-content:center; margin-top:30px;
    }
    .page-btn{
      width:40px; height:40px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.05); border:1px solid var(--line);
      cursor:pointer;
    }
    .page-btn.active{
      background:linear-gradient(135deg, rgba(74,163,255,.2), rgba(103,243,196,.2));
      border-color:var(--accent2);
    }
    .page-btn.disabled{
      opacity:0.3; cursor:not-allowed;
    }
    .loading-spinner{
      text-align:center; padding:60px;
      color:var(--muted);
    }
    .loading-spinner .emoji{
      font-size:48px; margin-bottom:16px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .empty-state{
      text-align:center; padding:60px 20px;
      background:rgba(0,0,0,.18); border-radius:18px;
      border:1px dashed var(--line);
      color:var(--muted);
    }
    .empty-state .emoji{
      font-size:48px; margin-bottom:16px;
      opacity:0.5;
    }
    .error-message{
      background:rgba(255,107,107,.1);
      border:1px solid var(--bad);
      border-radius:12px;
      padding:16px;
      margin:20px 0;
      text-align:center;
      color:var(--bad);
    }
    .success-message{
      background:rgba(103,243,196,.1);
      border:1px solid var(--good);
      border-radius:12px;
      padding:16px;
      margin:20px 0;
      text-align:center;
      color:var(--good);
    }
    footer{
      max-width:1400px; margin:0 auto;
      padding: 0 18px 30px;
      color: var(--muted); font-size: 12px;
      border-top:1px solid var(--line); padding-top:20px;
      margin-top:20px;
    }
    
    .detail-container {
      background: rgba(0,0,0,.22);
      border-radius: 24px;
      padding: 24px;
      margin-top: 20px;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 24px;
    }
    @media (max-width: 768px) {
      .detail-grid {
        grid-template-columns: 1fr;
      }
    }
    .detail-image {
      background: rgba(0,0,0,.3);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
    }
    .detail-image img {
      max-width: 100%;
      border-radius: 16px;
    }
    .detail-image-placeholder {
      font-size: 120px;
    }
    .detail-info {
      padding: 20px;
    }
    .detail-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .detail-id {
      font-family: var(--mono);
      font-size: 16px;
      background: rgba(74,163,255,.2);
      padding: 6px 12px;
      border-radius: 30px;
      color: var(--accent);
    }
    .detail-name {
      font-size: 36px;
      font-weight: 800;
      margin: 0 0 16px;
      background: linear-gradient(135deg, #fff, var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .detail-creator {
      font-family: var(--mono);
      color: var(--muted);
      margin-bottom: 20px;
      word-break: break-all;
    }
    .detail-description {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 24px;
    }
    .attributes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }
    .attribute-item {
      background: rgba(0,0,0,.3);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    .attribute-trait {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
    }
    .attribute-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent2);
    }
    
    .attribute-item { min-width: 0; }
    .attribute-value{
      overflow-wrap: anywhere;
      word-break: break-word;
      line-height: 1.15;
      font-size: 12.5px;
    }
    .detail-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .detail-uri {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      word-break: break-all;
      margin-top: 16px;
    }
  
    html, body { width: 100%; overflow-x: hidden; }
    body { -webkit-text-size-adjust: 100%; touch-action: pan-y; }

    .badge-container {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      margin: 4px 0;
    }
    
    .badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 10px;
      background: rgba(74,163,255,.15);
      border: 1px solid var(--accent);
      color: var(--accent);
    }
    
    .badge.legendary {
      background: rgba(255,215,0,.15);
      border-color: gold;
      color: gold;
    }
    
    .badge.verified {
      background: rgba(103,243,196,.15);
      border-color: var(--good);
      color: var(--good);
    }
    
    .badge.registry {
      background: rgba(74,163,255,.15);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .share-link {
      font-size: 11px;
      color: var(--accent2);
      cursor: pointer;
      margin-left: 8px;
    }
    
    .share-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 560px){
      header{
        flex-direction: column;
        align-items: flex-start;
      }
      .top-actions{
        width: 100%;
        justify-content: flex-start;
      }
      .pill{
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      button.smallbtn, button.primary.smallbtn{
        width: 100%;
      }
      .agents-grid{
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 560px){
      .attributes-grid{ grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
    }

  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1 id="pageTitle">ToadAid Agent Directory ‚Äî Toadgang Registry</h1>
      <div class="sub" id="pageSubtitle">ERC‚Äë8004 Agents on Base ¬∑ Public, read‚Äëonly index ¬∑ No wallet required ü™ûüåäüçÉ</div>
    </div>
  </div>

  <div class="top-actions">
    <span class="pill" id="netPill">Network: Base (8453)</span>
    <span class="pill" id="modePill">Mode: Read‚Äëonly</span>
  </div>
</header>

<main>
  <div class="nav-links" style="margin-bottom:24px;">
    <a href="/" class="nav-link">üè† Home</a>
    <a href="/forge/" class="nav-link">üî® Forge</a>
    <a href="/agent/" class="nav-link active" id="directoryLink">üìã Directory</a>
    <a href="/agent/legendary/" class="nav-link" style="border-color: gold; color: gold;">üëë Legends</a>
    <a href="#" class="nav-link" id="statsLink">üìä Stats</a>
  </div>

  <div style="background: linear-gradient(90deg, rgba(255,215,0,.1), rgba(74,163,255,.1)); border: 1px solid gold; border-radius: 18px; padding: 16px; margin-bottom: 24px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
    <div style="display: flex; align-items: center; gap: 12px;">
      <span style="font-size: 32px;">üëë</span>
      <div>
        <div style="font-weight: 800; color: gold;">The Legends</div>
        <div class="sub">Agent 0 & 1 ‚Äî The OGs that started it all</div>
      </div>
    </div>
    <a href="/agent/legendary/" class="nav-link" style="border-color: gold; color: gold;">View Legends ‚Üí</a>
  </div>

  <div class="stats-bar" id="statsBar">
    <div class="stat-card">
      <div class="stat-number" id="totalAgents">‚Äî</div>
      <div class="stat-label">Total Agents</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="toadAgents">‚Äî</div>
      <div class="stat-label">Toadgang Agents</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="activeAgents">‚Äî</div>
      <div class="stat-label">Active</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="lastUpdate">‚Äî</div>
      <div class="stat-label">Last Update</div>
    </div>
  </div>

  <div class="filter-bar" id="filterBar">
    <input type="text" class="filter-input" id="searchInput" placeholder="üîç Search by ID, address, tx hash, or IPFS URI...">
    <select class="filter-select" id="creatorFilter">
      <option value="all">All Creators</option>
      <option value="toadgang">üê∏ Toadgang Only</option>
    </select>
    <select class="filter-select" id="statusFilter">
      <option value="all">All Status</option>
      <option value="true">Active Only</option>
      <option value="false">Inactive</option>
    </select>
    <select class="filter-select" id="sortFilter">
      <option value="newest">‚ú® Newest</option>
      <option value="oldest">üìÖ Oldest</option>
      <option value="id"># ID</option>
    </select>
    <select class="filter-select" id="metadataFilter">
      <option value="all">All Agents</option>
      <option value="has">‚úÖ Has Metadata</option>
      <option value="missing">‚ùå Missing Metadata</option>
    </select>
    <button class="primary" id="refreshBtn">üîÑ Refresh</button>
  </div>

  <div id="statusMessage" class="success-message" style="display:none;"></div>
  <div id="errorDisplay" class="error-message" style="display:none;"></div>

  <div id="agentsContainer">
    <div class="loading-spinner" id="loadingSpinner">
      <div class="emoji">ü™û</div>
      <div id="loadingMessage">Fetching real agents from Blockscout...</div>
      <div style="font-size:11px; margin-top:12px;">No API key needed - free and fast!</div>
    </div>
    <div class="agents-grid" id="agentsGrid" style="display:none;"></div>
    <div class="empty-state" id="emptyState" style="display:none;">
      <div class="emoji">ü™û</div>
      <div style="font-size:18px; margin-bottom:8px;">No agents found</div>
      <div class="sub">Be the first to <a href="/forge/" style="color:var(--accent2)">forge an agent</a>!</div>
    </div>
  </div>

  <div class="pagination" id="pagination" style="display:none;">
    <div class="page-btn" id="prevPage">‚Üê</div>
    <div class="page-btn active" id="page1">1</div>
    <div class="page-btn" id="page2">2</div>
    <div class="page-btn" id="page3">3</div>
    <div class="page-btn" id="nextPage">‚Üí</div>
  </div>
</main>

<footer id="mainFooter">
  <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
    <div>ü™û ToadAid ¬∑ Agent Explorer ¬∑ Real data from Blockscout</div>
    <div>
      <a href="/forge/" style="color:var(--muted); margin-right:16px;">Forge</a>
      <a href="https://basescan.org/address/0x17163e5380929b04D4cC24f82aa6AC30877Bd0e0" target="_blank" style="color:var(--muted); margin-right:16px;">Contract</a>
      <a href="https://github.com/toadaid" target="_blank" style="color:var(--muted);">GitHub</a>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
<script type="module">
  const BASE_ID = 8453;
  
  const REGISTRY_ROUTER = "0x17163e5380929b04D4cC24f82aa6AC30877Bd0e0";
  const REGISTRY_PROXY = "0x8004A169FB4a3325136EB29fA0ceB6D2e539a432";
  const TOAD_ADDRESS = "0x587464fd25af9147cb4660b03d899c8893378c0a";
  

  const RPC_URL = "https://mainnet.base.org";
  // Source of truth for metadata: read tokenURI from the ERC-8004 Registry (proxy).
  const ERC721_ABI = [
    "function tokenURI(uint256 tokenId) view returns (string)",
    "function ownerOf(uint256 tokenId) view returns (address)"
  ];
  const provider = new ethers.JsonRpcProvider(RPC_URL);
  const registry = new ethers.Contract(REGISTRY_PROXY, ERC721_ABI, provider);

  // Small concurrency limiter to avoid hammering the public RPC.
  async function pMapLimit(items, limit, mapper) {
    const ret = new Array(items.length);
    let i = 0;
    const workers = Array.from({ length: Math.min(limit, items.length) }, async () => {
      while (true) {
        const idx = i++;
        if (idx >= items.length) return;
        ret[idx] = await mapper(items[idx], idx);
      }
    });
    await Promise.all(workers);
    return ret;
  }

  async function fetchTokenURI(tokenId) {
    try {
      const uri = await registry.tokenURI(tokenId);
      return (typeof uri === "string" && uri.length) ? uri : null;
    } catch (e) {
      return null;
    }
  }
  const FORGED_EVENT_SIG = "0x32fd3812eeed46543cb7aaca82d2d133bd341f9cda13bba567150c44bda2dc81";
  const BLOCKSCOUT_URL = `https://base.blockscout.com/api?module=logs&action=getLogs&fromBlock=0&toBlock=latest&address=${REGISTRY_ROUTER}&topic0=${FORGED_EVENT_SIG}`;
  
  const $ = (id) => document.getElementById(id);
  
  const params = new URLSearchParams(window.location.search);
  const qId = params.get("id");

  const path = window.location.pathname;
  const pathParts = path.split("/").filter(Boolean);
  const lastPart = pathParts[pathParts.length - 1];

  const parsedQueryId = qId && /^\d+$/.test(qId) ? parseInt(qId, 10) : null;
  const parsedPathId = lastPart && /^\d+$/.test(lastPart) && path.includes("/agent/") ? parseInt(lastPart, 10) : null;

  const agentId = parsedQueryId ?? parsedPathId;
  const isDetailView = Number.isInteger(agentId);

  console.log("URL path:", path, "Query id:", qId, "Agent ID:", agentId);

  let allAgents = [];
  let filteredAgents = [];
  let currentPage = 1;
  const pageSize = 12;
  
  const IPFS_GATEWAYS = [
    "https://ipfs.io/ipfs/",
    "https://cloudflare-ipfs.com/ipfs/",
    "https://gateway.pinata.cloud/ipfs/"
  ];
  
  function safeBase64Decode(base64) {
    try {
      const binaryString = atob(base64);
      
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      
      return new TextDecoder().decode(bytes);
    } catch (e) {
      console.warn("Base64 decode failed:", e);
      return null;
    }
  }
  
  function formatTimeAgo(timestamp) {
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return `${seconds}s ago`;
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
  }
  
  function shortAddr(addr) {
    return addr ? addr.slice(0,6) + "‚Ä¶" + addr.slice(-4) : "";
  }
  
  function hexToString(hex) {
    try {
      if (!hex || hex === '0x') return '';
      const hexStr = hex.startsWith('0x') ? hex.slice(2) : hex;
      const bytes = [];
      for (let i = 0; i < hexStr.length; i += 2) {
        const code = parseInt(hexStr.substr(i, 2), 16);
        if (code !== 0) bytes.push(code);
      }
      return new TextDecoder().decode(new Uint8Array(bytes));
    } catch (e) {
      return '';
    }
  }
  
  function extractUriFromLogData(dataHex, agentId) {
    try {
      if (!dataHex || dataHex === '0x') return null;
      
      const hex = dataHex.startsWith('0x') ? dataHex.slice(2) : dataHex;
      
      for (let i = 0; i < hex.length - 20; i++) {
        if (hex.substr(i, 14).toLowerCase() === '697066733a2f2f') {
          let uriHex = '';
          let j = i;
          while (j < hex.length && hex.substr(j, 2) !== '00') {
            uriHex += hex.substr(j, 2);
            j += 2;
          }
          const uri = hexToString(uriHex);
          if (uri.startsWith('ipfs://')) return uri;
        }
        
        if (hex.substr(i, 40).toLowerCase().includes('646174613a6170706c69636174696f6e2f6a736f6e3b6261736536342c')) {
          let uriHex = '';
          let j = i;
          while (j < hex.length && hex.substr(j, 2) !== '00') {
            uriHex += hex.substr(j, 2);
            j += 2;
          }
          const uri = hexToString(uriHex);
          if (uri.startsWith('data:application/json;base64,')) return uri;
        }
      }
      
      const tail = hex.slice(-400);
      let str = '';
      for (let i = 0; i < tail.length; i += 2) {
        const code = parseInt(tail.substr(i, 2), 16);
        if (code >= 32 && code <= 126) str += String.fromCharCode(code);
      }
      const match = str.match(/(ipfs:\/\/[^\s"'<>]+|data:application\/json;base64,[A-Za-z0-9+/=]+)/);
      return match ? match[1] : null;
      
    } catch (e) {
      console.warn("Error extracting URI from log data:", e);
      return null;
    }
  }
  
  function parseBase64Metadata(base64Data) {
    try {
      const decoded = safeBase64Decode(base64Data);
      if (!decoded) return null;
      return JSON.parse(decoded);
    } catch (e) {
      console.warn("Failed to parse base64 metadata:", e);
      return null;
    }
  }
  
  async function getImageUrl(agent) {
    if (agent.imageUrl) return agent.imageUrl;
    if (agent.image && agent.image.startsWith('http')) return agent.image;
    if (agent.image && agent.image.startsWith('ipfs://')) {
      const hash = agent.image.replace('ipfs://', '');
      return IPFS_GATEWAYS[0] + hash;
    }
    return null;
  }
  
  async function fetchFromIPFS(ipfsHash) {
    for (const gateway of IPFS_GATEWAYS) {
      try {
        const response = await fetch(gateway + ipfsHash);
        if (response.ok) return await response.json();
      } catch (e) {
        console.warn(`Gateway ${gateway} failed:`, e);
      }
    }
    return null;
  }
  
  function smartSearch(input) {
    const trimmed = input.trim();
    
    if (/^\d+$/.test(trimmed)) {
      window.location.href = `/agent/?id=${trimmed}`;
      return true;
    }
    
    if (/^0x[a-fA-F0-9]{40}$/.test(trimmed)) {
      filterByCreator(trimmed);
      return true;
    }
    
    if (/^0x[a-fA-F0-9]{64}$/.test(trimmed)) {
      window.open(`https://basescan.org/tx/${trimmed}`, '_blank');
      return true;
    }
    
    if (trimmed.startsWith('ipfs://') || trimmed.startsWith('Qm') || trimmed.startsWith('bafy')) {
      $("statusMessage").style.display = "block";
      $("statusMessage").innerHTML = `üîç Searching for agents with URI containing ${trimmed.slice(0,20)}...`;
      // Filter by URI in metadata
      filterByUri(trimmed);
      return true;
    }
    
    return false;
  }
  
  function filterByCreator(address) {
    $("creatorFilter").value = "all";
    $("searchInput").value = "";
    const lowerAddr = address.toLowerCase();
    filteredAgents = allAgents.filter(a => a.creator.toLowerCase() === lowerAddr);
    currentPage = 1;
    renderAgents();
    $("statusMessage").style.display = "block";
    $("statusMessage").innerHTML = `‚úÖ Showing ${filteredAgents.length} agents created by ${shortAddr(address)}`;
  }
  
  function filterByUri(uri) {
    const searchTerm = uri.toLowerCase();
    filteredAgents = allAgents.filter(a => 
      (a.uri && a.uri.toLowerCase().includes(searchTerm)) ||
      (a.name && a.name.toLowerCase().includes(searchTerm))
    );
    currentPage = 1;
    renderAgents();
    $("statusMessage").style.display = "block";
    $("statusMessage").innerHTML = `‚úÖ Found ${filteredAgents.length} agents matching "${uri.slice(0,20)}..."`;
  }
  
  async function copyShareLink(agentId) {
    const url = `${window.location.origin}/agent/?id=${agentId}`;
    await navigator.clipboard.writeText(url);
    $("statusMessage").style.display = "block";
    $("statusMessage").innerHTML = `‚úÖ Link copied to clipboard!`;
    setTimeout(() => {
      $("statusMessage").style.display = "none";
    }, 3000);
  }
  
  async function loadSingleAgent(id) {
    try {
      $("loadingSpinner").style.display = "block";
      $("agentsGrid").style.display = "none";
      $("errorDisplay").style.display = "none";
      $("statsBar").style.display = "none";
      $("filterBar").style.display = "none";
      $("pagination").style.display = "none";
      $("pageTitle").textContent = `Agent #${id} ‚Äî ToadAid Registry`;
      $("pageSubtitle").textContent = "ERC‚Äë8004 Agent Details ¬∑ Real data from IPFS ü™û";
      $("loadingMessage").textContent = `Loading agent #${id} from blockchain and IPFS...`;
      
      const response = await fetch(BLOCKSCOUT_URL);
      const data = await response.json();
      
      let creator = null;
      let timestamp = null;
      let txHash = null;
      let uri = null;
      let uriSource = null;
      
      if (data.status === "1" && data.result) {
        const log = data.result.find(l => parseInt(l.topics[2], 16) === id);
        
        if (log) {
          creator = '0x' + log.topics[1].slice(26);
          timestamp = parseInt(log.timeStamp) * 1000;
          txHash = log.transactionHash;
          
          if (log.data && log.data !== "0x") {
            const extractedUri = extractUriFromLogData(log.data, id);
            if (extractedUri) {
              uri = extractedUri;
              uriSource = "FORGED_EVENT_LOG";
              console.log("Agent URI extracted from log:", uri);
            }
          }

          // Prefer the latest on-chain tokenURI (supports updates).
          const onchainUri = await fetchTokenURI(id);
          if (onchainUri) {
            uri = onchainUri;
            uriSource = "TOKENURI_CALL";
            console.log("Agent tokenURI() from chain:", uri);
          }
        } else {
          throw new Error(`Agent #${id} not found on chain`);
        }
      } else {
        throw new Error("Could not fetch agent data from Blockscout");
      }
      
      let metadata = {
        name: `Agent #${id}`,
        description: "No description available",
        image: "ü™û",
        attributes: []
      };
      
      if (uri) {
        if (uri.startsWith('ipfs://')) {
          const ipfsHash = uri.replace('ipfs://', '');
          const ipfsData = await fetchFromIPFS(ipfsHash);
          if (ipfsData) {
            metadata = { ...metadata, ...ipfsData };
          }
        } else if (uri.startsWith('data:application/json;base64,')) {
          const base64Data = uri.replace('data:application/json;base64,', '');
          const parsed = parseBase64Metadata(base64Data);
          if (parsed) {
            metadata = { ...metadata, ...parsed };
          }
        }
      }
      
      const isToadgang = creator && creator.toLowerCase() === TOAD_ADDRESS.toLowerCase();
      
      let imageHtml = '<div class="detail-image-placeholder">ü™û</div>';
      if (metadata.image) {
        if (metadata.image.startsWith('http')) {
          imageHtml = `<img src="${metadata.image}" alt="${metadata.name}" />`;
        } else if (metadata.image.startsWith('ipfs://')) {
          const ipfsHash = metadata.image.replace('ipfs://', '');
          imageHtml = `<img src="https://ipfs.io/ipfs/${ipfsHash}" alt="${metadata.name}" />`;
        }
      }
      
      let attributesHtml = '';
      if (metadata.attributes && metadata.attributes.length > 0) {
        attributesHtml = metadata.attributes.map(attr => `
          <div class="attribute-item">
            <div class="attribute-trait">${attr.trait_type || 'Attribute'}</div>
            <div class="attribute-value">${attr.value}</div>
          </div>
        `).join('');
      }
      
      $("agentsGrid").innerHTML = `
        <div style="grid-column: span 12;">
          <div class="detail-container">
            <div class="detail-grid">
              <div class="detail-image">
                ${imageHtml}
              </div>
              <div class="detail-info">
                <div class="detail-header">
                  <span class="detail-id">#${id}</span>
                  ${isToadgang ? '<span class="toadgang-tag" style="font-size:14px;">üê∏ TOADGANG</span>' : ''}
                </div>
                <h1 class="detail-name">${metadata.name}</h1>
                <div class="detail-creator">Created by: ${creator || 'Unknown'}</div>
                <div class="detail-description">${metadata.description}</div>
                
                ${attributesHtml ? `
                  <div style="font-weight:600; margin:20px 0 10px;">Attributes</div>
                  <div class="attributes-grid">
                    ${attributesHtml}
                  </div>
                ` : ''}
                
                <div class="detail-actions">
                  <a href="/forge/?tab=attest&agentId=${id}" class="nav-link" style="background:linear-gradient(135deg, rgba(74,163,255,.2), rgba(103,243,196,.2));">‚≠ê Attest This Agent</a>
                  <a href="/agent/" class="nav-link">üìã Back to Directory</a>
                  <button class="smallbtn" onclick="copyShareLink(${id})">üîó Share</button>
                </div>
                
                <div class="detail-uri">
                  <strong>Agent URI:</strong> ${uri || '(unavailable)'}${uriSource ? ` <span style="opacity:.7">[${uriSource}]</span>` : ''}
                </div>
                ${txHash ? `
                  <div class="detail-uri" style="margin-top:8px;">
                    <strong>Transaction:</strong> <a href="https://basescan.org/tx/${txHash}" target="_blank" style="color:var(--accent2);">${txHash.slice(0,10)}‚Ä¶${txHash.slice(-8)}</a>
                  </div>
                ` : ''}
                ${timestamp ? `
                  <div class="detail-uri" style="margin-top:8px;">
                    <strong>Timestamp:</strong> ${new Date(timestamp).toLocaleString()}
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
        </div>
      `;
      
      $("loadingSpinner").style.display = "none";
      $("agentsGrid").style.display = "grid";
      
    } catch (error) {
      console.error("Error loading agent:", error);
      $("loadingSpinner").style.display = "none";
      $("errorDisplay").style.display = "block";
      $("errorDisplay").innerHTML = `‚ùå ${error.message}`;
      $("statsBar").style.display = "grid";
      $("filterBar").style.display = "flex";
      $("pagination").style.display = "flex";
      $("pageTitle").textContent = "ToadAid Agent Directory ‚Äî Toadgang Registry";
      $("pageSubtitle").textContent = "ERC‚Äë8004 Agents on Base ¬∑ Real data from Blockscout ü™ûüåäüçÉ";
    }
  }
  
  async function fetchAgentsFromBlockscout() {
    try {
      $("loadingSpinner").style.display = "block";
      $("agentsGrid").style.display = "none";
      $("emptyState").style.display = "none";
      $("errorDisplay").style.display = "none";
      $("statusMessage").style.display = "none";
      
      console.log("Fetching from Blockscout with event sig:", FORGED_EVENT_SIG);
      
      const response = await fetch(BLOCKSCOUT_URL);
      const data = await response.json();
      
      if (data.status === "1" && data.result && data.result.length > 0) {
        $("statusMessage").style.display = "block";
        $("statusMessage").innerHTML = `‚úÖ Found ${data.result.length} forged agents!`;
        
        const agents = await pMapLimit(data.result, 6, async (log) => {
          const agentId = parseInt(log.topics[2], 16);
          const creator = '0x' + log.topics[1].slice(26);
          
          let uri = await fetchTokenURI(agentId);
          let uriSource = uri ? "TOKENURI_CALL" : null;
          if (!uri && log.data && log.data !== '0x') {
            uri = extractUriFromLogData(log.data, agentId);
            if (uri) uriSource = "FORGED_EVENT_LOG";
          }
          
          let name = `Agent #${agentId}`;
          let description = '';
          let image = 'ü™û';
          let imageUrl = null;
          let hasMetadata = false;
          
          if (uri) {
            hasMetadata = true;
            if (uri.startsWith('data:application/json;base64,')) {
              const base64Data = uri.replace('data:application/json;base64,', '');
              const parsed = parseBase64Metadata(base64Data);
              if (parsed) {
                name = parsed.name || name;
                description = parsed.description || '';
                image = parsed.image || 'ü™û';
                if (parsed.image && parsed.image.startsWith('http')) {
                  imageUrl = parsed.image;
                } else if (parsed.image && parsed.image.startsWith('ipfs://')) {
                  const hash = parsed.image.replace('ipfs://', '');
                  imageUrl = IPFS_GATEWAYS[0] + hash;
                }
              }
            } else if (uri.startsWith('ipfs://')) {
              name = `IPFS Agent #${agentId}`;
              description = 'Metadata stored on IPFS';
              try {
                const ipfsHash = uri.replace('ipfs://', '');
                const ipfsData = await fetchFromIPFS(ipfsHash);
                if (ipfsData) {
                  name = ipfsData.name || name;
                  description = ipfsData.description || description;
                  if (ipfsData.image) {
                    if (ipfsData.image.startsWith('http')) {
                      imageUrl = ipfsData.image;
                    } else if (ipfsData.image.startsWith('ipfs://')) {
                      const imgHash = ipfsData.image.replace('ipfs://', '');
                      imageUrl = IPFS_GATEWAYS[0] + imgHash;
                    }
                  }
                }
              } catch (e) {}
            }
          }
          
          return {
            id: agentId,
            name: name,
            description: description,
            image: image,
            imageUrl: imageUrl,
            creator: creator,
            active: true,
            endorsements: 0,
            flags: 0,
            timestamp: parseInt(log.timeStamp) * 1000,
            uri: uri,
            uriSource: uriSource,
            transactionHash: log.transactionHash,
            hasMetadata: hasMetadata
          };
        });
        
        agents.sort((a, b) => b.timestamp - a.timestamp);
        allAgents = agents;
        $("statusMessage").innerHTML = `‚úÖ Loaded ${agents.length} real agents from Blockscout!`;
        return true;
        
      } else if (data.result && data.result.length === 0) {
        $("statusMessage").style.display = "block";
        $("statusMessage").innerHTML = "‚ö†Ô∏è No forged agents found yet.";
        return false;
      } else {
        throw new Error(data.message || "Unknown error");
      }
      
    } catch (error) {
      console.error("Blockscout error:", error);
      $("errorDisplay").style.display = "block";
      $("errorDisplay").innerHTML = `‚ö†Ô∏è Blockscout API error: ${error.message}. Using sample data.`;
      return false;
    } finally {
      $("loadingSpinner").style.display = "none";
    }
  }
  
  async function loadAgents() {
    const success = await fetchAgentsFromBlockscout();
    
    if (!success || allAgents.length === 0) {
      allAgents = [
        { id: 1, name: "Lore Guardian", description: "The keeper of Toadgang lore", image: "ü™û", imageUrl: null, creator: TOAD_ADDRESS, active: true, endorsements: 42, flags: 2, timestamp: Date.now() - 86400000 * 30, hasMetadata: true },
        { id: 2, name: "Pond Watcher", description: "Monitors pond liquidity", image: "üåä", imageUrl: null, creator: TOAD_ADDRESS, active: true, endorsements: 28, flags: 1, timestamp: Date.now() - 86400000 * 15, hasMetadata: true },
        { id: 3, name: "MCP Server", description: "Weather data for toads", image: "üåÄ", imageUrl: null, creator: "0x1234...5678", active: true, endorsements: 15, flags: 0, timestamp: Date.now() - 86400000 * 7, hasMetadata: false },
        { id: 4, name: "Toad Trader", description: "Trading bot", image: "üê∏", imageUrl: null, creator: "0x9876...4321", active: false, endorsements: 8, flags: 3, timestamp: Date.now() - 86400000 * 2, hasMetadata: false },
        { id: 5, name: "Weather Oracle", description: "Migration weather", image: "‚òÄÔ∏è", imageUrl: null, creator: TOAD_ADDRESS, active: true, endorsements: 56, flags: 0, timestamp: Date.now() - 86400000 * 45, hasMetadata: true },
        { id: 6, name: "Pond Monitor", description: "Tracks pond health", image: "üåä", imageUrl: null, creator: "0x5555...5555", active: true, endorsements: 19, flags: 1, timestamp: Date.now() - 86400000 * 10, hasMetadata: false },
        { id: 7, name: "ToadAid Bot", description: "Helps toads daily", image: "ü§ñ", imageUrl: null, creator: TOAD_ADDRESS, active: true, endorsements: 34, flags: 0, timestamp: Date.now() - 86400000 * 5, hasMetadata: true },
        { id: 8, name: "Liquidity Provider", description: "Pond liquidity data", image: "üíß", imageUrl: null, creator: "0x1111...1111", active: true, endorsements: 22, flags: 1, timestamp: Date.now() - 86400000 * 3, hasMetadata: false }
      ];
      
      $("errorDisplay").style.display = "block";
      $("errorDisplay").innerHTML = "‚ö†Ô∏è Using sample data. No real agents found.";
    }
    
    $("agentsGrid").style.display = "grid";
    updateStats();
    applyFiltersAndRender();
  }
  
  function updateStats() {
    $("totalAgents").textContent = allAgents.length;
    $("toadAgents").textContent = allAgents.filter(a => a.creator.toLowerCase() === TOAD_ADDRESS.toLowerCase()).length;
    $("activeAgents").textContent = allAgents.filter(a => a.active).length;
    $("lastUpdate").textContent = formatTimeAgo(Date.now());
  }
  
  function applyFiltersAndRender() {
    const search = $("searchInput").value.toLowerCase();
    const creator = $("creatorFilter").value;
    const status = $("statusFilter").value;
    const sort = $("sortFilter").value;
    const metadata = $("metadataFilter").value;
    
    let filtered = [...allAgents];
    
    if (search) {
      if (smartSearch(search)) {
        return;
      }
      filtered = filtered.filter(a => 
        a.name.toLowerCase().includes(search) ||
        a.description.toLowerCase().includes(search) ||
        a.id.toString().includes(search)
      );
    }
    
    if (creator === "toadgang") {
      filtered = filtered.filter(a => a.creator.toLowerCase() === TOAD_ADDRESS.toLowerCase());
    }
    
    if (status !== "all") {
      filtered = filtered.filter(a => a.active === (status === "true"));
    }
    
    if (metadata === "has") {
      filtered = filtered.filter(a => a.hasMetadata);
    } else if (metadata === "missing") {
      filtered = filtered.filter(a => !a.hasMetadata);
    }
    
    if (sort === "newest") {
      filtered.sort((a, b) => b.timestamp - a.timestamp);
    } else if (sort === "oldest") {
      filtered.sort((a, b) => a.timestamp - b.timestamp);
    } else if (sort === "id") {
      filtered.sort((a, b) => a.id - b.id);
    }
    
    filteredAgents = filtered;
    currentPage = 1;
    renderAgents();
  }
  
  function renderAgents() {
    const grid = $("agentsGrid");
    const pagination = $("pagination");
    
    if (filteredAgents.length === 0) {
      grid.style.display = "none";
      $("emptyState").style.display = "block";
      pagination.style.display = "none";
      return;
    }
    
    $("emptyState").style.display = "none";
    grid.style.display = "grid";
    
    const start = (currentPage - 1) * pageSize;
    const paginated = filteredAgents.slice(start, start + pageSize);
    const totalPages = Math.ceil(filteredAgents.length / pageSize);
    
    grid.innerHTML = paginated.map(agent => {
      let imageHtml = `<div class="agent-card-image-placeholder">${agent.image}</div>`;
      if (agent.imageUrl) {
        imageHtml = `<img src="${agent.imageUrl}" alt="${agent.name}" class="agent-card-image" onerror="this.onerror=null; this.parentNode.innerHTML='<div class=\'agent-card-image-placeholder\'>ü™û</div>';">`;
      } else if (agent.image && agent.image.startsWith('http')) {
        imageHtml = `<img src="${agent.image}" alt="${agent.name}" class="agent-card-image" onerror="this.onerror=null; this.parentNode.innerHTML='<div class=\'agent-card-image-placeholder\'>ü™û</div>';">`;
      }
      
      const isToadgang = agent.creator.toLowerCase() === TOAD_ADDRESS.toLowerCase();
      const isLegendary = agent.id < 2;
      const hasMetadata = agent.hasMetadata;
      
      return `
        <div class="agent-card" onclick="window.location.href='/agent/?id=${agent.id}'">
          <div class="agent-card-image-container">
            ${imageHtml}
          </div>
          <div class="agent-card-content">
            <div class="agent-card-header">
              <span class="agent-card-id">#${agent.id}</span>
              <span class="agent-card-badge">${agent.active ? 'üü¢' : '‚ö´'}</span>
            </div>
            <div class="agent-card-name">${agent.name}</div>
            <div class="agent-card-creator" title="${agent.creator}">${shortAddr(agent.creator)}</div>
            <div class="badge-container">
              ${isLegendary ? '<span class="badge legendary">üëë OG</span>' : ''}
              ${hasMetadata ? '<span class="badge verified">‚úÖ Verified</span>' : ''}
              ${agent.uri ? '<span class="badge registry">üìã Registry</span>' : ''}
            </div>
            <div class="agent-card-footer">
              ${isToadgang ? '<span class="agent-card-tag">üê∏ TOADGANG</span>' : '<span></span>'}
              <div style="display:flex; align-items:center; gap:8px;">
                <span class="share-link" onclick="event.stopPropagation(); copyShareLink(${agent.id})">üîó</span>
                <span class="agent-card-link">View ‚Üí</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
    pagination.style.display = "flex";
    
    $("page1").textContent = currentPage;
    $("page2").textContent = currentPage + 1 <= totalPages ? currentPage + 1 : '';
    $("page3").textContent = currentPage + 2 <= totalPages ? currentPage + 2 : '';
    
    $("page1").style.display = 'flex';
    $("page2").style.display = currentPage + 1 <= totalPages ? 'flex' : 'none';
    $("page3").style.display = currentPage + 2 <= totalPages ? 'flex' : 'none';
    
    $("prevPage").className = `page-btn ${currentPage === 1 ? 'disabled' : ''}`;
    $("nextPage").className = `page-btn ${currentPage === totalPages ? 'disabled' : ''}`;
  }
  
  $("searchInput")?.addEventListener("input", applyFiltersAndRender);
  $("creatorFilter")?.addEventListener("change", applyFiltersAndRender);
  $("statusFilter")?.addEventListener("change", applyFiltersAndRender);
  $("sortFilter")?.addEventListener("change", applyFiltersAndRender);
  $("metadataFilter")?.addEventListener("change", applyFiltersAndRender);
  
  $("refreshBtn")?.addEventListener("click", loadAgents);
  
  $("prevPage")?.addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage--;
      renderAgents();
    }
  });
  
  $("nextPage")?.addEventListener("click", () => {
    const totalPages = Math.ceil(filteredAgents.length / pageSize);
    if (currentPage < totalPages) {
      currentPage++;
      renderAgents();
    }
  });
  
  $("page1")?.addEventListener("click", () => {
    currentPage = parseInt($("page1").textContent);
    renderAgents();
  });
  
  $("page2")?.addEventListener("click", () => {
    if ($("page2").textContent) {
      currentPage = parseInt($("page2").textContent);
      renderAgents();
    }
  });
  
  $("page3")?.addEventListener("click", () => {
    if ($("page3").textContent) {
      currentPage = parseInt($("page3").textContent);
      renderAgents();
    }
  });
  
  $("statsLink")?.addEventListener("click", (e) => {
    e.preventDefault();
    alert(`Total Agents: ${allAgents.length}\nToadgang Agents: ${allAgents.filter(a => a.creator.toLowerCase() === TOAD_ADDRESS.toLowerCase()).length}\nActive: ${allAgents.filter(a => a.active).length}`);
  });

  window.copyShareLink = copyShareLink;

  if (isDetailView) {
    $("statsBar").style.display = "none";
    $("filterBar").style.display = "none";
    $("pagination").style.display = "none";
    loadSingleAgent(agentId);
  } else {
    loadAgents();
    setInterval(loadAgents, 300000);
  }
  
  console.log("Agent Directory loaded with Blockscout!", isDetailView ? `Showing detail for #${agentId}` : "Showing directory");
</script>
</body>
</html>
