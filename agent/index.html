<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ToadAid ‚Äî Agent Directory (ERC-8004) | Toadgang Registry</title>
  <style>
    /* ALL YOUR EXISTING STYLES - KEEP THEM EXACTLY THE SAME */
    :root{
      --bg:#0b1020; --text:#e8eeff; --muted:#9bb0ff; --line:rgba(255,255,255,.08);
      --accent:#4aa3ff; --accent2:#67f3c4; --warn:#ffcc66; --bad:#ff6b6b; --good:#5cff95;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(74,163,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 80% 20%, rgba(103,243,196,.12), transparent 60%),
                  radial-gradient(800px 600px at 50% 90%, rgba(155,176,255,.10), transparent 55%),
                  var(--bg);
    }
    header{
      padding:28px 18px 14px;
      max-width:1400px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, rgba(74,163,255,.9), rgba(103,243,196,.9));
      box-shadow: var(--shadow); position:relative;
    }
    .logo:after{
      content:"üìã"; position:absolute; inset:0;
      display:grid; place-items:center;
      font-size:18px; filter: drop-shadow(0 4px 10px rgba(0,0,0,.35));
    }
    h1{ font-size:18px; margin:0; letter-spacing:.2px}
    .sub{ font-size:12.5px; color:var(--muted); margin-top:3px}
    .top-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{
      border:1px solid var(--line); background: rgba(255,255,255,.06);
      color:var(--text); padding:10px 12px; border-radius:12px;
      cursor:pointer; transition:.15s ease; font-weight:600;
    }
    button:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09) }
    button.primary{
      background: linear-gradient(135deg, rgba(74,163,255,.95), rgba(103,243,196,.85));
      color:#041024; border:0;
    }
    button.primary:hover{ filter:brightness(1.05) }
    .pill{
      font-family:var(--mono); font-size:12px; padding:8px 10px;
      border:1px solid var(--line); border-radius:999px;
      color:var(--muted); background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .nav-links{
      display:flex; gap:8px; margin-left:auto;
    }
    .nav-link{
      padding:8px 16px; border-radius:20px;
      background:rgba(255,255,255,.05); border:1px solid var(--line);
      color:var(--text); text-decoration:none; font-size:14px;
    }
    .nav-link.active{
      background:linear-gradient(135deg, rgba(74,163,255,.2), rgba(103,243,196,.2));
      border-color:var(--accent2);
    }
    .nav-link:hover{
      background:rgba(255,255,255,.1);
    }
    main{
      max-width:1400px; margin:0 auto;
      padding: 0 18px 40px;
    }
    .stats-bar{
      display:grid; grid-template-columns: repeat(4, 1fr);
      gap:16px; margin-bottom:24px;
    }
    .stat-card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:18px;
      padding:16px; text-align:center;
    }
    .stat-number{
      font-size:32px; font-weight:800;
      background:linear-gradient(135deg, #fff, var(--accent2));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      line-height:1.2;
    }
    .stat-label{
      font-size:12px; color:var(--muted);
      text-transform:uppercase; letter-spacing:1px;
    }
    .filter-bar{
      background: rgba(0,0,0,.22); border:1px solid var(--line);
      border-radius:18px; padding:16px; margin-bottom:24px;
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
    }
    .filter-input{
      flex:1; min-width:200px;
      background: rgba(0,0,0,.3); border:1px solid var(--line);
      border-radius:40px; padding:10px 16px;
      color:var(--text); font-family:var(--mono); font-size:13px;
    }
    .filter-select{
      background: rgba(0,0,0,.3); border:1px solid var(--line);
      border-radius:40px; padding:10px 16px;
      color:var(--text); font-family:var(--mono); font-size:13px;
      min-width:150px;
    }
    .agents-grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap:20px; margin-bottom:30px;
    }
    .agent-card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:18px;
      overflow:hidden; transition:.2s;
      backdrop-filter: blur(10px);
      cursor: pointer;
    }
    .agent-card:hover{
      transform: translateY(-4px); border-color:var(--accent2);
      box-shadow:0 10px 30px rgba(103,243,196,.15);
    }
    .agent-header{
      padding:12px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      background: rgba(0,0,0,.18);
    }
    .agent-id{
      font-family:var(--mono); font-size:12px;
      background:rgba(74,163,255,.2); padding:4px 8px;
      border-radius:20px; color:var(--accent);
    }
    .agent-badge{
      font-size:11px; padding:4px 8px; border-radius:20px;
      background:rgba(103,243,196,.15); color:var(--accent2);
    }
    .agent-body{
      padding:16px;
    }
    .agent-name{
      font-size:18px; font-weight:800; margin-bottom:8px;
      background:linear-gradient(135deg, #fff, var(--accent2));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .agent-desc{
      font-size:13px; color:var(--muted);
      margin-bottom:12px; line-height:1.5;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .agent-meta{
      display:flex; gap:12px; margin-bottom:12px;
      font-size:11px; font-family:var(--mono);
    }
    .meta-item{
      display:flex; align-items:center; gap:4px;
    }
    .agent-footer{
      padding:12px 16px; border-top:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center;
      background: rgba(0,0,0,.18);
    }
    .agent-creator{
      font-family:var(--mono); font-size:11px;
      color:var(--muted);
    }
    .agent-link{
      color:var(--accent2); text-decoration:none;
      font-size:12px; display:flex; align-items:center; gap:4px;
    }
    .pagination{
      display:flex; gap:8px; justify-content:center; margin-top:30px;
    }
    .page-btn{
      width:40px; height:40px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.05); border:1px solid var(--line);
      cursor:pointer;
    }
    .page-btn.active{
      background:linear-gradient(135deg, rgba(74,163,255,.2), rgba(103,243,196,.2));
      border-color:var(--accent2);
    }
    .page-btn.disabled{
      opacity:0.3; cursor:not-allowed;
    }
    .loading-spinner{
      text-align:center; padding:60px;
      color:var(--muted);
    }
    .loading-spinner .emoji{
      font-size:48px; margin-bottom:16px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .empty-state{
      text-align:center; padding:60px 20px;
      background:rgba(0,0,0,.18); border-radius:18px;
      border:1px dashed var(--line);
      color:var(--muted);
    }
    .empty-state .emoji{
      font-size:48px; margin-bottom:16px;
      opacity:0.5;
    }
    .toadgang-tag{
      background:rgba(103,243,196,.15);
      color:var(--accent2); padding:2px 8px;
      border-radius:12px; font-size:10px;
      margin-left:8px;
    }
    .error-message{
      background:rgba(255,107,107,.1);
      border:1px solid var(--bad);
      border-radius:12px;
      padding:16px;
      margin:20px 0;
      text-align:center;
      color:var(--bad);
    }
    .success-message{
      background:rgba(103,243,196,.1);
      border:1px solid var(--good);
      border-radius:12px;
      padding:16px;
      margin:20px 0;
      text-align:center;
      color:var(--good);
    }
    footer{
      max-width:1400px; margin:0 auto;
      padding: 0 18px 30px;
      color: var(--muted); font-size: 12px;
      border-top:1px solid var(--line); padding-top:20px;
      margin-top:20px;
    }
    
    /* Detail view styles */
    .detail-container {
      background: rgba(0,0,0,.22);
      border-radius: 24px;
      padding: 24px;
      margin-top: 20px;
    }
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 24px;
    }
    @media (max-width: 768px) {
      .detail-grid {
        grid-template-columns: 1fr;
      }
    }
    .detail-image {
      background: rgba(0,0,0,.3);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
    }
    .detail-image img {
      max-width: 100%;
      border-radius: 16px;
    }
    .detail-image-placeholder {
      font-size: 120px;
    }
    .detail-info {
      padding: 20px;
    }
    .detail-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .detail-id {
      font-family: var(--mono);
      font-size: 16px;
      background: rgba(74,163,255,.2);
      padding: 6px 12px;
      border-radius: 30px;
      color: var(--accent);
    }
    .detail-name {
      font-size: 36px;
      font-weight: 800;
      margin: 0 0 16px;
      background: linear-gradient(135deg, #fff, var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .detail-creator {
      font-family: var(--mono);
      color: var(--muted);
      margin-bottom: 20px;
      word-break: break-all;
    }
    .detail-description {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 24px;
    }
    .attributes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }
    .attribute-item {
      background: rgba(0,0,0,.3);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
    }
    .attribute-trait {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
    }
    .attribute-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent2);
    }
    
    /* Fix long values (addresses / hashes) overlapping in attribute cards */
    .attribute-item { min-width: 0; }
    .attribute-value{
      overflow-wrap: anywhere;
      word-break: break-word;
      line-height: 1.15;
      font-size: 12.5px;
    }
.detail-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    .detail-uri {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      word-break: break-all;
      margin-top: 16px;
    }
  
    /* ===== Mobile scroll + layout fixes ===== */
    html, body { width: 100%; overflow-x: hidden; }
    body { -webkit-text-size-adjust: 100%; touch-action: pan-y; }

    /* Make header stack cleanly on small screens */
    @media (max-width: 560px){
      header{
        flex-direction: column;
        align-items: flex-start;
      }
      .top-actions{
        width: 100%;
        justify-content: flex-start;
      }
      .pill{
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      button.smallbtn, button.primary.smallbtn{
        width: 100%;
      }
      .agents-grid{
        grid-template-columns: 1fr;
      }
    }


    @media (max-width: 560px){
      .attributes-grid{ grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
    }

</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1 id="pageTitle">ToadAid Agent Directory ‚Äî Toadgang Registry</h1>
      <div class="sub" id="pageSubtitle">ERC‚Äë8004 Agents on Base ¬∑ Public, read‚Äëonly index ¬∑ No wallet required ü™ûüåäüçÉ</div>
    </div>
  </div>

  <div class="top-actions">
    <span class="pill" id="netPill">Network: Base (8453)</span>
    <span class="pill" id="modePill">Mode: Read‚Äëonly</span>
  </div>
</header>

<main>
  <!-- Navigation -->
  <div class="nav-links" style="margin-bottom:24px;">
    <a href="/" class="nav-link">üè† Home</a>
    <a href="/forge/" class="nav-link">üî® Forge</a>
    <a href="/agent/" class="nav-link active" id="directoryLink">üìã Directory</a>
    <a href="#" class="nav-link" id="statsLink">üìä Stats</a>
  </div>

  <!-- Stats (hidden in detail mode) -->
  <div class="stats-bar" id="statsBar">
    <div class="stat-card">
      <div class="stat-number" id="totalAgents">‚Äî</div>
      <div class="stat-label">Total Agents</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="toadAgents">‚Äî</div>
      <div class="stat-label">Toadgang Agents</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="activeAgents">‚Äî</div>
      <div class="stat-label">Active</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="lastUpdate">‚Äî</div>
      <div class="stat-label">Last Update</div>
    </div>
  </div>

  <!-- Filters (hidden in detail mode) -->
  <div class="filter-bar" id="filterBar">
    <input type="text" class="filter-input" id="searchInput" placeholder="üîç Search by name, description, or agent ID...">
    <select class="filter-select" id="creatorFilter">
      <option value="all">All Creators</option>
      <option value="toadgang">üê∏ Toadgang Only</option>
    </select>
    <select class="filter-select" id="statusFilter">
      <option value="all">All Status</option>
      <option value="true">Active Only</option>
      <option value="false">Inactive</option>
    </select>
    <select class="filter-select" id="sortFilter">
      <option value="newest">Newest First</option>
      <option value="oldest">Oldest First</option>
      <option value="id">ID (ascending)</option>
    </select>
    <button class="primary" id="refreshBtn">üîÑ Refresh from Blockscout</button>
  </div>

  <!-- Status Message -->
  <div id="statusMessage" class="success-message" style="display:none;"></div>
  <div id="errorDisplay" class="error-message" style="display:none;"></div>

  <!-- Agents Grid (used for both directory and detail) -->
  <div id="agentsContainer">
    <div class="loading-spinner" id="loadingSpinner">
      <div class="emoji">ü™û</div>
      <div id="loadingMessage">Fetching real agents from Blockscout...</div>
      <div style="font-size:11px; margin-top:12px;">No API key needed - free and fast!</div>
    </div>
    <div class="agents-grid" id="agentsGrid" style="display:none;"></div>
    <div class="empty-state" id="emptyState" style="display:none;">
      <div class="emoji">ü™û</div>
      <div style="font-size:18px; margin-bottom:8px;">No agents found on chain</div>
      <div class="sub">Be the first to <a href="/forge/" style="color:var(--accent2)">forge an agent</a>!</div>
    </div>
  </div>

  <!-- Pagination (hidden in detail mode) -->
  <div class="pagination" id="pagination" style="display:none;">
    <div class="page-btn" id="prevPage">‚Üê</div>
    <div class="page-btn active" id="page1">1</div>
    <div class="page-btn" id="page2">2</div>
    <div class="page-btn" id="page3">3</div>
    <div class="page-btn" id="nextPage">‚Üí</div>
  </div>
</main>

<footer id="mainFooter">
  <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
    <div>ü™û ToadAid ¬∑ Agent Directory ¬∑ Real data from Blockscout API</div>
    <div>
      <a href="/forge/" style="color:var(--muted); margin-right:16px;">Forge</a>
      <a href="https://basescan.org/address/0x17163e5380929b04D4cC24f82aa6AC30877Bd0e0" target="_blank" style="color:var(--muted); margin-right:16px;">Contract</a>
      <a href="https://github.com/toadaid" target="_blank" style="color:var(--muted);">GitHub</a>
    </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
<script type="module">
  // ===== CONFIGURATION =====
  const BASE_ID = 8453;
  
  const REGISTRY_ROUTER = "0x17163e5380929b04D4cC24f82aa6AC30877Bd0e0";
  const REGISTRY_PROXY = "0x8004A169FB4a3325136EB29fA0ceB6D2e539a432";
  const TOAD_ADDRESS = "0x587464fd25af9147cb4660b03d899c8893378c0a";
  
  // REAL Forged event signature from Blockscout!
  const FORGED_EVENT_SIG = "0x32fd3812eeed46543cb7aaca82d2d133bd341f9cda13bba567150c44bda2dc81";
  const BLOCKSCOUT_URL = `https://base.blockscout.com/api?module=logs&action=getLogs&fromBlock=0&toBlock=latest&address=${REGISTRY_ROUTER}&topic0=${FORGED_EVENT_SIG}`;
  
  // ===== DOM ELEMENTS =====
  const $ = (id) => document.getElementById(id);
  
  // ===== CHECK URL FOR AGENT ID =====
  // Prefer query param: /agent/?id=19173 (GitHub Pages safe)
  // Fallback: /agent/19173 (works only with /agent/404.html redirect)
  const params = new URLSearchParams(window.location.search);
  const qId = params.get("id");

  const path = window.location.pathname;
  const pathParts = path.split("/").filter(Boolean);
  const lastPart = pathParts[pathParts.length - 1];

  const parsedQueryId = qId && /^\d+$/.test(qId) ? parseInt(qId, 10) : null;
  const parsedPathId = lastPart && /^\d+$/.test(lastPart) && path.includes("/agent/") ? parseInt(lastPart, 10) : null;

  const agentId = parsedQueryId ?? parsedPathId;
  const isDetailView = Number.isInteger(agentId);

  console.log("URL path:", path, "Query id:", qId, "Agent ID:", agentId);

  // ===== STATE =====
  let allAgents = [];
  let filteredAgents = [];
  let currentPage = 1;
  const pageSize = 12;
  let provider;
  
  // IPFS gateways
  const IPFS_GATEWAYS = [
    "https://ipfs.io/ipfs/",
    "https://cloudflare-ipfs.com/ipfs/",
    "https://gateway.pinata.cloud/ipfs/"
  ];
  
  // ===== HELPER FUNCTIONS =====
  function formatTimeAgo(timestamp) {
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return `${seconds}s ago`;
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
  }
  
  // Decode hex string to UTF-8
  function hexToString(hex) {
    try {
      if (!hex || hex === '0x') return '';
      const hexStr = hex.startsWith('0x') ? hex.slice(2) : hex;
      let str = '';
      for (let i = 0; i < hexStr.length; i += 2) {
        const code = parseInt(hexStr.substr(i, 2), 16);
        if (code !== 0) str += String.fromCharCode(code);
      }
      return str;
    } catch (e) {
      return '';
    }
  }
  
  // Extract URI from log data (simplified version)
  function extractUriFromLogData(dataHex, agentId) {
    try {
      if (!dataHex || dataHex === '0x') return null;
      
      // Remove '0x' prefix
      const hex = dataHex.startsWith('0x') ? dataHex.slice(2) : dataHex;
      
      // Try to find IPFS pattern
      for (let i = 0; i < hex.length - 20; i++) {
        // Look for 'ipfs://' in hex (69 70 66 73 3a 2f 2f)
        if (hex.substr(i, 14).toLowerCase() === '697066733a2f2f') {
          let uriHex = '';
          let j = i;
          while (j < hex.length && hex.substr(j, 2) !== '00') {
            uriHex += hex.substr(j, 2);
            j += 2;
          }
          const uri = hexToString(uriHex);
          if (uri.startsWith('ipfs://')) return uri;
        }
        
        // Look for 'data:application/json;base64,' pattern
        if (hex.substr(i, 40).toLowerCase().includes('646174613a6170706c69636174696f6e2f6a736f6e3b6261736536342c')) {
          let uriHex = '';
          let j = i;
          while (j < hex.length && hex.substr(j, 2) !== '00') {
            uriHex += hex.substr(j, 2);
            j += 2;
          }
          const uri = hexToString(uriHex);
          if (uri.startsWith('data:application/json;base64,')) return uri;
        }
      }
      
      // Fallback: try the tail of the data (where URI usually is)
      const tail = hex.slice(-400);
      let str = '';
      for (let i = 0; i < tail.length; i += 2) {
        const code = parseInt(tail.substr(i, 2), 16);
        if (code >= 32 && code <= 126) str += String.fromCharCode(code);
      }
      const match = str.match(/(ipfs:\/\/[^\s"'<>]+|data:application\/json;base64,[A-Za-z0-9+/=]+)/);
      return match ? match[1] : null;
      
    } catch (e) {
      console.warn("Error extracting URI from log data:", e);
      return null;
    }
  }
  
  // Fetch from IPFS with fallback gateways
  async function fetchFromIPFS(ipfsHash) {
    for (const gateway of IPFS_GATEWAYS) {
      try {
        const response = await fetch(gateway + ipfsHash);
        if (response.ok) return await response.json();
      } catch (e) {
        console.warn(`Gateway ${gateway} failed:`, e);
      }
    }
    return null;
  }
  
  // ===== LOAD SINGLE AGENT DETAIL =====
  async function loadSingleAgent(id) {
    try {
      $("loadingSpinner").style.display = "block";
      $("agentsGrid").style.display = "none";
      $("errorDisplay").style.display = "none";
      $("statsBar").style.display = "none";
      $("filterBar").style.display = "none";
      $("pagination").style.display = "none";
      $("pageTitle").textContent = `Agent #${id} ‚Äî ToadAid Registry`;
      $("pageSubtitle").textContent = "ERC‚Äë8004 Agent Details ¬∑ Real data from IPFS ü™û";
      $("loadingMessage").textContent = `Loading agent #${id} from blockchain and IPFS...`;
      
      // First, get the agent data from Blockscout logs
      const response = await fetch(BLOCKSCOUT_URL);
      const data = await response.json();
      
      let creator = null;
      let timestamp = null;
      let txHash = null;
      let uri = null;
      let uriSource = null;
      
      if (data.status === "1" && data.result) {
        // Find the log for this specific agent ID
        const log = data.result.find(l => parseInt(l.topics[2], 16) === id);
        
        if (log) {
          creator = '0x' + log.topics[1].slice(26);
          timestamp = parseInt(log.timeStamp) * 1000;
          txHash = log.transactionHash;
          
          // Extract URI from log data
          if (log.data && log.data !== "0x") {
            const extractedUri = extractUriFromLogData(log.data, id);
            if (extractedUri) {
              uri = extractedUri;
              uriSource = "FORGED_EVENT_LOG";
              console.log("Agent URI extracted from log:", uri);
            }
          }
        } else {
          // Agent ID not found in logs
          throw new Error(`Agent #${id} not found on chain`);
        }
      } else {
        throw new Error("Could not fetch agent data from Blockscout");
      }
      
      // Parse metadata from URI
      let metadata = {
        name: `Agent #${id}`,
        description: "No description available",
        image: "ü™û",
        attributes: []
      };
      
      if (uri) {
        if (uri.startsWith('ipfs://')) {
          const ipfsHash = uri.replace('ipfs://', '');
          const ipfsData = await fetchFromIPFS(ipfsHash);
          if (ipfsData) {
            metadata = { ...metadata, ...ipfsData };
          }
        } else if (uri.startsWith('data:application/json;base64,')) {
          try {
            const base64 = uri.replace('data:application/json;base64,', '');
            const json = atob(base64);
            metadata = { ...metadata, ...JSON.parse(json) };
          } catch (e) {
            console.warn("Failed to parse base64 metadata:", e);
          }
        }
      }
      
      const isToadgang = creator && creator.toLowerCase() === TOAD_ADDRESS.toLowerCase();
      
      // Build image HTML
      let imageHtml = '<div class="detail-image-placeholder">ü™û</div>';
      if (metadata.image) {
        if (metadata.image.startsWith('http')) {
          imageHtml = `<img src="${metadata.image}" alt="${metadata.name}" />`;
        } else if (metadata.image.startsWith('ipfs://')) {
          const ipfsHash = metadata.image.replace('ipfs://', '');
          imageHtml = `<img src="https://ipfs.io/ipfs/${ipfsHash}" alt="${metadata.name}" />`;
        }
      }
      
      // Build attributes HTML
      let attributesHtml = '';
      if (metadata.attributes && metadata.attributes.length > 0) {
        attributesHtml = metadata.attributes.map(attr => `
          <div class="attribute-item">
            <div class="attribute-trait">${attr.trait_type || 'Attribute'}</div>
            <div class="attribute-value">${attr.value}</div>
          </div>
        `).join('');
      }
      
      // Render detail view
      $("agentsGrid").innerHTML = `
        <div style="grid-column: span 12;">
          <div class="detail-container">
            <div class="detail-grid">
              <div class="detail-image">
                ${imageHtml}
              </div>
              <div class="detail-info">
                <div class="detail-header">
                  <span class="detail-id">#${id}</span>
                  ${isToadgang ? '<span class="toadgang-tag" style="font-size:14px;">üê∏ TOADGANG</span>' : ''}
                </div>
                <h1 class="detail-name">${metadata.name}</h1>
                <div class="detail-creator">Created by: ${creator || 'Unknown'}</div>
                <div class="detail-description">${metadata.description}</div>
                
                ${attributesHtml ? `
                  <div style="font-weight:600; margin:20px 0 10px;">Attributes</div>
                  <div class="attributes-grid">
                    ${attributesHtml}
                  </div>
                ` : ''}
                
                <div class="detail-actions">
                  <a href="/forge/?tab=attest&agentId=${id}" class="nav-link" style="background:linear-gradient(135deg, rgba(74,163,255,.2), rgba(103,243,196,.2));">‚≠ê Attest This Agent</a>
                  <a href="/agent/" class="nav-link">üìã Back to Directory</a>
                </div>
                
                <div class="detail-uri">
                  <strong>Agent URI:</strong> ${uri || '(unavailable)'}${uriSource ? ` <span style="opacity:.7">[${uriSource}]</span>` : ''}
                </div>
                ${txHash ? `
                  <div class="detail-uri" style="margin-top:8px;">
                    <strong>Transaction:</strong> <a href="https://basescan.org/tx/${txHash}" target="_blank" style="color:var(--accent2);">${txHash.slice(0,10)}‚Ä¶${txHash.slice(-8)}</a>
                  </div>
                ` : ''}
                ${timestamp ? `
                  <div class="detail-uri" style="margin-top:8px;">
                    <strong>Timestamp:</strong> ${new Date(timestamp).toLocaleString()}
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
        </div>
      `;
      
      $("loadingSpinner").style.display = "none";
      $("agentsGrid").style.display = "grid";
      
    } catch (error) {
      console.error("Error loading agent:", error);
      $("loadingSpinner").style.display = "none";
      $("errorDisplay").style.display = "block";
      $("errorDisplay").innerHTML = `‚ùå ${error.message}`;
      $("statsBar").style.display = "grid";
      $("filterBar").style.display = "flex";
      $("pagination").style.display = "flex";
      $("pageTitle").textContent = "ToadAid Agent Directory ‚Äî Toadgang Registry";
      $("pageSubtitle").textContent = "ERC‚Äë8004 Agents on Base ¬∑ Real data from Blockscout ü™ûüåäüçÉ";
    }
  }
  
  // ===== FETCH REAL AGENTS FROM BLOCKSCOUT =====
  async function fetchAgentsFromBlockscout() {
    try {
      $("loadingSpinner").style.display = "block";
      $("agentsGrid").style.display = "none";
      $("emptyState").style.display = "none";
      $("errorDisplay").style.display = "none";
      $("statusMessage").style.display = "none";
      
      console.log("Fetching from Blockscout with event sig:", FORGED_EVENT_SIG);
      
      const response = await fetch(BLOCKSCOUT_URL);
      const data = await response.json();
      
      if (data.status === "1" && data.result && data.result.length > 0) {
        $("statusMessage").style.display = "block";
        $("statusMessage").innerHTML = `‚úÖ Found ${data.result.length} forged agents!`;
        
        const agents = await Promise.all(data.result.map(async (log) => {
          const agentId = parseInt(log.topics[2], 16);
          const creator = '0x' + log.topics[1].slice(26);
          
          // Extract URI from log data
          let uri = null;
          if (log.data && log.data !== '0x') {
            uri = extractUriFromLogData(log.data, agentId);
          }
          
          // Parse metadata if we have URI
          let name = `Agent #${agentId}`;
          let description = '';
          let image = 'ü™û';
          
          if (uri) {
            if (uri.startsWith('data:application/json;base64,')) {
              try {
                const base64 = uri.replace('data:application/json;base64,', '');
                const json = atob(base64);
                const metadata = JSON.parse(json);
                name = metadata.name || name;
                description = metadata.description || '';
                image = metadata.image || 'ü™û';
              } catch (e) {}
            } else if (uri.startsWith('ipfs://')) {
              name = `IPFS Agent #${agentId}`;
              description = 'Metadata stored on IPFS';
              // Optionally try to fetch from IPFS here
            }
          }
          
          return {
            id: agentId,
            name: name,
            description: description,
            image: image,
            creator: creator,
            active: true,
            endorsements: 0,
            flags: 0,
            timestamp: parseInt(log.timeStamp) * 1000,
            uri: uri,
            transactionHash: log.transactionHash
          };
        }));
        
        agents.sort((a, b) => b.timestamp - a.timestamp);
        allAgents = agents;
        $("statusMessage").innerHTML = `‚úÖ Loaded ${agents.length} real agents from Blockscout!`;
        return true;
        
      } else if (data.result && data.result.length === 0) {
        $("statusMessage").style.display = "block";
        $("statusMessage").innerHTML = "‚ö†Ô∏è No forged agents found yet.";
        return false;
      } else {
        throw new Error(data.message || "Unknown error");
      }
      
    } catch (error) {
      console.error("Blockscout error:", error);
      $("errorDisplay").style.display = "block";
      $("errorDisplay").innerHTML = `‚ö†Ô∏è Blockscout API error: ${error.message}. Using sample data.`;
      return false;
    } finally {
      $("loadingSpinner").style.display = "none";
    }
  }
  
  // ===== LOAD AGENTS FOR DIRECTORY =====
  async function loadAgents() {
    const success = await fetchAgentsFromBlockscout();
    
    if (!success || allAgents.length === 0) {
      allAgents = [
        { id: 1, name: "Lore Guardian", description: "The keeper of Toadgang lore", image: "ü™û", creator: TOAD_ADDRESS, active: true, endorsements: 42, flags: 2, timestamp: Date.now() - 86400000 * 30 },
        { id: 2, name: "Pond Watcher", description: "Monitors pond liquidity", image: "üåä", creator: TOAD_ADDRESS, active: true, endorsements: 28, flags: 1, timestamp: Date.now() - 86400000 * 15 },
        { id: 3, name: "MCP Server", description: "Weather data for toads", image: "üåÄ", creator: "0x1234...5678", active: true, endorsements: 15, flags: 0, timestamp: Date.now() - 86400000 * 7 },
        { id: 4, name: "Toad Trader", description: "Trading bot", image: "üê∏", creator: "0x9876...4321", active: false, endorsements: 8, flags: 3, timestamp: Date.now() - 86400000 * 2 },
        { id: 5, name: "Weather Oracle", description: "Migration weather", image: "‚òÄÔ∏è", creator: TOAD_ADDRESS, active: true, endorsements: 56, flags: 0, timestamp: Date.now() - 86400000 * 45 },
        { id: 6, name: "Pond Monitor", description: "Tracks pond health", image: "üåä", creator: "0x5555...5555", active: true, endorsements: 19, flags: 1, timestamp: Date.now() - 86400000 * 10 },
        { id: 7, name: "ToadAid Bot", description: "Helps toads daily", image: "ü§ñ", creator: TOAD_ADDRESS, active: true, endorsements: 34, flags: 0, timestamp: Date.now() - 86400000 * 5 },
        { id: 8, name: "Liquidity Provider", description: "Pond liquidity data", image: "üíß", creator: "0x1111...1111", active: true, endorsements: 22, flags: 1, timestamp: Date.now() - 86400000 * 3 }
      ];
      
      $("errorDisplay").style.display = "block";
      $("errorDisplay").innerHTML = "‚ö†Ô∏è Using sample data. No real agents found.";
    }
    
    $("agentsGrid").style.display = "grid";
    updateStats();
    applyFiltersAndRender();
  }
  
  // ===== UI FUNCTIONS =====
  function updateStats() {
    $("totalAgents").textContent = allAgents.length;
    $("toadAgents").textContent = allAgents.filter(a => a.creator.toLowerCase() === TOAD_ADDRESS.toLowerCase()).length;
    $("activeAgents").textContent = allAgents.filter(a => a.active).length;
    $("lastUpdate").textContent = formatTimeAgo(Date.now());
  }
  
  function applyFiltersAndRender() {
    const search = $("searchInput").value.toLowerCase();
    const creator = $("creatorFilter").value;
    const status = $("statusFilter").value;
    const sort = $("sortFilter").value;
    
    let filtered = [...allAgents];
    
    if (search) {
      filtered = filtered.filter(a => 
        a.name.toLowerCase().includes(search) ||
        a.description.toLowerCase().includes(search) ||
        a.id.toString().includes(search)
      );
    }
    
    if (creator === "toadgang") {
      filtered = filtered.filter(a => a.creator.toLowerCase() === TOAD_ADDRESS.toLowerCase());
    }
    
    if (status !== "all") {
      filtered = filtered.filter(a => a.active === (status === "true"));
    }
    
    if (sort === "newest") {
      filtered.sort((a, b) => b.timestamp - a.timestamp);
    } else if (sort === "oldest") {
      filtered.sort((a, b) => a.timestamp - b.timestamp);
    } else if (sort === "id") {
      filtered.sort((a, b) => a.id - b.id);
    }
    
    filteredAgents = filtered;
    currentPage = 1;
    renderAgents();
  }
  
  function renderAgents() {
    const grid = $("agentsGrid");
    const pagination = $("pagination");
    
    if (filteredAgents.length === 0) {
      grid.style.display = "none";
      $("emptyState").style.display = "block";
      pagination.style.display = "none";
      return;
    }
    
    $("emptyState").style.display = "none";
    grid.style.display = "grid";
    
    const start = (currentPage - 1) * pageSize;
    const paginated = filteredAgents.slice(start, start + pageSize);
    const totalPages = Math.ceil(filteredAgents.length / pageSize);
    
    grid.innerHTML = paginated.map(agent => `
      <div class="agent-card" onclick="window.location.href='/agent/?id=${agent.id}'">
        <div class="agent-header">
          <span class="agent-id">#${agent.id}</span>
          <span class="agent-badge">${agent.active ? 'üü¢ Active' : '‚ö´ Inactive'}</span>
        </div>
        <div class="agent-body">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
            <div style="font-size:32px;">${agent.image}</div>
            <div class="agent-name">${agent.name}</div>
          </div>
          ${agent.creator.toLowerCase() === TOAD_ADDRESS.toLowerCase() ? '<span class="toadgang-tag">üê∏ TOADGANG</span>' : ''}
          <div class="agent-desc">${agent.description}</div>
          <div class="agent-meta">
            <span class="meta-item">‚≠ê ${agent.endorsements}</span>
            <span class="meta-item">üö© ${agent.flags}</span>
            <span class="meta-item">üìÖ ${new Date(agent.timestamp).toLocaleDateString()}</span>
          </div>
        </div>
        <div class="agent-footer">
          <span class="agent-creator" title="${agent.creator}">${agent.creator.slice(0,6)}‚Ä¶${agent.creator.slice(-4)}</span>
          <span class="agent-link">
            View Details ‚Üí
          </span>
        </div>
      </div>
    `).join('');
    
    pagination.style.display = "flex";
    
    $("page1").textContent = currentPage;
    $("page2").textContent = currentPage + 1 <= totalPages ? currentPage + 1 : '';
    $("page3").textContent = currentPage + 2 <= totalPages ? currentPage + 2 : '';
    
    $("page1").style.display = 'flex';
    $("page2").style.display = currentPage + 1 <= totalPages ? 'flex' : 'none';
    $("page3").style.display = currentPage + 2 <= totalPages ? 'flex' : 'none';
    
    $("prevPage").className = `page-btn ${currentPage === 1 ? 'disabled' : ''}`;
    $("nextPage").className = `page-btn ${currentPage === totalPages ? 'disabled' : ''}`;
  }
  
  // ===== EVENT LISTENERS =====
  $("searchInput")?.addEventListener("input", applyFiltersAndRender);
  $("creatorFilter")?.addEventListener("change", applyFiltersAndRender);
  $("statusFilter")?.addEventListener("change", applyFiltersAndRender);
  $("sortFilter")?.addEventListener("change", applyFiltersAndRender);
  
  $("refreshBtn")?.addEventListener("click", loadAgents);
  
  $("prevPage")?.addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage--;
      renderAgents();
    }
  });
  
  $("nextPage")?.addEventListener("click", () => {
    const totalPages = Math.ceil(filteredAgents.length / pageSize);
    if (currentPage < totalPages) {
      currentPage++;
      renderAgents();
    }
  });
  
  $("page1")?.addEventListener("click", () => {
    currentPage = parseInt($("page1").textContent);
    renderAgents();
  });
  
  $("page2")?.addEventListener("click", () => {
    if ($("page2").textContent) {
      currentPage = parseInt($("page2").textContent);
      renderAgents();
    }
  });
  
  $("page3")?.addEventListener("click", () => {
    if ($("page3").textContent) {
      currentPage = parseInt($("page3").textContent);
      renderAgents();
    }
  });
  
  $("statsLink")?.addEventListener("click", (e) => {
    e.preventDefault();
    alert(`Total Agents: ${allAgents.length}\nToadgang Agents: ${allAgents.filter(a => a.creator.toLowerCase() === TOAD_ADDRESS.toLowerCase()).length}\nActive: ${allAgents.filter(a => a.active).length}`);
  });

  // ===== INIT =====
  if (isDetailView) {
    // Show single agent detail
    $("statsBar").style.display = "none";
    $("filterBar").style.display = "none";
    $("pagination").style.display = "none";
    loadSingleAgent(agentId);
  } else {
    // Show directory
    loadAgents();
    // Auto-refresh every 5 minutes
    setInterval(loadAgents, 300000);
  }
  
  console.log("Agent Directory loaded with Blockscout!", isDetailView ? `Showing detail for #${agentId}` : "Showing directory");
</script>
</body>
</html>
