<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ToadAid ‚Äî Agent Directory (ERC-8004) | Toadgang Registry</title>
  <style>
    /* ALL STYLES FROM YOUR PREVIOUS VERSION - KEEP THEM EXACTLY */
    :root{
      --bg:#0b1020; --text:#e8eeff; --muted:#9bb0ff; --line:rgba(255,255,255,.08);
      --accent:#4aa3ff; --accent2:#67f3c4; --warn:#ffcc66; --bad:#ff6b6b; --good:#5cff95;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(74,163,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 80% 20%, rgba(103,243,196,.12), transparent 60%),
                  radial-gradient(800px 600px at 50% 90%, rgba(155,176,255,.10), transparent 55%),
                  var(--bg);
    }
    header{
      padding:28px 18px 14px;
      max-width:1400px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, rgba(74,163,255,.9), rgba(103,243,196,.9));
      box-shadow: var(--shadow); position:relative;
    }
    .logo:after{
      content:"üìã"; position:absolute; inset:0;
      display:grid; place-items:center;
      font-size:18px; filter: drop-shadow(0 4px 10px rgba(0,0,0,.35));
    }
    h1{ font-size:18px; margin:0; letter-spacing:.2px}
    .sub{ font-size:12.5px; color:var(--muted); margin-top:3px}
    .top-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    button{
      border:1px solid var(--line); background: rgba(255,255,255,.06);
      color:var(--text); padding:10px 12px; border-radius:12px;
      cursor:pointer; transition:.15s ease; font-weight:600;
    }
    button:hover{ transform: translateY(-1px); background: rgba(255,255,255,.09) }
    button.primary{
      background: linear-gradient(135deg, rgba(74,163,255,.95), rgba(103,243,196,.85));
      color:#041024; border:0;
    }
    button.primary:hover{ filter:brightness(1.05) }
    .pill{
      font-family:var(--mono); font-size:12px; padding:8px 10px;
      border:1px solid var(--line); border-radius:999px;
      color:var(--muted); background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .nav-links{
      display:flex; gap:8px; margin-left:auto;
    }
    .nav-link{
      padding:8px 16px; border-radius:20px;
      background:rgba(255,255,255,.05); border:1px solid var(--line);
      color:var(--text); text-decoration:none; font-size:14px;
    }
    .nav-link.active{
      background:linear-gradient(135deg, rgba(74,163,255,.2), rgba(103,243,196,.2));
      border-color:var(--accent2);
    }
    .nav-link:hover{
      background:rgba(255,255,255,.1);
    }
    main{
      max-width:1400px; margin:0 auto;
      padding: 0 18px 40px;
    }
    .stats-bar{
      display:grid; grid-template-columns: repeat(4, 1fr);
      gap:16px; margin-bottom:24px;
    }
    .stat-card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:18px;
      padding:16px; text-align:center;
    }
    .stat-number{
      font-size:32px; font-weight:800;
      background:linear-gradient(135deg, #fff, var(--accent2));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      line-height:1.2;
    }
    .stat-label{
      font-size:12px; color:var(--muted);
      text-transform:uppercase; letter-spacing:1px;
    }
    .filter-bar{
      background: rgba(0,0,0,.22); border:1px solid var(--line);
      border-radius:18px; padding:16px; margin-bottom:24px;
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
    }
    .filter-input{
      flex:1; min-width:200px;
      background: rgba(0,0,0,.3); border:1px solid var(--line);
      border-radius:40px; padding:10px 16px;
      color:var(--text); font-family:var(--mono); font-size:13px;
    }
    .filter-select{
      background: rgba(0,0,0,.3); border:1px solid var(--line);
      border-radius:40px; padding:10px 16px;
      color:var(--text); font-family:var(--mono); font-size:13px;
      min-width:150px;
    }
    .agents-grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap:20px; margin-bottom:30px;
    }
    .agent-card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:18px;
      overflow:hidden; transition:.2s;
      backdrop-filter: blur(10px);
      cursor: pointer;
    }
    .agent-card:hover{
      transform: translateY(-4px); border-color:var(--accent2);
      box-shadow:0 10px 30px rgba(103,243,196,.15);
    }
    .agent-header{
      padding:12px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      background: rgba(0,0,0,.18);
    }
    .agent-id{
      font-family:var(--mono); font-size:12px;
      background:rgba(74,163,255,.2); padding:4px 8px;
      border-radius:20px; color:var(--accent);
    }
    .agent-badge{
      font-size:11px; padding:4px 8px; border-radius:20px;
      background:rgba(103,243,196,.15); color:var(--accent2);
    }
    .agent-body{
      padding:16px;
    }
    .agent-name{
      font-size:18px; font-weight:800; margin-bottom:8px;
      background:linear-gradient(135deg, #fff, var(--accent2));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .agent-desc{
      font-size:13px; color:var(--muted);
      margin-bottom:12px; line-height:1.5;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .agent-meta{
      display:flex; gap:12px; margin-bottom:12px;
      font-size:11px; font-family:var(--mono);
    }
    .meta-item{
      display:flex; align-items:center; gap:4px;
    }
    .agent-footer{
      padding:12px 16px; border-top:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center;
      background: rgba(0,0,0,.18);
    }
    .agent-creator{
      font-family:var(--mono); font-size:11px;
      color:var(--muted);
    }
    .agent-link{
      color:var(--accent2); text-decoration:none;
      font-size:12px; display:flex; align-items:center; gap:4px;
    }
    .pagination{
      display:flex; gap:8px; justify-content:center; margin-top:30px;
    }
    .page-btn{
      width:40px; height:40px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.05); border:1px solid var(--line);
      cursor:pointer;
    }
    .page-btn.active{
      background:linear-gradient(135deg, rgba(74,163,255,.2), rgba(103,243,196,.2));
      border-color:var(--accent2);
    }
    .page-btn.disabled{
      opacity:0.3; cursor:not-allowed;
    }
    .loading-spinner{
      text-align:center; padding:60px;
      color:var(--muted);
    }
    .loading-spinner .emoji{
      font-size:48px; margin-bottom:16px;
      animation: spin 2s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .empty-state{
      text-align:center; padding:60px 20px;
      background:rgba(0,0,0,.18); border-radius:18px;
      border:1px dashed var(--line);
      color:var(--muted);
    }
    .empty-state .emoji{
      font-size:48px; margin-bottom:16px;
      opacity:0.5;
    }
    .toadgang-tag{
      background:rgba(103,243,196,.15);
      color:var(--accent2); padding:2px 8px;
      border-radius:12px; font-size:10px;
      margin-left:8px;
    }
    .error-message{
      background:rgba(255,107,107,.1);
      border:1px solid var(--bad);
      border-radius:12px;
      padding:16px;
      margin:20px 0;
      text-align:center;
      color:var(--bad);
    }
    .success-message{
      background:rgba(103,243,196,.1);
      border:1px solid var(--good);
      border-radius:12px;
      padding:16px;
      margin:20px 0;
      text-align:center;
      color:var(--good);
    }
    footer{
      max-width:1400px; margin:0 auto;
      padding: 0 18px 30px;
      color: var(--muted); font-size: 12px;
      border-top:1px solid var(--line); padding-top:20px;
      margin-top:20px;
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>ToadAid Agent Directory ‚Äî Toadgang Registry</h1>
      <div class="sub">ERC‚Äë8004 Agents on Base ¬∑ Real data from Alchemy ü™ûüåäüçÉ</div>
    </div>
  </div>

  <div class="top-actions">
    <span class="pill" id="netPill">Network: ‚Äî</span>
    <span class="pill" id="addrPill">Wallet: ‚Äî</span>
    <button class="smallbtn" id="btnConnect">Connect</button>
    <button class="smallbtn" id="btnDisconnect" style="display:none;">Disconnect</button>
  </div>
</header>

<main>
  <!-- Navigation -->
  <div class="nav-links" style="margin-bottom:24px;">
    <a href="/" class="nav-link">üè† Home</a>
    <a href="/forge/" class="nav-link">üî® Forge</a>
    <a href="/agent/" class="nav-link active">üìã Directory</a>
    <a href="#" class="nav-link" id="statsLink">üìä Stats</a>
  </div>

  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-number" id="totalAgents">‚Äî</div>
      <div class="stat-label">Total Agents</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="toadAgents">‚Äî</div>
      <div class="stat-label">Toadgang Agents</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="activeAgents">‚Äî</div>
      <div class="stat-label">Active</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="lastUpdate">‚Äî</div>
      <div class="stat-label">Last Update</div>
    </div>
  </div>

  <!-- Status Message -->
  <div id="statusMessage" class="success-message" style="display:none;"></div>
  <div id="errorDisplay" class="error-message" style="display:none;"></div>

  <!-- Filters -->
  <div class="filter-bar">
    <input type="text" class="filter-input" id="searchInput" placeholder="üîç Search by name, description, or agent ID...">
    <select class="filter-select" id="creatorFilter">
      <option value="all">All Creators</option>
      <option value="toadgang">üê∏ Toadgang Only</option>
    </select>
    <select class="filter-select" id="statusFilter">
      <option value="all">All Status</option>
      <option value="true">Active Only</option>
      <option value="false">Inactive</option>
    </select>
    <select class="filter-select" id="sortFilter">
      <option value="newest">Newest First</option>
      <option value="oldest">Oldest First</option>
      <option value="id">ID (ascending)</option>
    </select>
    <button class="primary" id="refreshBtn">üîÑ Refresh from Alchemy</button>
  </div>

  <!-- Agents Grid -->
  <div id="agentsContainer">
    <div class="loading-spinner" id="loadingSpinner">
      <div class="emoji">ü™û</div>
      <div>Fetching real agents from Alchemy...</div>
      <div style="font-size:11px; margin-top:12px;">Using your Alchemy API key</div>
    </div>
    <div class="agents-grid" id="agentsGrid" style="display:none;"></div>
    <div class="empty-state" id="emptyState" style="display:none;">
      <div class="emoji">ü™û</div>
      <div style="font-size:18px; margin-bottom:8px;">No agents found on chain</div>
      <div class="sub">Be the first to <a href="/forge/" style="color:var(--accent2)">forge an agent</a>!</div>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination" id="pagination" style="display:none;">
    <div class="page-btn" id="prevPage">‚Üê</div>
    <div class="page-btn active" id="page1">1</div>
    <div class="page-btn" id="page2">2</div>
    <div class="page-btn" id="page3">3</div>
    <div class="page-btn" id="nextPage">‚Üí</div>
  </div>
</main>

<footer>
  <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px;">
    <div>ü™û ToadAid ¬∑ Agent Directory ¬∑ Real data from Alchemy API</div>
    <div>
      <a href="/forge/" style="color:var(--muted); margin-right:16px;">Forge</a>
      <a href="https://basescan.org/address/0x17163e5380929b04D4cC24f82aa6AC30877Bd0e0" target="_blank" style="color:var(--muted); margin-right:16px;">Contract</a>
      <a href="https://github.com/toadaid" target="_blank" style="color:var(--muted);">GitHub</a>
    </div>
  </div>
</footer>

<!-- WalletConnect Modal -->
<div id="walletModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); backdrop-filter:blur(8px); align-items:center; justify-content:center; z-index:1000;">
  <div style="background:#0f1733; border:1px solid var(--accent); border-radius:24px; padding:24px; max-width:400px; width:90%;">
    <h3 style="margin-top:0; color:var(--accent2); text-align:center;">üîå Connect Wallet</h3>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:20px 0;">
      <div id="optBrowser" style="background:rgba(255,255,255,.1); border-radius:14px; padding:15px; text-align:center; cursor:pointer;">
        <div style="font-size:24px;">üß©</div>
        <div>Browser</div>
        <small style="color:var(--muted);">MetaMask, Rabby</small>
      </div>
      <div id="optWC" style="background:rgba(255,255,255,.1); border-radius:14px; padding:15px; text-align:center; cursor:pointer;">
        <div style="font-size:24px;">üì±</div>
        <div>Mobile</div>
        <small style="color:var(--muted);">WalletConnect QR</small>
      </div>
    </div>
    <button onclick="document.getElementById('walletModal').style.display='none'" style="width:100%; background:transparent; border:1px solid var(--line); padding:12px; border-radius:40px; cursor:pointer;">Cancel</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
<script type="module">
  // Import WalletConnect
  import { EthereumProvider } from "https://esm.sh/@walletconnect/ethereum-provider@2.17.5";

  // ===== CONFIGURATION =====
  const ALCHEMY_API_KEY = "-JrfkGdCwU2Ts6dC-9uhAP0ZHYUFJkBG"; // Your working Alchemy key!
  const ALCHEMY_URL = `https://base-mainnet.g.alchemy.com/v2/${ALCHEMY_API_KEY}`;
  
  const WC_PROJECT_ID = "c86752a13a29b19d308dc10fb72b820f";
  const BASE_ID = 8453;
  
  const REGISTRY_ROUTER = "0x17163e5380929b04D4cC24f82aa6AC30877Bd0e0";
  const TOAD_ADDRESS = "0x587464fd25af9147cb4660b03d899c8893378c0a"; // Updated from your event!
  
  // REAL Forged event signature from your contract!
  const FORGED_EVENT_SIG = "0x433b1a743df29cafbb6a1974d6683ffdf634082f8fada01f1ef9c57713ab8894";
  
  // ===== DOM ELEMENTS =====
  const $ = (id) => document.getElementById(id);
  
  // ===== STATE =====
  let allAgents = [];
  let filteredAgents = [];
  let currentPage = 1;
  const pageSize = 12;
  let provider, signer, wcProvider;
  
  // ===== HELPER FUNCTIONS =====
  function formatTimeAgo(timestamp) {
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return `${seconds}s ago`;
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
  }
  
  // Parse agent URI to get metadata
  function parseAgentURI(uriHex, agentId) {
    try {
      let agentURI = '';
      if (uriHex && uriHex !== '0x') {
        const hex = uriHex.slice(2);
        const bytes = [];
        for (let i = 0; i < hex.length; i += 2) {
          bytes.push(parseInt(hex.substr(i, 2), 16));
        }
        agentURI = new TextDecoder().decode(new Uint8Array(bytes));
      }
      
      let metadata = { name: `Agent #${agentId}`, description: '', image: 'ü™û', active: true };
      
      if (agentURI.startsWith('data:application/json;base64,')) {
        const base64 = agentURI.replace('data:application/json;base64,', '');
        const json = atob(base64);
        metadata = { ...metadata, ...JSON.parse(json) };
      } else if (agentURI.startsWith('ipfs://')) {
        // For IPFS URIs, show IPFS tag
        metadata.name = `IPFS Agent #${agentId}`;
        metadata.description = 'Metadata stored on IPFS';
      }
      
      return metadata;
    } catch (e) {
      console.warn('Failed to parse metadata for agent', agentId, e);
      return { name: `Agent #${agentId}`, description: 'Metadata parse failed', image: 'ü™û', active: true };
    }
  }
  
  // ===== FETCH REAL AGENTS FROM ALCHEMY =====
  async function fetchAgentsFromAlchemy() {
    try {
      $("loadingSpinner").style.display = "block";
      $("agentsGrid").style.display = "none";
      $("emptyState").style.display = "none";
      $("errorDisplay").style.display = "none";
      $("statusMessage").style.display = "none";
      
      console.log("Fetching from Alchemy with event sig:", FORGED_EVENT_SIG);
      
      // Create provider with your Alchemy key
      const alchemyProvider = new ethers.JsonRpcProvider(ALCHEMY_URL);
      
      // Test connection
      const blockNumber = await alchemyProvider.getBlockNumber();
      console.log("Connected to Alchemy. Current block:", blockNumber);
      
      $("statusMessage").style.display = "block";
      $("statusMessage").innerHTML = `‚úÖ Connected to Alchemy (block ${blockNumber}). Fetching agents...`;
      
      // Get logs for Forged events using the REAL signature
      const logs = await alchemyProvider.send("eth_getLogs", [{
        address: REGISTRY_ROUTER,
        fromBlock: "0x0",
        toBlock: "latest",
        topics: [FORGED_EVENT_SIG]
      }]);
      
      console.log("Found logs:", logs.length);
      
      if (logs.length === 0) {
        $("statusMessage").innerHTML = "‚ö†Ô∏è No Forged events found yet.";
        return false;
      }
      
      // Process logs into agents
      const agents = [];
      
      for (let i = 0; i < logs.length; i++) {
        const log = logs[i];
        try {
          // Extract data from log
          // topics[0] = event sig, topics[1] = creator, topics[2] = agentId, topics[3] = registry
          const creator = log.topics[1] ? '0x' + log.topics[1].slice(26) : null;
          const agentIdHex = log.topics[2] || '0x0';
          const agentId = parseInt(agentIdHex, 16);
          const metadata = parseAgentURI(log.data, agentId);
          
          if (creator) {
            agents.push({
              id: agentId,
              name: metadata.name,
              description: metadata.description || 'No description',
              image: metadata.image || 'ü™û',
              creator: creator,
              active: metadata.active !== false,
              endorsements: 0, // You can fetch attestations later
              flags: 0,
              timestamp: Date.now() - (i * 86400000), // Approx - you could get block timestamp
              transactionHash: log.transactionHash
            });
          }
        } catch (e) {
          console.warn("Error processing log:", e);
        }
      }
      
      if (agents.length > 0) {
        allAgents = agents;
        $("statusMessage").innerHTML = `‚úÖ Loaded ${agents.length} real agents from Alchemy!`;
        return true;
      }
      
      return false;
      
    } catch (error) {
      console.error("Alchemy error:", error);
      $("errorDisplay").style.display = "block";
      $("errorDisplay").innerHTML = `‚ö†Ô∏è Alchemy API error: ${error.message}.`;
      return false;
    }
  }
  
  // ===== LOAD AGENTS (with fallback to mock) =====
  async function loadAgents() {
    const success = await fetchAgentsFromAlchemy();
    
    if (!success || allAgents.length === 0) {
      // Fallback to mock data (should not happen now with your event signature)
      allAgents = [
        { id: 1, name: "Lore Guardian", description: "The keeper of Toadgang lore", image: "ü™û", creator: TOAD_ADDRESS, active: true, endorsements: 42, flags: 2, timestamp: Date.now() - 86400000 * 30 },
        { id: 2, name: "Pond Watcher", description: "Monitors pond liquidity", image: "üåä", creator: TOAD_ADDRESS, active: true, endorsements: 28, flags: 1, timestamp: Date.now() - 86400000 * 15 },
        { id: 3, name: "MCP Server", description: "Weather data for toads", image: "üåÄ", creator: "0x1234...5678", active: true, endorsements: 15, flags: 0, timestamp: Date.now() - 86400000 * 7 },
        { id: 4, name: "Toad Trader", description: "Trading bot", image: "üê∏", creator: "0x9876...4321", active: false, endorsements: 8, flags: 3, timestamp: Date.now() - 86400000 * 2 },
        { id: 5, name: "Weather Oracle", description: "Migration weather", image: "‚òÄÔ∏è", creator: TOAD_ADDRESS, active: true, endorsements: 56, flags: 0, timestamp: Date.now() - 86400000 * 45 },
        { id: 6, name: "Pond Monitor", description: "Tracks pond health", image: "üåä", creator: "0x5555...5555", active: true, endorsements: 19, flags: 1, timestamp: Date.now() - 86400000 * 10 },
        { id: 7, name: "ToadAid Bot", description: "Helps toads daily", image: "ü§ñ", creator: TOAD_ADDRESS, active: true, endorsements: 34, flags: 0, timestamp: Date.now() - 86400000 * 5 },
        { id: 8, name: "Liquidity Provider", description: "Pond liquidity data", image: "üíß", creator: "0x1111...1111", active: true, endorsements: 22, flags: 1, timestamp: Date.now() - 86400000 * 3 }
      ];
      
      $("errorDisplay").style.display = "block";
      $("errorDisplay").innerHTML = "‚ö†Ô∏è Using sample data. No real agents found.";
    }
    
    $("loadingSpinner").style.display = "none";
    $("agentsGrid").style.display = "grid";
    
    updateStats();
    applyFiltersAndRender();
  }
  
  // ===== UI FUNCTIONS =====
  function updateStats() {
    $("totalAgents").textContent = allAgents.length;
    $("toadAgents").textContent = allAgents.filter(a => a.creator.toLowerCase() === TOAD_ADDRESS.toLowerCase()).length;
    $("activeAgents").textContent = allAgents.filter(a => a.active).length;
    $("lastUpdate").textContent = formatTimeAgo(Date.now());
  }
  
  function applyFiltersAndRender() {
    const search = $("searchInput").value.toLowerCase();
    const creator = $("creatorFilter").value;
    const status = $("statusFilter").value;
    const sort = $("sortFilter").value;
    
    let filtered = [...allAgents];
    
    if (search) {
      filtered = filtered.filter(a => 
        a.name.toLowerCase().includes(search) ||
        a.description.toLowerCase().includes(search) ||
        a.id.toString().includes(search)
      );
    }
    
    if (creator === "toadgang") {
      filtered = filtered.filter(a => a.creator.toLowerCase() === TOAD_ADDRESS.toLowerCase());
    }
    
    if (status !== "all") {
      filtered = filtered.filter(a => a.active === (status === "true"));
    }
    
    if (sort === "newest") {
      filtered.sort((a, b) => b.timestamp - a.timestamp);
    } else if (sort === "oldest") {
      filtered.sort((a, b) => a.timestamp - b.timestamp);
    } else if (sort === "id") {
      filtered.sort((a, b) => a.id - b.id);
    }
    
    filteredAgents = filtered;
    currentPage = 1;
    renderAgents();
  }
  
  function renderAgents() {
    const grid = $("agentsGrid");
    const pagination = $("pagination");
    
    if (filteredAgents.length === 0) {
      grid.style.display = "none";
      $("emptyState").style.display = "block";
      pagination.style.display = "none";
      return;
    }
    
    $("emptyState").style.display = "none";
    grid.style.display = "grid";
    
    const start = (currentPage - 1) * pageSize;
    const paginated = filteredAgents.slice(start, start + pageSize);
    const totalPages = Math.ceil(filteredAgents.length / pageSize);
    
    grid.innerHTML = paginated.map(agent => `
      <div class="agent-card" onclick="window.location.href='/agent/${agent.id}/'">
        <div class="agent-header">
          <span class="agent-id">#${agent.id}</span>
          <span class="agent-badge">${agent.active ? 'üü¢ Active' : '‚ö´ Inactive'}</span>
        </div>
        <div class="agent-body">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
            <div style="font-size:32px;">${agent.image}</div>
            <div class="agent-name">${agent.name}</div>
          </div>
          ${agent.creator.toLowerCase() === TOAD_ADDRESS.toLowerCase() ? '<span class="toadgang-tag">üê∏ TOADGANG</span>' : ''}
          <div class="agent-desc">${agent.description}</div>
          <div class="agent-meta">
            <span class="meta-item">‚≠ê ${agent.endorsements}</span>
            <span class="meta-item">üö© ${agent.flags}</span>
            <span class="meta-item">üìÖ ${new Date(agent.timestamp).toLocaleDateString()}</span>
          </div>
        </div>
        <div class="agent-footer">
          <span class="agent-creator" title="${agent.creator}">${agent.creator.slice(0,6)}‚Ä¶${agent.creator.slice(-4)}</span>
          <span class="agent-link">
            View Details ‚Üí
          </span>
        </div>
      </div>
    `).join('');
    
    pagination.style.display = "flex";
    
    $("page1").textContent = currentPage;
    $("page2").textContent = currentPage + 1 <= totalPages ? currentPage + 1 : '';
    $("page3").textContent = currentPage + 2 <= totalPages ? currentPage + 2 : '';
    
    $("page1").style.display = 'flex';
    $("page2").style.display = currentPage + 1 <= totalPages ? 'flex' : 'none';
    $("page3").style.display = currentPage + 2 <= totalPages ? 'flex' : 'none';
    
    $("prevPage").className = `page-btn ${currentPage === 1 ? 'disabled' : ''}`;
    $("nextPage").className = `page-btn ${currentPage === totalPages ? 'disabled' : ''}`;
  }
  
  // ===== EVENT LISTENERS =====
  $("searchInput").addEventListener("input", applyFiltersAndRender);
  $("creatorFilter").addEventListener("change", applyFiltersAndRender);
  $("statusFilter").addEventListener("change", applyFiltersAndRender);
  $("sortFilter").addEventListener("change", applyFiltersAndRender);
  
  $("refreshBtn").addEventListener("click", loadAgents);
  
  $("prevPage").addEventListener("click", () => {
    if (currentPage > 1) {
      currentPage--;
      renderAgents();
    }
  });
  
  $("nextPage").addEventListener("click", () => {
    const totalPages = Math.ceil(filteredAgents.length / pageSize);
    if (currentPage < totalPages) {
      currentPage++;
      renderAgents();
    }
  });
  
  $("page1").addEventListener("click", () => {
    currentPage = parseInt($("page1").textContent);
    renderAgents();
  });
  
  $("page2").addEventListener("click", () => {
    if ($("page2").textContent) {
      currentPage = parseInt($("page2").textContent);
      renderAgents();
    }
  });
  
  $("page3").addEventListener("click", () => {
    if ($("page3").textContent) {
      currentPage = parseInt($("page3").textContent);
      renderAgents();
    }
  });
  
  $("statsLink").addEventListener("click", (e) => {
    e.preventDefault();
    alert(`Total Agents: ${allAgents.length}\nToadgang Agents: ${allAgents.filter(a => a.creator.toLowerCase() === TOAD_ADDRESS.toLowerCase()).length}\nActive: ${allAgents.filter(a => a.active).length}`);
  });
  
  // ===== WALLET CONNECT =====
  $("optBrowser").onclick = async () => {
    if(!window.ethereum) return alert("No extension found");
    try {
      $("walletModal").style.display = "none";
      const p = new ethers.BrowserProvider(window.ethereum);
      await p.send("eth_requestAccounts", []);
      
      signer = await p.getSigner();
      provider = p;
      const addr = await signer.getAddress();
      
      $("addrPill").textContent = addr.slice(0,6) + "..." + addr.slice(-4);
      $("netPill").textContent = "Base (8453)";
      $("btnConnect").style.display = "none";
      $("btnDisconnect").style.display = "inline-block";
    } catch(e) { 
      console.error(e);
      alert("Connection failed: " + e.message);
    }
  };

  $("optWC").onclick = async () => {
    try {
      $("walletModal").style.display = "none";
      
      wcProvider = await EthereumProvider.init({
        projectId: WC_PROJECT_ID,
        chains: [BASE_ID],
        showQrModal: true,
        optionalChains: [BASE_ID],
        methods: ['eth_sendTransaction', 'eth_sign', 'personal_sign', 'eth_signTypedData'],
        events: ['chainChanged', 'accountsChanged']
      });
      
      await wcProvider.connect();
      
      const p = new ethers.BrowserProvider(wcProvider);
      signer = await p.getSigner();
      provider = p;
      const addr = await signer.getAddress();
      
      $("addrPill").textContent = addr.slice(0,6) + "..." + addr.slice(-4);
      $("netPill").textContent = "Base (8453)";
      $("btnConnect").style.display = "none";
      $("btnDisconnect").style.display = "inline-block";
      
    } catch(e) { 
      console.error(e);
      alert("WalletConnect failed: " + e.message);
    }
  };

  $("btnDisconnect").onclick = async () => {
    if (wcProvider) {
      try { await wcProvider.disconnect(); } catch(e) {}
      wcProvider = null;
    }
    provider = null;
    signer = null;
    
    $("addrPill").textContent = "Wallet: ‚Äî";
    $("netPill").textContent = "Network: ‚Äî";
    $("btnConnect").style.display = "inline-block";
    $("btnDisconnect").style.display = "none";
  };

  $("btnConnect").onclick = () => {
    $("walletModal").style.display = "flex";
  };

  window.onclick = (e) => {
    if (e.target === $("walletModal")) {
      $("walletModal").style.display = "none";
    }
  };
  
  // ===== INIT =====
  loadAgents();
  
  // Auto-refresh every 5 minutes
  setInterval(loadAgents, 300000);
  
  console.log("Agent Directory loaded with REAL event signature!");
</script>
</body>
</html>
